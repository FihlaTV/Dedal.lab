!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DDLS={})}(this,function(t){"use strict";function e(t){console.log(t)}function s(t,e){this.type=t||0,0===this.type?(this.k=[],this.v=[]):this.h={}}function i(t,e){this.x=t||0,this.y=e||0}function n(t,e,s,i,n,r){this.n=[t||1,e||0,s||0,i||1,n||0,r||0]}function r(t,e,s){this.rangeMin=e||0,this.rangeMax=s||1,this._originalSeed=this._currSeed=t||1234,this._numIter=0,Object.defineProperty(this,"seed",{get:function(){return this._originalSeed},set:function(t){this._originalSeed=this._currSeed=t}})}function o(){this._fromFace=null,this._nextEdge=null,Object.defineProperty(this,"fromFace",{set:function(t){this._fromFace=t,this._nextEdge=this._fromFace.edge}})}function h(){this._fromMesh=null,this._currIndex=0,Object.defineProperty(this,"fromMesh",{set:function(t){this._fromMesh=t,this._currIndex=0}})}function a(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){this._fromVertex=t,this._nextEdge=this._fromVertex.edge}})}function u(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){for(this._fromVertex=t,this._nextEdge=this._fromVertex.edge;!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function d(){this.realEdgesOnly=!0,this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){if(this._fromVertex=t,this._nextEdge=this._fromVertex.edge,null!=this._nextEdge)for(;this.realEdgesOnly&&!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function l(t,e){e=e||1;var s=t.length;if(s<=4)return[].concat(t);for(var n=t[0],r=t[1],o=t[s-2],h=t[s-1],a=-1,u=0,d=1,c=s>>1;d<c;){var g=d++,p=Q.distanceSquaredPointToSegment(new i(t[g<<1],t[1+(g<<1)]),new i(n,r),new i(o,h));p>u&&(u=p,a=g)}if(u>e*e){var f=t.slice(0,2+(a<<1)),x=t.slice(a<<1),_=l(f,e),y=l(x,e);return _.slice(0,_.length-2).concat(y)}return[n,r,o,h]}function c(t,e){this.length=t*e,this.bytes=new X.ARRAY(this.length<<2),this.width=t,this.height=e}function g(t,e){if(t){var s=t.width,i=t.height,n=document.createElement("canvas");n.width=s,n.height=i;var r=n.getContext("2d");r.drawImage(t,0,0,s,i),e=r.getImageData(0,0,s,i)}for(var o=new c(e.width,e.height),h=e.data,a=h.byteLength,u=0,d=0;u<a;)d=u++,o.bytes[d]=255&h[d];return t&&(r.clearRect(0,0,s,i),n=null,r=null),o}function p(t,e){this.images=new s(2),this.loaded=e,this.count=t.length;for(var i=0;i<t.length;){var n=t[i];++i,this.load(n)}}function f(){this.type=G,this.id=U.get("edge"),this.fromConstraintSegments=[],this.isConstrained=!1,this.isReal=!1,this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,Object.defineProperty(this,"destinationVertex",{get:function(){return this.oppositeEdge.originVertex}}),Object.defineProperty(this,"nextRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge}}),Object.defineProperty(this,"rotLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"rotRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge}}),Object.defineProperty(this,"rightFace",{get:function(){return this.oppositeEdge.leftFace}})}function x(){this.type=Y,this.id=U.get("face"),this.isReal=!1,this.edge=null}function _(){this.type=W,this.id=U.get("vertex"),this.pos=new i,this.fromConstraintSegments=[],this.edge=null,this.isReal=!1}function y(){this.id=U.get("shape"),this.segments=[]}function m(t,e){this.id=U.get("segment"),this.edges=[],this.fromShape=null}function v(){this.id=U.get("object2D"),this._pivot=new i,this._position=new i,this._scale=new i(1,1),this._matrix=new n,this._rotation=0,this._constraintShape=null,this._coordinates=[],this.hasChanged=!1,Object.defineProperty(this,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation!=t&&(this._rotation=t,this.hasChanged=!0)}}),Object.defineProperty(this,"matrix",{get:function(){return this._matrix},set:function(t){this._matrix=t,this.hasChanged=!0}}),Object.defineProperty(this,"coordinates",{get:function(){return this._coordinates},set:function(t){this._coordinates=t,this.hasChanged=!0}}),Object.defineProperty(this,"constraintShape",{get:function(){return this._constraintShape},set:function(t){this._constraintShape=t,this.hasChanged=!0}}),Object.defineProperty(this,"edges",{get:function(){for(var t,e=[],s=this._constraintShape.segments,i=s.length,n=0,r=0,o=0,h=0;n<i;)for(r=0,t=s[o=n++].edges.length;r<t;)h=r++,e.push(s[o].edges[h]);return e}})}function E(){this.id=U.get("graph"),this.edge=null,this.node=null}function w(){this.id=U.get("graphEdge"),this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}function S(){this.id=U.get("graphNode"),this.successorNodes=new s(1),this.prev=null,this.next=null,this.outgoingEdge=null,this.data=null}function C(){}function P(){}function F(t,e){this.id=U.get("mesh2D"),this.__objectsUpdateInProgress=!1,this.__centerVertex=null,this.width=t,this.height=e,this.clipping=!0,this._edges=[],this._faces=[],this._objects=[],this._vertices=[],this._constraintShapes=[],this.__edgesToCheck=[],this.AR_vertex=null,this.AR_edge=null,this.isRedraw=!0}function V(){this.iterEdge=new o,this.mesh=null,this._radius=0,this.radiusSquared=0,this.diameter=0,this.diameterSquared=0,Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this.radiusSquared=this._radius*this._radius,this.diameter=2*this._radius,this.diameterSquared=this.diameter*this.diameter}})}function b(){this._currPoolPointsIndex=0,this._poolPointsSize=3e3,this._numSamplesCircle=16,this._radiusSquared=0,this._radius=0,this._poolPoints=[];for(var t=this._poolPointsSize,e=0;e<t;){e++;this._poolPoints.push(new i)}Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){if(this._radius=X.max(0,t),this._radiusSquared=this._radius*this._radius,this._sampleCircle=[],0!=this._radius){for(var e,s=this._numSamplesCircle,n=0;n<s;){var r=n++;e=-X.TwoPI*r/this._numSamplesCircle,this._sampleCircle.push(new i(this._radius*X.cos(e),this._radius*X.sin(e)))}this._sampleCircleDistanceSquared=X.Squared(this._sampleCircle[0].x-this._sampleCircle[1].x,this._sampleCircle[0].y-this._sampleCircle[1].y)}}})}function D(){this.astar=new V,this.funnel=new b,this.listFaces=[],this.listEdges=[],this._mesh=null,this.entity=null,Object.defineProperty(this,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh=t,this.astar.mesh=t}})}function O(){this.entity=null,this.hasPrev=!1,this.hasNext=!1,this.countMax=0,this.count=0,this._currentX=0,this._currentY=0,this._path=[],Object.defineProperty(this,"x",{get:function(){return this._currentX}}),Object.defineProperty(this,"y",{get:function(){return this._currentY}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this.countMax=.5*this._path.length,this.reset()}})}function L(){this.entity=null,this._path=null,this._samplingDistanceSquared=1,this._samplingDistance=1,this._preCompX=[],this._preCompY=[],this.pos=new i,this.hasPrev=!1,this.hasNext=!1,this._count=0,Object.defineProperty(this,"x",{get:function(){return this.pos.x}}),Object.defineProperty(this,"y",{get:function(){return this.pos.y}}),Object.defineProperty(this,"countMax",{get:function(){return this._preCompX.length-1}}),Object.defineProperty(this,"count",{get:function(){return this._count},set:function(t){this._count=t,this._count<0&&(this._count=0),this._count>this.countMax-1&&(this._count=this.countMax-1),0==this._count?this.hasPrev=!1:this.hasPrev=!0,this._count==this.countMax-1?this.hasNext=!1:this.hasNext=!0,this.applyLast(),this.updateEntity()}}),Object.defineProperty(this,"samplingDistance",{get:function(){return this._samplingDistance},set:function(t){this._samplingDistance=t,this._samplingDistanceSquared=this._samplingDistance*this._samplingDistance}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this._preComputed=!1,this.reset()}})}function N(t,e){this.entity=t||null,this.world=e||null}function R(t,e){this.isSee=!1,this.isWalking=!1,this.isSelected=!1,this.isMove=!1,this.world=e,t=t||{},this.position=new i(t.x||0,t.y||0),this.direction=new i(1,0),this.radius=t.r||10,this.angle=0,this.angleFOV=(t.fov||120)*X.torad,this.radiusFOV=t.distance||200,this.testSee=t.see||!1,this.path=[],this.tmppath=[],this.target=new i,this.newPath=!1,this.mesh=null,this.fov=new N(this,this.world),this.pathSampler=new L,this.pathSampler.entity=this,this.pathSampler.path=this.tmppath,this.pathSampler.samplingDistance=t.speed||10}function T(t,e){for(var s=[],i=[],n=[],r=[],o=4;o--;)n.push(new x),s.push(new _),r.push(new m),i.push(new f,new f,new f);var h=new y;s[0].pos.set(-10,-10),s[1].pos.set(t+10,-10),s[2].pos.set(t+10,e+10),s[3].pos.set(-10,e+10),s[0].setDatas(i[0]),s[1].setDatas(i[2]),s[2].setDatas(i[4]),s[3].setDatas(i[6]),i[0].setDatas(s[0],i[1],i[2],n[3],!0,!0),i[1].setDatas(s[1],i[0],i[7],n[0],!0,!0),i[2].setDatas(s[1],i[3],i[11],n[3],!0,!0),i[3].setDatas(s[2],i[2],i[8],n[1],!0,!0),i[4].setDatas(s[2],i[5],i[6],n[2],!0,!0),i[5].setDatas(s[3],i[4],i[3],n[1],!0,!0),i[6].setDatas(s[3],i[7],i[10],n[2],!0,!0),i[7].setDatas(s[0],i[6],i[9],n[0],!0,!0),i[8].setDatas(s[1],i[9],i[5],n[1],!0,!1),i[9].setDatas(s[3],i[8],i[1],n[0],!0,!1),i[10].setDatas(s[0],i[11],i[4],n[2],!1,!1),i[11].setDatas(s[2],i[10],i[0],n[3],!1,!1),n[0].setDatas(i[9],!0),n[1].setDatas(i[8],!0),n[2].setDatas(i[4],!1),n[3].setDatas(i[2],!1),s[0].fromConstraintSegments=[r[0],r[3]],s[1].fromConstraintSegments=[r[0],r[1]],s[2].fromConstraintSegments=[r[1],r[2]],s[3].fromConstraintSegments=[r[2],r[3]],i[0].fromConstraintSegments.push(r[0]),i[1].fromConstraintSegments.push(r[0]),i[2].fromConstraintSegments.push(r[1]),i[3].fromConstraintSegments.push(r[1]),i[4].fromConstraintSegments.push(r[2]),i[5].fromConstraintSegments.push(r[2]),i[6].fromConstraintSegments.push(r[3]),i[7].fromConstraintSegments.push(r[3]),r[0].edges.push(i[0]),r[1].edges.push(i[2]),r[2].edges.push(i[4]),r[3].edges.push(i[6]),r[0].fromShape=h,r[1].fromShape=h,r[2].fromShape=h,r[3].fromShape=h,h.segments.push(r[0],r[1],r[2],r[3]);var a=new F(t,e);return a._vertices=s,a._edges=i,a._faces=n,a.clipping=!1,a.insertConstraintShape([0,0,t,0,t,0,t,e,t,e,0,e,0,e,0,0]),a.clipping=!0,a}function q(t,e){this.heroes=[],this.shapes=[],this.segments=[],this.objects=[],this.w=t||512,this.h=e||512,this.mesh=T(this.w,this.h),this.pathFinder=new D,this.pathFinder.mesh=this.mesh}function I(t,e){this.visited=!1,this.col=t,this.row=e;for(var s=[],i=0;i<4;){i++;s.push([])}this.walls=s}function j(t,e,s,i){this.generate(t,e,s,i)}function M(t,e,s,i){this.generate(t,e,s,i)}function k(t){this.g0=new A(t.w,t.h),this.g=new A(t.w,t.h),this.g.canvas.style.pointerEvents="none",this.g0.canvas.style.pointerEvents="auto",this.entitiesWidth=1,this.entitiesColor={r:0,g:255,b:0,a:.75},this.entitiesColor2={r:255,g:255,b:255,a:.75},this.entitiesField={r:0,g:255,b:0,a:.1},this.entitiesField2={r:255,g:255,b:255,a:.1},this.pathsWidth=2,this.pathsColor={r:255,g:255,b:0,a:.75},this.verticesRadius=1,this.verticesColor={r:255,g:120,b:0,a:.5},this.constraintsWidth=2,this.constraintsColor={r:255,g:0,b:0,a:1},this.edgesWidth=1,this.edgesColor={r:190,g:190,b:190,a:.25},this.edgesColor2={r:0,g:190,b:0,a:.25},this.mesh_data=null,this.domElement=this.g0.canvas,H.set(this)}function A(t,e){this.w=t||200,this.h=e||200,this.canvas=document.createElement("canvas"),this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.canvas.style.cssText="position:absolute; left:50%; top:50%; margin-left:"+.5*-this.w+"px; margin-top:"+.5*-this.h+"px;",document.body.appendChild(this.canvas)}function B(t,e){this.world=e,this.maxVertices=3e4,this.currentVertex=0;var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.maxVertices),3)),s.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*this.maxVertices),3)),this.positions=s.attributes.position.array,this.colors=s.attributes.color.array,s.computeBoundingSphere(),this.buffer=new THREE.LineSegments(s,new THREE.LineBasicMaterial({vertexColors:!0})),this.buffer.frustumCulled=!1,t.add(this.buffer),this.maxPathVertices=1e3,this.currentPathVertex=0;var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),this.positionsPath=i.attributes.position.array,this.colorsPath=i.attributes.color.array,s.computeBoundingSphere(),this.bufferPath=new THREE.LineSegments(i,new THREE.LineBasicMaterial({vertexColors:!0})),this.bufferPath.frustumCulled=!1,t.add(this.bufferPath),H.set(this)}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(void 0!==i&&null!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e});var W=0,G=1,Y=2,H={view:null,get:function(){return this.view},set:function(t){this.view=t}},U={id:{segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0},get:function(t){return++this.id[t]},reset:function(){this.id={segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0}}};s.prototype={set:function(t,e){2===this.type?this.h[t]=e:1===this.type?this.h[t.id]=e:(this.k.push(t),this.v.push(e))},get:function(t){if(2===this.type)return this.h[t];if(1===this.type)return this.h[t.id];var e=this.k.indexOf(t);return-1!=e?this.v[e]:void 0},dispose:function(){if(0===this.type){for(;this.k.length>0;)this.k.pop();for(;this.v.length>0;)this.v.pop();this.k=null,this.v=null}else this.h=null}};var X={ARRAY:"undefined"!=typeof Float32Array?Float32Array:Array,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,torad:.017453292519943295,todeg:57.29577951308232,Pi:3.141592653589793,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,inv255:.003921569,golden:10.166407384630519,INF:1/0,NINF:-1/0,EPZ:1e-5,EPZ2:1e-6,EPSILON:.01,EPSILON_SQUARED:1e-4,Squared:function(t,e){return t*t+e*e},SquaredSqrt:function(t,e){return X.sqrt(t*t+e*e)},isFinite:function(t){return isFinite(t)},int:function(t){return Math.floor(t)},fix:function(t,e){return 1*t.toFixed(e||3)},lerp:function(t,e,s){return(1-s)*t+s*e},rand:function(t,e){return t+Math.random()*(e-t)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},nearEqual:function(t,e,s){return Math.abs(t-e)<s},generateUUID:function(){var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),i=0;return function(){for(var n=0;n<36;n++)8===n||13===n||18===n||23===n?s[n]="-":14===n?s[n]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),t=15&i,i>>=4,s[n]=e[19===n?3&t|8:t]);return s.join("")}}(),clamp:function(t,e,s){return X.max(e,X.min(s,t))},distance:function(t,e){var s=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2];return X.sqrt(s*s+i*i+n*n)},acosClamp:function(t){return t>1?0:t<-1?X.Pi:X.acos(t)},distanceVector:function(t,e){var s=t.x-e.x,i=t.y-e.y,n=t.z-e.z;return s*s+i*i+n*n},dotVectors:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}};i.prototype={constructor:i,set:function(t,e){return this.x=t,this.y=e,this},transform:function(t){return t.tranform(this),this},copy:function(t){return this.x=t.x,this.y=t.y,this},clone:function(){return new i(this.x,this.y)},sub:function(t){return this.x-=t.x,this.y-=t.y,this},mul:function(t){return this.x*=t,this.y*=t,this},add:function(t){return this.x+=t.x,this.y+=t.y,this},div:function(t){var e=1/t;return this.x*=e,this.y*=e,this},negate:function(){return new i(-this.x,-this.y)},transformMat2D:function(t){var e=this.x,s=this.y,i=t.n;return this.x=i[0]*e+i[2]*s+i[4],this.y=i[1]*e+i[3]*s+i[5],this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},angular:function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this},normalize:function(){var t=this.length();return this.x/=t,this.y/=t,t},distanceTo:function(t){var e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)},distanceSquaredTo:function(t){var e=this.x-t.x,s=this.y-t.y;return e*e+s*s},equals:function(t){return this.x===t.x&&this.y===t.y}},n.prototype={constructor:n,identity:function(){return this.n=[1,0,0,1,0,0],this},translate:function(t){var e=this.n;return e[4]+=t.x,e[5]+=t.y,this},scale:function(t){var e=this.n;return e[0]*=t.x,e[1]*=t.y,e[2]*=t.x,e[3]*=t.y,e[4]*=t.x,e[5]*=t.y,this},rotate:function(t){var e=this.n,s=e[0],i=e[1],n=e[2],r=e[3],o=e[4],h=e[5],a=Math.sin(t),u=Math.cos(t);return e[0]=s*u+i*a,e[1]=-s*a+i*u,e[2]=n*u+r*a,e[3]=-n*a+u*r,e[4]=u*o+a*h,e[5]=u*h-a*o,this},tranform:function(t){var e=this.n,s=e[0]*t.x+e[2]*t.y+e[4],i=e[1]*t.x+e[3]*t.y+e[5];t.x=s,t.y=i},transformX:function(t,e){var s=this.n;return s[0]*t+s[2]*e+s[4]},transformY:function(t,e){var s=this.n;return s[1]*t+s[3]*e+s[5]},concat:function(t){var e=this.n,s=t.n,i=e[0]*s[0]+e[1]*s[2],n=e[0]*s[1]+e[1]*s[3],r=e[2]*s[0]+e[3]*s[2],o=e[2]*s[1]+e[3]*s[3],h=e[4]*s[0]+e[5]*s[2]+s[4],a=e[4]*s[1]+e[5]*s[3]+s[5];return e[0]=i,e[1]=n,e[2]=r,e[3]=o,e[4]=h,e[5]=a,this},clone:function(){var t=this.n;return new n(t[0],t[1],t[2],t[3],t[4],t[5])}},r.prototype={constructor:r,reset:function(){this._currSeed=this._originalSeed,this._numIter=0},next:function(){var t=1*this._currSeed;for(this._tempString=(t*t).toString();this._tempString.length<8;)this._tempString="0"+this._tempString;this._currSeed=parseInt(this._tempString.substr(1,5));var e=Math.round(this.rangeMin+this._currSeed/99999*(this.rangeMax-this.rangeMin));return 0===this._currSeed&&(this._currSeed=this._originalSeed+this._numIter),200===++this._numIter&&this.reset(),e},nextInRange:function(t,e){return this.rangeMin=t,this.rangeMax=e,this.next()},shuffle:function(t){for(var e,s,i=t.length;i>0;)e=this.nextInRange(0,i-1),s=t[--i],t[i]=t[e],t[e]=s}},o.prototype={next:function(){return null!=this._nextEdge?(this._resultEdge=this._nextEdge,this._nextEdge=this._nextEdge.nextLeftEdge,this._nextEdge==this._fromFace.edge&&(this._nextEdge=null)):this._resultEdge=null,this._resultEdge}},h.prototype={next:function(){do{if(!(this._currIndex<this._fromMesh._vertices.length)){this._resultVertex=null;break}this._resultVertex=this._fromMesh._vertices[this._currIndex],this._currIndex++}while(!this._resultVertex.isReal);return this._resultVertex}},a.prototype={next:function(){if(null!=this._nextEdge){do{if(this._resultFace=this._nextEdge.leftFace,this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null,this._resultFace.isReal||(this._resultFace=null);break}}while(!this._resultFace.isReal)}else this._resultFace=null;return this._resultFace}},u.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge.oppositeEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}},d.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(this.realEdgesOnly&&!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}};var Q={__samples:[],__circumcenter:new i,_randGen:null,locatePosition:function(t,i){var n,h;for(null==Q._randGen&&(Q._randGen=new r),Q._randGen.seed=X.int(10*t.x+4*t.y),Q.__samples.splice(0,Q.__samples.length),h=X.int(X.pow(i._vertices.length,.333333334)),Q._randGen.rangeMin=0,Q._randGen.rangeMax=i._vertices.length-1,n=0;n<h;)Q.__samples.push(i._vertices[Q._randGen.next()]),n++;var u,d,l,c=X.INF,g=null;for(n=0;n<h;)d=(u=Q.__samples[n]).pos,(l=X.Squared(d.x-t.x,d.y-t.y))<c&&(c=l,g=u),n++;var p=new a;null===g&&e("no closedVertex find ?"),p.fromVertex=g;for(var f,x=p.next(),_=new s,y=new o,m=0,v=0,E=Q.isInFace(t,x);_.get(x)||3===E.type;){if(_.set(x,!0),50==++v&&e("WALK TAKE MORE THAN 50 LOOP"),1e3==v){e("WALK TAKE MORE THAN 1000 LOOP -> WE ESCAPE"),E={type:3};break}y.fromFace=x;do{if(null===(f=y.next()))return e("KILL PATH"),null;m=Q.getRelativePosition(t,f)}while(1==m||0==m);x=f.rightFace,E=Q.isInFace(t,x)}return _.dispose(),E},isCircleIntersectingAnyConstraint:function(t,e,i){if(t.x<=0||t.x>=i.width||t.y<=0||t.y>=i.height)return!0;var n,r=Q.locatePosition(t,i);switch(r.type){case 0:n=r.edge.leftFace;break;case 1:n=r.leftFace;break;case 2:n=r;break;case 3:n=null}var o,h=e*e;if(o=n.edge.originVertex.pos,X.Squared(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.originVertex.pos,X.Squared(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.nextLeftEdge.originVertex.pos,X.Squared(o.x-t.x,o.y-t.y)<=h)return!0;var a=[];a.push(n.edge),a.push(n.edge.nextLeftEdge),a.push(n.edge.nextLeftEdge.nextLeftEdge);for(var u,d,l,c=new s(0);a.length>0;)if(u=a.pop(),c.set(u,!0),d=u.originVertex.pos,l=u.destinationVertex.pos,Q.intersectionsSegmentCircle(d,l,t,e)){if(u.isConstrained)return!0;u=u.oppositeEdge.nextLeftEdge,c.get(u)||c.get(u.oppositeEdge)||-1!=a.indexOf(u)||-1!=a.indexOf(u.oppositeEdge)||a.push(u),u=u.nextLeftEdge,c.get(u)||c.get(u.oppositeEdge)||-1!=a.indexOf(u)||-1!=a.indexOf(u.oppositeEdge)||a.push(u)}return!1},getDirection:function(t,e,s){var i=(s.x-t.x)*(e.y-t.y)+(s.y-t.y)*(-e.x+t.x);return 0==i?0:i>0?1:-1},getRelativePosition:function(t,e){return Q.getDirection(e.originVertex.pos,e.destinationVertex.pos,t)},getRelativePosition2:function(t,e){return void 0===e?(console.log("error no eUp"),0):Q.Orient2d(e.originVertex.pos,e.destinationVertex.pos,t)},Orient2d:function(t,e,s){var i=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x);return i>-X.EPSILON_SQUARED&&i<X.EPSILON_SQUARED?0:i>0?-1:1},isInFace:function(t,e){var s={type:3};if(null===e)return s;var i=e.edge,n=i.nextLeftEdge,r=n.nextLeftEdge;if(Q.getRelativePosition(t,i)>=0&&Q.getRelativePosition(t,n)>=0&&Q.getRelativePosition(t,r)>=0){var o=i.originVertex,h=n.originVertex,a=r.originVertex,u=o.pos.x,d=o.pos.y,l=h.pos.x,c=h.pos.y,g=a.pos.x,p=a.pos.y,f=X.Squared(u-t.x,d-t.y),x=X.Squared(l-t.x,c-t.y),_=X.Squared(g-t.x,p-t.y),y=1/X.Squared(l-u,c-d),m=1/X.Squared(g-l,p-c),v=1/X.Squared(u-g,d-p),E=(t.x-u)*(l-u)+(t.y-d)*(c-d),w=(t.x-l)*(g-l)+(t.y-c)*(p-c),S=(t.x-g)*(u-g)+(t.y-p)*(d-p),C=x-w*w*m,P=_-S*S*v,F=f-E*E*y<=X.EPSILON_SQUARED,V=C<=X.EPSILON_SQUARED,b=P<=X.EPSILON_SQUARED;s=F?b?o:V?h:i:V?b?a:n:b?r:e}return s},clipSegmentByTriangle:function(t,e,s,i,n,r,o){var h=Q.getDirection(s,i,t),a=Q.getDirection(s,i,e);if(h<=0&&a<=0)return!1;var u=Q.getDirection(i,n,t),d=Q.getDirection(i,n,e);if(u<=0&&d<=0)return!1;var l=Q.getDirection(n,s,t),c=Q.getDirection(n,s,e);if(l<=0&&c<=0)return!1;if(h>=0&&u>=0&&l>=0&&a>=0&&d>=0&&c>=0)return r=t.clone(),o=e.clone(),!0;var g=0;return Q.intersections2segments(t,e,s,i,r,null)&&g++,0==g?Q.intersections2segments(t,e,i,n,r,null)&&g++:Q.intersections2segments(t,e,i,n,o,null)&&(-.01>r.x-o.x||r.x-o.x>X.EPSILON||-X.EPSILON>r.y-o.y||r.y-o.y>X.EPSILON)&&g++,0==g?Q.intersections2segments(t,e,n,s,r,null)&&g++:1==g&&Q.intersections2segments(t,e,n,s,o,null)&&(-X.EPSILON>r.x-o.x||r.x-o.x>X.EPSILON||-X.EPSILON>r.y-o.y||r.y-o.y>X.EPSILON)&&g++,1==g&&(h>=0&&u>=0&&l>=0?o=t.clone():a>=0&&d>=0&&c>=0?o=e.clone():g=0),g>0},isDelaunay:function(t){var e=t.originVertex,s=t.destinationVertex,i=t.nextLeftEdge.destinationVertex,n=t.nextRightEdge.destinationVertex;Q.getCircumcenter(i.pos,e.pos,s.pos,Q.__circumcenter);var r=(i.pos.x-Q.__circumcenter.x)*(i.pos.x-Q.__circumcenter.x)+(i.pos.y-Q.__circumcenter.y)*(i.pos.y-Q.__circumcenter.y);return(n.pos.x-Q.__circumcenter.x)*(n.pos.x-Q.__circumcenter.x)+(n.pos.y-Q.__circumcenter.y)*(n.pos.y-Q.__circumcenter.y)>=r},getCircumcenter:function(t,e,s,n){null==n&&(n=new i);var r=.5*(t.x+e.x),o=.5*(t.y+e.y),h=.5*(t.x+s.x),a=.5*(t.y+s.y),u=(r*(t.x-s.x)+(o-a)*(t.y-s.y)+h*(s.x-t.x))/(t.x*(s.y-e.y)+e.x*(t.y-s.y)+s.x*(e.y-t.y));return n.x=r+u*(e.y-t.y),n.y=o-u*(e.x-t.x),n},intersections2segments:function(t,e,s,i,n,r,o){null==o&&(o=!1);var h,a=0,u=0,d=(t.x-e.x)*(s.y-i.y)+(e.y-t.y)*(s.x-i.x);if(0==d)h=!1;else{h=!0;var l=1/d;o&&null==n&&null==r||(a=(t.x*(s.y-i.y)+t.y*(i.x-s.x)+s.x*i.y-s.y*i.x)*l,u=(t.x*(s.y-e.y)+t.y*(e.x-s.x)-e.x*s.y+e.y*s.x)*l,o||0<=a&&a<=1&&0<=u&&u<=1||(h=!1))}return h&&(null!=n&&(n.x=t.x+a*(e.x-t.x),n.y=t.y+a*(e.y-t.y)),null!=r&&r.push(a,u)),h},intersections2edges:function(t,e,s,i,n){return null==n&&(n=!1),Q.intersections2segments(t.originVertex.pos,t.destinationVertex.pos,e.originVertex.pos,e.destinationVertex.pos,s,i,n)},isConvex:function(t){var e,s,i=!0;return e=t.nextLeftEdge.oppositeEdge,s=t.nextRightEdge.destinationVertex,-1!=Q.getRelativePosition(s.pos,e)?i=!1:(e=t.prevRightEdge,s=t.prevLeftEdge.originVertex,-1!=Q.getRelativePosition(s.pos,e)&&(i=!1)),i},projectOrthogonaly:function(t,e){var s=e.originVertex.pos.x,i=e.originVertex.pos.y,n=e.destinationVertex.pos.x,r=e.destinationVertex.pos.y,o=t.x,h=t.y,a=(s*s-s*n-s*o+i*i-i*r-i*h+n*o+r*h)/(s*s-2*s*n+i*i-2*i*r+n*n+r*r);t.x=s+a*(n-s),t.y=i+a*(r-i)},intersections2Circles:function(t,e,s,i,n){var r,o,h,a,u,d,l;return u=X.Squared(s.x-t.x,s.y-t.y),d=1/(2*u),(t.x!=s.x||t.y!=s.y)&&u<=(e+i)*(e+i)&&u>=(e-i)*(e-i)&&(l=X.sqrt(((e+i)*(e+i)-u)*(u-(i-e)*(i-e))),r=s.clone().sub(t).mul(d),o=t.clone().add(s).mul(.5),h=r.clone().mul(e*e-i*i),a=o.clone().add(h),null!=n&&n.push(a.x+r.y*l,a.y-r.x*l,a.x-r.y*l,a.y+r.x*l),!0)},intersectionsSegmentCircle:function(t,e,s,i,n){var r,o,h,a=t.x*t.x,u=t.y*t.y,d=e.y*e.y-2*e.y*t.y+u+e.x*e.x-2*e.x*t.x+a,l=2*t.y*s.y-2*a+2*e.y*t.y-2*u+2*e.x*t.x-2*e.x*s.x+2*t.x*s.x-2*e.y*s.y,c=l*l-4*d*(u+s.y*s.y+s.x*s.x-2*t.y*s.y-2*t.x*s.x+a-i*i);if(c<0)return!1;if(0==c)return!((o=-l/(2*d))<0||o>1)&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),!0);h=(-l-(r=X.sqrt(c)))/(2*d);var g=!1;return 0<=(o=(-l+r)/(2*d))&&o<=1&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),g=!0),0<=h&&h<=1&&(null!=n&&n.push(t.x+h*(e.x-t.x),t.y+h*(e.y-t.y),h),g=!0),g},tangentsPointToCircle:function(t,e,s,i){var n=t.clone().add(e).mul(.5),r=.5*X.SquaredSqrt(t.x-e.x,t.y-e.y);return Q.intersections2Circles(n,r,e,s,i)},tangentsCrossCircleToCircle:function(t,e,s,i){var n=X.SquaredSqrt(e.x-s.x,e.y-s.y),r=.25*n,o=s.clone().sub(e).mul(.25).add(e);if(Q.intersections2Circles(e,t,o,r,i)){var h=i[0],a=i[1],u=i[2],d=i[3],l=e.clone().add(s).mul(.5),c=((h-l.x)*(s.y-e.y)+(a-l.y)*(-s.x+e.x))/(n*n),g=2*(l.x+c*(s.y-e.y))-h,p=2*(l.y-c*(s.x-e.x))-a,f=g+u-h,x=d+p-a;return i.push(f,x,g,p),!0}return!1},tangentsParalCircleToCircle:function(t,e,s,i){var n=1/X.SquaredSqrt(e.x-s.x,e.y-s.y),r=e.x+t*(s.y-e.y)*n,o=e.y+t*(-s.x+e.x)*n,h=2*e.x-r,a=2*e.y-o,u=h+s.x-e.x,d=a+s.y-e.y,l=r+s.x-e.x,c=o+s.y-e.y;i.push(r,o,h,a,u,d,l,c)},distanceSquaredPointToSegment:function(t,e,s){var i=X.Squared(s.x-e.x,s.y-e.y),n=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/i;return n<0?X.Squared(t.x-e.x,t.y-e.y):n<=1?X.Squared(e.x-t.x,e.y-t.y)-n*n*i:X.Squared(t.x-s.x,t.y-s.y)},distanceSquaredVertexToEdge:function(t,e){return Q.distanceSquaredPointToSegment(t.pos,e.originVertex.pos,e.destinationVertex.pos)},pathLength:function(t){for(var e,s,i,n,r=0,o=t[0],h=t[1],a=2,u=t.length;a<u;)i=(e=t[a])-o,n=(s=t[a+1])-h,r+=X.SquaredSqrt(i,n),o=e,h=s,a+=2;return r}},z=X.TwoPI;p.prototype={load:function(t){var e,s=window.document;(e=s.createElement("img")).style.cssText="position:absolute;",e.onload=function(){this.store(e,t.split("/").pop())}.bind(this),e.src=t},store:function(t,s){e("store "+s+" "+--this.count),this.images.set(s,t),0==this.count&&this.loaded()}},f.prototype={constructor:f,setDatas:function(t,e,s,i,n,r){this.isConstrained=void 0!==n&&r,this.isReal=void 0===n||n,this.originVertex=t,this.oppositeEdge=e,this.nextLeftEdge=s,this.leftFace=i},getDatas:function(){return[this.originVertex.pos.x,this.originVertex.pos.y,this.destinationVertex.pos.x,this.destinationVertex.pos.y,this.isConstrained?1:0]},addFromConstraintSegment:function(t){-1===this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!==e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,this.fromConstraintSegments=null},toString:function(){return"edge "+this.originVertex.id+" - "+this.destinationVertex.id}},x.prototype={constructor:x,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},dispose:function(){this.edge=null,this.isReal=!1}},_.prototype={constructor:_,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},addFromConstraintSegment:function(t){-1==this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!=e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.pos=null,this.edge=null,this.fromConstraintSegments=null},toString:function(){return"ver_id "+this.id}},y.prototype={constructor:y,dispose:function(){for(;this.segments.length>0;)this.segments.pop().dispose();this.segments=null}},m.prototype={constructor:m,addEdge:function(t){-1==this.edges.indexOf(t)&&-1==this.edges.indexOf(t.oppositeEdge)&&this.edges.push(t)},removeEdge:function(t){var e=this.edges.indexOf(t);-1==e&&(e=this.edges.indexOf(t.oppositeEdge)),-1!=e&&this.edges.splice(e,1)},dispose:function(){this.edges=null,this.fromShape=null},toString:function(){return"seg_id "+this.id}},v.prototype={constructor:v,position:function(t,e){this._position.set(t,e),this.hasChanged=!0},scale:function(t,e){this._scale.set(t,e),this.hasChanged=!0},pivot:function(t,e){this._pivot.set(t,e),this.hasChanged=!0},dispose:function(){this._matrix=null,this._coordinates=null,this._constraintShape=null},updateValuesFromMatrix:function(){},updateMatrixFromValues:function(){this._matrix.identity().translate(this._pivot.negate()).scale(this._scale).rotate(this._rotation).translate(this._position)}},E.prototype={constructor:E,dispose:function(){for(;null!=this.node;)this.deleteNode(this.node)},insertNode:function(){var t=new S;return null!=this.node&&(t.next=this.node,this.node.prev=t),this.node=t,t},deleteNode:function(t){for(;null!=t.outgoingEdge;)null!=t.outgoingEdge.oppositeEdge&&this.deleteEdge(t.outgoingEdge.oppositeEdge),this.deleteEdge(t.outgoingEdge);for(var e,s=this.node;null!=s;)null!=(e=s.successorNodes.get(t))&&this.deleteEdge(e),s=s.next;this.node==t?null!=t.next?(t.next.prev=null,this.node=t.next):this.node=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.dispose()},insertEdge:function(t,e){if(null!=t.successorNodes.get(e))return null;var s=new w;null!=this.edge&&(this.edge.prev=s,s.next=this.edge),this.edge=s,s.sourceNode=t,s.destinationNode=e,t.successorNodes.set(e,s),null!=t.outgoingEdge?(t.outgoingEdge.rotPrevEdge=s,s.rotNextEdge=t.outgoingEdge,t.outgoingEdge=s):t.outgoingEdge=s;var i=e.successorNodes.get(t);return null!=i&&(s.oppositeEdge=i,i.oppositeEdge=s),s},deleteEdge:function(t){this.edge==t?null!=t.next?(t.next.prev=null,this.edge=t.next):this.edge=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.sourceNode.outgoingEdge==t?null!=t.rotNextEdge?(t.rotNextEdge.rotPrevEdge=null,t.sourceNode.outgoingEdge=t.rotNextEdge):t.sourceNode.outgoingEdge=null:null!=t.rotNextEdge?(t.rotPrevEdge.rotNextEdge=t.rotNextEdge,t.rotNextEdge.rotPrevEdge=t.rotPrevEdge):t.rotPrevEdge.rotNextEdge=null,t.dispose()}},w.prototype={dispose:function(){this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}},S.prototype={dispose:function(){this.successorNodes.dispose(),this.prev=null,this.next=null,this.outgoingEdge=null,this.successorNodes=null,this.data=null}};var K={color:{r:255,g:255,b:255},nearly:50,maxDistance:1,setColor:function(t){K.color=t},setNearly:function(t){K.nearly=t},getWhite:function(t,e,s){var i=K.color,n=K.nearly,r=!1;if(e>t.width||e<0)return!1;if(s>t.height||s<0)return!1;var o=s*(4*t.width)+4*e,h=t.bytes[o+0],a=t.bytes[o+1],u=t.bytes[o+2],d=t.bytes[o+3];return void 0!==i.r&&X.nearEqual(h,i.r,n)&&(r=!0),void 0!==i.g&&X.nearEqual(a,i.g,n)&&(r=!0),void 0!==i.b&&X.nearEqual(u,i.b,n)&&(r=!0),void 0!==i.a&&X.nearEqual(d,i.a,n)&&(r=!0),r},buildShapes:function(t){for(var e=[],i=new s(2),n=t.height-1,r=t.width-1,o=1;o<n;o++)for(var h=0;h<r;h++)K.getWhite(t,h,o)&&!K.getWhite(t,h+1,o)&&(i.get(h+1+"_"+o)||e.push(K.buildShape(t,o,h+1,i)));return i.dispose(),e},buildShape:function(t,e,s,n){var r=s,o=e,h=[r,o];n.set(r+"_"+o,!0);t.width,t.height;for(var a,u,d=new i(0,1),l=new i,c=-1;;){if(a=e+d.x+d.y,u=s+d.x-d.y,K.getWhite(t,u,a)?(a=e+d.y,u=s+d.x,K.getWhite(t,u,a)?(a=e,u=s,l.x=d.y,l.y=-d.x):(l.x=d.x,l.y=d.y)):(l.x=-d.y,l.y=d.x),r+=d.x,o+=d.y,r===h[0]&&o===h[1])break;if(h.push(r),h.push(o),n.set(r+"_"+o,!0),e=a,s=u,d.x=l.x,d.y=l.y,0===--c)break}return h},buildGraph:function(t){var e,s,n=new E;for(e=0;e<t.length;)(s=n.insertNode()).data=new P,s.data.index=e,s.data.point=new i(t[e],t[e+1]),e+=2;var r,o,h,a,u,d,l,c,g=!1;for(r=n.node;null!=r;){for(o=null!=r.next?r.next:n.node;o!=r;){for(g=!0,h=null!=r.next?r.next:n.node,d=2,u=0;h!=o;){if((a=Q.distanceSquaredPointToSegment(h.data.point,r.data.point,o.data.point))<0&&(a=0),a>=K.maxDistance){g=!1;break}d++,u+=a,h=null!=h.next?h.next:n.node}if(!g)break;l=n.insertEdge(r,o),(c=new C).sumDistancesSquared=u,c.length=r.data.point.distanceTo(o.data.point),c.nodesCount=d,l.data=c,o=null!=o.next?o.next:n.node}r=r.next}return n},buildPolygon:function(t){var e,s,n,r,o,h,a,u=[],d=2147483647,l=null;for(r=t.node;r.data.index<d;){for(d=r.data.index,u.push(r.data.point.x),u.push(r.data.point.y),a=0,o=r.outgoingEdge;null!=o;)(h=o.data.nodesCount-o.data.length*X.sqrt(o.data.sumDistancesSquared/o.data.nodesCount))>a&&(a=h,l=o),o=o.rotNextEdge;r=l.destinationNode}return e=new i(u[u.length-2],u[u.length-1]),s=new i(u[0],u[1]),n=new i(u[2],u[3]),0==Q.getDirection(e,s,n)&&(u.shift(),u.shift()),u}};F.prototype={constructor:F,clear:function(t){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=[];this._edges.length>0;)this._edges.pop().dispose();for(this._edges=[];this._faces.length>0;)this._faces.pop().dispose();for(this._faces=[];this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();if(this._constraintShapes=[],!t)for(;this._objects.length>0;)this._objects.pop().dispose();this._objects=[],this.__edgesToCheck=[],this.__centerVertex=[],this.AR_vertex=null,this.AR_edge=null},dispose:function(){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=null;this._edges.length>0;)this._edges.pop().dispose();for(this._edges=null;this._faces.length>0;)this._faces.pop().dispose();for(this._faces=null;this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();for(this._constraintShapes=null;this._objects.length>0;)this._objects.pop().dispose();this._objects=null,this.__edgesToCheck=null,this.__centerVertex=null,this.AR_vertex=null,this.AR_edge=null},buildFromRecord:function(t){for(var e=t.split(";"),s=e.length,i=0;i<s;)this.insertConstraintSegment(parseFloat(e[i]),parseFloat(e[i+1]),parseFloat(e[i+2]),parseFloat(e[i+3])),i+=4},insertObject:function(t){null!=t.constraintShape&&this.deleteObject(t);var e,s=new y,r=t.coordinates;t.updateMatrixFromValues();var o=t.matrix||new n,h=new i,a=new i,u=r.length,d=0;for(d=0;d<u;d+=4)h.set(r[d],r[d+1]).transformMat2D(o),a.set(r[d+2],r[d+3]).transformMat2D(o),null!=(e=this.insertConstraintSegment(h.x,h.y,a.x,a.y))&&(e.fromShape=s,s.segments.push(e));this._constraintShapes.push(s),t.constraintShape=s,this.__objectsUpdateInProgress||this._objects.push(t)},deleteObject:function(t){if(null!=t.constraintShape&&(this.deleteConstraintShape(t.constraintShape),t.constraintShape=null,!this.__objectsUpdateInProgress)){var e=this._objects.indexOf(t);this._objects.splice(e,1)}},updateObjects:function(){this.__objectsUpdateInProgress=!0;for(var t,e=this._objects.length,s=0;s<e;)(t=this._objects[s]).hasChanged&&(this.deleteObject(t),this.insertObject(t),t.hasChanged=!1,this.isRedraw=!0),s++;this.__objectsUpdateInProgress=!1},insertConstraintShape:function(t){for(var e=new y,s=null,i=t.length,n=0;n<i;)null!=(s=this.insertConstraintSegment(t[n],t[n+1],t[n+2],t[n+3]))&&(s.fromShape=e,e.segments.push(s)),n+=4;return this._constraintShapes.push(e),e},deleteConstraintShape:function(t){for(var e=0,s=t.segments.length;e<s;)this.deleteConstraintSegment(t.segments[e]),e++;this._constraintShapes.splice(this._constraintShapes.indexOf(t),1),t.dispose()},insertConstraintSegment:function(t,e,s,n){var r=t,o=e,h=s,a=n;if(t>this.width&&s>this.width||t<0&&s<0||e>this.height&&n>this.height||e<0&&n<0)return null;var u=s-t,l=n-e,c=-X.INF,g=X.INF;if(0!=u){var p=(0-t)/u,x=(this.width-t)/u;c=X.max(c,X.min(p,x)),g=X.min(g,X.max(p,x))}if(0!=l){var _=(0-e)/l,y=(this.height-e)/l;c=X.max(c,X.min(_,y)),g=X.min(g,X.max(_,y))}if(!(g>=c))return null;g<1&&(h=u*g+t,a=l*g+e),c>0&&(r=u*c+t,o=l*c+e);var v=this.insertVertex(r,o);if(null==v)return null;var E=this.insertVertex(h,a);if(null==E)return null;if(v.id===E.id)return null;var w,S,C=new d,P=new m,F=new f,V=new f;F.setDatas(v,V,null,null,!0,!0),V.setDatas(E,F,null,null,!0,!0);var b,D,O,L=[],N=[],R=[],T={type:3},q=new i,I=!1;for(T=w=v,T=w;;)if(I=!1,0===T.type){for(w=T,C.fromVertex=w;null!=(S=C.next());){if(S.destinationVertex.id===E.id)return S.isConstrained||(S.isConstrained=!0,S.oppositeEdge.isConstrained=!0),S.addFromConstraintSegment(P),S.oppositeEdge.fromConstraintSegments=S.fromConstraintSegments,v.addFromConstraintSegment(P),E.addFromConstraintSegment(P),P.addEdge(S),P;if(Q.distanceSquaredVertexToEdge(S.destinationVertex,F)<=X.EPSILON_SQUARED){S.isConstrained||(S.isConstrained=!0,S.oppositeEdge.isConstrained=!0),S.addFromConstraintSegment(P),S.oppositeEdge.fromConstraintSegments=S.fromConstraintSegments,v.addFromConstraintSegment(P),P.addEdge(S),v=S.destinationVertex,F.originVertex=v,T=v,I=!0;break}}if(I)continue;for(C.fromVertex=w;null!=(S=C.next());)if(S=S.nextLeftEdge,Q.intersections2edges(S,F,q)){if(S.isConstrained){for(v=this.splitEdge(S,q.x,q.y),C.fromVertex=w;null!=(S=C.next());)if(S.destinationVertex.id===v.id){S.isConstrained=!0,S.oppositeEdge.isConstrained=!0,S.addFromConstraintSegment(P),S.oppositeEdge.fromConstraintSegments=S.fromConstraintSegments,P.addEdge(S);break}w.addFromConstraintSegment(P),F.originVertex=v,T=v}else L.push(S),N.unshift(S.nextLeftEdge),R.push(S.prevLeftEdge),T=S=S.oppositeEdge;break}}else if(1===T.type){if(S=T,(b=S.nextLeftEdge).destinationVertex.id===E.id)return N.unshift(b.nextLeftEdge),R.push(b),D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(E,D,null,null,!0,!0),N.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,N,R),P;if(Q.distanceSquaredVertexToEdge(b.destinationVertex,F)<=X.EPSILON_SQUARED)N.unshift(b.nextLeftEdge),R.push(b),D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(b.destinationVertex,D,null,null,!0,!0),N.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,N,R),L.splice(0,L.length),N.splice(0,N.length),R.splice(0,R.length),v=b.destinationVertex,F.originVertex=v,T=v;else if(Q.intersections2edges(b,F,q))if(b.isConstrained){for(w=this.splitEdge(b,q.x,q.y),C.fromVertex=w;null!=(S=C.next());)S.destinationVertex==N[0].originVertex&&N.unshift(S),S.destinationVertex==R[R.length-1].destinationVertex&&R.push(S.oppositeEdge);D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),N.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,N,R),L.splice(0,L.length),N.splice(0,N.length),R.splice(0,R.length),v=w,F.originVertex=v,T=v}else L.push(b),N.unshift(b.nextLeftEdge),T=S=b.oppositeEdge;else if(b=b.nextLeftEdge,Q.intersections2edges(b,F,q),b.isConstrained){for(w=this.splitEdge(b,q.x,q.y),C.fromVertex=w;null!=(S=C.next());)S.destinationVertex.id===N[0].originVertex.id&&N.unshift(S),S.destinationVertex.id===R[R.length-1].destinationVertex.id&&R.push(S.oppositeEdge);D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),N.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,N,R),L.splice(0,L.length),N.splice(0,N.length),R.splice(0,R.length),v=w,F.originVertex=v,T=v}else L.push(b),R.push(b.prevLeftEdge),T=S=b.oppositeEdge}return P},insertNewConstrainedEdge:function(t,e,s,i,n){this._edges.push(e),this._edges.push(e.oppositeEdge),e.addFromConstraintSegment(t),e.oppositeEdge.fromConstraintSegments=e.fromConstraintSegments,t.addEdge(e),e.originVertex.addFromConstraintSegment(t),e.destinationVertex.addFromConstraintSegment(t),this.untriangulate(s),this.triangulate(i,!0),this.triangulate(n,!0)},deleteConstraintSegment:function(t){for(var e,s=[],i=null,n=t.edges.length,r=0;r<n;)(i=t.edges[r]).removeFromConstraintSegment(t),0==i.fromConstraintSegments.length&&(i.isConstrained=!1,i.oppositeEdge.isConstrained=!1),(e=i.originVertex).removeFromConstraintSegment(t),s.push(e),r++;for((e=i.destinationVertex).removeFromConstraintSegment(t),s.push(e),n=s.length,r=0;r<n;)this.deleteVertex(s[r]),r++;t.dispose()},check:function(){for(var t=this._edges.length,s=0;s<t;){if(null==this._edges[s].nextLeftEdge)return void e("!!! missing nextLeftEdge");s++}e("check OK")},insertVertex:function(t,e){if(t<0||e<0||t>this.width||e>this.height)return null;this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var s=Q.locatePosition(new i(t,e),this),n=null;switch(s.type){case 0:n=s;break;case 1:var r=s;n=this.splitEdge(r,t,e);break;case 2:var o=s;n=this.splitFace(o,t,e)}return this.restoreAsDelaunay(),n},flipEdge:function(t){var e=t,s=t.oppositeEdge,i=new f,n=new f,r=e.nextLeftEdge,o=r.nextLeftEdge,h=s.nextLeftEdge,a=h.nextLeftEdge,u=e.originVertex,d=s.originVertex,l=o.originVertex,c=a.originVertex,g=e.leftFace,p=s.leftFace,_=new x,y=new x;return this._edges.push(i),this._edges.push(n),this._faces.push(y),this._faces.push(_),i.setDatas(l,n,a,y,t.isReal,t.isConstrained),n.setDatas(c,i,o,_,t.isReal,t.isConstrained),y.setDatas(i),_.setDatas(n),d.edge.id===s.id&&d.setDatas(r),u.edge.id===e.id&&u.setDatas(h),r.nextLeftEdge=i,r.leftFace=y,o.nextLeftEdge=h,o.leftFace=_,h.nextLeftEdge=n,h.leftFace=_,a.nextLeftEdge=r,a.leftFace=y,this._edges.splice(this._edges.indexOf(e),1),this._edges.splice(this._edges.indexOf(s),1),e.dispose(),s.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),n},splitEdge:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t,n=i.oppositeEdge,r=i.nextLeftEdge,o=r.nextLeftEdge,h=n.nextLeftEdge,a=h.nextLeftEdge,u=o.originVertex,d=i.originVertex,l=a.originVertex,c=n.originVertex,g=i.leftFace,p=n.leftFace;if((d.pos.x-e)*(d.pos.x-e)+(d.pos.y-s)*(d.pos.y-s)<=X.EPSILON_SQUARED)return d;if((c.pos.x-e)*(c.pos.x-e)+(c.pos.y-s)*(c.pos.y-s)<=X.EPSILON_SQUARED)return c;var y=new _,m=new f,v=new f,E=new f,w=new f,S=new f,C=new f,P=new f,F=new f,V=new x,b=new x,D=new x,O=new x;if(this._vertices.push(y),this._edges.push(v),this._edges.push(m),this._edges.push(C),this._edges.push(S),this._edges.push(w),this._edges.push(E),this._edges.push(F),this._edges.push(P),this._faces.push(O),this._faces.push(D),this._faces.push(b),this._faces.push(V),y.setDatas(g.isReal?v:w),y.pos.x=e,y.pos.y=s,Q.projectOrthogonaly(y.pos,i),v.setDatas(y,m,o,V,g.isReal),m.setDatas(u,v,F,O,g.isReal),C.setDatas(y,S,h,b,t.isReal,t.isConstrained),S.setDatas(d,C,v,V,t.isReal,t.isConstrained),w.setDatas(y,E,a,D,p.isReal),E.setDatas(l,w,C,b,p.isReal),F.setDatas(y,P,r,O,t.isReal,t.isConstrained),P.setDatas(c,F,w,D,t.isReal,t.isConstrained),V.setDatas(v,g.isReal),b.setDatas(C,p.isReal),D.setDatas(w,p.isReal),O.setDatas(F,g.isReal),d.edge.id===i.id&&d.setDatas(S),c.edge.id===n.id&&c.setDatas(P),o.nextLeftEdge=S,o.leftFace=V,h.nextLeftEdge=E,h.leftFace=b,a.nextLeftEdge=P,a.leftFace=D,r.nextLeftEdge=m,r.leftFace=O,i.isConstrained){var L=i.fromConstraintSegments;S.fromConstraintSegments=L.slice(0),C.fromConstraintSegments=S.fromConstraintSegments,F.fromConstraintSegments=L.slice(0),P.fromConstraintSegments=F.fromConstraintSegments;for(var N,R,T=i.fromConstraintSegments.length,q=0;q<T;)-1!=(R=(N=i.fromConstraintSegments[q].edges).indexOf(i))?N.splice(R,1,S,F):N.splice(N.indexOf(n),1,P,C),q++;y.fromConstraintSegments=L.slice(0)}return this._edges.splice(this._edges.indexOf(i),1),this._edges.splice(this._edges.indexOf(n),1),i.dispose(),n.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),this.__centerVertex=y,this.__edgesToCheck.push(o),this.__edgesToCheck.push(h),this.__edgesToCheck.push(a),this.__edgesToCheck.push(r),y},splitFace:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t.edge,n=i.nextLeftEdge,r=n.nextLeftEdge,o=i.originVertex,h=n.originVertex,a=r.originVertex,u=new _,d=new f,l=new f,c=new f,g=new f,p=new f,y=new f,m=new x,v=new x,E=new x;return this._vertices.push(u),this._edges.push(d),this._edges.push(l),this._edges.push(c),this._edges.push(g),this._edges.push(p),this._edges.push(y),this._faces.push(m),this._faces.push(v),this._faces.push(E),u.setDatas(l),u.pos.x=e,u.pos.y=s,d.setDatas(o,l,y,E),l.setDatas(u,d,i,m),c.setDatas(h,g,l,m),g.setDatas(u,c,n,v),p.setDatas(a,y,g,v),y.setDatas(u,p,r,E),m.setDatas(l),v.setDatas(g),E.setDatas(y),i.nextLeftEdge=c,i.leftFace=m,n.nextLeftEdge=p,n.leftFace=v,r.nextLeftEdge=d,r.leftFace=E,this._faces.splice(this._faces.indexOf(t),1),t.dispose(),this.__centerVertex=u,this.__edgesToCheck.push(i),this.__edgesToCheck.push(n),this.__edgesToCheck.push(r),u},restoreAsDelaunay:function(){for(var t;this.__edgesToCheck.length>0;)!(t=this.__edgesToCheck.shift()).isReal||t.isConstrained||Q.isDelaunay(t)||(t.nextLeftEdge.destinationVertex.id===this.__centerVertex.id?(this.__edgesToCheck.push(t.nextRightEdge),this.__edgesToCheck.push(t.prevRightEdge)):(this.__edgesToCheck.push(t.nextLeftEdge),this.__edgesToCheck.push(t.prevLeftEdge)),this.flipEdge(t))},deleteVertex:function(t){var e,s=new d;s.fromVertex=t,s.realEdgesOnly=!1;var i,n=[],r=[],o=!1,h=!1,a=[],u=[];if(e=0==t.fromConstraintSegments.length)for(;null!=(i=s.next());)n.push(i),r.push(i.nextLeftEdge);else{for(var l,c=0,g=t.fromConstraintSegments.length;c<g;){var p=c++;if((l=t.fromConstraintSegments[p].edges)[0].originVertex.id===t.id||l[l.length-1].destinationVertex.id===t.id)return!1}for(var x=0;null!=(i=s.next());)if(n.push(i),i.isConstrained&&++x>2)return!1;a=[],u=[];var _=null,y=null,m=new f,v=new f;this._edges.push(m),this._edges.push(v);for(var E=0,w=n.length;E<w;)(i=n[E++]).isConstrained?null==_?(v.setDatas(i.destinationVertex,m,null,null,!0,!0),a.push(m),a.push(i.nextLeftEdge),u.push(v),_=i):null==y&&(m.setDatas(i.destinationVertex,v,null,null,!0,!0),u.push(i.nextLeftEdge),y=i):null==_?u.push(i.nextLeftEdge):null==y?a.push(i.nextLeftEdge):u.push(i.nextLeftEdge);o=_.leftFace.isReal,h=y.leftFace.isReal,m.fromConstraintSegments=_.fromConstraintSegments.slice(0),v.fromConstraintSegments=m.fromConstraintSegments;for(var S,C=0,P=t.fromConstraintSegments.length;C<P;){var F=C++;-1!=(S=(l=t.fromConstraintSegments[F].edges).indexOf(_))?l.splice(S-1,2,m):l.splice(l.indexOf(y)-1,2,v)}}for(var V,b=0,D=n.length;b<D;)V=(i=n[b++]).leftFace,this._faces.splice(this._faces.indexOf(V),1),V.dispose(),i.destinationVertex.edge=i.nextLeftEdge,this._edges.splice(this._edges.indexOf(i.oppositeEdge),1),i.oppositeEdge.dispose(),this._edges.splice(this._edges.indexOf(i),1),i.dispose();return this._vertices.splice(this._vertices.indexOf(t),1),t.dispose(),e?this.triangulate(r,!0):(this.triangulate(a,o),this.triangulate(u,h)),!0},untriangulate:function(t){for(var e,i=new s(1),n=0,r=t.length;n<r;){var o=n++;e=t[o],null==i.get(e.originVertex)&&(e.originVertex.edge=e.prevLeftEdge.oppositeEdge,i.set(e.originVertex,!0)),null==i.get(e.destinationVertex)&&(e.destinationVertex.edge=e.nextLeftEdge,i.set(e.destinationVertex,!0)),this._faces.splice(this._faces.indexOf(e.leftFace),1),e.leftFace.dispose(),o==t.length-1&&(this._faces.splice(this._faces.indexOf(e.rightFace),1),e.rightFace.dispose())}i.dispose();for(var h=0,a=t.length;h<a;)e=t[h++],this._edges.splice(this._edges.indexOf(e.oppositeEdge),1),this._edges.splice(this._edges.indexOf(e),1),e.oppositeEdge.dispose(),e.dispose()},triangulate:function(t,s){if(t.length<2)e("BREAK ! the hole has less than 2 edges");else if(2!==t.length)if(3===t.length){var n=new x;n.setDatas(t[0],s),this._faces.push(n),t[0].leftFace=n,t[1].leftFace=n,t[2].leftFace=n,t[0].nextLeftEdge=t[1],t[1].nextLeftEdge=t[2],t[2].nextLeftEdge=t[0]}else{for(var r,o,h=t[0],a=h.originVertex,u=h.destinationVertex,d=new i,l=0,c=!1,g=0,p=2,_=t.length;p<_;){var y=p++;if(r=t[y].originVertex,1==Q.getRelativePosition2(r.pos,h)){g=y,c=!0,Q.getCircumcenter(a.pos,u.pos,r.pos,d),l=X.Squared(a.pos.x-d.x,a.pos.y-d.y),l-=X.EPSILON_SQUARED;for(var m=2,v=t.length;m<v;){var E=m++;if(E!=y&&(o=t[E].originVertex,X.Squared(o.pos.x-d.x,o.pos.y-d.y)<l)){c=!1;break}}if(c)break}}c||(e("NO DELAUNAY FOUND"),g=2);var w,S,C,P,F,V,b=[];g<t.length-1&&(w=new f,S=new f,this._edges.push(w,S),w.setDatas(a,S,null,null,s,!1),S.setDatas(t[g].originVertex,w,null,null,s,!1),(F=t.slice(g)).push(w),this.triangulate(F,s)),g>2&&(C=new f,P=new f,this._edges.push(C,P),C.setDatas(t[1].originVertex,P,null,null,s,!1),P.setDatas(t[g].originVertex,C,null,null,s,!1),(V=t.slice(1,g)).push(P),this.triangulate(V,s)),2===g?b.push(h,t[1],S):g===t.length-1?b.push(h,C,t[g]):b.push(h,C,S),this.triangulate(b,s)}else e("BREAK ! the hole has only 2 edges")},findPositionFromBounds:function(t,e){return t<=0?e<=0?1:e>=this.height?7:8:t>=this.width?e<=0?3:e>=this.height?5:4:e<=0?2:e>=this.height?6:0},compute_Data:function(){var t,e,i,n=[],r=[];(i=new h).fromMesh=this;var o;o=new u;for(var a=new s(1);null!=(t=i.next());)if(a.set(t,!0),this.vertexIsInsideAABB(t,this))for(n.push(t.pos.x,t.pos.y),o.fromVertex=t;null!=(e=o.next());)a.get(e.originVertex)||(r=r.concat(e.getDatas()));a.dispose(),this.AR_vertex=new X.ARRAY(n),this.AR_edge=new X.ARRAY(r),this.data_vertex=null,this.data_edges=null},vertexIsInsideAABB:function(t,e){return!(t.pos.x<0||t.pos.x>e.width||t.pos.y<0||t.pos.y>e.height)}},V.prototype={constructor:V,dispose:function(){this.mesh=null,this.closedFaces.dispose(),this.openedFaces.dispose(),this.entryEdges.dispose(),this.predecessor.dispose(),this.entryX.dispose(),this.entryY.dispose(),this.scoreF.dispose(),this.scoreG.dispose(),this.scoreH.dispose(),this.sortedOpenedFaces=null,this.closedFaces=null,this.openedFaces=null,this.entryEdges=null,this.entryX=null,this.entryY=null,this.scoreF=null,this.scoreG=null,this.scoreH=null,this.predecessor=null},findPath:function(t,n,r,o){this.sortedOpenedFaces=[],this.closedFaces=new s(1),this.openedFaces=new s(1),this.entryEdges=new s(1),this.predecessor=new s(1),this.entryX=new s(1),this.entryY=new s(1),this.scoreF=new s(1),this.scoreG=new s(1),this.scoreH=new s(1);var h;if(0!==(h=Q.locatePosition(t,this.mesh)).type){if(1===h.type){if(h.isConstrained)return;this.fromFace=h.leftFace}else 2===h.type&&(this.fromFace=h);0===(h=Q.locatePosition(n,this.mesh)).type?this.toFace=h.edge.leftFace:1===h.type?this.toFace=h.leftFace:2===h.type&&(this.toFace=h),this.sortedOpenedFaces.push(this.fromFace),this.entryEdges.set(this.fromFace,null),this.entryX.set(this.fromFace,t.x),this.entryY.set(this.fromFace,t.y),this.scoreG.set(this.fromFace,0);var a=X.SquaredSqrt(n.x-t.x,n.y-t.y);this.scoreH.set(this.fromFace,a),this.scoreF.set(this.fromFace,a);for(var u,d,l,c,g,p=new i,f=new i,x=new i,_=!1;;){if(0==this.sortedOpenedFaces.length){e("AStar no path found"),this.curFace=null;break}if(this.curFace=this.sortedOpenedFaces.pop(),this.curFace==this.toFace)break;for(this.iterEdge.fromFace=this.curFace;null!=(u=this.iterEdge.next());)if(!u.isConstrained&&(d=u.rightFace,!this.closedFaces.get(d))){if(this.curFace!=this.fromFace&&this._radius>0&&!this.isWalkableByRadius(this.entryEdges.get(this.curFace),this.curFace,u))continue;p.x=this.entryX.get(this.curFace),p.y=this.entryY.get(this.curFace),f.x=p.x,f.y=p.y,f.x=.5*(u.originVertex.pos.x+u.destinationVertex.pos.x),f.y=.5*(u.originVertex.pos.y+u.destinationVertex.pos.y),x.x=f.x-n.x,x.y=f.y-n.y,g=x.length(),x.x=p.x-f.x,x.y=p.y-f.y,l=g+(c=this.scoreG.get(this.curFace)+x.length()),_=!1,null!=this.openedFaces.get(d)&&this.openedFaces.get(d)?this.scoreF.get(d)>l&&(_=!0):(this.sortedOpenedFaces.push(d),this.openedFaces.set(d,!0),_=!0),_&&(this.entryEdges.set(d,u),this.entryX.set(d,f.x),this.entryY.set(d,f.y),this.scoreF.set(d,l),this.scoreG.set(d,c),this.scoreH.set(d,g),this.predecessor.set(d,this.curFace))}this.openedFaces.set(this.curFace,!1),this.closedFaces.set(this.curFace,!0),this.sortedOpenedFaces.sort(function(t,e){return this.scoreF.get(t)==this.scoreF.get(e)?0:this.scoreF.get(t)<this.scoreF.get(e)?1:-1}.bind(this))}if(null!=this.curFace)for(r.push(this.curFace);this.curFace!=this.fromFace;)o.unshift(this.entryEdges.get(this.curFace)),this.curFace=this.predecessor.get(this.curFace),r.unshift(this.curFace)}},isWalkableByRadius:function(t,e,n){var r=null,o=null,h=null;t.originVertex==n.originVertex?(r=t.destinationVertex,o=n.destinationVertex,h=t.originVertex):t.destinationVertex==n.destinationVertex?(r=t.originVertex,o=n.originVertex,h=t.destinationVertex):t.originVertex==n.destinationVertex?(r=t.destinationVertex,o=n.originVertex,h=t.originVertex):t.destinationVertex==n.originVertex&&(r=t.originVertex,o=n.destinationVertex,h=t.destinationVertex);var a;if((h.pos.x-r.pos.x)*(o.pos.x-r.pos.x)+(h.pos.y-r.pos.y)*(o.pos.y-r.pos.y)<=0)return X.Squared(h.pos.x-r.pos.x,h.pos.y-r.pos.y)>=this.diameterSquared;if((h.pos.x-o.pos.x)*(r.pos.x-o.pos.x)+(h.pos.y-o.pos.y)*(r.pos.y-o.pos.y)<=0)return X.Squared(h.pos.x-o.pos.x,h.pos.y-o.pos.y)>=this.diameterSquared;if((a=e.edge!=t&&e.edge.oppositeEdge!=t&&e.edge!=n&&e.edge.oppositeEdge!=n?e.edge:e.edge.nextLeftEdge!=t&&e.edge.nextLeftEdge.oppositeEdge!=t&&e.edge.nextLeftEdge!=n&&e.edge.nextLeftEdge.oppositeEdge!=n?e.edge.nextLeftEdge:e.edge.prevLeftEdge).isConstrained){var u=new i(h.pos.x,h.pos.y);return Q.projectOrthogonaly(u,a),X.Squared(u.x-h.pos.x,u.y-h.pos.y)>=this.diameterSquared}var d=X.Squared(h.pos.x-r.pos.x,h.pos.y-r.pos.y),l=X.Squared(h.pos.x-o.pos.x,h.pos.y-o.pos.y);if(d<this.diameterSquared||l<this.diameterSquared)return!1;var c=[],g=[],p=new s(1);if(g.push(a),a.leftFace==e){c.push(a.rightFace);var f=a.rightFace;p.set(f,!0)}else{c.push(a.leftFace);var x=a.leftFace;p.set(x,!0)}for(var _,y,m,v,E,w;c.length>0;){if(_=c.shift(),y=g.shift(),_.edge==y||_.edge==y.oppositeEdge?(m=_.edge.nextLeftEdge,E=_.edge.nextLeftEdge.nextLeftEdge):_.edge.nextLeftEdge==y||_.edge.nextLeftEdge==y.oppositeEdge?(m=_.edge,E=_.edge.nextLeftEdge.nextLeftEdge):(m=_.edge,E=_.edge.nextLeftEdge),v=m.leftFace==_?m.rightFace:m.leftFace,w=E.leftFace==_?E.rightFace:E.leftFace,!p.get(v)&&Q.distanceSquaredVertexToEdge(h,m)<this.diameterSquared){if(m.isConstrained)return!1;c.push(v),g.push(m),p.set(v,!0)}if(!p.get(w)&&Q.distanceSquaredVertexToEdge(h,E)<this.diameterSquared){if(E.isConstrained)return!1;c.push(w),g.push(E),p.set(w,!0)}}return p.dispose(),!0}},b.prototype={constructor:b,dispose:function(){this._sampleCircle=null},getPoint:function(t,e){return e=e||0,t=t||0,this.__point=this._poolPoints[this._currPoolPointsIndex],this.__point.set(t,e),++this._currPoolPointsIndex==this._poolPointsSize&&(this._poolPoints.push(new i),this._poolPointsSize++),this.__point},getCopyPoint:function(t){return this.getPoint(t.x,t.y)},findPath:function(t,i,n,r,o){var h=t,a=i,u=1.01*this._radius;if(this._currPoolPointsIndex=0,this._radius>0){var d,l,c,g,p,f=n[0];c=f.edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(d=X.Squared(c.x-h.x,c.y-h.y))<=this._radiusSquared?(l=X.sqrt(d),h.sub(c).div(l).mul(u).add(c)):(d=X.Squared(g.x-h.x,g.y-h.y))<=this._radiusSquared?(l=X.sqrt(d),h.sub(g).div(l).mul(u).add(g)):(d=X.Squared(p.x-h.x,p.y-h.y))<=this._radiusSquared&&(l=X.sqrt(d),h.sub(p).div(l).mul(u).add(p)),c=(f=n[n.length-1]).edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(d=X.Squared(c.x-a.x,c.y-a.y))<=this._radiusSquared?(l=X.sqrt(d),a.sub(c).div(l).mul(u).add(c)):(d=X.Squared(g.x-a.x,g.y-a.y))<=this._radiusSquared?(l=X.sqrt(d),a.sub(g).div(l).mul(u).add(g)):(d=X.Squared(p.x-a.x,p.y-a.y))<=this._radiusSquared&&(l=X.sqrt(d),a.sub(p).div(l).mul(u).add(p))}var x,_;if(x=h.clone(),_=a.clone(),1==n.length)return o.push(X.fix(x.x)),o.push(X.fix(x.y)),o.push(X.fix(_.x)),void o.push(X.fix(_.y));var y,m,v,E,w,S=null,C=null,P=Q.isInFace(h,n[0]);P.type===G&&r[0]===P&&(r.length>1&&r.shift(),n.length>1&&n.shift(),console.log("isShift",P,r,n));var F=[],V=[];F.push(x),V.push(x);var b=new s(1),D=[],O=new s(0),L=new s(0);O.set(x,0),S=r[0];var N,R,T,q=Q.getRelativePosition2(h,S);R=this.getCopyPoint(S.destinationVertex.pos),T=this.getCopyPoint(S.originVertex.pos),D.push(R),D.push(T),L.set(x,R),L.set(R,T),N=T,1==q?(O.set(R,1),O.set(T,-1),b.set(S.destinationVertex,1),b.set(S.originVertex,-1)):-1==q&&(O.set(R,-1),O.set(T,1),b.set(S.destinationVertex,-1),b.set(S.originVertex,1));for(var I=r[0].originVertex,j=r[0].destinationVertex,M=1,k=r.length;M<k;)(S=r[M++]).originVertex==I?C=S.destinationVertex:S.destinationVertex==I?C=S.originVertex:S.originVertex==j?(C=S.destinationVertex,I=j):S.destinationVertex==j?(C=S.originVertex,I=j):e("IMPOSSIBLE TO IDENTIFY THE VERTEX !!!"),R=this.getCopyPoint(C.pos),D.push(R),w=-b.get(I),O.set(R,w),L.set(N,R),b.set(C,w),N=R,j=I,I=C;L.set(N,_),O.set(_,0);var A=[],B=new s(1);A.push(x),B.set(x,0);for(var W,Y=0,H=D.length;Y<H;)if(W=D[Y++],-1==O.get(W)){for(m=F.length-2;m>=0;){if(-1!=(w=Q.getDirection(F[m],F[m+1],W))){F.shift();for(var U=0;U<m;){U++;A.push(F[0]),B.set(F[0],1),F.shift()}A.push(F[0]),B.set(F[0],1),V.splice(0,V.length),V.push(F[0]),V.push(W);break}m--}for(V.push(W),m=V.length-3;m>=0&&-1!=(w=Q.getDirection(V[m],V[m+1],W));)V.splice(m+1,1),m--}else{for(m=V.length-2;m>=0;){if(1!=(w=Q.getDirection(V[m],V[m+1],W))){V.shift();for(var z=0;z<m;){z++;A.push(V[0]),B.set(V[0],-1),V.shift()}A.push(V[0]),B.set(V[0],-1),F.splice(0,F.length),F.push(V[0]),F.push(W);break}m--}for(F.push(W),m=F.length-3;m>=0&&1!=(w=Q.getDirection(F[m],F[m+1],W));)F.splice(m+1,1),m--}var K=!1;for(m=V.length-2;m>=0;){if(1!=(w=Q.getDirection(V[m],V[m+1],a))){V.shift();for(var Z=0,J=m+1;Z<J;){Z++;A.push(V[0]),B.set(V[0],-1),V.shift()}A.push(_),B.set(_,0),K=!0;break}m--}if(!K)for(m=F.length-2;m>=0;){if(-1!=(w=Q.getDirection(F[m],F[m+1],a))){F.shift();for(var $=0,tt=m+1;$<tt;){$++;A.push(F[0]),B.set(F[0],1),F.shift()}A.push(_),B.set(_,0),K=!0;break}m--}K||(A.push(_),B.set(_,0),K=!0);var et=[];if(this._radius>0){var st=[];if(2==A.length)this.adjustWithTangents(A[0],!1,A[1],!1,O,L,st,et);else if(A.length>2){if(this.adjustWithTangents(A[0],!1,A[1],!0,O,L,st,et),A.length>3)for(var it=1,nt=A.length-3+1;it<nt;){var rt=it++;this.adjustWithTangents(A[rt],!0,A[rt+1],!0,O,L,st,et)}var ot=A.length;this.adjustWithTangents(A[ot-2],!0,A[ot-1],!1,O,L,st,et)}st.push(_),this.checkAdjustedPath(st,et,O);var ht=[];for(y=st.length-2;y>=1;){for(this.smoothAngle(et[2*y-1],st[y],et[2*y],O.get(st[y]),ht);0!=ht.length;)et.splice(2*y,0,ht.pop());y--}}else et=A;for(E=0,v=et.length;E<v;)y=E++,o.push(X.fix(et[y].x)),o.push(X.fix(et[y].y))},adjustWithTangents:function(t,s,i,n,r,o,h,a){var u=[],d=r.get(t),l=r.get(i),c=null,g=null;if(s||n)if(s)if(n)if(1==d&&1==l)Q.tangentsParalCircleToCircle(this._radius,t,i,u),c=this.getPoint(u[2],u[3]),g=this.getPoint(u[4],u[5]);else if(-1==d&&-1==l)Q.tangentsParalCircleToCircle(this._radius,t,i,u),c=this.getPoint(u[0],u[1]),g=this.getPoint(u[6],u[7]);else if(1==d&&-1==l){if(!Q.tangentsCrossCircleToCircle(this._radius,t,i,u))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(u[2],u[3]),g=this.getPoint(u[6],u[7])}else{if(!Q.tangentsCrossCircleToCircle(this._radius,t,i,u))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(u[0],u[1]),g=this.getPoint(u[4],u[5])}else{if(!Q.tangentsPointToCircle(i,t,this._radius,u))return void e("NO TANGENT");u.length>0&&(1==d?(c=this.getPoint(u[0],u[1]),g=i):(c=this.getPoint(u[2],u[3]),g=i))}else{if(!Q.tangentsPointToCircle(t,i,this._radius,u))return void e("NO TANGENT");1==l?(c=t,g=this.getPoint(u[2],u[3])):(c=t,g=this.getPoint(u[0],u[1]))}else c=t,g=i;for(var p=o.get(t);p!=i;){if(Q.distanceSquaredPointToSegment(p,c,g)<this._radiusSquared)return this.adjustWithTangents(t,s,p,!0,r,o,h,a),void this.adjustWithTangents(p,!0,i,n,r,o,h,a);p=o.get(p)}a.push(c),a.push(g),h.push(t)},checkAdjustedPath:function(t,e,s){for(var i,n,r,o,h,a,u,d,l,c=!0,g=[],p=null,f=null;c;){c=!1;for(var x=2;x<t.length;)h=t[x],a=s.get(h),r=t[x-1],o=s.get(r),i=t[x-2],n=s.get(i),o==a&&(u=e[2*(x-2)],d=e[2*(x-1)-1],l=e[2*(x-1)],(u.x-d.x)*(l.x-d.x)+(u.y-d.y)*(l.y-d.y)>0&&(2==x?(Q.tangentsPointToCircle(i,h,this._radius,g),1==a?(p=i,f=this.getPoint(g[2],g[3])):(p=i,f=this.getPoint(g[0],g[1]))):x==t.length-1?(Q.tangentsPointToCircle(h,i,this._radius,g),1==n?(p=this.getPoint(g[0],g[1]),f=h):(p=this.getPoint(g[2],g[3]),f=h)):1==n&&-1==a?(Q.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[6],g[7])):-1==n&&1==a?(Q.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[4],g[5])):1==n&&1==a?(Q.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[4],g[5])):-1==n&&-1==a&&(Q.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[6],g[7])),e.splice(2*(x-2),1,p),e.splice(2*x-1,1,f),t.splice(x-1,1),e.splice(2*(x-1)-1,2),g.splice(0,g.length),x--)),x++}},smoothAngle:function(t,e,s,i,n){var r=Q.getDirection(t,e,s);if(!(X.Squared(t.x-s.x,t.y-s.y)<=this._sampleCircleDistanceSquared)){for(var o,h,a,u,d=0,l=0,c=this._numSamplesCircle;l<c;){var g=l++;a=!1,u=e.clone().add(this._sampleCircle[g]),o=Q.getDirection(t,e,u),h=Q.getDirection(e,s,u),1==i?-1==r?-1==o&&-1==h&&(a=!0):-1!=o&&-1!=h||(a=!0):1==r?1==o&&1==h&&(a=!0):1!=o&&1!=h||(a=!0),a?(n.splice(d,0,u),d++):d=0}-1==i&&n.reverse()}}},D.prototype={constructor:D,dispose:function(){this._mesh=null,this.astar.dispose(),this.astar=null,this.funnel.dispose(),this.funnel=null,this.listEdges=null,this.listFaces=null},findPath:function(t,s){if(s.splice(0,s.length),!Q.isCircleIntersectingAnyConstraint(t,this.entity.radius,this._mesh)){this.astar.radius=this.entity.radius,this.funnel.radius=this.entity.radius,this.listFaces.splice(0,this.listFaces.length),this.listEdges.splice(0,this.listEdges.length);var i=this.entity.position;this.astar.findPath(i,t,this.listFaces,this.listEdges),0!=this.listFaces.length?this.funnel.findPath(i,t,this.listFaces,this.listEdges,s):e("PathFinder listFaces.length == 0")}}},O.prototype={constructor:O,reset:function(){this.count=0,this._currentX=this._path[this.count],this._currentY=this._path[this.count+1],this.updateEntity(),this.hasPrev=!1,this._path.length>2?this.hasNext=!0:this.hasNext=!1},prev:function(){return!!this.hasPrev&&(this.hasNext=!0,this.count--,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),0==this.count&&(this.hasPrev=!1),!0)},next:function(){return!!this.hasNext&&(this.hasPrev=!0,this.count++,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),2*(this.count+1)==this._path.length&&(this.hasNext=!1),!0)},updateEntity:function(){this.entity&&(this.entity.x=this._currentX,this.entity.y=this._currentY)}},L.prototype={constructor:L,dispose:function(){this.entity=null,this._path=null,this._preCompX=null,this._preCompY=null},reset:function(){this._path.length>0?(this.pos.x=this._path[0],this.pos.y=this._path[1],this._iPrev=0,this._iNext=2,this.hasPrev=!1,this.hasNext=!0,this._count=0,this.updateEntity()):(this.hasPrev=!1,this.hasNext=!1,this._count=0)},preCompute:function(){for(this._preCompX.splice(0,this._preCompX.length),this._preCompY.splice(0,this._preCompY.length),this._count=0,this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y),this._preComputed=!1;this.next();)this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y);this.reset(),this._preComputed=!0},prev:function(){if(!this.hasPrev)return!1;if(this.hasNext=!0,this._preComputed)return 0==--this._count&&(this.hasPrev=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iPrev],i=this._path[this._iPrev+1];if(!((e=X.SquaredSqrt(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this._iPrev-=2,this._iNext-=2,0==this._iNext)break}return 0==this._iNext?(this.pos.x=this._path[0],this.pos.y=this._path[1],this.hasPrev=!1,this._iNext=2,this._iPrev=0,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iPrev]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iPrev+1]-this.pos.y)*t/e,this.updateEntity(),!0)},next:function(){if(!this.hasNext)return!1;if(this.hasPrev=!0,this._preComputed)return++this._count==this._preCompX.length-1&&(this.hasNext=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iNext],i=this._path[this._iNext+1];if(!((e=X.SquaredSqrt(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this.pos.x=this._path[this._iNext],this.pos.y=this._path[this._iNext+1],this._iPrev+=2,this._iNext+=2,this._iNext==this._path.length)break}return this._iNext==this._path.length?(this.pos.x=this._path[this._iPrev],this.pos.y=this._path[this._iPrev+1],this.hasNext=!1,this._iNext=this._path.length-2,this._iPrev=this._iNext-2,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iNext]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iNext+1]-this.pos.y)*t/e,this.updateEntity(),!0)},applyLast:function(){this.pos.set(this._preCompX[this._count],this._preCompY[this._count])},updateEntity:function(){null!=this.entity&&(this.entity.angle=X.atan2(this.pos.y-this.entity.position.y,this.pos.x-this.entity.position.x),this.entity.direction.angular(this.entity.angle),this.entity.position.copy(this.pos))}},N.prototype={constructor:N,isInField:function(t){if(this.world&&this.entity){this.mesh=this.world.getMesh();var e=this.entity.position,n=this.entity.direction,r=t.position,o=this.entity.radiusFOV,h=this.entity.angleFOV,a=t.radius;if(X.Squared(e.x-r.x,e.y-r.y)>=(o+a)*(o+a))return!1;var u,d,l=new i,c=new i,g=[];Q.intersections2Circles(e,o,r,a,g)&&(l.set(g[0],g[1]),c.set(g[2],g[3]));var p=e.clone().add(r).mul(.5);(0==g.length||X.Squared(p.x-r.x,p.y-r.y)<X.Squared(p.x-l.x,p.y-l.y))&&(g.splice(0,g.length),Q.tangentsPointToCircle(e,r,a,g),l.set(g[0],g[1]),c.set(g[2],g[3]));var f=Math.cos(.5*this.entity.angleFOV),x=l.clone().sub(e),_=Math.sqrt(x.x*x.x+x.y*x.y);u=x.x/_*n.x+x.y/_*n.y>f;var y=c.clone().sub(e),m=Math.sqrt(y.x*y.x+y.y*y.y);if(d=y.x/m*n.x+y.y/m*n.y>f,!u&&!d){var v=e.clone().add(n);if(1!==Q.getDirection(e,v,l)||-1!==Q.getDirection(e,v,c))return!1}if(!u||!d){var E,w=new i;if(E=X.atan2(n.y,n.x),!u){var S=new i(X.cos(E-.5*h),X.sin(E-.5*h)).add(e);Q.intersections2segments(e,S,l,c,w,null,!0),l=w.clone()}if(!d){var C=new i(X.cos(E+.5*h),X.sin(E+.5*h)).add(e);Q.intersections2segments(e,C,l,c,w,null,!0),c=w.clone()}}var P,F=new s,V=new s,b=[],D=Q.locatePosition(e,this.mesh);2==D.type?P=D:1==D.type?P=D.leftFace:0==D.type&&(P=D.edge.leftFace);var O=[],L=new s;O.push(P),L[P]=!0;for(var N,R,T,q,I,j,M,k,A,B=new i,W=new i,G=[],Y=[];O.length>0;)for(N=O.shift(),L.set(N,null),F.set(N,!0),R=N.edge,V.get(R)||V.get(R.oppositeEdge)||(Y.push(R),V.set(R,!0)),R=R.nextLeftEdge,V.get(R)||V.get(R.oppositeEdge)||(Y.push(R),V.set(R,!0)),R=R.nextLeftEdge,V.get(R)||V.get(R.oppositeEdge)||(Y.push(R),V.set(R,!0));Y.length>0;)if(R=Y.pop(),T=R.originVertex.pos,q=R.destinationVertex.pos,Q.clipSegmentByTriangle(T,q,e,c,l,B,W)){if(R.isConstrained){for(G.splice(0,G.length),Q.intersections2segments(e,B,l,c,null,G,!0),Q.intersections2segments(e,W,l,c,null,G,!0),I=G[1],(j=G[3])<I&&(I=j,j=G[1]),M=b.length-1;M>=0&&!(j>=b[M]);M--);for((A=M+1)%2==0&&b.splice(A,0,j),M=0;M<b.length&&!(I<=b[M]);M++);if((k=M)%2==0?(b.splice(k,0,I),A++):k--,b.splice(k+1,A-k-1),2==b.length&&-X.EPSILON<b[0]&&b[0]<X.EPSILON&&1-X.EPSILON<b[1]&&b[1]<1+X.EPSILON)return!1}N=R.rightFace,L.get(N)||F.get(N)||(O.push(N),L.set(N,!0))}return!0}}},R.prototype={constructor:R,setTarget:function(t,e){this.path=[],this.target.set(t,e),this.world.pathFinder.entity=this,this.world.pathFinder.findPath(this.target,this.path),this.testPath()},testPath:function(){if(this.path&&this.path.length>0){this.pathSampler.reset(),this.tmppath=[];for(var t=this.path.length;t--;)this.tmppath[t]=this.path[t];this.pathSampler.path=this.tmppath,this.newPath=!0}},getPos:function(){return{x:this.position.x,y:this.position.y,r:-this.angle}},update:function(){var t;this.pathSampler.hasNext?(this.newPath=!1,this.isMove=!0,this.pathSampler.next()):(this.isMove=!1,this.tmppath=[]),this.isMove&&!this.isWalking&&(this.isWalking=!0),!this.isMove&&this.isWalking&&(this.isWalking=!1),null!==this.mesh&&(t=this.getPos(),this.mesh.position.set(t.x,0,t.y),this.mesh.rotation.y=t.r)}};var Z={};Z.buildFromBmpData=function(t,e,s){void 0!==s&&K.setColor(s),e=e||1;var i,n=K.buildShapes(t);if(e>=1)for(var r=0,o=n.length;r<o;){var h=r++;n[h]=l(n[h],e)}for(var a=[],u=0,d=n.length;u<d;){var c=u++;a.push(K.buildGraph(n[c]))}for(var g=[],p=0,f=a.length;p<f;){var x=p++;g.push(K.buildPolygon(a[x]))}for(var _=new v,y=0,m=g.length;y<m;){var E=y++;for(i=0;i<g[E].length-2;)_.coordinates.push(g[E][i]),_.coordinates.push(g[E][i+1]),_.coordinates.push(g[E][i+2]),_.coordinates.push(g[E][i+3]),i+=2;_.coordinates.push(g[E][0]),_.coordinates.push(g[E][1]),_.coordinates.push(g[E][i]),_.coordinates.push(g[E][i+1])}return _},q.prototype={constructor:q,getMesh:function(){return this.mesh},update:function(){for(var t,e,s=this.heroes.length,i=s;i--;)if((e=this.heroes[i]).update(),e.testSee)for(t=s;t--;)i!==t&&(this.heroes[i].isSee=this.heroes[i].fov.isInField(this.heroes[t]))},updateMesh:function(){this.mesh.updateObjects()},add:function(t){this.mesh.insertObject(t),this.objects.push(t)},addHeroe:function(t){var e=new R(t,this);return this.heroes.push(e),e},addObject:function(t){t=t||{};var e=new v;return e.coordinates=t.coord||[-1,-1,1,-1,1,-1,1,1,1,1,-1,1,-1,1,-1,-1],e.position(t.x||1,t.y||1),e.scale(t.w||1,t.h||1),e.pivot(t.px||0,t.py||0),e.rotation=t.r||0,this.mesh.insertObject(e),this.objects.push(e),e},reset:function(t,e){this.mesh.dispose(),t&&(this.w=t),e&&(this.h=e),this.mesh=T(this.w,this.h),this.pathFinder.mesh=this.mesh},rebuild:function(t){this.mesh.clear(!0),this.mesh=void 0!==t?t:T(this.w,this.h),this.pathFinder.mesh=this.mesh;for(var e=this.objects.length;e--;)this.objects[e]._constraintShape=null,this.mesh.insertObject(this.objects[e])},addBitmapZone:function(t){if((t=t||{}).url){var e=document.createElement("img");e.onload=function(){t.pixel=g(e),t.w=e.width,t.h=e.height,this.updateBitmapZone(t)}.bind(this),e.src=t.url}t.canvas&&(t.w=t.canvas.width,t.h=t.canvas.height,t.pixel=g(null,t.canvas.getContext("2d").getImageData(0,0,t.w,t.h)),this.updateBitmapZone(t)),t.img&&(t.w=t.img.width,t.h=t.img.height,t.pixel=g(t.img),this.updateBitmapZone(t))},updateBitmapZone:function(t){t=t||{};var e=Z.buildFromBmpData(t.pixel,t.precision||1.8,t.color,t.revers);this.reset(t.w,t.h),this.mesh.insertObject(e);var s=H.get();s&&s.drawMesh(this.mesh)}};var J={};J.buildFromBmpData=function(t,e){e=e||1;var s,i=K.buildShapes(t);if(e>=1)for(var n=0,r=i.length;n<r;){var o=n++;i[o]=l(i[o],e)}for(var h=[],a=0,u=i.length;a<u;){var d=a++;h.push(K.buildGraph(i[d]))}for(var c=[],g=0,p=h.length;g<p;){var f=g++;c.push(K.buildPolygon(h[f]))}for(var x=T(t.width,t.height),_=0,y=c.length;_<y;){var m=_++;for(s=0;s<c[m].length-2;)x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3]),s+=2;x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3])}return x},j.prototype={constructor:j,generate:function(t,e,s,i){this.tileWidth=t/s|0,this.tileHeight=e/i|0,this.cols=s,this.rows=i,this.rng=new r(X.randInt(1234,7259)),this.makeGrid(),this.traverseGrid(),this.populateObject()},makeGrid:function(){this.grid=[];for(var t=0,e=this.cols;t<e;){var s=t++;this.grid[s]=[];for(var i=0,n=this.rows;i<n;){var r=i++,o=new I(s,r);this.grid[s][r]=o;var h=[s*this.tileWidth,r*this.tileHeight],a=[(s+1)*this.tileWidth,r*this.tileHeight],u=[s*this.tileWidth,(r+1)*this.tileHeight],d=[(s+1)*this.tileWidth,(r+1)*this.tileHeight];o.walls[0]=h.concat(a),o.walls[1]=a.concat(d),o.walls[2]=u.concat(d),0==r&&0==s||(o.walls[3]=h.concat(u))}}},traverseGrid:function(){for(var t=[0,1,0,-1],e=[-1,0,1,0],s=[2,3,0,1],i=this.rng.nextInRange(0,this.cols-1),n=this.rng.nextInRange(0,this.rows-1),r=[this.grid[i][n]];r.length>0;){var o=r.length-1,h=r[o];h.visited=!0;var a=[0,1,2,3];this.rng.shuffle(a);for(var u=0;u<a.length;){var d=a[u];++u;var l=h.col+t[d],c=h.row+e[d];if(l>=0&&l<this.cols&&c>=0&&c<this.rows&&!this.grid[l][c].visited){var g=this.grid[l][c];h.walls[d]=[],g.walls[s[d]]=[],g.visited=!0,r.push(g),o=-1;break}}o>=0&&r.splice(o,1)}},populateObject:function(){this.object=new v;for(var t=[],e=0,s=this.cols;e<s;)for(var i=e++,n=0,r=this.rows;n<r;)for(var o=n++,h=0,a=this.grid[i][o].walls;h<a.length;){var u=a[h];++h;for(var d=0;d<u.length;){var l=u[d];++d,t.push(l)}}this.object.coordinates=t}},M.prototype={constructor:M,generate:function(t,e,s,i){this.w=t/10,this.h=e/10,this.rooms=[],this.map=[];for(g=0;g<this.w;g++){this.map[g]=[];for(p=0;p<this.h;p++)this.map[g][p]=0}for(var n=X.randInt(10,20),r=s||5,o=i||15,h=0;h<n;h++)(c={}).x=X.randInt(1,this.w-o-1),c.y=X.randInt(1,this.h-o-1),c.w=X.randInt(r,o),c.h=X.randInt(r,o),this.DoesCollide(c)?h--:(c.w--,c.h--,this.rooms.push(c));for(this.SquashRooms(),h=0;h<n;h++)for(var a=this.rooms[h],u=this.FindClosestRoom(a),d={x:X.randInt(a.x,a.x+a.w),y:X.randInt(a.y,a.y+a.h)},l={x:X.randInt(u.x,u.x+u.w),y:X.randInt(u.y,u.y+u.h)};l.x!=d.x||l.y!=d.y;)l.x!=d.x?l.x>d.x?l.x--:l.x++:l.y!=d.y&&(l.y>d.y?l.y--:l.y++),this.map[l.x][l.y]=1;for(h=0;h<n;h++)for(var c=this.rooms[h],g=c.x;g<c.x+c.w;g++)for(p=c.y;p<c.y+c.h;p++)this.map[g][p]=1;for(g=0;g<this.w;g++)for(var p=0;p<this.h;p++)if(1==this.map[g][p])for(var f=g-1;f<=g+1;f++)for(var x=p-1;x<=p+1;x++)0==this.map[f][x]&&(this.map[f][x]=2);this.populateObject()},FindClosestRoom:function(t){for(var e={x:t.x+t.w/2,y:t.y+t.h/2},s=null,i=1e3,n=0;n<this.rooms.length;n++){var r=this.rooms[n];if(r!=t){var o={x:r.x+r.w/2,y:r.y+r.h/2},h=Math.min(Math.abs(e.x-o.x)-t.w/2-r.w/2,Math.abs(e.y-o.y)-t.h/2-r.h/2);h<i&&(i=h,s=r)}}return s},SquashRooms:function(){for(var t=0;t<10;t++)for(var e=0;e<this.rooms.length;e++)for(var s=this.rooms[e];;){var i={x:s.x,y:s.y};if(s.x>1&&s.x--,s.y>1&&s.y--,1==s.x&&1==s.y)break;if(this.DoesCollide(s,e)){s.x=i.x,s.y=i.y;break}}},DoesCollide:function(t,e){for(var s=0;s<this.rooms.length;s++)if(s!=e){var i=this.rooms[s];if(!(t.x+t.w<i.x||t.x>i.x+i.w||t.y+t.h<i.y||t.y>i.y+i.h))return!0}return!1},populateObject:function(){var t=document.createElement("canvas");t.width=10*this.w,t.height=10*this.h;var e=t.getContext("2d");e.fillStyle="#FFF",e.fillRect(0,0,t.width,t.height);for(var s=0;s<this.h;s++)for(var i=0;i<this.w;i++){var n=this.map[i][s];e.fillStyle=0===n?"#000000":1===n?"#FFFFFF":"#000000",e.fillRect(10*i,10*s,10,10)}var r=g(null,e.getImageData(0,0,10*this.w,10*this.h));this.object=Z.buildFromBmpData(r,1.8)}},k.prototype={drawImage:function(t,e,s){this.g0.drawImage(t,e,s)},drawMesh:function(t,e){var s=this.g0;void 0!==e&&e&&this.g0.clear(),t.compute_Data();for(var i=t.AR_edge,n=t.AR_vertex,r=i.length,o=0;r--;)i[(o=5*r)+4]?s.lineStyle(this.constraintsWidth,this.constraintsColor):s.lineStyle(this.edgesWidth,this.edgesColor),s.moveTo(i[o],i[o+1]),s.lineTo(i[o+2],i[o+3]),s.stroke(),s.closePath();for(s.lineStyle(this.verticesRadius,this.verticesColor),r=n.length;r--;)o=2*r,s.beginFill(this.verticesColor,this.verticesAlpha),s.drawCircle(n[o],n[o+1],this.verticesRadius),s.endFill()},drawEntity:function(t,e){var s=this.g,i=t.isSee;void 0!==e&&e&&s.clear(),i?s.beginFill(this.entitiesField):s.beginFill(this.entitiesField2),s.moveTo(t.position.x,t.position.y),s.drawCircle(t.position.x,t.position.y,t.radiusFOV,t.angle-.5*t.angleFOV,t.angle+.5*t.angleFOV),s.lineTo(t.position.x,t.position.y),s.endFill(),i?s.beginFill(this.entitiesColor):s.beginFill(this.entitiesColor2),s.drawCircle(t.position.x,t.position.y,t.radius),s.endFill()},drawPath:function(t,e){var s=this.g;if(void 0!==e&&e&&this.g.clear(),0!==t.length){s.lineStyle(this.pathsWidth,this.pathsColor),s.moveTo(t[0],t[1]);for(var i=2;i<t.length;)s.lineTo(t[i],t[i+1]),i+=2;s.stroke()}},clear:function(){this.g.clear()}},A.prototype={clear:function(){this.ctx.clearRect(0,0,this.w,this.h)},drawImage:function(t,e,s){this.ctx.drawImage(t,0,0,e||this.w,s||this.h)},drawCircle:function(t,e,s,i,n){i=i||0,n=n||X.TwoPI,this.ctx.beginPath(),this.ctx.arc(t,e,s,i,n,!1)},drawRect:function(t,e,s,i){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+s,e),this.ctx.lineTo(t+s,e+i),this.ctx.lineTo(t,e+i),this.ctx.stroke(),this.ctx.closePath()},lineStyle:function(t,e){this.ctx.lineWidth=t,this.ctx.strokeStyle="rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},moveTo:function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t,e)},lineTo:function(t,e){this.ctx.lineTo(t,e)},stroke:function(){this.ctx.stroke()},closePath:function(){this.ctx.closePath()},beginFill:function(t){this.ctx.fillStyle="rgba("+t.r+","+t.g+","+t.b+","+t.a+")",this.ctx.beginPath()},endFill:function(){this.ctx.closePath(),this.ctx.fill()}},B.prototype={constructor:B,drawMesh:function(t,e){},collapseBuffer:function(){for(var t=this.maxVertices,e=this.currentVertex,s=0;t>=e;)s=3*t,this.positions[s]=0,this.positions[s+1]=0,this.positions[s+2]=0,this.colors[s]=0,this.colors[s+1]=0,this.colors[s+2]=0,t--},collapsePathBuffer:function(){for(var t=this.maxPathVertices,e=this.currentPathVertex,s=0;t>=e;)s=3*t,this.positionsPath[s]=0,this.positionsPath[s+1]=0,this.positionsPath[s+2]=0,this.colorsPath[s]=0,this.colorsPath[s+1]=0,this.colorsPath[s+2]=0,t--},update:function(){this.world.mesh.isRedraw&&(this.currentVertex=0,this.world.mesh.draw(),this.collapseBuffer(),this.buffer.geometry.attributes.position.needsUpdate=!0,this.buffer.geometry.attributes.color.needsUpdate=!0),this.world.update();for(var t,e=this.world.heroes.length;e--;)if((t=this.world.heroes[e]).isSelected&&t.tmppath.length>0){this.currentPathVertex=0;for(var s=this.world.heroes[e].tmppath,i=s[0],n=s[1],r=2;r<s.length;)this.insertPath(i,n,s[r],s[r+1],1,0,0),i=s[r],n=s[r+1],r+=2;this.collapsePathBuffer(),this.bufferPath.geometry.attributes.position.needsUpdate=!0,this.bufferPath.geometry.attributes.color.needsUpdate=!0}},insertLine:function(t,e,s,i,n,r,o){var h=this.currentVertex,a=3*h;this.positions[a]=t,this.positions[a+1]=0,this.positions[a+2]=e,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,a=3*++h,this.positions[a]=s,this.positions[a+1]=0,this.positions[a+2]=i,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,this.currentVertex+=2},insertPath:function(t,e,s,i,n,r,o){var h=this.currentPathVertex,a=3*h;this.positionsPath[a]=t,this.positionsPath[a+1]=0,this.positionsPath[a+2]=e,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,a=3*++h,this.positionsPath[a]=s,this.positionsPath[a+1]=0,this.positionsPath[a+2]=i,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,this.currentPathVertex+=2}},F.prototype.draw=function(){this.compute_Data();for(var t=H.get(),e=this.AR_edge,s=e.length,i=0;s--;)e[(i=5*s)+4]?t.insertLine(e[i],e[i+1],e[i+2],e[i+3],0,0,0):t.insertLine(e[i],e[i+1],e[i+2],e[i+3],.4,.4,.4);this.isRedraw=!1},t.IDX=U,t.REVISION="1.0.0",t.Main=H,t.Log=e,t.Dictionary=s,t._Math=X,t.Point=i,t.Matrix2D=n,t.Geom2D=Q,t.TwoPI=z,t.rand=function(t,e){return X.rand(t,e)},t.randInt=function(t,e){return X.randInt(t,e)},t.ImageLoader=p,t.fromImageData=g,t.Edge=f,t.Face=x,t.Vertex=_,t.Shape=y,t.Segment=m,t.Object2D=v,t.Graph=E,t.Potrace=K,t.Mesh2D=F,t.AStar=V,t.Funnel=b,t.PathFinder=D,t.PathIterator=O,t.LinearPathSampler=L,t.FieldOfView=N,t.Entity=R,t.World=q,t.RectMesh=T,t.CircleMesh=function(t,e,s,i){s=s||100,t=t||s,e=e||s;for(var n=[],r=[],o=[],h=[],a=[],u=i=i||8;u--;)o.push(new x),n.push(new _),h.push(new m),r.push(new f,new f,new f);var d=new y,l=1/i;for(u=0;u<i;)n[u].pos.set(t+(s+10)*X.cos(X.TwoPI*u*l),e+(s+10)*X.sin(X.TwoPI*u*l)),n[u].setDatas(r[2*u]),u++;for(u=0;u<i;)a.push(t+s*X.cos(X.TwoPI*u*l)),a.push(e+s*X.sin(X.TwoPI*u*l)),a.push(t+s*X.cos(X.TwoPI*(u+1)*l)),a.push(e+s*X.sin(X.TwoPI*(u+1)*l)),u++;var c=new F(2*s,2*s);return c._vertices=n,c._edges=r,c._faces=o,c._constraintShapes.push(d),c.clipping=!1,c.insertConstraintShape(a),c.clipping=!0,c},t.BitmapObject=Z,t.BitmapMesh=J,t.GridMaze=j,t.Dungeon=M,t.SimpleView=k,t.ThreeView=B,Object.defineProperty(t,"__esModule",{value:!0})});
