!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DDLS={})}(this,function(t){"use strict";function e(t){console.log(t)}function s(t,e){this.type=t||0,0===this.type?(this.k=[],this.v=[]):this.h={}}function i(t,e){this.x=t||0,this.y=e||0}function n(t,e,s,i,n,r){this.n=[t||1,e||0,s||0,i||1,n||0,r||0]}function r(t,e){e=e||1;var s=t.length;if(s<=4)return[].concat(t);for(var n=t[0],o=t[1],h=t[s-2],a=t[s-1],l=-1,u=0,d=1,c=s>>1;d<c;){var g=d++,p=st.distanceSquaredPointToSegment(new i(t[g<<1],t[1+(g<<1)]),new i(n,o),new i(h,a));p>u&&(u=p,l=g)}if(u>e*e){var f=t.slice(0,2+(l<<1)),x=t.slice(l<<1),y=r(f,e),_=r(x,e);return y.slice(0,y.length-2).concat(_)}return[n,o,h,a]}function o(t,e){this.length=t*e,this.bytes=new et(4*this.length),this.width=t,this.height=e}function h(t,e){if(t){var s=t.width,i=t.height,n=document.createElement("canvas");n.width=s,n.height=i;var r=n.getContext("2d");r.drawImage(t,0,0,s,i),e=r.getImageData(0,0,s,i)}for(var h=new o(e.width,e.height),a=e.data,l=a.byteLength,u=0,d=0;u<l;)d=u++,h.bytes[d]=255&a[d];return t&&(r.clearRect(0,0,s,i),n=null,r=null),h}function a(t,e){this.images=new s(2),this.loaded=e,this.count=t.length;for(var i=0;i<t.length;){var n=t[i];++i,this.load(n)}}function l(t,e,s){this.rangeMin=e||0,this.rangeMax=s||1,this._originalSeed=this._currSeed=t||1234,this._numIter=0,Object.defineProperty(this,"seed",{get:function(){return this._originalSeed},set:function(t){this._originalSeed=this._currSeed=t}})}function u(){this._fromFace=null,this._nextEdge=null,Object.defineProperty(this,"fromFace",{set:function(t){this._fromFace=t,this._nextEdge=this._fromFace.edge}})}function d(){this._fromMesh=null,this._currIndex=0,Object.defineProperty(this,"fromMesh",{set:function(t){this._fromMesh=t,this._currIndex=0}})}function c(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){this._fromVertex=t,this._nextEdge=this._fromVertex.edge}})}function g(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){for(this._fromVertex=t,this._nextEdge=this._fromVertex.edge;!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function p(){this.realEdgesOnly=!0,this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){if(this._fromVertex=t,this._nextEdge=this._fromVertex.edge,null!=this._nextEdge)for(;this.realEdgesOnly&&!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function f(){this.type=Y,this.id=K.get("edge"),this.fromConstraintSegments=[],this.isConstrained=!1,this.isReal=!1,this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,Object.defineProperty(this,"destinationVertex",{get:function(){return this.oppositeEdge.originVertex}}),Object.defineProperty(this,"nextRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge}}),Object.defineProperty(this,"rotLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"rotRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge}}),Object.defineProperty(this,"rightFace",{get:function(){return this.oppositeEdge.leftFace}})}function x(){this.type=H,this.id=K.get("face"),this.isReal=!1,this.edge=null}function y(){this.type=X,this.id=K.get("vertex"),this.pos=new i,this.fromConstraintSegments=[],this.edge=null,this.isReal=!1}function _(){this.id=K.get("shape"),this.segments=[]}function m(t,e){this.id=K.get("segment"),this.edges=[],this.fromShape=null}function v(){this.id=K.get("object2D"),this._pivot=new i,this._position=new i,this._scale=new i(1,1),this._matrix=new n,this._rotation=0,this._constraintShape=null,this._coordinates=[],this.hasChanged=!1,Object.defineProperty(this,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation!=t&&(this._rotation=t,this.hasChanged=!0)}}),Object.defineProperty(this,"matrix",{get:function(){return this._matrix},set:function(t){this._matrix=t,this.hasChanged=!0}}),Object.defineProperty(this,"coordinates",{get:function(){return this._coordinates},set:function(t){this._coordinates=t,this.hasChanged=!0}}),Object.defineProperty(this,"constraintShape",{get:function(){return this._constraintShape},set:function(t){this._constraintShape=t,this.hasChanged=!0}}),Object.defineProperty(this,"edges",{get:function(){for(var t,e=[],s=this._constraintShape.segments,i=s.length,n=0,r=0,o=0,h=0;n<i;)for(r=0,t=s[o=n++].edges.length;r<t;)h=r++,e.push(s[o].edges[h]);return e}})}function E(){this.id=K.get("graph"),this.edge=null,this.node=null}function w(){this.id=K.get("graphEdge"),this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}function C(){this.id=K.get("graphNode"),this.successorNodes=new s(1),this.prev=null,this.next=null,this.outgoingEdge=null,this.data=null}function S(){}function F(){}function P(t,e){this.id=K.get("mesh2D"),this.__objectsUpdateInProgress=!1,this.__centerVertex=null,this.width=t,this.height=e,this.clipping=!0,this._edges=[],this._faces=[],this._objects=[],this._vertices=[],this._constraintShapes=[],this.__edgesToCheck=[],this.AR_vertex=null,this.AR_edge=null,this.isRedraw=!0}function V(){this.fromFace=null,this.toFace=null,this.curFace=null,this.iterEdge=new u,this.mesh=null,this._radius=0,this.radiusSquared=0,this.diameter=0,this.diameterSquared=0,Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this.radiusSquared=this._radius*this._radius,this.diameter=2*this._radius,this.diameterSquared=this.diameter*this.diameter}})}function b(){this._currPoolPointsIndex=0,this._poolPointsSize=3e3,this._numSamplesCircle=16,this._radiusSquared=0,this._radius=0,this._poolPoints=[];for(var t=this._poolPointsSize,e=0;e<t;){e++;this._poolPoints.push(new i)}Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){if(this._radius=Math.max(0,t),this._radiusSquared=this._radius*this._radius,this._sampleCircle=[],0!=this._radius){for(var e,s=this._numSamplesCircle,n=0;n<s;){var r=n++;e=-G*r/this._numSamplesCircle,this._sampleCircle.push(new i(this._radius*Math.cos(e),this._radius*Math.sin(e)))}this._sampleCircleDistanceSquared=Z(this._sampleCircle[0].x-this._sampleCircle[1].x,this._sampleCircle[0].y-this._sampleCircle[1].y)}}})}function D(){this.astar=new V,this.funnel=new b,this.listFaces=[],this.listEdges=[],this._mesh=null,this.entity=null,Object.defineProperty(this,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh=t,this.astar.mesh=t}})}function O(){this.entity=null,this.hasPrev=!1,this.hasNext=!1,this.countMax=0,this.count=0,this._currentX=0,this._currentY=0,this._path=[],Object.defineProperty(this,"x",{get:function(){return this._currentX}}),Object.defineProperty(this,"y",{get:function(){return this._currentY}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this.countMax=.5*this._path.length,this.reset()}})}function L(){this.entity=null,this._path=null,this._samplingDistanceSquared=1,this._samplingDistance=1,this._preCompX=[],this._preCompY=[],this.pos=new i,this.hasPrev=!1,this.hasNext=!1,this._count=0,Object.defineProperty(this,"x",{get:function(){return this.pos.x}}),Object.defineProperty(this,"y",{get:function(){return this.pos.y}}),Object.defineProperty(this,"countMax",{get:function(){return this._preCompX.length-1}}),Object.defineProperty(this,"count",{get:function(){return this._count},set:function(t){this._count=t,this._count<0&&(this._count=0),this._count>this.countMax-1&&(this._count=this.countMax-1),0==this._count?this.hasPrev=!1:this.hasPrev=!0,this._count==this.countMax-1?this.hasNext=!1:this.hasNext=!0,this.applyLast(),this.updateEntity()}}),Object.defineProperty(this,"samplingDistance",{get:function(){return this._samplingDistance},set:function(t){this._samplingDistance=t,this._samplingDistanceSquared=this._samplingDistance*this._samplingDistance}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this._preComputed=!1,this.reset()}})}function M(t,e){this.entity=t||null,this.world=e||null}function N(t,e){this.isSee=!1,this.isWalking=!1,this.isSelected=!1,this.isMove=!1,this.world=e,t=t||{},this.position=new i(t.x||0,t.y||0),this.direction=new i(1,0),this.radius=t.r||10,this.angle=0,this.angleFOV=(t.fov||120)*W,this.radiusFOV=t.distance||200,this.testSee=t.see||!1,this.path=[],this.tmppath=[],this.target=new i,this.newPath=!1,this.mesh=null,this.fov=new M(this,this.world),this.pathSampler=new L,this.pathSampler.entity=this,this.pathSampler.path=this.tmppath,this.pathSampler.samplingDistance=t.speed||10}function T(t,e){for(var s=[],i=[],n=[],r=[],o=4;o--;)n.push(new x),s.push(new y),r.push(new m),i.push(new f,new f,new f);var h=new _;s[0].pos.set(-10,-10),s[1].pos.set(t+10,-10),s[2].pos.set(t+10,e+10),s[3].pos.set(-10,e+10),s[0].setDatas(i[0]),s[1].setDatas(i[2]),s[2].setDatas(i[4]),s[3].setDatas(i[6]),i[0].setDatas(s[0],i[1],i[2],n[3],!0,!0),i[1].setDatas(s[1],i[0],i[7],n[0],!0,!0),i[2].setDatas(s[1],i[3],i[11],n[3],!0,!0),i[3].setDatas(s[2],i[2],i[8],n[1],!0,!0),i[4].setDatas(s[2],i[5],i[6],n[2],!0,!0),i[5].setDatas(s[3],i[4],i[3],n[1],!0,!0),i[6].setDatas(s[3],i[7],i[10],n[2],!0,!0),i[7].setDatas(s[0],i[6],i[9],n[0],!0,!0),i[8].setDatas(s[1],i[9],i[5],n[1],!0,!1),i[9].setDatas(s[3],i[8],i[1],n[0],!0,!1),i[10].setDatas(s[0],i[11],i[4],n[2],!1,!1),i[11].setDatas(s[2],i[10],i[0],n[3],!1,!1),n[0].setDatas(i[9],!0),n[1].setDatas(i[8],!0),n[2].setDatas(i[4],!1),n[3].setDatas(i[2],!1),s[0].fromConstraintSegments=[r[0],r[3]],s[1].fromConstraintSegments=[r[0],r[1]],s[2].fromConstraintSegments=[r[1],r[2]],s[3].fromConstraintSegments=[r[2],r[3]],i[0].fromConstraintSegments.push(r[0]),i[1].fromConstraintSegments.push(r[0]),i[2].fromConstraintSegments.push(r[1]),i[3].fromConstraintSegments.push(r[1]),i[4].fromConstraintSegments.push(r[2]),i[5].fromConstraintSegments.push(r[2]),i[6].fromConstraintSegments.push(r[3]),i[7].fromConstraintSegments.push(r[3]),r[0].edges.push(i[0]),r[1].edges.push(i[2]),r[2].edges.push(i[4]),r[3].edges.push(i[6]),r[0].fromShape=h,r[1].fromShape=h,r[2].fromShape=h,r[3].fromShape=h,h.segments.push(r[0],r[1],r[2],r[3]);var a=new P(t,e);return a._vertices=s,a._edges=i,a._faces=n,a.clipping=!1,a.insertConstraintShape([0,0,t,0,t,0,t,e,t,e,0,e,0,e,0,0]),a.clipping=!0,a}function j(t,e){this.heroes=[],this.shapes=[],this.segments=[],this.objects=[],this.w=t||512,this.h=e||512,this.mesh=T(this.w,this.h),this.pathFinder=new D,this.pathFinder.mesh=this.mesh}function R(t,e){this.visited=!1,this.col=t,this.row=e;for(var s=[],i=0;i<4;){i++;s.push([])}this.walls=s}function k(t,e,s,i){this.generate(t,e,s,i)}function I(t,e,s,i){this.generate(t,e,s,i)}function A(t){this.g0=new q(t.w,t.h),this.g=new q(t.w,t.h),this.g.canvas.style.pointerEvents="none",this.g0.canvas.style.pointerEvents="auto",this.entitiesWidth=1,this.entitiesColor={r:0,g:255,b:0,a:.75},this.entitiesColor2={r:255,g:255,b:255,a:.75},this.entitiesField={r:0,g:255,b:0,a:.1},this.entitiesField2={r:255,g:255,b:255,a:.1},this.pathsWidth=2,this.pathsColor={r:255,g:255,b:0,a:.75},this.verticesRadius=1,this.verticesColor={r:255,g:120,b:0,a:.5},this.constraintsWidth=2,this.constraintsColor={r:255,g:0,b:0,a:1},this.edgesWidth=1,this.edgesColor={r:190,g:190,b:190,a:.25},this.edgesColor2={r:0,g:190,b:0,a:.25},this.mesh_data=null,this.domElement=this.g0.canvas,U.set(this)}function q(t,e){this.w=t||200,this.h=e||200,this.canvas=document.createElement("canvas"),this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.canvas.style.cssText="position:absolute; left:50%; top:50%; margin-left:"+.5*-this.w+"px; margin-top:"+.5*-this.h+"px;",document.body.appendChild(this.canvas)}function B(t,e,s){var i=s;this.world=e,this.maxVertices=3e4,this.currentVertex=0;var n=new i.BufferGeometry;n.addAttribute("position",new i.BufferAttribute(new Float32Array(3*this.maxVertices),3)),n.addAttribute("color",new i.BufferAttribute(new Float32Array(3*this.maxVertices),3)),this.positions=n.attributes.position.array,this.colors=n.attributes.color.array,n.computeBoundingSphere(),this.buffer=new i.LineSegments(n,new i.LineBasicMaterial({vertexColors:!0})),this.buffer.frustumCulled=!1,t.add(this.buffer),this.maxPathVertices=1e3,this.currentPathVertex=0;var r=new i.BufferGeometry;r.addAttribute("position",new i.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),r.addAttribute("color",new i.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),this.positionsPath=r.attributes.position.array,this.colorsPath=r.attributes.color.array,n.computeBoundingSphere(),this.bufferPath=new i.LineSegments(r,new i.LineBasicMaterial({vertexColors:!0})),this.bufferPath.frustumCulled=!1,t.add(this.bufferPath),U.set(this)}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(void 0!==i&&null!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e});var W=.017453292519943295,G=2*Math.PI,X=0,Y=1,H=2,U={view:null,get:function(){return this.view},set:function(t){this.view=t}},K={id:{segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0},get:function(t){return++this.id[t]},reset:function(){this.id={segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0}}};s.prototype={set:function(t,e){2===this.type?this.h[t]=e:1===this.type?this.h[t.id]=e:(this.k.push(t),this.v.push(e))},get:function(t){if(2===this.type)return this.h[t];if(1===this.type)return this.h[t.id];var e=this.k.indexOf(t);return-1!=e?this.v[e]:void 0},dispose:function(){if(0===this.type){for(;this.k.length>0;)this.k.pop();for(;this.v.length>0;)this.v.pop();this.k=null,this.v=null}else this.h=null}},i.prototype={constructor:i,set:function(t,e){return this.x=t,this.y=e,this},transform:function(t){return t.tranform(this),this},copy:function(t){return this.x=t.x,this.y=t.y,this},clone:function(){return new i(this.x,this.y)},sub:function(t){return this.x-=t.x,this.y-=t.y,this},mul:function(t){return this.x*=t,this.y*=t,this},add:function(t){return this.x+=t.x,this.y+=t.y,this},div:function(t){var e=1/t;return this.x*=e,this.y*=e,this},negate:function(){return new i(-this.x,-this.y)},transformMat2D:function(t){var e=this.x,s=this.y,i=t.n;return this.x=i[0]*e+i[2]*s+i[4],this.y=i[1]*e+i[3]*s+i[5],this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},angular:function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this},normalize:function(){var t=this.length();return this.x/=t,this.y/=t,t},distanceTo:function(t){var e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)},distanceSquaredTo:function(t){var e=this.x-t.x,s=this.y-t.y;return e*e+s*s},equals:function(t){return this.x===t.x&&this.y===t.y}},n.prototype={constructor:n,identity:function(){return this.n=[1,0,0,1,0,0],this},translate:function(t){var e=this.n;return e[4]+=t.x,e[5]+=t.y,this},scale:function(t){var e=this.n;return e[0]*=t.x,e[1]*=t.y,e[2]*=t.x,e[3]*=t.y,e[4]*=t.x,e[5]*=t.y,this},rotate:function(t){var e=this.n,s=e[0],i=e[1],n=e[2],r=e[3],o=e[4],h=e[5],a=Math.sin(t),l=Math.cos(t);return e[0]=s*l+i*a,e[1]=-s*a+i*l,e[2]=n*l+r*a,e[3]=-n*a+l*r,e[4]=l*o+a*h,e[5]=l*h-a*o,this},tranform:function(t){var e=this.n,s=e[0]*t.x+e[2]*t.y+e[4],i=e[1]*t.x+e[3]*t.y+e[5];t.x=s,t.y=i},transformX:function(t,e){var s=this.n;return s[0]*t+s[2]*e+s[4]},transformY:function(t,e){var s=this.n;return s[1]*t+s[3]*e+s[5]},concat:function(t){var e=this.n,s=t.n,i=e[0]*s[0]+e[1]*s[2],n=e[0]*s[1]+e[1]*s[3],r=e[2]*s[0]+e[3]*s[2],o=e[2]*s[1]+e[3]*s[3],h=e[4]*s[0]+e[5]*s[2]+s[4],a=e[4]*s[1]+e[5]*s[3]+s[5];return e[0]=i,e[1]=n,e[2]=r,e[3]=o,e[4]=h,e[5]=a,this},clone:function(){var t=this.n;return new n(t[0],t[1],t[2],t[3],t[4],t[5])}};var z=function(t,e){return t+Math.floor(Math.random()*(e-t+1))},Z=function(t,e){return t*t+e*e},Q=function(t,e){return Math.sqrt(t*t+e*e)},J=function(t,e,s){return Math.abs(t-e)<s},$=function(t){return Math.floor(t)},tt=function(t,e){return 1*t.toFixed(e||3)},et="undefined"!=typeof Float32Array?Float32Array:Array;a.prototype={load:function(t){var e,s=window.document;(e=s.createElement("img")).style.cssText="position:absolute;",e.onload=function(){this.store(e,t.split("/").pop())}.bind(this),e.src=t},store:function(t,s){e("store "+s+" "+--this.count),this.images.set(s,t),0==this.count&&this.loaded()}},l.prototype={constructor:l,reset:function(){this._currSeed=this._originalSeed,this._numIter=0},next:function(){var t=1*this._currSeed;for(this._tempString=(t*t).toString();this._tempString.length<8;)this._tempString="0"+this._tempString;this._currSeed=parseInt(this._tempString.substr(1,5));var e=Math.round(this.rangeMin+this._currSeed/99999*(this.rangeMax-this.rangeMin));return 0===this._currSeed&&(this._currSeed=this._originalSeed+this._numIter),200===++this._numIter&&this.reset(),e},nextInRange:function(t,e){return this.rangeMin=t,this.rangeMax=e,this.next()},shuffle:function(t){for(var e,s,i=t.length;i>0;)e=this.nextInRange(0,i-1),s=t[--i],t[i]=t[e],t[e]=s}},u.prototype={next:function(){return null!=this._nextEdge?(this._resultEdge=this._nextEdge,this._nextEdge=this._nextEdge.nextLeftEdge,this._nextEdge==this._fromFace.edge&&(this._nextEdge=null)):this._resultEdge=null,this._resultEdge}},d.prototype={next:function(){do{if(!(this._currIndex<this._fromMesh._vertices.length)){this._resultVertex=null;break}this._resultVertex=this._fromMesh._vertices[this._currIndex],this._currIndex++}while(!this._resultVertex.isReal);return this._resultVertex}},c.prototype={next:function(){if(null!=this._nextEdge){do{if(this._resultFace=this._nextEdge.leftFace,this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null,this._resultFace.isReal||(this._resultFace=null);break}}while(!this._resultFace.isReal)}else this._resultFace=null;return this._resultFace}},g.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge.oppositeEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}},p.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(this.realEdgesOnly&&!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}};var st={__samples:[],__circumcenter:new i,_randGen:null,locatePosition:function(t,i){var n,r;for(null==st._randGen&&(st._randGen=new l),st._randGen.seed=$(10*t.x+4*t.y),st.__samples.splice(0,st.__samples.length),r=$(Math.pow(i._vertices.length,.333333334)),st._randGen.rangeMin=0,st._randGen.rangeMax=i._vertices.length-1,n=0;n<r;)st.__samples.push(i._vertices[st._randGen.next()]),n++;var o,h,a,d=1/0,g=null;for(n=0;n<r;)h=(o=st.__samples[n]).pos,(a=Z(h.x-t.x,h.y-t.y))<d&&(d=a,g=o),n++;var p=new c;null===g&&e("no closedVertex find ?"),p.fromVertex=g;for(var f,x=p.next(),y=new s,_=new u,m=0,v=0,E=st.isInFace(t,x);y.get(x)||3===E.type;){if(y.set(x,!0),50==++v&&e("WALK TAKE MORE THAN 50 LOOP"),1e3==v){e("WALK TAKE MORE THAN 1000 LOOP -> WE ESCAPE"),E={type:3};break}_.fromFace=x;do{if(null===(f=_.next()))return e("KILL PATH"),null;m=st.getRelativePosition(t,f)}while(1==m||0==m);x=f.rightFace,E=st.isInFace(t,x)}return y.dispose(),E},isCircleIntersectingAnyConstraint:function(t,e,i){if(t.x<=0||t.x>=i.width||t.y<=0||t.y>=i.height)return!0;var n,r=st.locatePosition(t,i);switch(r.type){case 0:n=r.edge.leftFace;break;case 1:n=r.leftFace;break;case 2:n=r;break;case 3:n=null}var o,h=e*e;if(o=n.edge.originVertex.pos,Z(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.originVertex.pos,Z(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.nextLeftEdge.originVertex.pos,Z(o.x-t.x,o.y-t.y)<=h)return!0;var a=[];a.push(n.edge),a.push(n.edge.nextLeftEdge),a.push(n.edge.nextLeftEdge.nextLeftEdge);for(var l,u,d,c=new s(0);a.length>0;)if(l=a.pop(),c.set(l,!0),u=l.originVertex.pos,d=l.destinationVertex.pos,st.intersectionsSegmentCircle(u,d,t,e)){if(l.isConstrained)return!0;l=l.oppositeEdge.nextLeftEdge,c.get(l)||c.get(l.oppositeEdge)||-1!=a.indexOf(l)||-1!=a.indexOf(l.oppositeEdge)||a.push(l),l=l.nextLeftEdge,c.get(l)||c.get(l.oppositeEdge)||-1!=a.indexOf(l)||-1!=a.indexOf(l.oppositeEdge)||a.push(l)}return!1},getDirection:function(t,e,s){var i=(s.x-t.x)*(e.y-t.y)+(s.y-t.y)*(-e.x+t.x);return 0==i?0:i>0?1:-1},getRelativePosition:function(t,e){return st.getDirection(e.originVertex.pos,e.destinationVertex.pos,t)},getRelativePosition2:function(t,e){return void 0===e?(console.log("error no eUp"),0):st.Orient2d(e.originVertex.pos,e.destinationVertex.pos,t)},Orient2d:function(t,e,s){var i=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x);return i>-1e-4&&i<1e-4?0:i>0?-1:1},isInFace:function(t,e){var s={type:3};if(null===e)return s;var i=e.edge,n=i.nextLeftEdge,r=n.nextLeftEdge;if(st.getRelativePosition(t,i)>=0&&st.getRelativePosition(t,n)>=0&&st.getRelativePosition(t,r)>=0){var o=i.originVertex,h=n.originVertex,a=r.originVertex,l=o.pos.x,u=o.pos.y,d=h.pos.x,c=h.pos.y,g=a.pos.x,p=a.pos.y,f=Z(l-t.x,u-t.y),x=Z(d-t.x,c-t.y),y=Z(g-t.x,p-t.y),_=1/Z(d-l,c-u),m=1/Z(g-d,p-c),v=1/Z(l-g,u-p),E=(t.x-l)*(d-l)+(t.y-u)*(c-u),w=(t.x-d)*(g-d)+(t.y-c)*(p-c),C=(t.x-g)*(l-g)+(t.y-p)*(u-p),S=x-w*w*m<=1e-4,F=y-C*C*v<=1e-4;s=f-E*E*_<=1e-4?F?o:S?h:i:S?F?a:n:F?r:e}return s},clipSegmentByTriangle:function(t,e,s,i,n,r,o){var h=st.getDirection(s,i,t),a=st.getDirection(s,i,e);if(h<=0&&a<=0)return!1;var l=st.getDirection(i,n,t),u=st.getDirection(i,n,e);if(l<=0&&u<=0)return!1;var d=st.getDirection(n,s,t),c=st.getDirection(n,s,e);if(d<=0&&c<=0)return!1;if(h>=0&&l>=0&&d>=0&&a>=0&&u>=0&&c>=0)return r=t.clone(),o=e.clone(),!0;var g=0;return st.intersections2segments(t,e,s,i,r,null)&&g++,0==g?st.intersections2segments(t,e,i,n,r,null)&&g++:st.intersections2segments(t,e,i,n,o,null)&&(-.01>r.x-o.x||r.x-o.x>.01||-.01>r.y-o.y||r.y-o.y>.01)&&g++,0==g?st.intersections2segments(t,e,n,s,r,null)&&g++:1==g&&st.intersections2segments(t,e,n,s,o,null)&&(-.01>r.x-o.x||r.x-o.x>.01||-.01>r.y-o.y||r.y-o.y>.01)&&g++,1==g&&(h>=0&&l>=0&&d>=0?o=t.clone():a>=0&&u>=0&&c>=0?o=e.clone():g=0),g>0},isDelaunay:function(t){var e=t.originVertex,s=t.destinationVertex,i=t.nextLeftEdge.destinationVertex,n=t.nextRightEdge.destinationVertex;st.getCircumcenter(i.pos,e.pos,s.pos,st.__circumcenter);var r=(i.pos.x-st.__circumcenter.x)*(i.pos.x-st.__circumcenter.x)+(i.pos.y-st.__circumcenter.y)*(i.pos.y-st.__circumcenter.y);return(n.pos.x-st.__circumcenter.x)*(n.pos.x-st.__circumcenter.x)+(n.pos.y-st.__circumcenter.y)*(n.pos.y-st.__circumcenter.y)>=r},getCircumcenter:function(t,e,s,n){null==n&&(n=new i);var r=.5*(t.x+e.x),o=.5*(t.y+e.y),h=.5*(t.x+s.x),a=.5*(t.y+s.y),l=(r*(t.x-s.x)+(o-a)*(t.y-s.y)+h*(s.x-t.x))/(t.x*(s.y-e.y)+e.x*(t.y-s.y)+s.x*(e.y-t.y));return n.x=r+l*(e.y-t.y),n.y=o-l*(e.x-t.x),n},intersections2segments:function(t,e,s,i,n,r,o){null==o&&(o=!1);var h,a=0,l=0,u=(t.x-e.x)*(s.y-i.y)+(e.y-t.y)*(s.x-i.x);if(0==u)h=!1;else{h=!0;var d=1/u;o&&null==n&&null==r||(a=(t.x*(s.y-i.y)+t.y*(i.x-s.x)+s.x*i.y-s.y*i.x)*d,l=(t.x*(s.y-e.y)+t.y*(e.x-s.x)-e.x*s.y+e.y*s.x)*d,o||0<=a&&a<=1&&0<=l&&l<=1||(h=!1))}return h&&(null!=n&&(n.x=t.x+a*(e.x-t.x),n.y=t.y+a*(e.y-t.y)),null!=r&&r.push(a,l)),h},intersections2edges:function(t,e,s,i,n){return null==n&&(n=!1),st.intersections2segments(t.originVertex.pos,t.destinationVertex.pos,e.originVertex.pos,e.destinationVertex.pos,s,i,n)},isConvex:function(t){var e,s,i=!0;return e=t.nextLeftEdge.oppositeEdge,s=t.nextRightEdge.destinationVertex,-1!=st.getRelativePosition(s.pos,e)?i=!1:(e=t.prevRightEdge,s=t.prevLeftEdge.originVertex,-1!=st.getRelativePosition(s.pos,e)&&(i=!1)),i},projectOrthogonaly:function(t,e){var s=e.originVertex.pos.x,i=e.originVertex.pos.y,n=e.destinationVertex.pos.x,r=e.destinationVertex.pos.y,o=t.x,h=t.y,a=(s*s-s*n-s*o+i*i-i*r-i*h+n*o+r*h)/(s*s-2*s*n+i*i-2*i*r+n*n+r*r);t.x=s+a*(n-s),t.y=i+a*(r-i)},intersections2Circles:function(t,e,s,i,n){var r,o,h,a,l,u,d;return l=Z(s.x-t.x,s.y-t.y),u=1/(2*l),(t.x!=s.x||t.y!=s.y)&&l<=(e+i)*(e+i)&&l>=(e-i)*(e-i)&&(d=Math.sqrt(((e+i)*(e+i)-l)*(l-(i-e)*(i-e))),r=s.clone().sub(t).mul(u),o=t.clone().add(s).mul(.5),h=r.clone().mul(e*e-i*i),a=o.clone().add(h),null!=n&&n.push(a.x+r.y*d,a.y-r.x*d,a.x-r.y*d,a.y+r.x*d),!0)},intersectionsSegmentCircle:function(t,e,s,i,n){var r,o,h,a=t.x*t.x,l=t.y*t.y,u=e.y*e.y-2*e.y*t.y+l+e.x*e.x-2*e.x*t.x+a,d=2*t.y*s.y-2*a+2*e.y*t.y-2*l+2*e.x*t.x-2*e.x*s.x+2*t.x*s.x-2*e.y*s.y,c=d*d-4*u*(l+s.y*s.y+s.x*s.x-2*t.y*s.y-2*t.x*s.x+a-i*i);if(c<0)return!1;if(0==c)return!((o=-d/(2*u))<0||o>1)&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),!0);h=(-d-(r=Math.sqrt(c)))/(2*u);var g=!1;return 0<=(o=(-d+r)/(2*u))&&o<=1&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),g=!0),0<=h&&h<=1&&(null!=n&&n.push(t.x+h*(e.x-t.x),t.y+h*(e.y-t.y),h),g=!0),g},tangentsPointToCircle:function(t,e,s,i){var n=t.clone().add(e).mul(.5),r=.5*Q(t.x-e.x,t.y-e.y);return st.intersections2Circles(n,r,e,s,i)},tangentsCrossCircleToCircle:function(t,e,s,i){var n=Q(e.x-s.x,e.y-s.y),r=.25*n,o=s.clone().sub(e).mul(.25).add(e);if(st.intersections2Circles(e,t,o,r,i)){var h=i[0],a=i[1],l=i[2],u=i[3],d=e.clone().add(s).mul(.5),c=((h-d.x)*(s.y-e.y)+(a-d.y)*(-s.x+e.x))/(n*n),g=2*(d.x+c*(s.y-e.y))-h,p=2*(d.y-c*(s.x-e.x))-a,f=g+l-h,x=u+p-a;return i.push(f,x,g,p),!0}return!1},tangentsParalCircleToCircle:function(t,e,s,i){var n=1/Q(e.x-s.x,e.y-s.y),r=e.x+t*(s.y-e.y)*n,o=e.y+t*(-s.x+e.x)*n,h=2*e.x-r,a=2*e.y-o,l=h+s.x-e.x,u=a+s.y-e.y,d=r+s.x-e.x,c=o+s.y-e.y;i.push(r,o,h,a,l,u,d,c)},distanceSquaredPointToSegment:function(t,e,s){var i=Z(s.x-e.x,s.y-e.y),n=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/i;return n<0?Z(t.x-e.x,t.y-e.y):n<=1?Z(e.x-t.x,e.y-t.y)-n*n*i:Z(t.x-s.x,t.y-s.y)},distanceSquaredVertexToEdge:function(t,e){return st.distanceSquaredPointToSegment(t.pos,e.originVertex.pos,e.destinationVertex.pos)},pathLength:function(t){for(var e,s,i=0,n=t[0],r=t[1],o=2,h=t.length;o<h;)e=t[o],s=t[o+1],i+=Q(e-n,s-r),n=e,r=s,o+=2;return i}};f.prototype={constructor:f,setDatas:function(t,e,s,i,n,r){this.isConstrained=void 0!==n&&r,this.isReal=void 0===n||n,this.originVertex=t,this.oppositeEdge=e,this.nextLeftEdge=s,this.leftFace=i},getDatas:function(){return[this.originVertex.pos.x,this.originVertex.pos.y,this.destinationVertex.pos.x,this.destinationVertex.pos.y,this.isConstrained?1:0]},addFromConstraintSegment:function(t){-1===this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!==e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,this.fromConstraintSegments=null},toString:function(){return"edge "+this.originVertex.id+" - "+this.destinationVertex.id}},x.prototype={constructor:x,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},dispose:function(){this.edge=null,this.isReal=!1}},y.prototype={constructor:y,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},addFromConstraintSegment:function(t){-1==this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!=e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.pos=null,this.edge=null,this.fromConstraintSegments=null},toString:function(){return"ver_id "+this.id}},_.prototype={constructor:_,dispose:function(){for(;this.segments.length>0;)this.segments.pop().dispose();this.segments=null}},m.prototype={constructor:m,addEdge:function(t){-1==this.edges.indexOf(t)&&-1==this.edges.indexOf(t.oppositeEdge)&&this.edges.push(t)},removeEdge:function(t){var e=this.edges.indexOf(t);-1==e&&(e=this.edges.indexOf(t.oppositeEdge)),-1!=e&&this.edges.splice(e,1)},dispose:function(){this.edges=null,this.fromShape=null},toString:function(){return"seg_id "+this.id}},v.prototype={constructor:v,position:function(t,e){this._position.set(t,e),this.hasChanged=!0},scale:function(t,e){this._scale.set(t,e),this.hasChanged=!0},pivot:function(t,e){this._pivot.set(t,e),this.hasChanged=!0},dispose:function(){this._matrix=null,this._coordinates=null,this._constraintShape=null},updateValuesFromMatrix:function(){},updateMatrixFromValues:function(){this._matrix.identity().translate(this._pivot.negate()).scale(this._scale).rotate(this._rotation).translate(this._position)}},E.prototype={constructor:E,dispose:function(){for(;null!=this.node;)this.deleteNode(this.node)},insertNode:function(){var t=new C;return null!=this.node&&(t.next=this.node,this.node.prev=t),this.node=t,t},deleteNode:function(t){for(;null!=t.outgoingEdge;)null!=t.outgoingEdge.oppositeEdge&&this.deleteEdge(t.outgoingEdge.oppositeEdge),this.deleteEdge(t.outgoingEdge);for(var e,s=this.node;null!=s;)null!=(e=s.successorNodes.get(t))&&this.deleteEdge(e),s=s.next;this.node==t?null!=t.next?(t.next.prev=null,this.node=t.next):this.node=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.dispose()},insertEdge:function(t,e){if(null!=t.successorNodes.get(e))return null;var s=new w;null!=this.edge&&(this.edge.prev=s,s.next=this.edge),this.edge=s,s.sourceNode=t,s.destinationNode=e,t.successorNodes.set(e,s),null!=t.outgoingEdge?(t.outgoingEdge.rotPrevEdge=s,s.rotNextEdge=t.outgoingEdge,t.outgoingEdge=s):t.outgoingEdge=s;var i=e.successorNodes.get(t);return null!=i&&(s.oppositeEdge=i,i.oppositeEdge=s),s},deleteEdge:function(t){this.edge==t?null!=t.next?(t.next.prev=null,this.edge=t.next):this.edge=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.sourceNode.outgoingEdge==t?null!=t.rotNextEdge?(t.rotNextEdge.rotPrevEdge=null,t.sourceNode.outgoingEdge=t.rotNextEdge):t.sourceNode.outgoingEdge=null:null!=t.rotNextEdge?(t.rotPrevEdge.rotNextEdge=t.rotNextEdge,t.rotNextEdge.rotPrevEdge=t.rotPrevEdge):t.rotPrevEdge.rotNextEdge=null,t.dispose()}},w.prototype={dispose:function(){this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}},C.prototype={dispose:function(){this.successorNodes.dispose(),this.prev=null,this.next=null,this.outgoingEdge=null,this.successorNodes=null,this.data=null}};var it={color:{r:255,g:255,b:255},nearly:50,maxDistance:1,setColor:function(t){it.color=t},setNearly:function(t){it.nearly=t},getWhite:function(t,e,s){var i=!1,n=t.bytes,r=t.width,o=it.color,h=it.nearly,a=e+s*r<<2;return void 0!==o.r&&J(n[a],o.r,h)&&(i=!0),void 0!==o.g&&J(n[a+1],o.g,h)&&(i=!0),void 0!==o.b&&J(n[a+2],o.b,h)&&(i=!0),void 0!==o.a&&J(n[a+3],o.a,h)&&(i=!0),i},buildShapes:function(t){for(var e=[],i=new s(2),n=t.height-1,r=t.width-1,o=1;o<n;o++)for(var h=0;h<r;h++)it.getWhite(t,h,o)&&!it.getWhite(t,h+1,o)&&(i.get(h+1+"_"+o)||e.push(it.buildShape(t,o,h+1,i)));return i.dispose(),e},buildShape:function(t,e,s,n){var r=s,o=e,h=[r,o];n.set(r+"_"+o,!0);t.width,t.height;for(var a,l,u=new i(0,1),d=new i,c=-1;;){if(a=e+u.x+u.y,l=s+u.x-u.y,it.getWhite(t,l,a)?(a=e+u.y,l=s+u.x,it.getWhite(t,l,a)?(a=e,l=s,d.x=u.y,d.y=-u.x):(d.x=u.x,d.y=u.y)):(d.x=-u.y,d.y=u.x),r+=u.x,o+=u.y,r===h[0]&&o===h[1])break;if(h.push(r),h.push(o),n.set(r+"_"+o,!0),e=a,s=l,u.x=d.x,u.y=d.y,0===--c)break}return h},buildGraph:function(t){var e,s,n=new E;for(e=0;e<t.length;)(s=n.insertNode()).data=new F,s.data.index=e,s.data.point=new i(t[e],t[e+1]),e+=2;var r,o,h,a,l,u,d,c,g=!1;for(r=n.node;null!=r;){for(o=null!=r.next?r.next:n.node;o!=r;){for(g=!0,h=null!=r.next?r.next:n.node,u=2,l=0;h!=o;){if((a=st.distanceSquaredPointToSegment(h.data.point,r.data.point,o.data.point))<0&&(a=0),a>=it.maxDistance){g=!1;break}u++,l+=a,h=null!=h.next?h.next:n.node}if(!g)break;d=n.insertEdge(r,o),(c=new S).sumDistancesSquared=l,c.length=r.data.point.distanceTo(o.data.point),c.nodesCount=u,d.data=c,o=null!=o.next?o.next:n.node}r=r.next}return n},buildPolygon:function(t){var e,s,n,r,o,h,a,l=[],u=2147483647,d=null;for(r=t.node;r.data.index<u;){for(u=r.data.index,l.push(r.data.point.x),l.push(r.data.point.y),a=0,o=r.outgoingEdge;null!=o;)(h=o.data.nodesCount-o.data.length*Math.sqrt(o.data.sumDistancesSquared/o.data.nodesCount))>a&&(a=h,d=o),o=o.rotNextEdge;r=d.destinationNode}return e=new i(l[l.length-2],l[l.length-1]),s=new i(l[0],l[1]),n=new i(l[2],l[3]),0==st.getDirection(e,s,n)&&(l.shift(),l.shift()),l}};P.prototype={constructor:P,clear:function(t){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=[];this._edges.length>0;)this._edges.pop().dispose();for(this._edges=[];this._faces.length>0;)this._faces.pop().dispose();for(this._faces=[];this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();if(this._constraintShapes=[],!t)for(;this._objects.length>0;)this._objects.pop().dispose();this._objects=[],this.__edgesToCheck=[],this.__centerVertex=[],this.AR_vertex=null,this.AR_edge=null},dispose:function(){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=null;this._edges.length>0;)this._edges.pop().dispose();for(this._edges=null;this._faces.length>0;)this._faces.pop().dispose();for(this._faces=null;this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();for(this._constraintShapes=null;this._objects.length>0;)this._objects.pop().dispose();this._objects=null,this.__edgesToCheck=null,this.__centerVertex=null,this.AR_vertex=null,this.AR_edge=null},buildFromRecord:function(t){for(var e=t.split(";"),s=e.length,i=0;i<s;)this.insertConstraintSegment(parseFloat(e[i]),parseFloat(e[i+1]),parseFloat(e[i+2]),parseFloat(e[i+3])),i+=4},insertObject:function(t){null!=t.constraintShape&&this.deleteObject(t);var e,s=new _,r=t.coordinates;t.updateMatrixFromValues();var o=t.matrix||new n,h=new i,a=new i,l=r.length,u=0;for(u=0;u<l;u+=4)h.set(r[u],r[u+1]).transformMat2D(o),a.set(r[u+2],r[u+3]).transformMat2D(o),null!=(e=this.insertConstraintSegment(h.x,h.y,a.x,a.y))&&(e.fromShape=s,s.segments.push(e));this._constraintShapes.push(s),t.constraintShape=s,this.__objectsUpdateInProgress||this._objects.push(t)},deleteObject:function(t){if(null!=t.constraintShape&&(this.deleteConstraintShape(t.constraintShape),t.constraintShape=null,!this.__objectsUpdateInProgress)){var e=this._objects.indexOf(t);this._objects.splice(e,1)}},updateObjects:function(){this.__objectsUpdateInProgress=!0;for(var t,e=this._objects.length,s=0;s<e;)(t=this._objects[s]).hasChanged&&(this.deleteObject(t),this.insertObject(t),t.hasChanged=!1,this.isRedraw=!0),s++;this.__objectsUpdateInProgress=!1},insertConstraintShape:function(t){for(var e=new _,s=null,i=t.length,n=0;n<i;)null!=(s=this.insertConstraintSegment(t[n],t[n+1],t[n+2],t[n+3]))&&(s.fromShape=e,e.segments.push(s)),n+=4;return this._constraintShapes.push(e),e},deleteConstraintShape:function(t){for(var e=0,s=t.segments.length;e<s;)this.deleteConstraintSegment(t.segments[e]),e++;this._constraintShapes.splice(this._constraintShapes.indexOf(t),1),t.dispose()},insertConstraintSegment:function(t,e,s,n){var r=t,o=e,h=s,a=n;if(t>this.width&&s>this.width||t<0&&s<0||e>this.height&&n>this.height||e<0&&n<0)return null;var l=s-t,u=n-e,d=-1/0,c=1/0;if(0!=l){var g=(0-t)/l,x=(this.width-t)/l;d=Math.max(d,Math.min(g,x)),c=Math.min(c,Math.max(g,x))}if(0!=u){var y=(0-e)/u,_=(this.height-e)/u;d=Math.max(d,Math.min(y,_)),c=Math.min(c,Math.max(y,_))}if(!(c>=d))return null;c<1&&(h=l*c+t,a=u*c+e),d>0&&(r=l*d+t,o=u*d+e);var v=this.insertVertex(r,o);if(null==v)return null;var E=this.insertVertex(h,a);if(null==E)return null;if(v.id===E.id)return null;var w,C,S=new p,F=new m,P=new f,V=new f;P.setDatas(v,V,null,null,!0,!0),V.setDatas(E,P,null,null,!0,!0);var b,D,O,L=[],M=[],N=[],T={type:3},j=new i,R=!1;for(T=w=v,T=w;;)if(R=!1,0===T.type){for(w=T,S.fromVertex=w;null!=(C=S.next());){if(C.destinationVertex.id===E.id)return C.isConstrained||(C.isConstrained=!0,C.oppositeEdge.isConstrained=!0),C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,v.addFromConstraintSegment(F),E.addFromConstraintSegment(F),F.addEdge(C),F;if(st.distanceSquaredVertexToEdge(C.destinationVertex,P)<=1e-4){C.isConstrained||(C.isConstrained=!0,C.oppositeEdge.isConstrained=!0),C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,v.addFromConstraintSegment(F),F.addEdge(C),v=C.destinationVertex,P.originVertex=v,T=v,R=!0;break}}if(R)continue;for(S.fromVertex=w;null!=(C=S.next());)if(C=C.nextLeftEdge,st.intersections2edges(C,P,j)){if(C.isConstrained){for(v=this.splitEdge(C,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)if(C.destinationVertex.id===v.id){C.isConstrained=!0,C.oppositeEdge.isConstrained=!0,C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,F.addEdge(C);break}w.addFromConstraintSegment(F),P.originVertex=v,T=v}else L.push(C),M.unshift(C.nextLeftEdge),N.push(C.prevLeftEdge),T=C=C.oppositeEdge;break}}else if(1===T.type){if(C=T,(b=C.nextLeftEdge).destinationVertex.id===E.id)return M.unshift(b.nextLeftEdge),N.push(b),D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(E,D,null,null,!0,!0),M.push(D),N.push(O),this.insertNewConstrainedEdge(F,D,L,M,N),F;if(st.distanceSquaredVertexToEdge(b.destinationVertex,P)<=1e-4)M.unshift(b.nextLeftEdge),N.push(b),D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(b.destinationVertex,D,null,null,!0,!0),M.push(D),N.push(O),this.insertNewConstrainedEdge(F,D,L,M,N),L.splice(0,L.length),M.splice(0,M.length),N.splice(0,N.length),v=b.destinationVertex,P.originVertex=v,T=v;else if(st.intersections2edges(b,P,j))if(b.isConstrained){for(w=this.splitEdge(b,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)C.destinationVertex==M[0].originVertex&&M.unshift(C),C.destinationVertex==N[N.length-1].destinationVertex&&N.push(C.oppositeEdge);D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),M.push(D),N.push(O),this.insertNewConstrainedEdge(F,D,L,M,N),L.splice(0,L.length),M.splice(0,M.length),N.splice(0,N.length),v=w,P.originVertex=v,T=v}else L.push(b),M.unshift(b.nextLeftEdge),T=C=b.oppositeEdge;else if(b=b.nextLeftEdge,st.intersections2edges(b,P,j),b.isConstrained){for(w=this.splitEdge(b,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)C.destinationVertex.id===M[0].originVertex.id&&M.unshift(C),C.destinationVertex.id===N[N.length-1].destinationVertex.id&&N.push(C.oppositeEdge);D=new f,O=new f,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),M.push(D),N.push(O),this.insertNewConstrainedEdge(F,D,L,M,N),L.splice(0,L.length),M.splice(0,M.length),N.splice(0,N.length),v=w,P.originVertex=v,T=v}else L.push(b),N.push(b.prevLeftEdge),T=C=b.oppositeEdge}},insertNewConstrainedEdge:function(t,e,s,i,n){this._edges.push(e),this._edges.push(e.oppositeEdge),e.addFromConstraintSegment(t),e.oppositeEdge.fromConstraintSegments=e.fromConstraintSegments,t.addEdge(e),e.originVertex.addFromConstraintSegment(t),e.destinationVertex.addFromConstraintSegment(t),this.untriangulate(s),this.triangulate(i,!0),this.triangulate(n,!0)},deleteConstraintSegment:function(t){for(var e,s=[],i=null,n=t.edges.length,r=0;r<n;)(i=t.edges[r]).removeFromConstraintSegment(t),0==i.fromConstraintSegments.length&&(i.isConstrained=!1,i.oppositeEdge.isConstrained=!1),(e=i.originVertex).removeFromConstraintSegment(t),s.push(e),r++;for((e=i.destinationVertex).removeFromConstraintSegment(t),s.push(e),n=s.length,r=0;r<n;)this.deleteVertex(s[r]),r++;t.dispose()},check:function(){for(var t=this._edges.length,s=0;s<t;){if(null==this._edges[s].nextLeftEdge)return void e("!!! missing nextLeftEdge");s++}e("check OK")},insertVertex:function(t,e){if(t<0||e<0||t>this.width||e>this.height)return null;this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var s=st.locatePosition(new i(t,e),this),n=null;switch(s.type){case 0:n=s;break;case 1:var r=s;n=this.splitEdge(r,t,e);break;case 2:var o=s;n=this.splitFace(o,t,e)}return this.restoreAsDelaunay(),n},flipEdge:function(t){var e=t,s=t.oppositeEdge,i=new f,n=new f,r=e.nextLeftEdge,o=r.nextLeftEdge,h=s.nextLeftEdge,a=h.nextLeftEdge,l=e.originVertex,u=s.originVertex,d=o.originVertex,c=a.originVertex,g=e.leftFace,p=s.leftFace,y=new x,_=new x;return this._edges.push(i),this._edges.push(n),this._faces.push(_),this._faces.push(y),i.setDatas(d,n,a,_,t.isReal,t.isConstrained),n.setDatas(c,i,o,y,t.isReal,t.isConstrained),_.setDatas(i),y.setDatas(n),u.edge.id===s.id&&u.setDatas(r),l.edge.id===e.id&&l.setDatas(h),r.nextLeftEdge=i,r.leftFace=_,o.nextLeftEdge=h,o.leftFace=y,h.nextLeftEdge=n,h.leftFace=y,a.nextLeftEdge=r,a.leftFace=_,this._edges.splice(this._edges.indexOf(e),1),this._edges.splice(this._edges.indexOf(s),1),e.dispose(),s.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),n},splitEdge:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t,n=i.oppositeEdge,r=i.nextLeftEdge,o=r.nextLeftEdge,h=n.nextLeftEdge,a=h.nextLeftEdge,l=o.originVertex,u=i.originVertex,d=a.originVertex,c=n.originVertex,g=i.leftFace,p=n.leftFace;if((u.pos.x-e)*(u.pos.x-e)+(u.pos.y-s)*(u.pos.y-s)<=1e-4)return u;if((c.pos.x-e)*(c.pos.x-e)+(c.pos.y-s)*(c.pos.y-s)<=1e-4)return c;var _=new y,m=new f,v=new f,E=new f,w=new f,C=new f,S=new f,F=new f,P=new f,V=new x,b=new x,D=new x,O=new x;if(this._vertices.push(_),this._edges.push(v),this._edges.push(m),this._edges.push(S),this._edges.push(C),this._edges.push(w),this._edges.push(E),this._edges.push(P),this._edges.push(F),this._faces.push(O),this._faces.push(D),this._faces.push(b),this._faces.push(V),_.setDatas(g.isReal?v:w),_.pos.x=e,_.pos.y=s,st.projectOrthogonaly(_.pos,i),v.setDatas(_,m,o,V,g.isReal),m.setDatas(l,v,P,O,g.isReal),S.setDatas(_,C,h,b,t.isReal,t.isConstrained),C.setDatas(u,S,v,V,t.isReal,t.isConstrained),w.setDatas(_,E,a,D,p.isReal),E.setDatas(d,w,S,b,p.isReal),P.setDatas(_,F,r,O,t.isReal,t.isConstrained),F.setDatas(c,P,w,D,t.isReal,t.isConstrained),V.setDatas(v,g.isReal),b.setDatas(S,p.isReal),D.setDatas(w,p.isReal),O.setDatas(P,g.isReal),u.edge.id===i.id&&u.setDatas(C),c.edge.id===n.id&&c.setDatas(F),o.nextLeftEdge=C,o.leftFace=V,h.nextLeftEdge=E,h.leftFace=b,a.nextLeftEdge=F,a.leftFace=D,r.nextLeftEdge=m,r.leftFace=O,i.isConstrained){var L=i.fromConstraintSegments;C.fromConstraintSegments=L.slice(0),S.fromConstraintSegments=C.fromConstraintSegments,P.fromConstraintSegments=L.slice(0),F.fromConstraintSegments=P.fromConstraintSegments;for(var M,N,T=i.fromConstraintSegments.length,j=0;j<T;)-1!=(N=(M=i.fromConstraintSegments[j].edges).indexOf(i))?M.splice(N,1,C,P):M.splice(M.indexOf(n),1,F,S),j++;_.fromConstraintSegments=L.slice(0)}return this._edges.splice(this._edges.indexOf(i),1),this._edges.splice(this._edges.indexOf(n),1),i.dispose(),n.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),this.__centerVertex=_,this.__edgesToCheck.push(o),this.__edgesToCheck.push(h),this.__edgesToCheck.push(a),this.__edgesToCheck.push(r),_},splitFace:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t.edge,n=i.nextLeftEdge,r=n.nextLeftEdge,o=i.originVertex,h=n.originVertex,a=r.originVertex,l=new y,u=new f,d=new f,c=new f,g=new f,p=new f,_=new f,m=new x,v=new x,E=new x;return this._vertices.push(l),this._edges.push(u),this._edges.push(d),this._edges.push(c),this._edges.push(g),this._edges.push(p),this._edges.push(_),this._faces.push(m),this._faces.push(v),this._faces.push(E),l.setDatas(d),l.pos.x=e,l.pos.y=s,u.setDatas(o,d,_,E),d.setDatas(l,u,i,m),c.setDatas(h,g,d,m),g.setDatas(l,c,n,v),p.setDatas(a,_,g,v),_.setDatas(l,p,r,E),m.setDatas(d),v.setDatas(g),E.setDatas(_),i.nextLeftEdge=c,i.leftFace=m,n.nextLeftEdge=p,n.leftFace=v,r.nextLeftEdge=u,r.leftFace=E,this._faces.splice(this._faces.indexOf(t),1),t.dispose(),this.__centerVertex=l,this.__edgesToCheck.push(i),this.__edgesToCheck.push(n),this.__edgesToCheck.push(r),l},restoreAsDelaunay:function(){for(var t;this.__edgesToCheck.length>0;)!(t=this.__edgesToCheck.shift()).isReal||t.isConstrained||st.isDelaunay(t)||(t.nextLeftEdge.destinationVertex.id===this.__centerVertex.id?(this.__edgesToCheck.push(t.nextRightEdge),this.__edgesToCheck.push(t.prevRightEdge)):(this.__edgesToCheck.push(t.nextLeftEdge),this.__edgesToCheck.push(t.prevLeftEdge)),this.flipEdge(t))},deleteVertex:function(t){var e,s=new p;s.fromVertex=t,s.realEdgesOnly=!1;var i,n=[],r=[],o=!1,h=!1,a=[],l=[];if(e=0==t.fromConstraintSegments.length)for(;null!=(i=s.next());)n.push(i),r.push(i.nextLeftEdge);else{for(var u,d=0,c=t.fromConstraintSegments.length;d<c;){var g=d++;if((u=t.fromConstraintSegments[g].edges)[0].originVertex.id===t.id||u[u.length-1].destinationVertex.id===t.id)return!1}for(var x=0;null!=(i=s.next());)if(n.push(i),i.isConstrained&&++x>2)return!1;a=[],l=[];var y=null,_=null,m=new f,v=new f;this._edges.push(m),this._edges.push(v);for(var E=0,w=n.length;E<w;)(i=n[E++]).isConstrained?null==y?(v.setDatas(i.destinationVertex,m,null,null,!0,!0),a.push(m),a.push(i.nextLeftEdge),l.push(v),y=i):null==_&&(m.setDatas(i.destinationVertex,v,null,null,!0,!0),l.push(i.nextLeftEdge),_=i):null==y?l.push(i.nextLeftEdge):null==_?a.push(i.nextLeftEdge):l.push(i.nextLeftEdge);o=y.leftFace.isReal,h=_.leftFace.isReal,m.fromConstraintSegments=y.fromConstraintSegments.slice(0),v.fromConstraintSegments=m.fromConstraintSegments;for(var C,S=0,F=t.fromConstraintSegments.length;S<F;){var P=S++;-1!=(C=(u=t.fromConstraintSegments[P].edges).indexOf(y))?u.splice(C-1,2,m):u.splice(u.indexOf(_)-1,2,v)}}for(var V,b=0,D=n.length;b<D;)V=(i=n[b++]).leftFace,this._faces.splice(this._faces.indexOf(V),1),V.dispose(),i.destinationVertex.edge=i.nextLeftEdge,this._edges.splice(this._edges.indexOf(i.oppositeEdge),1),i.oppositeEdge.dispose(),this._edges.splice(this._edges.indexOf(i),1),i.dispose();return this._vertices.splice(this._vertices.indexOf(t),1),t.dispose(),e?this.triangulate(r,!0):(this.triangulate(a,o),this.triangulate(l,h)),!0},untriangulate:function(t){for(var e,i=new s(1),n=0,r=t.length;n<r;){var o=n++;e=t[o],null==i.get(e.originVertex)&&(e.originVertex.edge=e.prevLeftEdge.oppositeEdge,i.set(e.originVertex,!0)),null==i.get(e.destinationVertex)&&(e.destinationVertex.edge=e.nextLeftEdge,i.set(e.destinationVertex,!0)),this._faces.splice(this._faces.indexOf(e.leftFace),1),e.leftFace.dispose(),o==t.length-1&&(this._faces.splice(this._faces.indexOf(e.rightFace),1),e.rightFace.dispose())}i.dispose();for(var h=0,a=t.length;h<a;)e=t[h++],this._edges.splice(this._edges.indexOf(e.oppositeEdge),1),this._edges.splice(this._edges.indexOf(e),1),e.oppositeEdge.dispose(),e.dispose()},triangulate:function(t,s){if(t.length<2)e("BREAK ! the hole has less than 2 edges");else if(2!==t.length)if(3===t.length){var n=new x;n.setDatas(t[0],s),this._faces.push(n),t[0].leftFace=n,t[1].leftFace=n,t[2].leftFace=n,t[0].nextLeftEdge=t[1],t[1].nextLeftEdge=t[2],t[2].nextLeftEdge=t[0]}else{for(var r,o,h=t[0],a=h.originVertex,l=h.destinationVertex,u=new i,d=0,c=!1,g=0,p=2,y=t.length;p<y;){var _=p++;if(r=t[_].originVertex,1==st.getRelativePosition2(r.pos,h)){g=_,c=!0,st.getCircumcenter(a.pos,l.pos,r.pos,u),d=Z(a.pos.x-u.x,a.pos.y-u.y),d-=1e-4;for(var m=2,v=t.length;m<v;){var E=m++;if(E!=_&&(o=t[E].originVertex,Z(o.pos.x-u.x,o.pos.y-u.y)<d)){c=!1;break}}if(c)break}}c||(e("NO DELAUNAY FOUND"),g=2);var w,C,S,F,P,V,b=[];g<t.length-1&&(w=new f,C=new f,this._edges.push(w,C),w.setDatas(a,C,null,null,s,!1),C.setDatas(t[g].originVertex,w,null,null,s,!1),(P=t.slice(g)).push(w),this.triangulate(P,s)),g>2&&(S=new f,F=new f,this._edges.push(S,F),S.setDatas(t[1].originVertex,F,null,null,s,!1),F.setDatas(t[g].originVertex,S,null,null,s,!1),(V=t.slice(1,g)).push(F),this.triangulate(V,s)),2===g?b.push(h,t[1],C):g===t.length-1?b.push(h,S,t[g]):b.push(h,S,C),this.triangulate(b,s)}else e("BREAK ! the hole has only 2 edges")},findPositionFromBounds:function(t,e){return t<=0?e<=0?1:e>=this.height?7:8:t>=this.width?e<=0?3:e>=this.height?5:4:e<=0?2:e>=this.height?6:0},compute_Data:function(){var t,e,i,n=[],r=[];(i=new d).fromMesh=this;var o;o=new g;for(var h=new s(1);null!=(t=i.next());)if(h.set(t,!0),this.vertexIsInsideAABB(t,this))for(n.push(t.pos.x,t.pos.y),o.fromVertex=t;null!=(e=o.next());)h.get(e.originVertex)||(r=r.concat(e.getDatas()));h.dispose(),this.AR_vertex=new et(n),this.AR_edge=new et(r),this.data_vertex=null,this.data_edges=null},vertexIsInsideAABB:function(t,e){return!(t.pos.x<0||t.pos.x>e.width||t.pos.y<0||t.pos.y>e.height)}},V.prototype={constructor:V,dispose:function(){this.mesh=null,this.closedFaces.dispose(),this.openedFaces.dispose(),this.entryEdges.dispose(),this.predecessor.dispose(),this.entryX.dispose(),this.entryY.dispose(),this.scoreF.dispose(),this.scoreG.dispose(),this.scoreH.dispose(),this.sortedOpenedFaces=null,this.closedFaces=null,this.openedFaces=null,this.entryEdges=null,this.entryX=null,this.entryY=null,this.scoreF=null,this.scoreG=null,this.scoreH=null,this.predecessor=null},findPath:function(t,n,r,o){this.sortedOpenedFaces=[],this.closedFaces=new s(1),this.openedFaces=new s(1),this.entryEdges=new s(1),this.predecessor=new s(1),this.entryX=new s(1),this.entryY=new s(1),this.scoreF=new s(1),this.scoreG=new s(1),this.scoreH=new s(1);var h;if(0!==(h=st.locatePosition(t,this.mesh)).type){if(1===h.type){if(h.isConstrained)return;this.fromFace=h.leftFace}else 2===h.type&&(this.fromFace=h);0===(h=st.locatePosition(n,this.mesh)).type?this.toFace=h.edge.leftFace:1===h.type?this.toFace=h.leftFace:2===h.type&&(this.toFace=h),this.sortedOpenedFaces.push(this.fromFace),this.entryEdges.set(this.fromFace,null),this.entryX.set(this.fromFace,t.x),this.entryY.set(this.fromFace,t.y),this.scoreG.set(this.fromFace,0);var a=Q(n.x-t.x,n.y-t.y);this.scoreH.set(this.fromFace,a),this.scoreF.set(this.fromFace,a);for(var l,u,d,c,g,p=new i,f=new i,x=new i,y=!1;;){if(0==this.sortedOpenedFaces.length){e("AStar no path found"),this.curFace=null;break}if(this.curFace=this.sortedOpenedFaces.pop(),this.curFace==this.toFace)break;for(this.iterEdge.fromFace=this.curFace;null!=(l=this.iterEdge.next());)if(!l.isConstrained&&(u=l.rightFace,!this.closedFaces.get(u))){if(this.curFace!=this.fromFace&&this._radius>0&&!this.isWalkableByRadius(this.entryEdges.get(this.curFace),this.curFace,l))continue;p.x=this.entryX.get(this.curFace),p.y=this.entryY.get(this.curFace),f.x=p.x,f.y=p.y,f.x=.5*(l.originVertex.pos.x+l.destinationVertex.pos.x),f.y=.5*(l.originVertex.pos.y+l.destinationVertex.pos.y),x.x=f.x-n.x,x.y=f.y-n.y,g=x.length(),x.x=p.x-f.x,x.y=p.y-f.y,d=g+(c=this.scoreG.get(this.curFace)+x.length()),y=!1,null!=this.openedFaces.get(u)&&this.openedFaces.get(u)?this.scoreF.get(u)>d&&(y=!0):(this.sortedOpenedFaces.push(u),this.openedFaces.set(u,!0),y=!0),y&&(this.entryEdges.set(u,l),this.entryX.set(u,f.x),this.entryY.set(u,f.y),this.scoreF.set(u,d),this.scoreG.set(u,c),this.scoreH.set(u,g),this.predecessor.set(u,this.curFace))}this.openedFaces.set(this.curFace,!1),this.closedFaces.set(this.curFace,!0),this.sortedOpenedFaces.sort(function(t,e){return this.scoreF.get(t)==this.scoreF.get(e)?0:this.scoreF.get(t)<this.scoreF.get(e)?1:-1}.bind(this))}if(null!=this.curFace)for(r.push(this.curFace);this.curFace!=this.fromFace;)o.unshift(this.entryEdges.get(this.curFace)),this.curFace=this.predecessor.get(this.curFace),r.unshift(this.curFace)}},isWalkableByRadius:function(t,e,n){var r=null,o=null,h=null;t.originVertex==n.originVertex?(r=t.destinationVertex,o=n.destinationVertex,h=t.originVertex):t.destinationVertex==n.destinationVertex?(r=t.originVertex,o=n.originVertex,h=t.destinationVertex):t.originVertex==n.destinationVertex?(r=t.destinationVertex,o=n.originVertex,h=t.originVertex):t.destinationVertex==n.originVertex&&(r=t.originVertex,o=n.destinationVertex,h=t.destinationVertex);var a;if((h.pos.x-r.pos.x)*(o.pos.x-r.pos.x)+(h.pos.y-r.pos.y)*(o.pos.y-r.pos.y)<=0)return Z(h.pos.x-r.pos.x,h.pos.y-r.pos.y)>=this.diameterSquared;if((h.pos.x-o.pos.x)*(r.pos.x-o.pos.x)+(h.pos.y-o.pos.y)*(r.pos.y-o.pos.y)<=0)return Z(h.pos.x-o.pos.x,h.pos.y-o.pos.y)>=this.diameterSquared;if((a=e.edge!=t&&e.edge.oppositeEdge!=t&&e.edge!=n&&e.edge.oppositeEdge!=n?e.edge:e.edge.nextLeftEdge!=t&&e.edge.nextLeftEdge.oppositeEdge!=t&&e.edge.nextLeftEdge!=n&&e.edge.nextLeftEdge.oppositeEdge!=n?e.edge.nextLeftEdge:e.edge.prevLeftEdge).isConstrained){var l=new i(h.pos.x,h.pos.y);return st.projectOrthogonaly(l,a),Z(l.x-h.pos.x,l.y-h.pos.y)>=this.diameterSquared}var u=Z(h.pos.x-r.pos.x,h.pos.y-r.pos.y),d=Z(h.pos.x-o.pos.x,h.pos.y-o.pos.y);if(u<this.diameterSquared||d<this.diameterSquared)return!1;var c=[],g=[],p=new s(1);if(g.push(a),a.leftFace==e){c.push(a.rightFace);var f=a.rightFace;p.set(f,!0)}else{c.push(a.leftFace);var x=a.leftFace;p.set(x,!0)}for(var y,_,m,v,E,w;c.length>0;){if(y=c.shift(),_=g.shift(),y.edge==_||y.edge==_.oppositeEdge?(m=y.edge.nextLeftEdge,E=y.edge.nextLeftEdge.nextLeftEdge):y.edge.nextLeftEdge==_||y.edge.nextLeftEdge==_.oppositeEdge?(m=y.edge,E=y.edge.nextLeftEdge.nextLeftEdge):(m=y.edge,E=y.edge.nextLeftEdge),v=m.leftFace==y?m.rightFace:m.leftFace,w=E.leftFace==y?E.rightFace:E.leftFace,!p.get(v)&&st.distanceSquaredVertexToEdge(h,m)<this.diameterSquared){if(m.isConstrained)return!1;c.push(v),g.push(m),p.set(v,!0)}if(!p.get(w)&&st.distanceSquaredVertexToEdge(h,E)<this.diameterSquared){if(E.isConstrained)return!1;c.push(w),g.push(E),p.set(w,!0)}}return p.dispose(),!0}},b.prototype={constructor:b,dispose:function(){this._sampleCircle=null},getPoint:function(t,e){return e=e||0,t=t||0,this.__point=this._poolPoints[this._currPoolPointsIndex],this.__point.set(t,e),++this._currPoolPointsIndex==this._poolPointsSize&&(this._poolPoints.push(new i),this._poolPointsSize++),this.__point},getCopyPoint:function(t){return this.getPoint(t.x,t.y)},findPath:function(t,i,n,r,o){var h=t,a=i,l=1.01*this._radius;if(this._currPoolPointsIndex=0,this._radius>0){var u,d,c,g,p,f=n[0];c=f.edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(u=Z(c.x-h.x,c.y-h.y))<=this._radiusSquared?(d=Math.sqrt(u),h.sub(c).div(d).mul(l).add(c)):(u=Z(g.x-h.x,g.y-h.y))<=this._radiusSquared?(d=Math.sqrt(u),h.sub(g).div(d).mul(l).add(g)):(u=Z(p.x-h.x,p.y-h.y))<=this._radiusSquared&&(d=Math.sqrt(u),h.sub(p).div(d).mul(l).add(p)),c=(f=n[n.length-1]).edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(u=Z(c.x-a.x,c.y-a.y))<=this._radiusSquared?(d=Math.sqrt(u),a.sub(c).div(d).mul(l).add(c)):(u=Z(g.x-a.x,g.y-a.y))<=this._radiusSquared?(d=Math.sqrt(u),a.sub(g).div(d).mul(l).add(g)):(u=Z(p.x-a.x,p.y-a.y))<=this._radiusSquared&&(d=Math.sqrt(u),a.sub(p).div(d).mul(l).add(p))}var x,y;if(x=h.clone(),y=a.clone(),1==n.length)return o.push(tt(x.x)),o.push(tt(x.y)),o.push(tt(y.x)),void o.push(tt(y.y));var _,m,v,E,w,C=null,S=null,F=st.isInFace(h,n[0]);F.type===Y&&r[0]===F&&(r.length>1&&r.shift(),n.length>1&&n.shift(),console.log("isShift",F,r,n));var P=[],V=[];P.push(x),V.push(x);var b=new s(1),D=[],O=new s(0),L=new s(0);O.set(x,0),C=r[0];var M,N,T,j=st.getRelativePosition2(h,C);N=this.getCopyPoint(C.destinationVertex.pos),T=this.getCopyPoint(C.originVertex.pos),D.push(N),D.push(T),L.set(x,N),L.set(N,T),M=T,1==j?(O.set(N,1),O.set(T,-1),b.set(C.destinationVertex,1),b.set(C.originVertex,-1)):-1==j&&(O.set(N,-1),O.set(T,1),b.set(C.destinationVertex,-1),b.set(C.originVertex,1));for(var R=r[0].originVertex,k=r[0].destinationVertex,I=1,A=r.length;I<A;)(C=r[I++]).originVertex==R?S=C.destinationVertex:C.destinationVertex==R?S=C.originVertex:C.originVertex==k?(S=C.destinationVertex,R=k):C.destinationVertex==k?(S=C.originVertex,R=k):e("IMPOSSIBLE TO IDENTIFY THE VERTEX !!!"),N=this.getCopyPoint(S.pos),D.push(N),w=-b.get(R),O.set(N,w),L.set(M,N),b.set(S,w),M=N,k=R,R=S;L.set(M,y),O.set(y,0);var q=[],B=new s(1);q.push(x),B.set(x,0);for(var W,G=0,X=D.length;G<X;)if(W=D[G++],-1==O.get(W)){for(m=P.length-2;m>=0;){if(-1!=(w=st.getDirection(P[m],P[m+1],W))){P.shift();for(var H=0;H<m;){H++;q.push(P[0]),B.set(P[0],1),P.shift()}q.push(P[0]),B.set(P[0],1),V.splice(0,V.length),V.push(P[0]),V.push(W);break}m--}for(V.push(W),m=V.length-3;m>=0&&-1!=(w=st.getDirection(V[m],V[m+1],W));)V.splice(m+1,1),m--}else{for(m=V.length-2;m>=0;){if(1!=(w=st.getDirection(V[m],V[m+1],W))){V.shift();for(var U=0;U<m;){U++;q.push(V[0]),B.set(V[0],-1),V.shift()}q.push(V[0]),B.set(V[0],-1),P.splice(0,P.length),P.push(V[0]),P.push(W);break}m--}for(P.push(W),m=P.length-3;m>=0&&1!=(w=st.getDirection(P[m],P[m+1],W));)P.splice(m+1,1),m--}var K=!1;for(m=V.length-2;m>=0;){if(1!=(w=st.getDirection(V[m],V[m+1],a))){V.shift();for(var z=0,Q=m+1;z<Q;){z++;q.push(V[0]),B.set(V[0],-1),V.shift()}q.push(y),B.set(y,0),K=!0;break}m--}if(!K)for(m=P.length-2;m>=0;){if(-1!=(w=st.getDirection(P[m],P[m+1],a))){P.shift();for(var J=0,$=m+1;J<$;){J++;q.push(P[0]),B.set(P[0],1),P.shift()}q.push(y),B.set(y,0),K=!0;break}m--}K||(q.push(y),B.set(y,0),K=!0);var et=[];if(this._radius>0){var it=[];if(2==q.length)this.adjustWithTangents(q[0],!1,q[1],!1,O,L,it,et);else if(q.length>2){if(this.adjustWithTangents(q[0],!1,q[1],!0,O,L,it,et),q.length>3)for(var nt=1,rt=q.length-3+1;nt<rt;){var ot=nt++;this.adjustWithTangents(q[ot],!0,q[ot+1],!0,O,L,it,et)}var ht=q.length;this.adjustWithTangents(q[ht-2],!0,q[ht-1],!1,O,L,it,et)}it.push(y),this.checkAdjustedPath(it,et,O);var at=[];for(_=it.length-2;_>=1;){for(this.smoothAngle(et[2*_-1],it[_],et[2*_],O.get(it[_]),at);0!=at.length;)et.splice(2*_,0,at.pop());_--}}else et=q;for(E=0,v=et.length;E<v;)_=E++,o.push(tt(et[_].x)),o.push(tt(et[_].y))},adjustWithTangents:function(t,s,i,n,r,o,h,a){var l=[],u=r.get(t),d=r.get(i),c=null,g=null;if(s||n)if(s)if(n)if(1==u&&1==d)st.tangentsParalCircleToCircle(this._radius,t,i,l),c=this.getPoint(l[2],l[3]),g=this.getPoint(l[4],l[5]);else if(-1==u&&-1==d)st.tangentsParalCircleToCircle(this._radius,t,i,l),c=this.getPoint(l[0],l[1]),g=this.getPoint(l[6],l[7]);else if(1==u&&-1==d){if(!st.tangentsCrossCircleToCircle(this._radius,t,i,l))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(l[2],l[3]),g=this.getPoint(l[6],l[7])}else{if(!st.tangentsCrossCircleToCircle(this._radius,t,i,l))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(l[0],l[1]),g=this.getPoint(l[4],l[5])}else{if(!st.tangentsPointToCircle(i,t,this._radius,l))return void e("NO TANGENT");l.length>0&&(1==u?(c=this.getPoint(l[0],l[1]),g=i):(c=this.getPoint(l[2],l[3]),g=i))}else{if(!st.tangentsPointToCircle(t,i,this._radius,l))return void e("NO TANGENT");1==d?(c=t,g=this.getPoint(l[2],l[3])):(c=t,g=this.getPoint(l[0],l[1]))}else c=t,g=i;for(var p=o.get(t);p!=i;){if(st.distanceSquaredPointToSegment(p,c,g)<this._radiusSquared)return this.adjustWithTangents(t,s,p,!0,r,o,h,a),void this.adjustWithTangents(p,!0,i,n,r,o,h,a);p=o.get(p)}a.push(c),a.push(g),h.push(t)},checkAdjustedPath:function(t,e,s){for(var i,n,r,o,h,a,l,u,d,c=!0,g=[],p=null,f=null;c;){c=!1;for(var x=2;x<t.length;)h=t[x],a=s.get(h),r=t[x-1],o=s.get(r),i=t[x-2],n=s.get(i),o==a&&(l=e[2*(x-2)],u=e[2*(x-1)-1],d=e[2*(x-1)],(l.x-u.x)*(d.x-u.x)+(l.y-u.y)*(d.y-u.y)>0&&(2==x?(st.tangentsPointToCircle(i,h,this._radius,g),1==a?(p=i,f=this.getPoint(g[2],g[3])):(p=i,f=this.getPoint(g[0],g[1]))):x==t.length-1?(st.tangentsPointToCircle(h,i,this._radius,g),1==n?(p=this.getPoint(g[0],g[1]),f=h):(p=this.getPoint(g[2],g[3]),f=h)):1==n&&-1==a?(st.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[6],g[7])):-1==n&&1==a?(st.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[4],g[5])):1==n&&1==a?(st.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[4],g[5])):-1==n&&-1==a&&(st.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[6],g[7])),e.splice(2*(x-2),1,p),e.splice(2*x-1,1,f),t.splice(x-1,1),e.splice(2*(x-1)-1,2),g.splice(0,g.length),x--)),x++}},smoothAngle:function(t,e,s,i,n){var r=st.getDirection(t,e,s);if(!(Z(t.x-s.x,t.y-s.y)<=this._sampleCircleDistanceSquared)){for(var o,h,a,l,u=0,d=0,c=this._numSamplesCircle;d<c;){var g=d++;a=!1,l=e.clone().add(this._sampleCircle[g]),o=st.getDirection(t,e,l),h=st.getDirection(e,s,l),1==i?-1==r?-1==o&&-1==h&&(a=!0):-1!=o&&-1!=h||(a=!0):1==r?1==o&&1==h&&(a=!0):1!=o&&1!=h||(a=!0),a?(n.splice(u,0,l),u++):u=0}-1==i&&n.reverse()}}},D.prototype={constructor:D,dispose:function(){this._mesh=null,this.astar.dispose(),this.astar=null,this.funnel.dispose(),this.funnel=null,this.listEdges=null,this.listFaces=null},findPath:function(t,s){if(s.splice(0,s.length),!st.isCircleIntersectingAnyConstraint(t,this.entity.radius,this._mesh)){this.astar.radius=this.entity.radius,this.funnel.radius=this.entity.radius,this.listFaces.splice(0,this.listFaces.length),this.listEdges.splice(0,this.listEdges.length);var i=this.entity.position;this.astar.findPath(i,t,this.listFaces,this.listEdges),0!=this.listFaces.length?this.funnel.findPath(i,t,this.listFaces,this.listEdges,s):e("PathFinder listFaces.length == 0")}}},O.prototype={constructor:O,reset:function(){this.count=0,this._currentX=this._path[this.count],this._currentY=this._path[this.count+1],this.updateEntity(),this.hasPrev=!1,this._path.length>2?this.hasNext=!0:this.hasNext=!1},prev:function(){return!!this.hasPrev&&(this.hasNext=!0,this.count--,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),0==this.count&&(this.hasPrev=!1),!0)},next:function(){return!!this.hasNext&&(this.hasPrev=!0,this.count++,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),2*(this.count+1)==this._path.length&&(this.hasNext=!1),!0)},updateEntity:function(){this.entity&&(this.entity.x=this._currentX,this.entity.y=this._currentY)}},L.prototype={constructor:L,dispose:function(){this.entity=null,this._path=null,this._preCompX=null,this._preCompY=null},reset:function(){this._path.length>0?(this.pos.x=this._path[0],this.pos.y=this._path[1],this._iPrev=0,this._iNext=2,this.hasPrev=!1,this.hasNext=!0,this._count=0,this.updateEntity()):(this.hasPrev=!1,this.hasNext=!1,this._count=0)},preCompute:function(){for(this._preCompX.splice(0,this._preCompX.length),this._preCompY.splice(0,this._preCompY.length),this._count=0,this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y),this._preComputed=!1;this.next();)this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y);this.reset(),this._preComputed=!0},prev:function(){if(!this.hasPrev)return!1;if(this.hasNext=!0,this._preComputed)return 0==--this._count&&(this.hasPrev=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iPrev],i=this._path[this._iPrev+1];if(!((e=Q(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this._iPrev-=2,this._iNext-=2,0==this._iNext)break}return 0==this._iNext?(this.pos.x=this._path[0],this.pos.y=this._path[1],this.hasPrev=!1,this._iNext=2,this._iPrev=0,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iPrev]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iPrev+1]-this.pos.y)*t/e,this.updateEntity(),!0)},next:function(){if(!this.hasNext)return!1;if(this.hasPrev=!0,this._preComputed)return++this._count==this._preCompX.length-1&&(this.hasNext=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iNext],i=this._path[this._iNext+1];if(!((e=Q(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this.pos.x=this._path[this._iNext],this.pos.y=this._path[this._iNext+1],this._iPrev+=2,this._iNext+=2,this._iNext==this._path.length)break}return this._iNext==this._path.length?(this.pos.x=this._path[this._iPrev],this.pos.y=this._path[this._iPrev+1],this.hasNext=!1,this._iNext=this._path.length-2,this._iPrev=this._iNext-2,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iNext]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iNext+1]-this.pos.y)*t/e,this.updateEntity(),!0)},applyLast:function(){this.pos.set(this._preCompX[this._count],this._preCompY[this._count])},updateEntity:function(){null!=this.entity&&(this.entity.angle=Math.atan2(this.pos.y-this.entity.position.y,this.pos.x-this.entity.position.x),this.entity.direction.angular(this.entity.angle),this.entity.position.copy(this.pos))}},M.prototype={constructor:M,isInField:function(t){if(this.world&&this.entity){this.mesh=this.world.getMesh();var e=this.entity.position,n=this.entity.direction,r=t.position,o=this.entity.radiusFOV,h=this.entity.angleFOV,a=t.radius;if(Z(e.x-r.x,e.y-r.y)>=(o+a)*(o+a))return!1;var l,u,d=new i,c=new i,g=[];st.intersections2Circles(e,o,r,a,g)&&(d.set(g[0],g[1]),c.set(g[2],g[3]));var p=e.clone().add(r).mul(.5);(0==g.length||Z(p.x-r.x,p.y-r.y)<Z(p.x-d.x,p.y-d.y))&&(g.splice(0,g.length),st.tangentsPointToCircle(e,r,a,g),d.set(g[0],g[1]),c.set(g[2],g[3]));var f=Math.cos(.5*this.entity.angleFOV),x=d.clone().sub(e),y=Math.sqrt(x.x*x.x+x.y*x.y);l=x.x/y*n.x+x.y/y*n.y>f;var _=c.clone().sub(e),m=Math.sqrt(_.x*_.x+_.y*_.y);if(u=_.x/m*n.x+_.y/m*n.y>f,!l&&!u){var v=e.clone().add(n);if(1!==st.getDirection(e,v,d)||-1!==st.getDirection(e,v,c))return!1}if(!l||!u){var E,w=new i;if(E=Math.atan2(n.y,n.x),!l){var C=new i(Math.cos(E-.5*h),Math.sin(E-.5*h)).add(e);st.intersections2segments(e,C,d,c,w,null,!0),d=w.clone()}if(!u){var S=new i(Math.cos(E+.5*h),Math.sin(E+.5*h)).add(e);st.intersections2segments(e,S,d,c,w,null,!0),c=w.clone()}}var F,P=new s,V=new s,b=[],D=st.locatePosition(e,this.mesh);2==D.type?F=D:1==D.type?F=D.leftFace:0==D.type&&(F=D.edge.leftFace);var O=[],L=new s;O.push(F),L[F]=!0;for(var M,N,T,j,R,k,I,A,q,B=new i,W=new i,G=[],X=[];O.length>0;)for(M=O.shift(),L.set(M,null),P.set(M,!0),N=M.edge,V.get(N)||V.get(N.oppositeEdge)||(X.push(N),V.set(N,!0)),N=N.nextLeftEdge,V.get(N)||V.get(N.oppositeEdge)||(X.push(N),V.set(N,!0)),N=N.nextLeftEdge,V.get(N)||V.get(N.oppositeEdge)||(X.push(N),V.set(N,!0));X.length>0;)if(N=X.pop(),T=N.originVertex.pos,j=N.destinationVertex.pos,st.clipSegmentByTriangle(T,j,e,c,d,B,W)){if(N.isConstrained){for(G.splice(0,G.length),st.intersections2segments(e,B,d,c,null,G,!0),st.intersections2segments(e,W,d,c,null,G,!0),R=G[1],(k=G[3])<R&&(R=k,k=G[1]),I=b.length-1;I>=0&&!(k>=b[I]);I--);for((q=I+1)%2==0&&b.splice(q,0,k),I=0;I<b.length&&!(R<=b[I]);I++);if((A=I)%2==0?(b.splice(A,0,R),q++):A--,b.splice(A+1,q-A-1),2==b.length&&-.01<b[0]&&b[0]<.01&&.99<b[1]&&b[1]<1.01)return!1}M=N.rightFace,L.get(M)||P.get(M)||(O.push(M),L.set(M,!0))}return!0}}},N.prototype={constructor:N,setTarget:function(t,e){this.path=[],this.target.set(t,e),this.world.pathFinder.entity=this,this.world.pathFinder.findPath(this.target,this.path),this.testPath()},testPath:function(){if(this.path&&this.path.length>0){this.pathSampler.reset(),this.tmppath=[];for(var t=this.path.length;t--;)this.tmppath[t]=this.path[t];this.pathSampler.path=this.tmppath,this.newPath=!0}},getPos:function(){return{x:this.position.x,y:this.position.y,r:-this.angle}},update:function(){var t;this.pathSampler.hasNext?(this.newPath=!1,this.isMove=!0,this.pathSampler.next()):(this.isMove=!1,this.tmppath=[]),this.isMove&&!this.isWalking&&(this.isWalking=!0),!this.isMove&&this.isWalking&&(this.isWalking=!1),null!==this.mesh&&(t=this.getPos(),this.mesh.position.set(t.x,0,t.y),this.mesh.rotation.y=t.r)}};var nt={};nt.buildFromBmpData=function(t,e,s){void 0!==s&&it.setColor(s),e=e||1;var i,n=it.buildShapes(t);if(e>=1)for(var o=0,h=n.length;o<h;){var a=o++;n[a]=r(n[a],e)}for(var l=[],u=0,d=n.length;u<d;){var c=u++;l.push(it.buildGraph(n[c]))}for(var g=[],p=0,f=l.length;p<f;){var x=p++;g.push(it.buildPolygon(l[x]))}for(var y=new v,_=0,m=g.length;_<m;){var E=_++;for(i=0;i<g[E].length-2;)y.coordinates.push(g[E][i]),y.coordinates.push(g[E][i+1]),y.coordinates.push(g[E][i+2]),y.coordinates.push(g[E][i+3]),i+=2;y.coordinates.push(g[E][0]),y.coordinates.push(g[E][1]),y.coordinates.push(g[E][i]),y.coordinates.push(g[E][i+1])}return y},j.prototype={constructor:j,getMesh:function(){return this.mesh},update:function(){for(var t,e,s=this.heroes.length,i=s;i--;)if((e=this.heroes[i]).update(),e.testSee)for(t=s;t--;)i!==t&&(this.heroes[i].isSee=this.heroes[i].fov.isInField(this.heroes[t]))},updateMesh:function(){this.mesh.updateObjects()},add:function(t){this.mesh.insertObject(t),this.objects.push(t)},addHeroe:function(t){var e=new N(t,this);return this.heroes.push(e),e},addObject:function(t){t=t||{};var e=new v;return e.coordinates=t.coord||[-1,-1,1,-1,1,-1,1,1,1,1,-1,1,-1,1,-1,-1],e.position(t.x||1,t.y||1),e.scale(t.w||1,t.h||1),e.pivot(t.px||0,t.py||0),e.rotation=t.r||0,this.mesh.insertObject(e),this.objects.push(e),e},reset:function(t,e){this.mesh.dispose(),t&&(this.w=t),e&&(this.h=e),this.mesh=T(this.w,this.h),this.pathFinder.mesh=this.mesh},rebuild:function(t){this.mesh.clear(!0),this.mesh=void 0!==t?t:T(this.w,this.h),this.pathFinder.mesh=this.mesh;for(var e=this.objects.length;e--;)this.objects[e]._constraintShape=null,this.mesh.insertObject(this.objects[e])},addBitmapZone:function(t){if((t=t||{}).url){var e=document.createElement("img");e.onload=function(){t.pixel=h(e),t.w=e.width,t.h=e.height,this.updateBitmapZone(t)}.bind(this),e.src=t.url}t.canvas&&(t.w=t.canvas.width,t.h=t.canvas.height,t.pixel=h(null,t.canvas.getContext("2d").getImageData(0,0,t.w,t.h)),this.updateBitmapZone(t)),t.img&&(t.w=t.img.width,t.h=t.img.height,t.pixel=h(t.img),this.updateBitmapZone(t))},updateBitmapZone:function(t){t=t||{};var e=nt.buildFromBmpData(t.pixel,t.precision||1.8,t.color);this.reset(t.w,t.h),this.mesh.insertObject(e);var s=U.get();s&&s.drawMesh(this.mesh)}};var rt={};rt.buildFromBmpData=function(t,e){e=e||1;var s,i=it.buildShapes(t);if(e>=1)for(var n=0,o=i.length;n<o;){var h=n++;i[h]=r(i[h],e)}for(var a=[],l=0,u=i.length;l<u;){var d=l++;a.push(it.buildGraph(i[d]))}for(var c=[],g=0,p=a.length;g<p;){var f=g++;c.push(it.buildPolygon(a[f]))}for(var x=T(t.width,t.height),y=0,_=c.length;y<_;){var m=y++;for(s=0;s<c[m].length-2;)x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3]),s+=2;x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3])}return x},k.prototype={constructor:k,generate:function(t,e,s,i){this.tileWidth=t/s|0,this.tileHeight=e/i|0,this.cols=s,this.rows=i,this.rng=new l(z(1234,7259)),this.makeGrid(),this.traverseGrid(),this.populateObject()},makeGrid:function(){this.grid=[];for(var t=0,e=this.cols;t<e;){var s=t++;this.grid[s]=[];for(var i=0,n=this.rows;i<n;){var r=i++,o=new R(s,r);this.grid[s][r]=o;var h=[s*this.tileWidth,r*this.tileHeight],a=[(s+1)*this.tileWidth,r*this.tileHeight],l=[s*this.tileWidth,(r+1)*this.tileHeight],u=[(s+1)*this.tileWidth,(r+1)*this.tileHeight];o.walls[0]=h.concat(a),o.walls[1]=a.concat(u),o.walls[2]=l.concat(u),0==r&&0==s||(o.walls[3]=h.concat(l))}}},traverseGrid:function(){for(var t=[0,1,0,-1],e=[-1,0,1,0],s=[2,3,0,1],i=this.rng.nextInRange(0,this.cols-1),n=this.rng.nextInRange(0,this.rows-1),r=[this.grid[i][n]];r.length>0;){var o=r.length-1,h=r[o];h.visited=!0;var a=[0,1,2,3];this.rng.shuffle(a);for(var l=0;l<a.length;){var u=a[l];++l;var d=h.col+t[u],c=h.row+e[u];if(d>=0&&d<this.cols&&c>=0&&c<this.rows&&!this.grid[d][c].visited){var g=this.grid[d][c];h.walls[u]=[],g.walls[s[u]]=[],g.visited=!0,r.push(g),o=-1;break}}o>=0&&r.splice(o,1)}},populateObject:function(){this.object=new v;for(var t=[],e=0,s=this.cols;e<s;)for(var i=e++,n=0,r=this.rows;n<r;)for(var o=n++,h=0,a=this.grid[i][o].walls;h<a.length;){var l=a[h];++h;for(var u=0;u<l.length;){var d=l[u];++u,t.push(d)}}this.object.coordinates=t}},I.prototype={constructor:I,generate:function(t,e,s,i){this.w=t/10,this.h=e/10,this.rooms=[],this.map=[];for(g=0;g<this.w;g++){this.map[g]=[];for(p=0;p<this.h;p++)this.map[g][p]=0}for(var n=z(10,20),r=s||5,o=i||15,h=0;h<n;h++)(c={}).x=z(1,this.w-o-1),c.y=z(1,this.h-o-1),c.w=z(r,o),c.h=z(r,o),this.DoesCollide(c)?h--:(c.w--,c.h--,this.rooms.push(c));for(this.SquashRooms(),h=0;h<n;h++)for(var a=this.rooms[h],l=this.FindClosestRoom(a),u={x:z(a.x,a.x+a.w),y:z(a.y,a.y+a.h)},d={x:z(l.x,l.x+l.w),y:z(l.y,l.y+l.h)};d.x!=u.x||d.y!=u.y;)d.x!=u.x?d.x>u.x?d.x--:d.x++:d.y!=u.y&&(d.y>u.y?d.y--:d.y++),this.map[d.x][d.y]=1;for(h=0;h<n;h++)for(var c=this.rooms[h],g=c.x;g<c.x+c.w;g++)for(p=c.y;p<c.y+c.h;p++)this.map[g][p]=1;for(g=0;g<this.w;g++)for(var p=0;p<this.h;p++)if(1==this.map[g][p])for(var f=g-1;f<=g+1;f++)for(var x=p-1;x<=p+1;x++)0==this.map[f][x]&&(this.map[f][x]=2);this.populateObject()},FindClosestRoom:function(t){for(var e={x:t.x+t.w/2,y:t.y+t.h/2},s=null,i=1e3,n=0;n<this.rooms.length;n++){var r=this.rooms[n];if(r!=t){var o={x:r.x+r.w/2,y:r.y+r.h/2},h=Math.min(Math.abs(e.x-o.x)-t.w/2-r.w/2,Math.abs(e.y-o.y)-t.h/2-r.h/2);h<i&&(i=h,s=r)}}return s},SquashRooms:function(){for(var t=0;t<10;t++)for(var e=0;e<this.rooms.length;e++)for(var s=this.rooms[e];;){var i={x:s.x,y:s.y};if(s.x>1&&s.x--,s.y>1&&s.y--,1==s.x&&1==s.y)break;if(this.DoesCollide(s,e)){s.x=i.x,s.y=i.y;break}}},DoesCollide:function(t,e){for(var s=0;s<this.rooms.length;s++)if(s!=e){var i=this.rooms[s];if(!(t.x+t.w<i.x||t.x>i.x+i.w||t.y+t.h<i.y||t.y>i.y+i.h))return!0}return!1},populateObject:function(){var t=document.createElement("canvas");t.width=10*this.w,t.height=10*this.h;var e=t.getContext("2d");e.fillStyle="#FFF",e.fillRect(0,0,t.width,t.height);for(var s=0;s<this.h;s++)for(var i=0;i<this.w;i++){var n=this.map[i][s];e.fillStyle=0===n?"#000000":1===n?"#FFFFFF":"#000000",e.fillRect(10*i,10*s,10,10)}var r=h(null,e.getImageData(0,0,10*this.w,10*this.h));this.object=nt.buildFromBmpData(r,1.8)}},A.prototype={drawImage:function(t,e,s){this.g0.drawImage(t,e,s)},drawMesh:function(t,e){var s=this.g0;void 0!==e&&e&&this.g0.clear(),t.compute_Data();for(var i=t.AR_edge,n=t.AR_vertex,r=i.length,o=0;r--;)i[(o=5*r)+4]?s.lineStyle(this.constraintsWidth,this.constraintsColor):s.lineStyle(this.edgesWidth,this.edgesColor),s.moveTo(i[o],i[o+1]),s.lineTo(i[o+2],i[o+3]),s.stroke(),s.closePath();for(s.lineStyle(this.verticesRadius,this.verticesColor),r=n.length;r--;)o=2*r,s.beginFill(this.verticesColor,this.verticesAlpha),s.drawCircle(n[o],n[o+1],this.verticesRadius),s.endFill()},drawEntity:function(t,e){var s=this.g,i=t.isSee;void 0!==e&&e&&s.clear(),i?s.beginFill(this.entitiesField):s.beginFill(this.entitiesField2),s.moveTo(t.position.x,t.position.y),s.drawCircle(t.position.x,t.position.y,t.radiusFOV,t.angle-.5*t.angleFOV,t.angle+.5*t.angleFOV),s.lineTo(t.position.x,t.position.y),s.endFill(),i?s.beginFill(this.entitiesColor):s.beginFill(this.entitiesColor2),s.drawCircle(t.position.x,t.position.y,t.radius),s.endFill()},drawPath:function(t,e){var s=this.g;if(void 0!==e&&e&&this.g.clear(),0!==t.length){s.lineStyle(this.pathsWidth,this.pathsColor),s.moveTo(t[0],t[1]);for(var i=2;i<t.length;)s.lineTo(t[i],t[i+1]),i+=2;s.stroke()}},clear:function(){this.g.clear()}},q.prototype={clear:function(){this.ctx.clearRect(0,0,this.w,this.h)},drawImage:function(t,e,s){this.ctx.drawImage(t,0,0,e||this.w,s||this.h)},drawCircle:function(t,e,s,i,n){i=i||0,n=n||G,this.ctx.beginPath(),this.ctx.arc(t,e,s,i,n,!1)},drawRect:function(t,e,s,i){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+s,e),this.ctx.lineTo(t+s,e+i),this.ctx.lineTo(t,e+i),this.ctx.stroke(),this.ctx.closePath()},lineStyle:function(t,e){this.ctx.lineWidth=t,this.ctx.strokeStyle="rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},moveTo:function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t,e)},lineTo:function(t,e){this.ctx.lineTo(t,e)},stroke:function(){this.ctx.stroke()},closePath:function(){this.ctx.closePath()},beginFill:function(t){this.ctx.fillStyle="rgba("+t.r+","+t.g+","+t.b+","+t.a+")",this.ctx.beginPath()},endFill:function(){this.ctx.closePath(),this.ctx.fill()}},B.prototype={constructor:B,drawMesh:function(t,e){},collapseBuffer:function(){for(var t=this.maxVertices,e=this.currentVertex,s=0;t>=e;)s=3*t,this.positions[s]=0,this.positions[s+1]=0,this.positions[s+2]=0,this.colors[s]=0,this.colors[s+1]=0,this.colors[s+2]=0,t--},collapsePathBuffer:function(){for(var t=this.maxPathVertices,e=this.currentPathVertex,s=0;t>=e;)s=3*t,this.positionsPath[s]=0,this.positionsPath[s+1]=0,this.positionsPath[s+2]=0,this.colorsPath[s]=0,this.colorsPath[s+1]=0,this.colorsPath[s+2]=0,t--},update:function(){this.world.mesh.isRedraw&&(this.currentVertex=0,this.world.mesh.draw(),this.collapseBuffer(),this.buffer.geometry.attributes.position.needsUpdate=!0,this.buffer.geometry.attributes.color.needsUpdate=!0),this.world.update();for(var t,e=this.world.heroes.length;e--;)if((t=this.world.heroes[e]).isSelected&&t.tmppath.length>0){this.currentPathVertex=0;for(var s=this.world.heroes[e].tmppath,i=s[0],n=s[1],r=2;r<s.length;)this.insertPath(i,n,s[r],s[r+1],1,0,0),i=s[r],n=s[r+1],r+=2;this.collapsePathBuffer(),this.bufferPath.geometry.attributes.position.needsUpdate=!0,this.bufferPath.geometry.attributes.color.needsUpdate=!0}},insertLine:function(t,e,s,i,n,r,o){var h=this.currentVertex,a=3*h;this.positions[a]=t,this.positions[a+1]=0,this.positions[a+2]=e,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,a=3*++h,this.positions[a]=s,this.positions[a+1]=0,this.positions[a+2]=i,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,this.currentVertex+=2},insertPath:function(t,e,s,i,n,r,o){var h=this.currentPathVertex,a=3*h;this.positionsPath[a]=t,this.positionsPath[a+1]=0,this.positionsPath[a+2]=e,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,a=3*++h,this.positionsPath[a]=s,this.positionsPath[a+1]=0,this.positionsPath[a+2]=i,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,this.currentPathVertex+=2}},P.prototype.draw=function(){this.compute_Data();for(var t=U.get(),e=this.AR_edge,s=e.length,i=0;s--;)e[(i=5*s)+4]?t.insertLine(e[i],e[i+1],e[i+2],e[i+3],0,0,0):t.insertLine(e[i],e[i+1],e[i+2],e[i+3],.4,.4,.4);this.isRedraw=!1},t.Point=i,t.Matrix2D=n,t.Geom2D=st,t.Edge=f,t.Face=x,t.Vertex=y,t.Shape=_,t.Segment=m,t.Object2D=v,t.Graph=E,t.Potrace=it,t.Mesh2D=P,t.AStar=V,t.Funnel=b,t.PathFinder=D,t.PathIterator=O,t.LinearPathSampler=L,t.FieldOfView=M,t.Entity=N,t.World=j,t.RectMesh=T,t.CircleMesh=function(t,e,s,i){s=s||100,t=t||s,e=e||s;for(var n=[],r=[],o=[],h=[],a=[],l=i=i||8;l--;)o.push(new x),n.push(new y),h.push(new m),r.push(new f,new f,new f);var u=new _,d=1/i;for(l=0;l<i;)n[l].pos.set(t+(s+10)*Math.cos(G*l*d),e+(s+10)*Math.sin(G*l*d)),n[l].setDatas(r[2*l]),l++;for(l=0;l<i;)a.push(t+s*Math.cos(G*l*d)),a.push(e+s*Math.sin(G*l*d)),a.push(t+s*Math.cos(G*(l+1)*d)),a.push(e+s*Math.sin(G*(l+1)*d)),l++;var c=new P(2*s,2*s);return c._vertices=n,c._edges=r,c._faces=o,c._constraintShapes.push(u),c.clipping=!1,c.insertConstraintShape(a),c.clipping=!0,c},t.BitmapObject=nt,t.BitmapMesh=rt,t.GridMaze=k,t.Dungeon=I,t.SimpleView=A,t.ThreeView=B,t.REVISION="1.0.0",t.torad=W,t.todeg=57.29577951308232,t.EPSILON=.01,t.EPSILON_SQUARED=1e-4,t.INFINITY=1/0,t.TwoPI=G,t.VERTEX=X,t.EDGE=Y,t.FACE=H,t.NULL=3,t.Main=U,t.IDX=K,t.Log=e,t.Dictionary=s,t.rand=function(t,e){return t+Math.random()*(e-t)},t.randInt=z,t.Squared=Z,t.SquaredSqrt=Q,t.nearEqual=J,t.Integral=$,t.fix=tt,t.ARRAY=et,t.ShapeSimplifier=r,t.fromImageData=h,t.ImageLoader=a,Object.defineProperty(t,"__esModule",{value:!0})});
