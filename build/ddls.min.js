!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DDLS={})}(this,function(t){"use strict";function e(t){console.log(t)}function s(t,e){this.type=t||0,0===this.type?(this.k=[],this.v=[]):this.h={}}function i(t,e){this.x=t||0,this.y=e||0}function n(t,e,s){this.rangeMin=e||0,this.rangeMax=s||1,this._originalSeed=this._currSeed=t||1234,this._numIter=0,Object.defineProperty(this,"seed",{get:function(){return this._originalSeed},set:function(t){this._originalSeed=this._currSeed=t}})}function r(){this._fromFace=null,this._nextEdge=null,Object.defineProperty(this,"fromFace",{set:function(t){this._fromFace=t,this._nextEdge=this._fromFace.edge}})}function o(){this._fromMesh=null,this._currIndex=0,Object.defineProperty(this,"fromMesh",{set:function(t){this._fromMesh=t,this._currIndex=0}})}function h(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){this._fromVertex=t,this._nextEdge=this._fromVertex.edge}})}function a(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){for(this._fromVertex=t,this._nextEdge=this._fromVertex.edge;!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function d(){this.realEdgesOnly=!0,this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){if(this._fromVertex=t,this._nextEdge=this._fromVertex.edge,null!=this._nextEdge)for(;this.realEdgesOnly&&!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function u(t,e){e=e||1;var s=t.length;if(s<=4)return[].concat(t);for(var n=t[0],r=t[1],o=t[s-2],h=t[s-1],a=-1,d=0,l=1,c=s>>1;l<c;){var g=l++,p=Y.distanceSquaredPointToSegment(new i(t[g<<1],t[1+(g<<1)]),new i(n,r),new i(o,h));p>d&&(d=p,a=g)}if(d>e*e){var f=t.slice(0,2+(a<<1)),x=t.slice(a<<1),y=u(f,e),_=u(x,e);return y.slice(0,y.length-2).concat(_)}return[n,r,o,h]}function l(t,e){this.length=t*e,this.bytes=new H.ARRAY(this.length<<2),this.width=t,this.height=e}function c(t,e){if(t){var s=t.width,i=t.height,n=document.createElement("canvas");n.width=s,n.height=i;var r=n.getContext("2d");r.drawImage(t,0,0,s,i),e=r.getImageData(0,0,s,i)}for(var o=new l(e.width,e.height),h=e.data,a=h.byteLength,d=0,u=0;d<a;)u=d++,o.bytes[u]=255&h[u];return t&&(r.clearRect(0,0,s,i),n=null,r=null),o}function g(t,e){this.images=new s(2),this.loaded=e,this.count=t.length;for(var i=0;i<t.length;){var n=t[i];++i,this.load(n)}}function p(t,e){this.entity=t||null,this.world=e||null}function f(){this.entity=null,this._path=null,this._samplingDistanceSquared=1,this._samplingDistance=1,this._preCompX=[],this._preCompY=[],this.pos=new i,this.hasPrev=!1,this.hasNext=!1,this._count=0,Object.defineProperty(this,"x",{get:function(){return this.pos.x}}),Object.defineProperty(this,"y",{get:function(){return this.pos.y}}),Object.defineProperty(this,"countMax",{get:function(){return this._preCompX.length-1}}),Object.defineProperty(this,"count",{get:function(){return this._count},set:function(t){this._count=t,this._count<0&&(this._count=0),this._count>this.countMax-1&&(this._count=this.countMax-1),0==this._count?this.hasPrev=!1:this.hasPrev=!0,this._count==this.countMax-1?this.hasNext=!1:this.hasNext=!0,this.applyLast(),this.updateEntity()}}),Object.defineProperty(this,"samplingDistance",{get:function(){return this._samplingDistance},set:function(t){this._samplingDistance=t,this._samplingDistanceSquared=this._samplingDistance*this._samplingDistance}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this._preComputed=!1,this.reset()}})}function x(t,e){this.isSee=!1,this.isWalking=!1,this.isSelected=!1,this.isMove=!1,this.world=e,t=t||{},this.position=new i(t.x||0,t.y||0),this.direction=new i(1,0),this.radius=t.r||10,this.angle=0,this.angleFOV=(t.fov||120)*H.torad,this.radiusFOV=t.distance||200,this.testSee=t.see||!1,this.path=[],this.tmppath=[],this.target=new i,this.newPath=!1,this.mesh=null,this.fov=new p(this,this.world),this.pathSampler=new f,this.pathSampler.entity=this,this.pathSampler.path=this.tmppath,this.pathSampler.samplingDistance=t.speed||10,this.entity=this}function y(){this.type=G,this.id=H.generateUUID(),this.isReal=!1,this.edge=null}function _(){this.type=W,this.id=H.generateUUID(),this.pos=new i,this.fromConstraintSegments=[],this.edge=null,this.isReal=!1}function m(t,e){this.id=H.generateUUID(),this.edges=[],this.fromShape=null}function v(){this.type=B,this.id=H.generateUUID(),this.fromConstraintSegments=[],this.isConstrained=!1,this.isReal=!1,this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,Object.defineProperty(this,"destinationVertex",{get:function(){return this.oppositeEdge.originVertex}}),Object.defineProperty(this,"nextRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge}}),Object.defineProperty(this,"rotLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"rotRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge}}),Object.defineProperty(this,"rightFace",{get:function(){return this.oppositeEdge.leftFace}})}function E(){this.id=H.generateUUID(),this.segments=[]}function S(t,e){this.id=H.generateUUID(),this.__objectsUpdateInProgress=!1,this.__centerVertex=null,this.width=t,this.height=e,this.clipping=!0,this._edges=[],this._faces=[],this._objects=[],this._vertices=[],this._constraintShapes=[],this.__edgesToCheck=[],this.AR_vertex=null,this.AR_edge=null,this.isRedraw=!0}function w(t,e){for(var s=[],i=[],n=[],r=[],o=4;o--;)n.push(new y),s.push(new _),r.push(new m),i.push(new v,new v,new v);var h=new E;s[0].pos.set(-10,-10),s[1].pos.set(t+10,-10),s[2].pos.set(t+10,e+10),s[3].pos.set(-10,e+10),s[0].setDatas(i[0]),s[1].setDatas(i[2]),s[2].setDatas(i[4]),s[3].setDatas(i[6]),i[0].setDatas(s[0],i[1],i[2],n[3],!0,!0),i[1].setDatas(s[1],i[0],i[7],n[0],!0,!0),i[2].setDatas(s[1],i[3],i[11],n[3],!0,!0),i[3].setDatas(s[2],i[2],i[8],n[1],!0,!0),i[4].setDatas(s[2],i[5],i[6],n[2],!0,!0),i[5].setDatas(s[3],i[4],i[3],n[1],!0,!0),i[6].setDatas(s[3],i[7],i[10],n[2],!0,!0),i[7].setDatas(s[0],i[6],i[9],n[0],!0,!0),i[8].setDatas(s[1],i[9],i[5],n[1],!0,!1),i[9].setDatas(s[3],i[8],i[1],n[0],!0,!1),i[10].setDatas(s[0],i[11],i[4],n[2],!1,!1),i[11].setDatas(s[2],i[10],i[0],n[3],!1,!1),n[0].setDatas(i[9],!0),n[1].setDatas(i[8],!0),n[2].setDatas(i[4],!1),n[3].setDatas(i[2],!1),s[0].fromConstraintSegments=[r[0],r[3]],s[1].fromConstraintSegments=[r[0],r[1]],s[2].fromConstraintSegments=[r[1],r[2]],s[3].fromConstraintSegments=[r[2],r[3]],i[0].fromConstraintSegments.push(r[0]),i[1].fromConstraintSegments.push(r[0]),i[2].fromConstraintSegments.push(r[1]),i[3].fromConstraintSegments.push(r[1]),i[4].fromConstraintSegments.push(r[2]),i[5].fromConstraintSegments.push(r[2]),i[6].fromConstraintSegments.push(r[3]),i[7].fromConstraintSegments.push(r[3]),r[0].edges.push(i[0]),r[1].edges.push(i[2]),r[2].edges.push(i[4]),r[3].edges.push(i[6]),r[0].fromShape=h,r[1].fromShape=h,r[2].fromShape=h,r[3].fromShape=h,h.segments.push(r[0],r[1],r[2],r[3]);var a=new S(t,e);return a._vertices=s,a._edges=i,a._faces=n,a._constraintShapes.push(h),a.clipping=!1,a.insertConstraintShape([0,0,t,0,t,0,t,e,t,e,0,e,0,e,0,0]),a.clipping=!0,a}function C(){this.iterEdge=new r,this.mesh=null,this._radius=0,this.radiusSquared=0,this.diameter=0,this.diameterSquared=0,Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this.radiusSquared=this._radius*this._radius,this.diameter=2*this._radius,this.diameterSquared=this.diameter*this.diameter}})}function P(){this._currPoolPointsIndex=0,this._poolPointsSize=3e3,this._numSamplesCircle=16,this._radiusSquared=0,this._radius=0,this._poolPoints=[];for(var t=this._poolPointsSize,e=0;e<t;){e++;this._poolPoints.push(new i)}Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){if(this._radius=H.max(0,t),this._radiusSquared=this._radius*this._radius,this._sampleCircle=[],0!=this._radius){for(var e,s=this._numSamplesCircle,n=0;n<s;){var r=n++;e=-H.TwoPI*r/this._numSamplesCircle,this._sampleCircle.push(new i(this._radius*H.cos(e),this._radius*H.sin(e)))}this._sampleCircleDistanceSquared=H.Squared(this._sampleCircle[0].x-this._sampleCircle[1].x,this._sampleCircle[0].y-this._sampleCircle[1].y)}}})}function F(){this.astar=new C,this.funnel=new P,this.listFaces=[],this.listEdges=[],this._mesh=null,this.entity=null,Object.defineProperty(this,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh=t,this.astar.mesh=t}})}function V(t,e,s,i,n,r){this.n=[t||1,e||0,s||0,i||1,n||0,r||0]}function b(){this.id=H.generateUUID(),this._pivot=new i,this._position=new i,this._scale=new i(1,1),this._matrix=new V,this._rotation=0,this._constraintShape=null,this._coordinates=[],this.hasChanged=!1,Object.defineProperty(this,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation!=t&&(this._rotation=t,this.hasChanged=!0)}}),Object.defineProperty(this,"matrix",{get:function(){return this._matrix},set:function(t){this._matrix=t,this.hasChanged=!0}}),Object.defineProperty(this,"coordinates",{get:function(){return this._coordinates},set:function(t){this._coordinates=t,this.hasChanged=!0}}),Object.defineProperty(this,"constraintShape",{get:function(){return this._constraintShape},set:function(t){this._constraintShape=t,this.hasChanged=!0}}),Object.defineProperty(this,"edges",{get:function(){for(var t,e=[],s=this._constraintShape.segments,i=s.length,n=0,r=0,o=0,h=0;n<i;)for(r=0,t=s[o=n++].edges.length;r<t;)h=r++,e.push(s[o].edges[h]);return e}})}function D(t,e){this.w=t||512,this.h=e||512,this.mesh=w(this.w,this.h),this.pathFinder=new F,this.pathFinder.mesh=this.mesh,this.heroes=[],this.shapes=[],this.segments=[],this.objects=[]}function O(){this.id=H.generateUUID(),this.edge=null,this.node=null}function L(){this.id=H.generateUUID(),this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}function I(){this.id=H.generateUUID(),this.successorNodes=new s(1),this.prev=null,this.next=null,this.outgoingEdge=null,this.data=null}function R(){}function T(){}function N(t,e){this.visited=!1,this.col=t,this.row=e;for(var s=[],i=0;i<4;){i++;s.push([])}this.walls=s}function q(t,e,s,i){this.generate(t,e,s,i)}function j(t,e,s,i){this.generate(t,e,s,i)}function k(t){this.g0=new M(t.w,t.h),this.g=new M(t.w,t.h),this.g.canvas.style.pointerEvents="none",this.g0.canvas.style.pointerEvents="auto",this.entitiesWidth=1,this.entitiesColor={r:0,g:255,b:0,a:.75},this.entitiesColor2={r:255,g:255,b:255,a:.75},this.entitiesField={r:0,g:255,b:0,a:.1},this.entitiesField2={r:255,g:255,b:255,a:.1},this.pathsWidth=2,this.pathsColor={r:255,g:255,b:0,a:.75},this.verticesRadius=1,this.verticesColor={r:255,g:120,b:0,a:.5},this.constraintsWidth=2,this.constraintsColor={r:255,g:0,b:0,a:1},this.edgesWidth=1,this.edgesColor={r:190,g:190,b:190,a:.25},this.edgesColor2={r:0,g:190,b:0,a:.25},this.mesh_data=null,this.domElement=this.g0.canvas,U.set(this)}function M(t,e){this.w=t||200,this.h=e||200,this.canvas=document.createElement("canvas"),this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.canvas.style.cssText="position:absolute; left:50%; top:50%; margin-left:"+.5*-this.w+"px; margin-top:"+.5*-this.h+"px;",document.body.appendChild(this.canvas)}function A(t,e){this.world=e,this.maxVertices=3e4,this.currentVertex=0;var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.maxVertices),3)),s.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*this.maxVertices),3)),this.positions=s.attributes.position.array,this.colors=s.attributes.color.array,s.computeBoundingSphere(),this.buffer=new THREE.LineSegments(s,new THREE.LineBasicMaterial({vertexColors:!0})),this.buffer.frustumCulled=!1,t.add(this.buffer),this.maxPathVertices=1e3,this.currentPathVertex=0;var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),this.positionsPath=i.attributes.position.array,this.colorsPath=i.attributes.color.array,s.computeBoundingSphere(),this.bufferPath=new THREE.LineSegments(i,new THREE.LineBasicMaterial({vertexColors:!0})),this.bufferPath.frustumCulled=!1,t.add(this.bufferPath),U.set(this)}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(void 0!==i&&null!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e});var U={view:null,get:function(){return this.view},set:function(t){this.view=t}},W=0,B=1,G=2;s.prototype={set:function(t,e){2===this.type?this.h[t]=e:1===this.type?this.h[t.id]=e:(this.k.push(t),this.v.push(e))},get:function(t){if(2===this.type)return this.h[t];if(1===this.type)return this.h[t.id];var e=this.k.indexOf(t);return-1!=e?this.v[e]:void 0},dispose:function(){if(0===this.type){for(;this.k.length>0;)this.k.pop();for(;this.v.length>0;)this.v.pop();this.k=null,this.v=null}else this.h=null}};var H={ARRAY:"undefined"!=typeof Float32Array?Float32Array:Array,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,torad:.017453292519943295,todeg:57.29577951308232,Pi:3.141592653589793,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,inv255:.003921569,golden:10.166407384630519,INF:1/0,NINF:-1/0,EPZ:1e-5,EPZ2:1e-6,EPSILON:.01,EPSILON_SQUARED:1e-4,Squared:function(t,e){return t*t+e*e},SquaredSqrt:function(t,e){return H.sqrt(t*t+e*e)},isFinite:function(t){return isFinite(t)},int:function(t){return Math.floor(t)},fix:function(t,e){return 1*t.toFixed(e||3)},lerp:function(t,e,s){return(1-s)*t+s*e},rand:function(t,e){return t+Math.random()*(e-t)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},generateUUID:function(){var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),i=0;return function(){for(var n=0;n<36;n++)8===n||13===n||18===n||23===n?s[n]="-":14===n?s[n]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),t=15&i,i>>=4,s[n]=e[19===n?3&t|8:t]);return s.join("")}}(),clamp:function(t,e,s){return H.max(e,H.min(s,t))},distance:function(t,e){var s=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2];return H.sqrt(s*s+i*i+n*n)},acosClamp:function(t){return t>1?0:t<-1?H.Pi:H.acos(t)},distanceVector:function(t,e){var s=t.x-e.x,i=t.y-e.y,n=t.z-e.z;return s*s+i*i+n*n},dotVectors:function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}};i.prototype={constructor:i,set:function(t,e){return this.x=t,this.y=e,this},transform:function(t){return t.tranform(this),this},copy:function(t){return this.x=t.x,this.y=t.y,this},clone:function(){return new i(this.x,this.y)},sub:function(t){return this.x-=t.x,this.y-=t.y,this},mul:function(t){return this.x*=t,this.y*=t,this},add:function(t){return this.x+=t.x,this.y+=t.y,this},div:function(t){var e=1/t;return this.x*=e,this.y*=e,this},negate:function(){return new i(-this.x,-this.y)},transformMat2D:function(t){var e=this.x,s=this.y,i=t.n;return this.x=i[0]*e+i[2]*s+i[4],this.y=i[1]*e+i[3]*s+i[5],this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},angular:function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this},normalize:function(){var t=this.length();return this.x/=t,this.y/=t,t},distanceTo:function(t){var e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)},distanceSquaredTo:function(t){var e=this.x-t.x,s=this.y-t.y;return e*e+s*s},equals:function(t){return this.x===t.x&&this.y===t.y}},n.prototype={constructor:n,reset:function(){this._currSeed=this._originalSeed,this._numIter=0},next:function(){var t=1*this._currSeed;for(this._tempString=(t*t).toString();this._tempString.length<8;)this._tempString="0"+this._tempString;this._currSeed=parseInt(this._tempString.substr(1,5));var e=Math.round(this.rangeMin+this._currSeed/99999*(this.rangeMax-this.rangeMin));return 0===this._currSeed&&(this._currSeed=this._originalSeed+this._numIter),200===++this._numIter&&this.reset(),e},nextInRange:function(t,e){return this.rangeMin=t,this.rangeMax=e,this.next()},shuffle:function(t){for(var e,s,i=t.length;i>0;)e=this.nextInRange(0,i-1),s=t[--i],t[i]=t[e],t[e]=s}},r.prototype={next:function(){return null!=this._nextEdge?(this._resultEdge=this._nextEdge,this._nextEdge=this._nextEdge.nextLeftEdge,this._nextEdge==this._fromFace.edge&&(this._nextEdge=null)):this._resultEdge=null,this._resultEdge}},o.prototype={next:function(){do{if(!(this._currIndex<this._fromMesh._vertices.length)){this._resultVertex=null;break}this._resultVertex=this._fromMesh._vertices[this._currIndex],this._currIndex++}while(!this._resultVertex.isReal);return this._resultVertex}},h.prototype={next:function(){if(null!=this._nextEdge){do{if(this._resultFace=this._nextEdge.leftFace,this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null,this._resultFace.isReal||(this._resultFace=null);break}}while(!this._resultFace.isReal)}else this._resultFace=null;return this._resultFace}},a.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge.oppositeEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}},d.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(this.realEdgesOnly&&!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}};var Y={__samples:[],__circumcenter:new i,_randGen:null,locatePosition:function(t,i){var o,a;for(null==Y._randGen&&(Y._randGen=new n),Y._randGen.seed=H.int(10*t.x+4*t.y),Y.__samples.splice(0,Y.__samples.length),a=H.int(H.pow(i._vertices.length,.333333334)),Y._randGen.rangeMin=0,Y._randGen.rangeMax=i._vertices.length-1,o=0;o<a;)Y.__samples.push(i._vertices[Y._randGen.next()]),o++;var d,u,l,c=H.INF,g=null;for(o=0;o<a;)u=(d=Y.__samples[o]).pos,(l=H.Squared(u.x-t.x,u.y-t.y))<c&&(c=l,g=d),o++;var p=new h;null===g&&e("no closedVertex find ?"),p.fromVertex=g;for(var f,x=p.next(),y=new s,_=new r,m=0,v=0,E=Y.isInFace(t,x);y.get(x)||3===E.type;){if(y.set(x,!0),50==++v&&e("WALK TAKE MORE THAN 50 LOOP"),1e3==v){e("WALK TAKE MORE THAN 1000 LOOP -> WE ESCAPE"),E={type:3};break}_.fromFace=x;do{if(null===(f=_.next()))return e("KILL PATH"),null;m=Y.getRelativePosition(t,f)}while(1==m||0==m);x=f.rightFace,E=Y.isInFace(t,x)}return y.dispose(),E},isCircleIntersectingAnyConstraint:function(t,e,i){if(t.x<=0||t.x>=i.width||t.y<=0||t.y>=i.height)return!0;var n,r=Y.locatePosition(t,i);switch(r.type){case 0:n=r.edge.leftFace;break;case 1:n=r.leftFace;break;case 2:n=r;break;case 3:n=null}var o,h=e*e;if(o=n.edge.originVertex.pos,H.Squared(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.originVertex.pos,H.Squared(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.nextLeftEdge.originVertex.pos,H.Squared(o.x-t.x,o.y-t.y)<=h)return!0;var a=[];a.push(n.edge),a.push(n.edge.nextLeftEdge),a.push(n.edge.nextLeftEdge.nextLeftEdge);for(var d,u,l,c=new s(0);a.length>0;)if(d=a.pop(),c.set(d,!0),u=d.originVertex.pos,l=d.destinationVertex.pos,Y.intersectionsSegmentCircle(u,l,t,e)){if(d.isConstrained)return!0;d=d.oppositeEdge.nextLeftEdge,c.get(d)||c.get(d.oppositeEdge)||-1!=a.indexOf(d)||-1!=a.indexOf(d.oppositeEdge)||a.push(d),d=d.nextLeftEdge,c.get(d)||c.get(d.oppositeEdge)||-1!=a.indexOf(d)||-1!=a.indexOf(d.oppositeEdge)||a.push(d)}return!1},getDirection:function(t,e,s){var i=(s.x-t.x)*(e.y-t.y)+(s.y-t.y)*(-e.x+t.x);return 0==i?0:i>0?1:-1},Orient2d:function(t,e,s){var i=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x);return i>-H.EPSILON_SQUARED&&i<H.EPSILON_SQUARED?0:i>0?-1:1},getRelativePosition:function(t,e){return Y.getDirection(e.originVertex.pos,e.destinationVertex.pos,t)},getRelativePosition2:function(t,e){return Y.Orient2d(e.originVertex.pos,e.destinationVertex.pos,t)},isInFace:function(t,e){var s={type:3};if(null===e)return s;var i=e.edge,n=i.nextLeftEdge,r=n.nextLeftEdge;if(Y.getRelativePosition(t,i)>=0&&Y.getRelativePosition(t,n)>=0&&Y.getRelativePosition(t,r)>=0){var o=i.originVertex,h=n.originVertex,a=r.originVertex,d=o.pos.x,u=o.pos.y,l=h.pos.x,c=h.pos.y,g=a.pos.x,p=a.pos.y,f=H.Squared(d-t.x,u-t.y),x=H.Squared(l-t.x,c-t.y),y=H.Squared(g-t.x,p-t.y),_=1/H.Squared(l-d,c-u),m=1/H.Squared(g-l,p-c),v=1/H.Squared(d-g,u-p),E=(t.x-d)*(l-d)+(t.y-u)*(c-u),S=(t.x-l)*(g-l)+(t.y-c)*(p-c),w=(t.x-g)*(d-g)+(t.y-p)*(u-p),C=x-S*S*m,P=y-w*w*v,F=f-E*E*_<=H.EPSILON_SQUARED,V=C<=H.EPSILON_SQUARED,b=P<=H.EPSILON_SQUARED;s=F?b?o:V?h:i:V?b?a:n:b?r:e}return s},clipSegmentByTriangle:function(t,e,s,i,n,r,o){var h=Y.getDirection(s,i,t),a=Y.getDirection(s,i,e);if(h<=0&&a<=0)return!1;var d=Y.getDirection(i,n,t),u=Y.getDirection(i,n,e);if(d<=0&&u<=0)return!1;var l=Y.getDirection(n,s,t),c=Y.getDirection(n,s,e);if(l<=0&&c<=0)return!1;if(h>=0&&d>=0&&l>=0&&a>=0&&u>=0&&c>=0)return r=t.clone(),o=e.clone(),!0;var g=0;return Y.intersections2segments(t,e,s,i,r,null)&&g++,0==g?Y.intersections2segments(t,e,i,n,r,null)&&g++:Y.intersections2segments(t,e,i,n,o,null)&&(-.01>r.x-o.x||r.x-o.x>H.EPSILON||-H.EPSILON>r.y-o.y||r.y-o.y>H.EPSILON)&&g++,0==g?Y.intersections2segments(t,e,n,s,r,null)&&g++:1==g&&Y.intersections2segments(t,e,n,s,o,null)&&(-H.EPSILON>r.x-o.x||r.x-o.x>H.EPSILON||-H.EPSILON>r.y-o.y||r.y-o.y>H.EPSILON)&&g++,1==g&&(h>=0&&d>=0&&l>=0?o=t.clone():a>=0&&u>=0&&c>=0?o=e.clone():g=0),g>0},isDelaunay:function(t){var e=t.originVertex,s=t.destinationVertex,i=t.nextLeftEdge.destinationVertex,n=t.nextRightEdge.destinationVertex;Y.getCircumcenter(i.pos,e.pos,s.pos,Y.__circumcenter);var r=(i.pos.x-Y.__circumcenter.x)*(i.pos.x-Y.__circumcenter.x)+(i.pos.y-Y.__circumcenter.y)*(i.pos.y-Y.__circumcenter.y);return(n.pos.x-Y.__circumcenter.x)*(n.pos.x-Y.__circumcenter.x)+(n.pos.y-Y.__circumcenter.y)*(n.pos.y-Y.__circumcenter.y)>=r},getCircumcenter:function(t,e,s,n){null==n&&(n=new i);var r=.5*(t.x+e.x),o=.5*(t.y+e.y),h=.5*(t.x+s.x),a=.5*(t.y+s.y),d=(r*(t.x-s.x)+(o-a)*(t.y-s.y)+h*(s.x-t.x))/(t.x*(s.y-e.y)+e.x*(t.y-s.y)+s.x*(e.y-t.y));return n.x=r+d*(e.y-t.y),n.y=o-d*(e.x-t.x),n},intersections2segments:function(t,e,s,i,n,r,o){null==o&&(o=!1);var h,a=0,d=0,u=(t.x-e.x)*(s.y-i.y)+(e.y-t.y)*(s.x-i.x);if(0==u)h=!1;else{h=!0;var l=1/u;o&&null==n&&null==r||(a=(t.x*(s.y-i.y)+t.y*(i.x-s.x)+s.x*i.y-s.y*i.x)*l,d=(t.x*(s.y-e.y)+t.y*(e.x-s.x)-e.x*s.y+e.y*s.x)*l,o||0<=a&&a<=1&&0<=d&&d<=1||(h=!1))}return h&&(null!=n&&(n.x=t.x+a*(e.x-t.x),n.y=t.y+a*(e.y-t.y)),null!=r&&r.push(a,d)),h},intersections2edges:function(t,e,s,i,n){return null==n&&(n=!1),Y.intersections2segments(t.originVertex.pos,t.destinationVertex.pos,e.originVertex.pos,e.destinationVertex.pos,s,i,n)},isConvex:function(t){var e,s,i=!0;return e=t.nextLeftEdge.oppositeEdge,s=t.nextRightEdge.destinationVertex,-1!=Y.getRelativePosition(s.pos,e)?i=!1:(e=t.prevRightEdge,s=t.prevLeftEdge.originVertex,-1!=Y.getRelativePosition(s.pos,e)&&(i=!1)),i},projectOrthogonaly:function(t,e){var s=e.originVertex.pos.x,i=e.originVertex.pos.y,n=e.destinationVertex.pos.x,r=e.destinationVertex.pos.y,o=t.x,h=t.y,a=(s*s-s*n-s*o+i*i-i*r-i*h+n*o+r*h)/(s*s-2*s*n+i*i-2*i*r+n*n+r*r);t.x=s+a*(n-s),t.y=i+a*(r-i)},intersections2Circles:function(t,e,s,i,n){var r,o,h,a,d,u,l;return d=H.Squared(s.x-t.x,s.y-t.y),u=1/(2*d),(t.x!=s.x||t.y!=s.y)&&d<=(e+i)*(e+i)&&d>=(e-i)*(e-i)&&(l=H.sqrt(((e+i)*(e+i)-d)*(d-(i-e)*(i-e))),r=s.clone().sub(t).mul(u),o=t.clone().add(s).mul(.5),h=r.clone().mul(e*e-i*i),a=o.clone().add(h),null!=n&&n.push(a.x+r.y*l,a.y-r.x*l,a.x-r.y*l,a.y+r.x*l),!0)},intersectionsSegmentCircle:function(t,e,s,i,n){var r,o,h,a=t.x*t.x,d=t.y*t.y,u=e.y*e.y-2*e.y*t.y+d+e.x*e.x-2*e.x*t.x+a,l=2*t.y*s.y-2*a+2*e.y*t.y-2*d+2*e.x*t.x-2*e.x*s.x+2*t.x*s.x-2*e.y*s.y,c=l*l-4*u*(d+s.y*s.y+s.x*s.x-2*t.y*s.y-2*t.x*s.x+a-i*i);if(c<0)return!1;if(0==c)return!((o=-l/(2*u))<0||o>1)&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),!0);h=(-l-(r=H.sqrt(c)))/(2*u);var g=!1;return 0<=(o=(-l+r)/(2*u))&&o<=1&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),g=!0),0<=h&&h<=1&&(null!=n&&n.push(t.x+h*(e.x-t.x),t.y+h*(e.y-t.y),h),g=!0),g},tangentsPointToCircle:function(t,e,s,i){var n=t.clone().add(e).mul(.5),r=.5*H.SquaredSqrt(t.x-e.x,t.y-e.y);return Y.intersections2Circles(n,r,e,s,i)},tangentsCrossCircleToCircle:function(t,e,s,i){var n=H.SquaredSqrt(e.x-s.x,e.y-s.y),r=.25*n,o=s.clone().sub(e).mul(.25).add(e);if(Y.intersections2Circles(e,t,o,r,i)){var h=i[0],a=i[1],d=i[2],u=i[3],l=e.clone().add(s).mul(.5),c=((h-l.x)*(s.y-e.y)+(a-l.y)*(-s.x+e.x))/(n*n),g=2*(l.x+c*(s.y-e.y))-h,p=2*(l.y-c*(s.x-e.x))-a,f=g+d-h,x=u+p-a;return i.push(f,x,g,p),!0}return!1},tangentsParalCircleToCircle:function(t,e,s,i){var n=1/H.SquaredSqrt(e.x-s.x,e.y-s.y),r=e.x+t*(s.y-e.y)*n,o=e.y+t*(-s.x+e.x)*n,h=2*e.x-r,a=2*e.y-o,d=h+s.x-e.x,u=a+s.y-e.y,l=r+s.x-e.x,c=o+s.y-e.y;i.push(r,o,h,a,d,u,l,c)},distanceSquaredPointToSegment:function(t,e,s){var i=H.Squared(s.x-e.x,s.y-e.y),n=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/i;return n<0?H.Squared(t.x-e.x,t.y-e.y):n<=1?H.Squared(e.x-t.x,e.y-t.y)-n*n*i:H.Squared(t.x-s.x,t.y-s.y)},distanceSquaredVertexToEdge:function(t,e){return Y.distanceSquaredPointToSegment(t.pos,e.originVertex.pos,e.destinationVertex.pos)},pathLength:function(t){for(var e,s,i,n,r=0,o=t[0],h=t[1],a=2,d=t.length;a<d;)i=(e=t[a])-o,n=(s=t[a+1])-h,r+=H.SquaredSqrt(i,n),o=e,h=s,a+=2;return r}},X=H.TwoPI;g.prototype={load:function(t){var e,s=window.document;(e=s.createElement("img")).style.cssText="position:absolute;",e.onload=function(){this.store(e,t.split("/").pop())}.bind(this),e.src=t},store:function(t,s){e("store "+s+" "+--this.count),this.images.set(s,t),0==this.count&&this.loaded()}},p.prototype={constructor:p,isInField:function(t){if(this.world&&this.entity){this.mesh=this.world.getMesh();var e=this.entity.position,n=this.entity.direction,r=t.position,o=this.entity.radiusFOV,h=this.entity.angleFOV,a=t.radius;if(H.Squared(e.x-r.x,e.y-r.y)>=(o+a)*(o+a))return!1;var d,u,l=new i,c=new i,g=[];Y.intersections2Circles(e,o,r,a,g)&&(l.set(g[0],g[1]),c.set(g[2],g[3]));var p=e.clone().add(r).mul(.5);(0==g.length||H.Squared(p.x-r.x,p.y-r.y)<H.Squared(p.x-l.x,p.y-l.y))&&(g.splice(0,g.length),Y.tangentsPointToCircle(e,r,a,g),l.set(g[0],g[1]),c.set(g[2],g[3]));var f=Math.cos(.5*this.entity.angleFOV),x=l.clone().sub(e),y=Math.sqrt(x.x*x.x+x.y*x.y);d=x.x/y*n.x+x.y/y*n.y>f;var _=c.clone().sub(e),m=Math.sqrt(_.x*_.x+_.y*_.y);if(u=_.x/m*n.x+_.y/m*n.y>f,!d&&!u){var v=e.clone().add(n);if(1!==Y.getDirection(e,v,l)||-1!==Y.getDirection(e,v,c))return!1}if(!d||!u){var E,S=new i;if(E=H.atan2(n.y,n.x),!d){var w=new i(H.cos(E-.5*h),H.sin(E-.5*h)).add(e);Y.intersections2segments(e,w,l,c,S,null,!0),l=S.clone()}if(!u){var C=new i(H.cos(E+.5*h),H.sin(E+.5*h)).add(e);Y.intersections2segments(e,C,l,c,S,null,!0),c=S.clone()}}var P,F=new s,V=new s,b=[],D=Y.locatePosition(e,this.mesh);2==D.type?P=D:1==D.type?P=D.leftFace:0==D.type&&(P=D.edge.leftFace);var O=[],L=new s;O.push(P),L[P]=!0;for(var I,R,T,N,q,j,k,M,A,U=new i,W=new i,B=[],G=[];O.length>0;)for(I=O.shift(),L.set(I,null),F.set(I,!0),R=I.edge,V.get(R)||V.get(R.oppositeEdge)||(G.push(R),V.set(R,!0)),R=R.nextLeftEdge,V.get(R)||V.get(R.oppositeEdge)||(G.push(R),V.set(R,!0)),R=R.nextLeftEdge,V.get(R)||V.get(R.oppositeEdge)||(G.push(R),V.set(R,!0));G.length>0;)if(R=G.pop(),T=R.originVertex.pos,N=R.destinationVertex.pos,Y.clipSegmentByTriangle(T,N,e,c,l,U,W)){if(R.isConstrained){for(B.splice(0,B.length),Y.intersections2segments(e,U,l,c,null,B,!0),Y.intersections2segments(e,W,l,c,null,B,!0),q=B[1],(j=B[3])<q&&(q=j,j=B[1]),k=b.length-1;k>=0&&!(j>=b[k]);k--);for((A=k+1)%2==0&&b.splice(A,0,j),k=0;k<b.length&&!(q<=b[k]);k++);if((M=k)%2==0?(b.splice(M,0,q),A++):M--,b.splice(M+1,A-M-1),2==b.length&&-H.EPSILON<b[0]&&b[0]<H.EPSILON&&1-H.EPSILON<b[1]&&b[1]<1+H.EPSILON)return!1}I=R.rightFace,L.get(I)||F.get(I)||(O.push(I),L.set(I,!0))}return!0}}},f.prototype={constructor:f,dispose:function(){this.entity=null,this._path=null,this._preCompX=null,this._preCompY=null},reset:function(){this._path.length>0?(this.pos.x=this._path[0],this.pos.y=this._path[1],this._iPrev=0,this._iNext=2,this.hasPrev=!1,this.hasNext=!0,this._count=0,this.updateEntity()):(this.hasPrev=!1,this.hasNext=!1,this._count=0)},preCompute:function(){for(this._preCompX.splice(0,this._preCompX.length),this._preCompY.splice(0,this._preCompY.length),this._count=0,this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y),this._preComputed=!1;this.next();)this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y);this.reset(),this._preComputed=!0},prev:function(){if(!this.hasPrev)return!1;if(this.hasNext=!0,this._preComputed)return 0==--this._count&&(this.hasPrev=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iPrev],i=this._path[this._iPrev+1];if(!((e=H.SquaredSqrt(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this._iPrev-=2,this._iNext-=2,0==this._iNext)break}return 0==this._iNext?(this.pos.x=this._path[0],this.pos.y=this._path[1],this.hasPrev=!1,this._iNext=2,this._iPrev=0,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iPrev]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iPrev+1]-this.pos.y)*t/e,this.updateEntity(),!0)},next:function(){if(!this.hasNext)return!1;if(this.hasPrev=!0,this._preComputed)return++this._count==this._preCompX.length-1&&(this.hasNext=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iNext],i=this._path[this._iNext+1];if(!((e=H.SquaredSqrt(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this.pos.x=this._path[this._iNext],this.pos.y=this._path[this._iNext+1],this._iPrev+=2,this._iNext+=2,this._iNext==this._path.length)break}return this._iNext==this._path.length?(this.pos.x=this._path[this._iPrev],this.pos.y=this._path[this._iPrev+1],this.hasNext=!1,this._iNext=this._path.length-2,this._iPrev=this._iNext-2,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iNext]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iNext+1]-this.pos.y)*t/e,this.updateEntity(),!0)},applyLast:function(){this.pos.set(this._preCompX[this._count],this._preCompY[this._count])},updateEntity:function(){null!=this.entity&&(this.entity.angle=H.atan2(this.pos.y-this.entity.position.y,this.pos.x-this.entity.position.x),this.entity.direction.angular(this.entity.angle),this.entity.position.copy(this.pos))}},x.prototype={constructor:x,setTarget:function(t,e){this.path=[],this.target.set(t,e),this.world.pathFinder.entity=this,this.world.pathFinder.findPath(this.target,this.path),this.testPath()},testPath:function(){if(this.path&&this.path.length>0){this.pathSampler.reset(),this.tmppath=[];for(var t=this.path.length;t--;)this.tmppath[t]=this.path[t];this.pathSampler.path=this.tmppath,this.newPath=!0}},getPos:function(){return{x:this.position.x,y:this.position.y,r:-this.angle}},update:function(){var t;this.pathSampler.hasNext?(this.newPath=!1,this.isMove=!0,this.pathSampler.next()):(this.isMove=!1,this.tmppath=[]),this.isMove&&!this.isWalking&&(this.isWalking=!0),!this.isMove&&this.isWalking&&(this.isWalking=!1),null!==this.mesh&&(t=this.getPos(),this.mesh.position.set(t.x,0,t.y),this.mesh.rotation.y=t.r)}},y.prototype={constructor:y,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},dispose:function(){this.edge=null}},_.prototype={constructor:_,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},addFromConstraintSegment:function(t){-1==this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!=e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.pos=null,this.edge=null,this.fromConstraintSegments=null},toString:function(){return"ver_id "+this.id}},m.prototype={constructor:m,addEdge:function(t){-1==this.edges.indexOf(t)&&-1==this.edges.indexOf(t.oppositeEdge)&&this.edges.push(t)},removeEdge:function(t){var e=this.edges.indexOf(t);-1==e&&(e=this.edges.indexOf(t.oppositeEdge)),-1!=e&&this.edges.splice(e,1)},dispose:function(){this.edges=null,this.fromShape=null},toString:function(){return"seg_id "+this.id}},v.prototype={constructor:v,setDatas:function(t,e,s,i,n,r){this.isConstrained=void 0!==n&&r,this.isReal=void 0===n||n,this.originVertex=t,this.oppositeEdge=e,this.nextLeftEdge=s,this.leftFace=i},getDatas:function(){return[this.originVertex.pos.x,this.originVertex.pos.y,this.destinationVertex.pos.x,this.destinationVertex.pos.y,this.isConstrained?1:0]},addFromConstraintSegment:function(t){-1===this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!==e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,this.fromConstraintSegments=null},toString:function(){return"edge "+this.originVertex.id+" - "+this.destinationVertex.id}},E.prototype={constructor:E,dispose:function(){for(;this.segments.length>0;)this.segments.pop().dispose();this.segments=null}},S.prototype={constructor:S,clear:function(t){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=[];this._edges.length>0;)this._edges.pop().dispose();for(this._edges=[];this._faces.length>0;)this._faces.pop().dispose();for(this._faces=[];this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();if(this._constraintShapes=[],!t)for(;this._objects.length>0;)this._objects.pop().dispose();this._objects=[],this.__edgesToCheck=[],this.__centerVertex=[],this.AR_vertex=null,this.AR_edge=null},dispose:function(){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=null;this._edges.length>0;)this._edges.pop().dispose();for(this._edges=null;this._faces.length>0;)this._faces.pop().dispose();for(this._faces=null;this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();for(this._constraintShapes=null;this._objects.length>0;)this._objects.pop().dispose();this._objects=null,this.__edgesToCheck=null,this.__centerVertex=null,this.AR_vertex=null,this.AR_edge=null},buildFromRecord:function(t){for(var e=t.split(";"),s=e.length,i=0;i<s;)this.insertConstraintSegment(parseFloat(e[i]),parseFloat(e[i+1]),parseFloat(e[i+2]),parseFloat(e[i+3])),i+=4},insertObject:function(t){null!=t.constraintShape&&this.deleteObject(t);var e,s=new E,n=t.coordinates;t.updateMatrixFromValues();for(var r=t.matrix,o=new i,h=new i,a=n.length,d=0;d<a;)o.set(n[d],n[d+1]).transformMat2D(r),h.set(n[d+2],n[d+3]).transformMat2D(r),null!=(e=this.insertConstraintSegment(o.x,o.y,h.x,h.y))&&(e.fromShape=s,s.segments.push(e)),d+=4;this._constraintShapes.push(s),t.constraintShape=s,this.__objectsUpdateInProgress||this._objects.push(t)},deleteObject:function(t){if(null!=t.constraintShape&&(this.deleteConstraintShape(t.constraintShape),t.constraintShape=null,!this.__objectsUpdateInProgress)){var e=this._objects.indexOf(t);this._objects.splice(e,1)}},updateObjects:function(){this.__objectsUpdateInProgress=!0;for(var t,e=this._objects.length,s=0;s<e;)(t=this._objects[s]).hasChanged&&(this.deleteObject(t),this.insertObject(t),t.hasChanged=!1,this.isRedraw=!0),s++;this.__objectsUpdateInProgress=!1},insertConstraintShape:function(t){for(var e=new E,s=null,i=t.length,n=0;n<i;)null!=(s=this.insertConstraintSegment(t[n],t[n+1],t[n+2],t[n+3]))&&(s.fromShape=e,e.segments.push(s)),n+=4;return this._constraintShapes.push(e),e},deleteConstraintShape:function(t){for(var e=0,s=t.segments.length;e<s;)this.deleteConstraintSegment(t.segments[e]),e++;this._constraintShapes.splice(this._constraintShapes.indexOf(t),1),t.dispose()},insertConstraintSegment:function(t,e,s,n){var r=t,o=e,h=s,a=n;if(t>this.width&&s>this.width||t<0&&s<0||e>this.height&&n>this.height||e<0&&n<0)return null;var u=s-t,l=n-e,c=-H.INF,g=H.INF;if(0!=u){var p=(0-t)/u,f=(this.width-t)/u;c=H.max(c,H.min(p,f)),g=H.min(g,H.max(p,f))}if(0!=l){var x=(0-e)/l,y=(this.height-e)/l;c=H.max(c,H.min(x,y)),g=H.min(g,H.max(x,y))}if(!(g>=c))return null;g<1&&(h=u*g+t,a=l*g+e),c>0&&(r=u*c+t,o=l*c+e);var _=this.insertVertex(r,o);if(null==_)return null;var E=this.insertVertex(h,a);if(null==E)return null;if(_.id==E.id)return null;var S,w,C=new d,P=new m,F=new v,V=new v;F.setDatas(_,V,null,null,!0,!0),V.setDatas(E,F,null,null,!0,!0);var b,D,O,L=[],I=[],R=[],T={type:3},N=new i,q=!1;for(T=S=_,T=S;;)if(q=!1,0===T.type){for(S=T,C.fromVertex=S;null!=(w=C.next());){if(w.destinationVertex.id==E.id)return w.isConstrained||(w.isConstrained=!0,w.oppositeEdge.isConstrained=!0),w.addFromConstraintSegment(P),w.oppositeEdge.fromConstraintSegments=w.fromConstraintSegments,_.addFromConstraintSegment(P),E.addFromConstraintSegment(P),P.addEdge(w),P;if(Y.distanceSquaredVertexToEdge(w.destinationVertex,F)<=H.EPSILON_SQUARED){w.isConstrained||(w.isConstrained=!0,w.oppositeEdge.isConstrained=!0),w.addFromConstraintSegment(P),w.oppositeEdge.fromConstraintSegments=w.fromConstraintSegments,_.addFromConstraintSegment(P),P.addEdge(w),_=w.destinationVertex,F.originVertex=_,T=_,q=!0;break}}if(q)continue;for(C.fromVertex=S;null!=(w=C.next());)if(w=w.nextLeftEdge,Y.intersections2edges(w,F,N)){if(w.isConstrained){for(_=this.splitEdge(w,N.x,N.y),C.fromVertex=S;null!=(w=C.next());)if(w.destinationVertex.id==_.id){w.isConstrained=!0,w.oppositeEdge.isConstrained=!0,w.addFromConstraintSegment(P),w.oppositeEdge.fromConstraintSegments=w.fromConstraintSegments,P.addEdge(w);break}S.addFromConstraintSegment(P),F.originVertex=_,T=_}else L.push(w),I.unshift(w.nextLeftEdge),R.push(w.prevLeftEdge),T=w=w.oppositeEdge;break}}else if(1===T.type){if(w=T,(b=w.nextLeftEdge).destinationVertex.id==E.id)return I.unshift(b.nextLeftEdge),R.push(b),D=new v,O=new v,D.setDatas(_,O,null,null,!0,!0),O.setDatas(E,D,null,null,!0,!0),I.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,I,R),P;if(Y.distanceSquaredVertexToEdge(b.destinationVertex,F)<=H.EPSILON_SQUARED)I.unshift(b.nextLeftEdge),R.push(b),D=new v,O=new v,D.setDatas(_,O,null,null,!0,!0),O.setDatas(b.destinationVertex,D,null,null,!0,!0),I.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,I,R),L.splice(0,L.length),I.splice(0,I.length),R.splice(0,R.length),_=b.destinationVertex,F.originVertex=_,T=_;else if(Y.intersections2edges(b,F,N))if(b.isConstrained){for(S=this.splitEdge(b,N.x,N.y),C.fromVertex=S;null!=(w=C.next());)w.destinationVertex==I[0].originVertex&&I.unshift(w),w.destinationVertex==R[R.length-1].destinationVertex&&R.push(w.oppositeEdge);D=new v,O=new v,D.setDatas(_,O,null,null,!0,!0),O.setDatas(S,D,null,null,!0,!0),I.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,I,R),L.splice(0,L.length),I.splice(0,I.length),R.splice(0,R.length),_=S,F.originVertex=_,T=_}else L.push(b),I.unshift(b.nextLeftEdge),T=w=b.oppositeEdge;else if(b=b.nextLeftEdge,Y.intersections2edges(b,F,N),b.isConstrained){for(S=this.splitEdge(b,N.x,N.y),C.fromVertex=S;null!=(w=C.next());)w.destinationVertex.id==I[0].originVertex.id&&I.unshift(w),w.destinationVertex.id==R[R.length-1].destinationVertex.id&&R.push(w.oppositeEdge);D=new v,O=new v,D.setDatas(_,O,null,null,!0,!0),O.setDatas(S,D,null,null,!0,!0),I.push(D),R.push(O),this.insertNewConstrainedEdge(P,D,L,I,R),L.splice(0,L.length),I.splice(0,I.length),R.splice(0,R.length),_=S,F.originVertex=_,T=_}else L.push(b),R.push(b.prevLeftEdge),T=w=b.oppositeEdge}},insertNewConstrainedEdge:function(t,e,s,i,n){this._edges.push(e),this._edges.push(e.oppositeEdge),e.addFromConstraintSegment(t),e.oppositeEdge.fromConstraintSegments=e.fromConstraintSegments,t.addEdge(e),e.originVertex.addFromConstraintSegment(t),e.destinationVertex.addFromConstraintSegment(t),this.untriangulate(s),this.triangulate(i,!0),this.triangulate(n,!0)},deleteConstraintSegment:function(t){for(var e,s=[],i=null,n=t.edges.length,r=0;r<n;)(i=t.edges[r]).removeFromConstraintSegment(t),0==i.fromConstraintSegments.length&&(i.isConstrained=!1,i.oppositeEdge.isConstrained=!1),(e=i.originVertex).removeFromConstraintSegment(t),s.push(e),r++;for((e=i.destinationVertex).removeFromConstraintSegment(t),s.push(e),n=s.length,r=0;r<n;)this.deleteVertex(s[r]),r++;t.dispose()},check:function(){for(var t=this._edges.length,s=0;s<t;){if(null==this._edges[s].nextLeftEdge)return void e("!!! missing nextLeftEdge");s++}e("check OK")},insertVertex:function(t,e){if(t<0||e<0||t>this.width||e>this.height)return null;this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var s=Y.locatePosition(new i(t,e),this),n=null;switch(s.type){case 0:n=s;break;case 1:var r=s;n=this.splitEdge(r,t,e);break;case 2:var o=s;n=this.splitFace(o,t,e)}return this.restoreAsDelaunay(),n},flipEdge:function(t){var e=t,s=t.oppositeEdge,i=new v,n=new v,r=e.nextLeftEdge,o=r.nextLeftEdge,h=s.nextLeftEdge,a=h.nextLeftEdge,d=e.originVertex,u=s.originVertex,l=o.originVertex,c=a.originVertex,g=e.leftFace,p=s.leftFace,f=new y,x=new y;return this._edges.push(i),this._edges.push(n),this._faces.push(x),this._faces.push(f),i.setDatas(l,n,a,x,t.isReal,t.isConstrained),n.setDatas(c,i,o,f,t.isReal,t.isConstrained),x.setDatas(i),f.setDatas(n),u.edge.id==s.id&&u.setDatas(r),d.edge.id==e.id&&d.setDatas(h),r.nextLeftEdge=i,r.leftFace=x,o.nextLeftEdge=h,o.leftFace=f,h.nextLeftEdge=n,h.leftFace=f,a.nextLeftEdge=r,a.leftFace=x,this._edges.splice(this._edges.indexOf(e),1),this._edges.splice(this._edges.indexOf(s),1),e.dispose(),s.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),n},splitEdge:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t,n=i.oppositeEdge,r=i.nextLeftEdge,o=r.nextLeftEdge,h=n.nextLeftEdge,a=h.nextLeftEdge,d=o.originVertex,u=i.originVertex,l=a.originVertex,c=n.originVertex,g=i.leftFace,p=n.leftFace;if((u.pos.x-e)*(u.pos.x-e)+(u.pos.y-s)*(u.pos.y-s)<=H.EPSILON_SQUARED)return u;if((c.pos.x-e)*(c.pos.x-e)+(c.pos.y-s)*(c.pos.y-s)<=H.EPSILON_SQUARED)return c;var f=new _,x=new v,m=new v,E=new v,S=new v,w=new v,C=new v,P=new v,F=new v,V=new y,b=new y,D=new y,O=new y;if(this._vertices.push(f),this._edges.push(m),this._edges.push(x),this._edges.push(C),this._edges.push(w),this._edges.push(S),this._edges.push(E),this._edges.push(F),this._edges.push(P),this._faces.push(O),this._faces.push(D),this._faces.push(b),this._faces.push(V),f.setDatas(g.isReal?m:S),f.pos.x=e,f.pos.y=s,Y.projectOrthogonaly(f.pos,i),m.setDatas(f,x,o,V,g.isReal),x.setDatas(d,m,F,O,g.isReal),C.setDatas(f,w,h,b,t.isReal,t.isConstrained),w.setDatas(u,C,m,V,t.isReal,t.isConstrained),S.setDatas(f,E,a,D,p.isReal),E.setDatas(l,S,C,b,p.isReal),F.setDatas(f,P,r,O,t.isReal,t.isConstrained),P.setDatas(c,F,S,D,t.isReal,t.isConstrained),V.setDatas(m,g.isReal),b.setDatas(C,p.isReal),D.setDatas(S,p.isReal),O.setDatas(F,g.isReal),u.edge.id===i.id&&u.setDatas(w),c.edge.id===n.id&&c.setDatas(P),o.nextLeftEdge=w,o.leftFace=V,h.nextLeftEdge=E,h.leftFace=b,a.nextLeftEdge=P,a.leftFace=D,r.nextLeftEdge=x,r.leftFace=O,i.isConstrained){var L=i.fromConstraintSegments;w.fromConstraintSegments=L.slice(0),C.fromConstraintSegments=w.fromConstraintSegments,F.fromConstraintSegments=L.slice(0),P.fromConstraintSegments=F.fromConstraintSegments;for(var I,R,T=i.fromConstraintSegments.length,N=0;N<T;)-1!=(R=(I=i.fromConstraintSegments[N].edges).indexOf(i))?I.splice(R,1,w,F):I.splice(I.indexOf(n),1,P,C),N++;f.fromConstraintSegments=L.slice(0)}return this._edges.splice(this._edges.indexOf(i),1),this._edges.splice(this._edges.indexOf(n),1),i.dispose(),n.dispose(),this._faces.splice(this._faces.indexOf(g),1),this._faces.splice(this._faces.indexOf(p),1),g.dispose(),p.dispose(),this.__centerVertex=f,this.__edgesToCheck.push(o),this.__edgesToCheck.push(h),this.__edgesToCheck.push(a),this.__edgesToCheck.push(r),f},splitFace:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t.edge,n=i.nextLeftEdge,r=n.nextLeftEdge,o=i.originVertex,h=n.originVertex,a=r.originVertex,d=new _,u=new v,l=new v,c=new v,g=new v,p=new v,f=new v,x=new y,m=new y,E=new y;return this._vertices.push(d),this._edges.push(u),this._edges.push(l),this._edges.push(c),this._edges.push(g),this._edges.push(p),this._edges.push(f),this._faces.push(x),this._faces.push(m),this._faces.push(E),d.setDatas(l),d.pos.x=e,d.pos.y=s,u.setDatas(o,l,f,E),l.setDatas(d,u,i,x),c.setDatas(h,g,l,x),g.setDatas(d,c,n,m),p.setDatas(a,f,g,m),f.setDatas(d,p,r,E),x.setDatas(l),m.setDatas(g),E.setDatas(f),i.nextLeftEdge=c,i.leftFace=x,n.nextLeftEdge=p,n.leftFace=m,r.nextLeftEdge=u,r.leftFace=E,this._faces.splice(this._faces.indexOf(t),1),t.dispose(),this.__centerVertex=d,this.__edgesToCheck.push(i),this.__edgesToCheck.push(n),this.__edgesToCheck.push(r),d},restoreAsDelaunay:function(){for(var t;this.__edgesToCheck.length>0;)!(t=this.__edgesToCheck.shift()).isReal||t.isConstrained||Y.isDelaunay(t)||(t.nextLeftEdge.destinationVertex.id===this.__centerVertex.id?(this.__edgesToCheck.push(t.nextRightEdge),this.__edgesToCheck.push(t.prevRightEdge)):(this.__edgesToCheck.push(t.nextLeftEdge),this.__edgesToCheck.push(t.prevLeftEdge)),this.flipEdge(t))},deleteVertex:function(t){var e,s=new d;s.fromVertex=t,s.realEdgesOnly=!1;var i,n=[],r=[],o=!1,h=!1,a=[],u=[];if(e=0==t.fromConstraintSegments.length)for(;null!=(i=s.next());)n.push(i),r.push(i.nextLeftEdge);else{for(var l,c=0,g=t.fromConstraintSegments.length;c<g;){var p=c++;if((l=t.fromConstraintSegments[p].edges)[0].originVertex.id==t.id||l[l.length-1].destinationVertex.id==t.id)return!1}for(var f=0;null!=(i=s.next());)if(n.push(i),i.isConstrained&&++f>2)return!1;a=[],u=[];var x=null,y=null,_=new v,m=new v;this._edges.push(_),this._edges.push(m);for(var E=0,S=n.length;E<S;)(i=n[E++]).isConstrained?null==x?(m.setDatas(i.destinationVertex,_,null,null,!0,!0),a.push(_),a.push(i.nextLeftEdge),u.push(m),x=i):null==y&&(_.setDatas(i.destinationVertex,m,null,null,!0,!0),u.push(i.nextLeftEdge),y=i):null==x?u.push(i.nextLeftEdge):null==y?a.push(i.nextLeftEdge):u.push(i.nextLeftEdge);o=x.leftFace.isReal,h=y.leftFace.isReal,_.fromConstraintSegments=x.fromConstraintSegments.slice(0),m.fromConstraintSegments=_.fromConstraintSegments;for(var w,C=0,P=t.fromConstraintSegments.length;C<P;){var F=C++;-1!=(w=(l=t.fromConstraintSegments[F].edges).indexOf(x))?l.splice(w-1,2,_):l.splice(l.indexOf(y)-1,2,m)}}for(var V,b=0,D=n.length;b<D;)V=(i=n[b++]).leftFace,this._faces.splice(this._faces.indexOf(V),1),V.dispose(),i.destinationVertex.edge=i.nextLeftEdge,this._edges.splice(this._edges.indexOf(i.oppositeEdge),1),i.oppositeEdge.dispose(),this._edges.splice(this._edges.indexOf(i),1),i.dispose();return this._vertices.splice(this._vertices.indexOf(t),1),t.dispose(),e?this.triangulate(r,!0):(this.triangulate(a,o),this.triangulate(u,h)),!0},untriangulate:function(t){for(var e,i=new s(1),n=0,r=t.length;n<r;){var o=n++;e=t[o],null==i.get(e.originVertex)&&(e.originVertex.edge=e.prevLeftEdge.oppositeEdge,i.set(e.originVertex,!0)),null==i.get(e.destinationVertex)&&(e.destinationVertex.edge=e.nextLeftEdge,i.set(e.destinationVertex,!0)),this._faces.splice(this._faces.indexOf(e.leftFace),1),e.leftFace.dispose(),o==t.length-1&&(this._faces.splice(this._faces.indexOf(e.rightFace),1),e.rightFace.dispose())}i.dispose();for(var h=0,a=t.length;h<a;)e=t[h++],this._edges.splice(this._edges.indexOf(e.oppositeEdge),1),this._edges.splice(this._edges.indexOf(e),1),e.oppositeEdge.dispose(),e.dispose()},triangulate:function(t,s){if(t.length<2)e("BREAK ! the hole has less than 2 edges");else if(2!==t.length)if(3===t.length){var n=new y;n.setDatas(t[0],s),this._faces.push(n),t[0].leftFace=n,t[1].leftFace=n,t[2].leftFace=n,t[0].nextLeftEdge=t[1],t[1].nextLeftEdge=t[2],t[2].nextLeftEdge=t[0]}else{for(var r,o,h=t[0],a=h.originVertex,d=h.destinationVertex,u=new i,l=0,c=!1,g=0,p=2,f=t.length;p<f;){var x=p++;if(r=t[x].originVertex,1==Y.getRelativePosition2(r.pos,h)){g=x,c=!0,Y.getCircumcenter(a.pos,d.pos,r.pos,u),l=H.Squared(a.pos.x-u.x,a.pos.y-u.y),l-=H.EPSILON_SQUARED;for(var _=2,m=t.length;_<m;){var E=_++;if(E!=x&&(o=t[E].originVertex,H.Squared(o.pos.x-u.x,o.pos.y-u.y)<l)){c=!1;break}}if(c)break}}c||(e("NO DELAUNAY FOUND"),g=2);var S,w,C,P,F,V,b=[];g<t.length-1&&(S=new v,w=new v,this._edges.push(S,w),S.setDatas(a,w,null,null,s,!1),w.setDatas(t[g].originVertex,S,null,null,s,!1),(F=t.slice(g)).push(S),this.triangulate(F,s)),g>2&&(C=new v,P=new v,this._edges.push(C,P),C.setDatas(t[1].originVertex,P,null,null,s,!1),P.setDatas(t[g].originVertex,C,null,null,s,!1),(V=t.slice(1,g)).push(P),this.triangulate(V,s)),2===g?b.push(h,t[1],w):g===t.length-1?b.push(h,C,t[g]):b.push(h,C,w),this.triangulate(b,s)}else e("BREAK ! the hole has only 2 edges")},findPositionFromBounds:function(t,e){return t<=0?e<=0?1:e>=this.height?7:8:t>=this.width?e<=0?3:e>=this.height?5:4:e<=0?2:e>=this.height?6:0},compute_Data:function(){var t,e,i,n=[],r=[];(i=new o).fromMesh=this;var h;h=new a;for(var d=new s(1);null!=(t=i.next());)if(d.set(t,!0),this.vertexIsInsideAABB(t,this))for(n.push(t.pos.x,t.pos.y),h.fromVertex=t;null!=(e=h.next());)d.get(e.originVertex)||(r=r.concat(e.getDatas()));d.dispose(),this.AR_vertex=new H.ARRAY(n),this.AR_edge=new H.ARRAY(r),this.data_vertex=null,this.data_edges=null},vertexIsInsideAABB:function(t,e){return!(t.pos.x<0||t.pos.x>e.width||t.pos.y<0||t.pos.y>e.height)}},C.prototype={constructor:C,dispose:function(){this.mesh=null,this.closedFaces.dispose(),this.openedFaces.dispose(),this.entryEdges.dispose(),this.predecessor.dispose(),this.entryX.dispose(),this.entryY.dispose(),this.scoreF.dispose(),this.scoreG.dispose(),this.scoreH.dispose(),this.sortedOpenedFaces=null,this.closedFaces=null,this.openedFaces=null,this.entryEdges=null,this.entryX=null,this.entryY=null,this.scoreF=null,this.scoreG=null,this.scoreH=null,this.predecessor=null},findPath:function(t,n,r,o){this.sortedOpenedFaces=[],this.closedFaces=new s(1),this.openedFaces=new s(1),this.entryEdges=new s(1),this.predecessor=new s(1),this.entryX=new s(1),this.entryY=new s(1),this.scoreF=new s(1),this.scoreG=new s(1),this.scoreH=new s(1);var h,a,d;if(0!=(h=Y.locatePosition(t,this.mesh)).type){if(1==h.type){if((a=h).isConstrained)return;this.fromFace=a.leftFace}else this.fromFace=h;0==(h=Y.locatePosition(n,this.mesh)).type?(d=h,this.toFace=d.edge.leftFace):1==h.type?(a=h,this.toFace=a.leftFace):this.toFace=h,this.sortedOpenedFaces.push(this.fromFace),this.entryEdges.set(this.fromFace,null),this.entryX.set(this.fromFace,t.x),this.entryY.set(this.fromFace,t.y),this.scoreG.set(this.fromFace,0);var u=H.SquaredSqrt(n.x-t.x,n.y-t.y);this.scoreH.set(this.fromFace,u),this.scoreF.set(this.fromFace,u);for(var l,c,g,p,f,x=new i,y=new i,_=new i,m=!1;;){if(0==this.sortedOpenedFaces.length){e("AStar no path found"),this.curFace=null;break}if(this.curFace=this.sortedOpenedFaces.pop(),this.curFace==this.toFace)break;for(this.iterEdge.fromFace=this.curFace;null!=(l=this.iterEdge.next());)if(!l.isConstrained&&(c=l.rightFace,!this.closedFaces.get(c))){if(this.curFace!=this.fromFace&&this._radius>0&&!this.isWalkableByRadius(this.entryEdges.get(this.curFace),this.curFace,l))continue;x.x=this.entryX.get(this.curFace),x.y=this.entryY.get(this.curFace),y.x=x.x,y.y=x.y,y.x=.5*(l.originVertex.pos.x+l.destinationVertex.pos.x),y.y=.5*(l.originVertex.pos.y+l.destinationVertex.pos.y),_.x=y.x-n.x,_.y=y.y-n.y,f=_.length(),_.x=x.x-y.x,_.y=x.y-y.y,g=f+(p=this.scoreG.get(this.curFace)+_.length()),m=!1,null!=this.openedFaces.get(c)&&this.openedFaces.get(c)?this.scoreF.get(c)>g&&(m=!0):(this.sortedOpenedFaces.push(c),this.openedFaces.set(c,!0),m=!0),m&&(this.entryEdges.set(c,l),this.entryX.set(c,y.x),this.entryY.set(c,y.y),this.scoreF.set(c,g),this.scoreG.set(c,p),this.scoreH.set(c,f),this.predecessor.set(c,this.curFace))}this.openedFaces.set(this.curFace,!1),this.closedFaces.set(this.curFace,!0),this.sortedOpenedFaces.sort(function(t,e){return this.scoreF.get(t)==this.scoreF.get(e)?0:this.scoreF.get(t)<this.scoreF.get(e)?1:-1}.bind(this))}if(null!=this.curFace)for(r.push(this.curFace);this.curFace!=this.fromFace;)o.unshift(this.entryEdges.get(this.curFace)),this.curFace=this.predecessor.get(this.curFace),r.unshift(this.curFace)}else d=h},isWalkableByRadius:function(t,e,n){var r=null,o=null,h=null;t.originVertex==n.originVertex?(r=t.destinationVertex,o=n.destinationVertex,h=t.originVertex):t.destinationVertex==n.destinationVertex?(r=t.originVertex,o=n.originVertex,h=t.destinationVertex):t.originVertex==n.destinationVertex?(r=t.destinationVertex,o=n.originVertex,h=t.originVertex):t.destinationVertex==n.originVertex&&(r=t.originVertex,o=n.destinationVertex,h=t.destinationVertex);var a;if((h.pos.x-r.pos.x)*(o.pos.x-r.pos.x)+(h.pos.y-r.pos.y)*(o.pos.y-r.pos.y)<=0)return H.Squared(h.pos.x-r.pos.x,h.pos.y-r.pos.y)>=this.diameterSquared;if((h.pos.x-o.pos.x)*(r.pos.x-o.pos.x)+(h.pos.y-o.pos.y)*(r.pos.y-o.pos.y)<=0)return H.Squared(h.pos.x-o.pos.x,h.pos.y-o.pos.y)>=this.diameterSquared;if((a=e.edge!=t&&e.edge.oppositeEdge!=t&&e.edge!=n&&e.edge.oppositeEdge!=n?e.edge:e.edge.nextLeftEdge!=t&&e.edge.nextLeftEdge.oppositeEdge!=t&&e.edge.nextLeftEdge!=n&&e.edge.nextLeftEdge.oppositeEdge!=n?e.edge.nextLeftEdge:e.edge.prevLeftEdge).isConstrained){var d=new i(h.pos.x,h.pos.y);return Y.projectOrthogonaly(d,a),H.Squared(d.x-h.pos.x,d.y-h.pos.y)>=this.diameterSquared}var u=H.Squared(h.pos.x-r.pos.x,h.pos.y-r.pos.y),l=H.Squared(h.pos.x-o.pos.x,h.pos.y-o.pos.y);if(u<this.diameterSquared||l<this.diameterSquared)return!1;var c=[],g=[],p=new s(1);if(g.push(a),a.leftFace==e){c.push(a.rightFace);var f=a.rightFace;p.set(f,!0)}else{c.push(a.leftFace);var x=a.leftFace;p.set(x,!0)}for(var y,_,m,v,E,S;c.length>0;){if(y=c.shift(),_=g.shift(),y.edge==_||y.edge==_.oppositeEdge?(m=y.edge.nextLeftEdge,E=y.edge.nextLeftEdge.nextLeftEdge):y.edge.nextLeftEdge==_||y.edge.nextLeftEdge==_.oppositeEdge?(m=y.edge,E=y.edge.nextLeftEdge.nextLeftEdge):(m=y.edge,E=y.edge.nextLeftEdge),v=m.leftFace==y?m.rightFace:m.leftFace,S=E.leftFace==y?E.rightFace:E.leftFace,!p.get(v)&&Y.distanceSquaredVertexToEdge(h,m)<this.diameterSquared){if(m.isConstrained)return!1;c.push(v),g.push(m),p.set(v,!0)}if(!p.get(S)&&Y.distanceSquaredVertexToEdge(h,E)<this.diameterSquared){if(E.isConstrained)return!1;c.push(S),g.push(E),p.set(S,!0)}}return p.dispose(),!0}},P.prototype={constructor:P,dispose:function(){this._sampleCircle=null},getPoint:function(t,e){return e=e||0,t=t||0,this.__point=this._poolPoints[this._currPoolPointsIndex],this.__point.set(t,e),++this._currPoolPointsIndex==this._poolPointsSize&&(this._poolPoints.push(new i),this._poolPointsSize++),this.__point},getCopyPoint:function(t){return this.getPoint(t.x,t.y)},findPath:function(t,i,n,r,o){var h=t,a=i,d=1.01*this._radius;if(this._currPoolPointsIndex=0,this._radius>0){var u,l,c,g,p,f=n[0];c=f.edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(u=H.Squared(c.x-h.x,c.y-h.y))<=this._radiusSquared?(l=H.sqrt(u),h.sub(c).div(l).mul(d).add(c)):(u=H.Squared(g.x-h.x,g.y-h.y))<=this._radiusSquared?(l=H.sqrt(u),h.sub(g).div(l).mul(d).add(g)):(u=H.Squared(p.x-h.x,p.y-h.y))<=this._radiusSquared&&(l=H.sqrt(u),h.sub(p).div(l).mul(d).add(p)),c=(f=n[n.length-1]).edge.originVertex.pos,g=f.edge.destinationVertex.pos,p=f.edge.nextLeftEdge.destinationVertex.pos,(u=H.Squared(c.x-a.x,c.y-a.y))<=this._radiusSquared?(l=H.sqrt(u),a.sub(c).div(l).mul(d).add(c)):(u=H.Squared(g.x-a.x,g.y-a.y))<=this._radiusSquared?(l=H.sqrt(u),a.sub(g).div(l).mul(d).add(g)):(u=H.Squared(p.x-a.x,p.y-a.y))<=this._radiusSquared&&(l=H.sqrt(u),a.sub(p).div(l).mul(d).add(p))}var x,y;if(x=h.clone(),y=a.clone(),1==n.length)return o.push(H.fix(x.x)),o.push(H.fix(x.y)),o.push(H.fix(y.x)),void o.push(H.fix(y.y));var _,m,v,E,S,w=null,C=null;r[0]==Y.isInFace(h,n[0])&&(r.shift(),n.shift());var P=[],F=[];P.push(x),F.push(x);var V=new s(1),b=[],D=new s(0),O=new s(0);D.set(x,0),w=r[0];var L,I,R,T=Y.getRelativePosition2(h,w);I=this.getCopyPoint(w.destinationVertex.pos),R=this.getCopyPoint(w.originVertex.pos),b.push(I),b.push(R),O.set(x,I),O.set(I,R),L=R,1==T?(D.set(I,1),D.set(R,-1),V.set(w.destinationVertex,1),V.set(w.originVertex,-1)):-1==T&&(D.set(I,-1),D.set(R,1),V.set(w.destinationVertex,-1),V.set(w.originVertex,1));for(var N=r[0].originVertex,q=r[0].destinationVertex,j=1,k=r.length;j<k;)(w=r[j++]).originVertex==N?C=w.destinationVertex:w.destinationVertex==N?C=w.originVertex:w.originVertex==q?(C=w.destinationVertex,N=q):w.destinationVertex==q?(C=w.originVertex,N=q):e("IMPOSSIBLE TO IDENTIFY THE VERTEX !!!"),I=this.getCopyPoint(C.pos),b.push(I),S=-V.get(N),D.set(I,S),O.set(L,I),V.set(C,S),L=I,q=N,N=C;O.set(L,y),D.set(y,0);var M=[],A=new s(1);M.push(x),A.set(x,0);for(var U,W=0,B=b.length;W<B;)if(U=b[W++],-1==D.get(U)){for(m=P.length-2;m>=0;){if(-1!=(S=Y.getDirection(P[m],P[m+1],U))){P.shift();for(var G=0;G<m;){G++;M.push(P[0]),A.set(P[0],1),P.shift()}M.push(P[0]),A.set(P[0],1),F.splice(0,F.length),F.push(P[0]),F.push(U);break}m--}for(F.push(U),m=F.length-3;m>=0&&-1!=(S=Y.getDirection(F[m],F[m+1],U));)F.splice(m+1,1),m--}else{for(m=F.length-2;m>=0;){if(1!=(S=Y.getDirection(F[m],F[m+1],U))){F.shift();for(var X=0;X<m;){X++;M.push(F[0]),A.set(F[0],-1),F.shift()}M.push(F[0]),A.set(F[0],-1),P.splice(0,P.length),P.push(F[0]),P.push(U);break}m--}for(P.push(U),m=P.length-3;m>=0&&1!=(S=Y.getDirection(P[m],P[m+1],U));)P.splice(m+1,1),m--}var Q=!1;for(m=F.length-2;m>=0;){if(1!=(S=Y.getDirection(F[m],F[m+1],a))){F.shift();for(var z=0,K=m+1;z<K;){z++;M.push(F[0]),A.set(F[0],-1),F.shift()}M.push(y),A.set(y,0),Q=!0;break}m--}if(!Q)for(m=P.length-2;m>=0;){if(-1!=(S=Y.getDirection(P[m],P[m+1],a))){P.shift();for(var Z=0,J=m+1;Z<J;){Z++;M.push(P[0]),A.set(P[0],1),P.shift()}M.push(y),A.set(y,0),Q=!0;break}m--}Q||(M.push(y),A.set(y,0),Q=!0);var $=[];if(this._radius>0){var tt=[];if(2==M.length)this.adjustWithTangents(M[0],!1,M[1],!1,D,O,tt,$);else if(M.length>2){if(this.adjustWithTangents(M[0],!1,M[1],!0,D,O,tt,$),M.length>3)for(var et=1,st=M.length-3+1;et<st;){var it=et++;this.adjustWithTangents(M[it],!0,M[it+1],!0,D,O,tt,$)}var nt=M.length;this.adjustWithTangents(M[nt-2],!0,M[nt-1],!1,D,O,tt,$)}tt.push(y),this.checkAdjustedPath(tt,$,D);var rt=[];for(_=tt.length-2;_>=1;){for(this.smoothAngle($[2*_-1],tt[_],$[2*_],D.get(tt[_]),rt);0!=rt.length;)$.splice(2*_,0,rt.pop());_--}}else $=M;for(E=0,v=$.length;E<v;)_=E++,o.push(H.fix($[_].x)),o.push(H.fix($[_].y))},adjustWithTangents:function(t,s,i,n,r,o,h,a){var d=[],u=r.get(t),l=r.get(i),c=null,g=null;if(s||n)if(s)if(n)if(1==u&&1==l)Y.tangentsParalCircleToCircle(this._radius,t,i,d),c=this.getPoint(d[2],d[3]),g=this.getPoint(d[4],d[5]);else if(-1==u&&-1==l)Y.tangentsParalCircleToCircle(this._radius,t,i,d),c=this.getPoint(d[0],d[1]),g=this.getPoint(d[6],d[7]);else if(1==u&&-1==l){if(!Y.tangentsCrossCircleToCircle(this._radius,t,i,d))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(d[2],d[3]),g=this.getPoint(d[6],d[7])}else{if(!Y.tangentsCrossCircleToCircle(this._radius,t,i,d))return void e("NO TANGENT, points are too close for radius");c=this.getPoint(d[0],d[1]),g=this.getPoint(d[4],d[5])}else{if(!Y.tangentsPointToCircle(i,t,this._radius,d))return void e("NO TANGENT");d.length>0&&(1==u?(c=this.getPoint(d[0],d[1]),g=i):(c=this.getPoint(d[2],d[3]),g=i))}else{if(!Y.tangentsPointToCircle(t,i,this._radius,d))return void e("NO TANGENT");1==l?(c=t,g=this.getPoint(d[2],d[3])):(c=t,g=this.getPoint(d[0],d[1]))}else c=t,g=i;for(var p=o.get(t);p!=i;){if(Y.distanceSquaredPointToSegment(p,c,g)<this._radiusSquared)return this.adjustWithTangents(t,s,p,!0,r,o,h,a),void this.adjustWithTangents(p,!0,i,n,r,o,h,a);p=o.get(p)}a.push(c),a.push(g),h.push(t)},checkAdjustedPath:function(t,e,s){for(var i,n,r,o,h,a,d,u,l,c=!0,g=[],p=null,f=null;c;){c=!1;for(var x=2;x<t.length;)h=t[x],a=s.get(h),r=t[x-1],o=s.get(r),i=t[x-2],n=s.get(i),o==a&&(d=e[2*(x-2)],u=e[2*(x-1)-1],l=e[2*(x-1)],(d.x-u.x)*(l.x-u.x)+(d.y-u.y)*(l.y-u.y)>0&&(2==x?(Y.tangentsPointToCircle(i,h,this._radius,g),1==a?(p=i,f=this.getPoint(g[2],g[3])):(p=i,f=this.getPoint(g[0],g[1]))):x==t.length-1?(Y.tangentsPointToCircle(h,i,this._radius,g),1==n?(p=this.getPoint(g[0],g[1]),f=h):(p=this.getPoint(g[2],g[3]),f=h)):1==n&&-1==a?(Y.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[6],g[7])):-1==n&&1==a?(Y.tangentsCrossCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[4],g[5])):1==n&&1==a?(Y.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[2],g[3]),f=this.getPoint(g[4],g[5])):-1==n&&-1==a&&(Y.tangentsParalCircleToCircle(this._radius,i,h,g),p=this.getPoint(g[0],g[1]),f=this.getPoint(g[6],g[7])),e.splice(2*(x-2),1,p),e.splice(2*x-1,1,f),t.splice(x-1,1),e.splice(2*(x-1)-1,2),g.splice(0,g.length),x--)),x++}},smoothAngle:function(t,e,s,i,n){var r=Y.getDirection(t,e,s);if(!(H.Squared(t.x-s.x,t.y-s.y)<=this._sampleCircleDistanceSquared)){for(var o,h,a,d,u=0,l=0,c=this._numSamplesCircle;l<c;){var g=l++;a=!1,d=e.clone().add(this._sampleCircle[g]),o=Y.getDirection(t,e,d),h=Y.getDirection(e,s,d),1==i?-1==r?-1==o&&-1==h&&(a=!0):-1!=o&&-1!=h||(a=!0):1==r?1==o&&1==h&&(a=!0):1!=o&&1!=h||(a=!0),a?(n.splice(u,0,d),u++):u=0}-1==i&&n.reverse()}}},F.prototype={constructor:F,dispose:function(){this._mesh=null,this.astar.dispose(),this.astar=null,this.funnel.dispose(),this.funnel=null,this.listEdges=null,this.listFaces=null},findPath:function(t,s){if(s.splice(0,s.length),!Y.isCircleIntersectingAnyConstraint(t,this.entity.radius,this._mesh)){this.astar.radius=this.entity.radius,this.funnel.radius=this.entity.radius,this.listFaces.splice(0,this.listFaces.length),this.listEdges.splice(0,this.listEdges.length);var i=this.entity.position;this.astar.findPath(i,t,this.listFaces,this.listEdges),0!=this.listFaces.length?this.funnel.findPath(i,t,this.listFaces,this.listEdges,s):e("PathFinder listFaces.length == 0")}}},V.prototype={constructor:V,identity:function(){return this.n=[1,0,0,1,0,0],this},translate:function(t){var e=this.n;return e[4]+=t.x,e[5]+=t.y,this},scale:function(t){var e=this.n;return e[0]*=t.x,e[1]*=t.y,e[2]*=t.x,e[3]*=t.y,e[4]*=t.x,e[5]*=t.y,this},rotate:function(t){var e=this.n,s=e[0],i=e[1],n=e[2],r=e[3],o=e[4],h=e[5],a=Math.sin(t),d=Math.cos(t);return e[0]=s*d+i*a,e[1]=-s*a+i*d,e[2]=n*d+r*a,e[3]=-n*a+d*r,e[4]=d*o+a*h,e[5]=d*h-a*o,this},tranform:function(t){var e=this.n,s=e[0]*t.x+e[2]*t.y+e[4],i=e[1]*t.x+e[3]*t.y+e[5];t.x=s,t.y=i},transformX:function(t,e){var s=this.n;return s[0]*t+s[2]*e+s[4]},transformY:function(t,e){var s=this.n;return s[1]*t+s[3]*e+s[5]},concat:function(t){var e=this.n,s=t.n,i=e[0]*s[0]+e[1]*s[2],n=e[0]*s[1]+e[1]*s[3],r=e[2]*s[0]+e[3]*s[2],o=e[2]*s[1]+e[3]*s[3],h=e[4]*s[0]+e[5]*s[2]+s[4],a=e[4]*s[1]+e[5]*s[3]+s[5];return e[0]=i,e[1]=n,e[2]=r,e[3]=o,e[4]=h,e[5]=a,this},clone:function(){var t=this.n;return new V(t[0],t[1],t[2],t[3],t[4],t[5])}},b.prototype={constructor:b,position:function(t,e){this._position.set(t,e),this.hasChanged=!0},scale:function(t,e){this._scale.set(t,e),this.hasChanged=!0},pivot:function(t,e){this._pivot.set(t,e),this.hasChanged=!0},dispose:function(){this._matrix=null,this._coordinates=null,this._constraintShape=null},updateValuesFromMatrix:function(){},updateMatrixFromValues:function(){this._matrix.identity().translate(this._pivot.negate()).scale(this._scale).rotate(this._rotation).translate(this._position)}},D.prototype={constructor:D,getMesh:function(){return this.mesh},update:function(){for(var t,e,s=this.heroes.length,i=s;i--;)if((e=this.heroes[i]).update(),e.testSee)for(t=s;t--;)i!==t&&(this.heroes[i].isSee=this.heroes[i].fov.isInField(this.heroes[t]))},updateMesh:function(){this.mesh.updateObjects()},add:function(t){this.mesh.insertObject(t),this.objects.push(t)},addHeroe:function(t){var e=new x(t,this);return this.heroes.push(e),e},addObject:function(t){t=t||{};var e=new b;return e.coordinates=t.coord||[-1,-1,1,-1,1,-1,1,1,1,1,-1,1,-1,1,-1,-1],e.position(t.x||1,t.y||1),e.scale(t.w||1,t.h||1),e.pivot(t.px||0,t.py||0),e.rotation=t.r||0,this.mesh.insertObject(e),this.objects.push(e),e},reset:function(t,e){this.mesh.dispose(),t&&(this.w=t),e&&(this.h=e),this.mesh=w(this.w,this.h),this.pathFinder.mesh=this.mesh},rebuild:function(t){this.mesh.clear(!0),this.mesh=void 0!==t?t:w(this.w,this.h),this.pathFinder.mesh=this.mesh;for(var e=this.objects.length;e--;)this.objects[e]._constraintShape=null,this.mesh.insertObject(this.objects[e])}},O.prototype={constructor:O,dispose:function(){for(;null!=this.node;)this.deleteNode(this.node)},insertNode:function(){var t=new I;return null!=this.node&&(t.next=this.node,this.node.prev=t),this.node=t,t},deleteNode:function(t){for(;null!=t.outgoingEdge;)null!=t.outgoingEdge.oppositeEdge&&this.deleteEdge(t.outgoingEdge.oppositeEdge),this.deleteEdge(t.outgoingEdge);for(var e,s=this.node;null!=s;)null!=(e=s.successorNodes.get(t))&&this.deleteEdge(e),s=s.next;this.node==t?null!=t.next?(t.next.prev=null,this.node=t.next):this.node=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.dispose()},insertEdge:function(t,e){if(null!=t.successorNodes.get(e))return null;var s=new L;null!=this.edge&&(this.edge.prev=s,s.next=this.edge),this.edge=s,s.sourceNode=t,s.destinationNode=e,t.successorNodes.set(e,s),null!=t.outgoingEdge?(t.outgoingEdge.rotPrevEdge=s,s.rotNextEdge=t.outgoingEdge,t.outgoingEdge=s):t.outgoingEdge=s;var i=e.successorNodes.get(t);return null!=i&&(s.oppositeEdge=i,i.oppositeEdge=s),s},deleteEdge:function(t){this.edge==t?null!=t.next?(t.next.prev=null,this.edge=t.next):this.edge=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.sourceNode.outgoingEdge==t?null!=t.rotNextEdge?(t.rotNextEdge.rotPrevEdge=null,t.sourceNode.outgoingEdge=t.rotNextEdge):t.sourceNode.outgoingEdge=null:null!=t.rotNextEdge?(t.rotPrevEdge.rotNextEdge=t.rotNextEdge,t.rotNextEdge.rotPrevEdge=t.rotPrevEdge):t.rotPrevEdge.rotNextEdge=null,t.dispose()}},L.prototype={dispose:function(){}},I.prototype={dispose:function(){this.successorNodes.dispose(),this.prev=null,this.next=null,this.outgoingEdge=null,this.successorNodes=null,this.data=null}};var Q={maxDistance:1,getWhite:function(t,e,s){if(e>t.width||e<0)return!1;if(s>t.height||s<0)return!1;var i=s*(4*t.width)+4*e,n=t.bytes[i+0],r=t.bytes[i+1],o=t.bytes[i+2];return 0===t.bytes[i+3]||255===n&&255===r&&255===o},buildShapes:function(t){for(var e=[],i=new s(2),n=t.height-1,r=t.width-1,o=1;o<n;o++)for(var h=0;h<r;h++)Q.getWhite(t,h,o)&&!Q.getWhite(t,h+1,o)&&(i.get(h+1+"_"+o)||e.push(Q.buildShape(t,o,h+1,i)));return i.dispose(),e},buildShape:function(t,e,s,n){var r=s,o=e,h=[r,o];n.set(r+"_"+o,!0);t.width,t.height;for(var a,d,u=new i(0,1),l=new i,c=-1;;){if(a=e+u.x+u.y,d=s+u.x-u.y,Q.getWhite(t,d,a)?(a=e+u.y,d=s+u.x,Q.getWhite(t,d,a)?(a=e,d=s,l.x=u.y,l.y=-u.x):(l.x=u.x,l.y=u.y)):(l.x=-u.y,l.y=u.x),r+=u.x,o+=u.y,r===h[0]&&o===h[1])break;if(h.push(r),h.push(o),n.set(r+"_"+o,!0),e=a,s=d,u.x=l.x,u.y=l.y,0===--c)break}return h},buildGraph:function(t){var e,s,n=new O;for(e=0;e<t.length;)(s=n.insertNode()).data=new T,s.data.index=e,s.data.point=new i(t[e],t[e+1]),e+=2;var r,o,h,a,d,u,l,c,g=!1;for(r=n.node;null!=r;){for(o=null!=r.next?r.next:n.node;o!=r;){for(g=!0,h=null!=r.next?r.next:n.node,u=2,d=0;h!=o;){if((a=Y.distanceSquaredPointToSegment(h.data.point,r.data.point,o.data.point))<0&&(a=0),a>=Q.maxDistance){g=!1;break}u++,d+=a,h=null!=h.next?h.next:n.node}if(!g)break;l=n.insertEdge(r,o),(c=new R).sumDistancesSquared=d,c.length=r.data.point.distanceTo(o.data.point),c.nodesCount=u,l.data=c,o=null!=o.next?o.next:n.node}r=r.next}return n},buildPolygon:function(t){var e,s,n,r,o,h,a,d=[],u=2147483647,l=null;for(r=t.node;r.data.index<u;){for(u=r.data.index,d.push(r.data.point.x),d.push(r.data.point.y),a=0,o=r.outgoingEdge;null!=o;)(h=o.data.nodesCount-o.data.length*H.sqrt(o.data.sumDistancesSquared/o.data.nodesCount))>a&&(a=h,l=o),o=o.rotNextEdge;r=l.destinationNode}return e=new i(d[d.length-2],d[d.length-1]),s=new i(d[0],d[1]),n=new i(d[2],d[3]),0==Y.getDirection(e,s,n)&&(d.shift(),d.shift()),d}},z={};z.buildFromBmpData=function(t,e,s,i){null==e&&(e=1);var n,r=Q.buildShapes(t,s,i);if(e>=1)for(var o=0,h=r.length;o<h;){var a=o++;r[a]=u(r[a],e)}for(var d=[],l=0,c=r.length;l<c;){var g=l++;d.push(Q.buildGraph(r[g]))}for(var p=[],f=0,x=d.length;f<x;){var y=f++;p.push(Q.buildPolygon(d[y],i))}for(var _=new b,m=0,v=p.length;m<v;){var E=m++;for(n=0;n<p[E].length-2;)_.coordinates.push(p[E][n]),_.coordinates.push(p[E][n+1]),_.coordinates.push(p[E][n+2]),_.coordinates.push(p[E][n+3]),n+=2;_.coordinates.push(p[E][0]),_.coordinates.push(p[E][1]),_.coordinates.push(p[E][n]),_.coordinates.push(p[E][n+1])}return _};var K={};K.buildFromBmpData=function(t,e){e=e||1;var s,i=Q.buildShapes(t);if(e>=1)for(var n=0,r=i.length;n<r;){var o=n++;i[o]=u(i[o],e)}for(var h=[],a=0,d=i.length;a<d;){var l=a++;h.push(Q.buildGraph(i[l]))}for(var c=[],g=0,p=h.length;g<p;){var f=g++;c.push(Q.buildPolygon(h[f]))}for(var x=w(t.width,t.height),y=0,_=c.length;y<_;){var m=y++;for(s=0;s<c[m].length-2;)x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3]),s+=2;x.insertConstraintSegment(c[m][s],c[m][s+1],c[m][s+2],c[m][s+3])}return x},q.prototype={constructor:q,generate:function(t,e,s,i){this.tileWidth=t/s|0,this.tileHeight=e/i|0,this.cols=s,this.rows=i,this.rng=new n(H.randInt(1234,7259)),this.makeGrid(),this.traverseGrid(),this.populateObject()},makeGrid:function(){this.grid=[];for(var t=0,e=this.cols;t<e;){var s=t++;this.grid[s]=[];for(var i=0,n=this.rows;i<n;){var r=i++,o=new N(s,r);this.grid[s][r]=o;var h=[s*this.tileWidth,r*this.tileHeight],a=[(s+1)*this.tileWidth,r*this.tileHeight],d=[s*this.tileWidth,(r+1)*this.tileHeight],u=[(s+1)*this.tileWidth,(r+1)*this.tileHeight];o.walls[0]=h.concat(a),o.walls[1]=a.concat(u),o.walls[2]=d.concat(u),0==r&&0==s||(o.walls[3]=h.concat(d))}}},traverseGrid:function(){for(var t=[0,1,0,-1],e=[-1,0,1,0],s=[2,3,0,1],i=this.rng.nextInRange(0,this.cols-1),n=this.rng.nextInRange(0,this.rows-1),r=[this.grid[i][n]];r.length>0;){var o=r.length-1,h=r[o];h.visited=!0;var a=[0,1,2,3];this.rng.shuffle(a);for(var d=0;d<a.length;){var u=a[d];++d;var l=h.col+t[u],c=h.row+e[u];if(l>=0&&l<this.cols&&c>=0&&c<this.rows&&!this.grid[l][c].visited){var g=this.grid[l][c];h.walls[u]=[],g.walls[s[u]]=[],g.visited=!0,r.push(g),o=-1;break}}o>=0&&r.splice(o,1)}},populateObject:function(){this.object=new b;for(var t=[],e=0,s=this.cols;e<s;)for(var i=e++,n=0,r=this.rows;n<r;)for(var o=n++,h=0,a=this.grid[i][o].walls;h<a.length;){var d=a[h];++h;for(var u=0;u<d.length;){var l=d[u];++u,t.push(l)}}this.object.coordinates=t}},j.prototype={constructor:j,generate:function(t,e,s,i){this.w=t/10,this.h=e/10,this.rooms=[],this.map=[];for(g=0;g<this.w;g++){this.map[g]=[];for(p=0;p<this.h;p++)this.map[g][p]=0}for(var n=H.randInt(10,20),r=s||5,o=i||15,h=0;h<n;h++)(c={}).x=H.randInt(1,this.w-o-1),c.y=H.randInt(1,this.h-o-1),c.w=H.randInt(r,o),c.h=H.randInt(r,o),this.DoesCollide(c)?h--:(c.w--,c.h--,this.rooms.push(c));for(this.SquashRooms(),h=0;h<n;h++)for(var a=this.rooms[h],d=this.FindClosestRoom(a),u={x:H.randInt(a.x,a.x+a.w),y:H.randInt(a.y,a.y+a.h)},l={x:H.randInt(d.x,d.x+d.w),y:H.randInt(d.y,d.y+d.h)};l.x!=u.x||l.y!=u.y;)l.x!=u.x?l.x>u.x?l.x--:l.x++:l.y!=u.y&&(l.y>u.y?l.y--:l.y++),this.map[l.x][l.y]=1;for(h=0;h<n;h++)for(var c=this.rooms[h],g=c.x;g<c.x+c.w;g++)for(p=c.y;p<c.y+c.h;p++)this.map[g][p]=1;for(g=0;g<this.w;g++)for(var p=0;p<this.h;p++)if(1==this.map[g][p])for(var f=g-1;f<=g+1;f++)for(var x=p-1;x<=p+1;x++)0==this.map[f][x]&&(this.map[f][x]=2);this.populateObject()},FindClosestRoom:function(t){for(var e={x:t.x+t.w/2,y:t.y+t.h/2},s=null,i=1e3,n=0;n<this.rooms.length;n++){var r=this.rooms[n];if(r!=t){var o={x:r.x+r.w/2,y:r.y+r.h/2},h=Math.min(Math.abs(e.x-o.x)-t.w/2-r.w/2,Math.abs(e.y-o.y)-t.h/2-r.h/2);h<i&&(i=h,s=r)}}return s},SquashRooms:function(){for(var t=0;t<10;t++)for(var e=0;e<this.rooms.length;e++)for(var s=this.rooms[e];;){var i={x:s.x,y:s.y};if(s.x>1&&s.x--,s.y>1&&s.y--,1==s.x&&1==s.y)break;if(this.DoesCollide(s,e)){s.x=i.x,s.y=i.y;break}}},DoesCollide:function(t,e){for(var s=0;s<this.rooms.length;s++)if(s!=e){var i=this.rooms[s];if(!(t.x+t.w<i.x||t.x>i.x+i.w||t.y+t.h<i.y||t.y>i.y+i.h))return!0}return!1},populateObject:function(){var t=document.createElement("canvas");t.width=10*this.w,t.height=10*this.h;var e=t.getContext("2d");e.fillStyle="#FFF",e.fillRect(0,0,t.width,t.height);for(var s=0;s<this.h;s++)for(var i=0;i<this.w;i++){var n=this.map[i][s];e.fillStyle=0===n?"#000000":1===n?"#FFFFFF":"#000000",e.fillRect(10*i,10*s,10,10)}var r=c(null,e.getImageData(0,0,10*this.w,10*this.h));this.object=z.buildFromBmpData(r,1.8)}},k.prototype={drawImage:function(t,e,s){this.g0.drawImage(t,e,s)},drawMesh:function(t,e){var s=this.g0;void 0!==e&&e&&this.g0.clear(),t.compute_Data();for(var i=t.AR_edge,n=t.AR_vertex,r=i.length,o=0;r--;)i[(o=5*r)+4]?s.lineStyle(this.constraintsWidth,this.constraintsColor):s.lineStyle(this.edgesWidth,this.edgesColor),s.moveTo(i[o],i[o+1]),s.lineTo(i[o+2],i[o+3]),s.stroke(),s.closePath();for(s.lineStyle(this.verticesRadius,this.verticesColor),r=n.length;r--;)o=2*r,s.beginFill(this.verticesColor,this.verticesAlpha),s.drawCircle(n[o],n[o+1],this.verticesRadius),s.endFill()},drawEntity:function(t,e){var s=this.g,i=t.isSee;void 0!==e&&e&&s.clear(),i?s.beginFill(this.entitiesField):s.beginFill(this.entitiesField2),s.moveTo(t.position.x,t.position.y),s.drawCircle(t.position.x,t.position.y,t.radiusFOV,t.angle-.5*t.angleFOV,t.angle+.5*t.angleFOV),s.lineTo(t.position.x,t.position.y),s.endFill(),i?s.beginFill(this.entitiesColor):s.beginFill(this.entitiesColor2),s.drawCircle(t.position.x,t.position.y,t.radius),s.endFill()},drawPath:function(t,e){var s=this.g;if(void 0!==e&&e&&this.g.clear(),0!==t.length){s.lineStyle(this.pathsWidth,this.pathsColor),s.moveTo(t[0],t[1]);for(var i=2;i<t.length;)s.lineTo(t[i],t[i+1]),i+=2;s.stroke()}},clear:function(){this.g.clear()}},M.prototype={clear:function(){this.ctx.clearRect(0,0,this.w,this.h)},drawImage:function(t,e,s){this.ctx.drawImage(t,0,0,e||this.w,s||this.h)},drawCircle:function(t,e,s,i,n){i=i||0,n=n||H.TwoPI,this.ctx.beginPath(),this.ctx.arc(t,e,s,i,n,!1)},drawRect:function(t,e,s,i){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+s,e),this.ctx.lineTo(t+s,e+i),this.ctx.lineTo(t,e+i),this.ctx.stroke(),this.ctx.closePath()},lineStyle:function(t,e){this.ctx.lineWidth=t,this.ctx.strokeStyle="rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},moveTo:function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t,e)},lineTo:function(t,e){this.ctx.lineTo(t,e)},stroke:function(){this.ctx.stroke()},closePath:function(){this.ctx.closePath()},beginFill:function(t){this.ctx.fillStyle="rgba("+t.r+","+t.g+","+t.b+","+t.a+")",this.ctx.beginPath()},endFill:function(){this.ctx.closePath(),this.ctx.fill()}},A.prototype={constructor:A,collapseBuffer:function(){for(var t=this.maxVertices,e=this.currentVertex,s=0;t>=e;)s=3*t,this.positions[s]=0,this.positions[s+1]=0,this.positions[s+2]=0,this.colors[s]=0,this.colors[s+1]=0,this.colors[s+2]=0,t--},collapsePathBuffer:function(){for(var t=this.maxPathVertices,e=this.currentPathVertex,s=0;t>=e;)s=3*t,this.positionsPath[s]=0,this.positionsPath[s+1]=0,this.positionsPath[s+2]=0,this.colorsPath[s]=0,this.colorsPath[s+1]=0,this.colorsPath[s+2]=0,t--},update:function(){this.world.mesh.isRedraw&&(this.currentVertex=0,this.world.mesh.draw(),this.collapseBuffer(),this.buffer.geometry.attributes.position.needsUpdate=!0,this.buffer.geometry.attributes.color.needsUpdate=!0),this.world.update();for(var t,e=this.world.heroes.length;e--;)if((t=this.world.heroes[e]).isSelected&&t.tmppath.length>0){this.currentPathVertex=0;for(var s=this.world.heroes[e].tmppath,i=s[0],n=s[1],r=2;r<s.length;)this.insertPath(i,n,s[r],s[r+1],1,0,0),i=s[r],n=s[r+1],r+=2;this.collapsePathBuffer(),this.bufferPath.geometry.attributes.position.needsUpdate=!0,this.bufferPath.geometry.attributes.color.needsUpdate=!0}},insertLine:function(t,e,s,i,n,r,o){var h=this.currentVertex,a=3*h;this.positions[a]=t,this.positions[a+1]=0,this.positions[a+2]=e,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,a=3*++h,this.positions[a]=s,this.positions[a+1]=0,this.positions[a+2]=i,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,this.currentVertex+=2},insertPath:function(t,e,s,i,n,r,o){var h=this.currentPathVertex,a=3*h;this.positionsPath[a]=t,this.positionsPath[a+1]=0,this.positionsPath[a+2]=e,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,a=3*++h,this.positionsPath[a]=s,this.positionsPath[a+1]=0,this.positionsPath[a+2]=i,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,this.currentPathVertex+=2}},S.prototype.draw=function(){this.compute_Data();for(var t=U.get(),e=this.AR_edge,s=e.length,i=0;s--;)e[(i=5*s)+4]?t.insertLine(e[i],e[i+1],e[i+2],e[i+3],0,0,0):t.insertLine(e[i],e[i+1],e[i+2],e[i+3],.4,.4,.4);this.isRedraw=!1},t.REVISION="1.0.0",t.Main=U,t.TwoPI=X,t.rand=function(t,e){return H.rand(t,e)},t.randInt=function(t,e){return H.randInt(t,e)},t.ImageLoader=g,t.fromImageData=c,t.Entity=x,t.World=D,t.RectMesh=w,t.CircleMesh=function(t,e,s,i){s=s||100,t=t||s,e=e||s;for(var n=[],r=[],o=[],h=[],a=[],d=i=i||8;d--;)o.push(new y),n.push(new _),h.push(new m),r.push(new v,new v,new v);var u=new E,l=1/i;for(d=0;d<i;)n[d].pos.set(t+(s+10)*H.cos(H.TwoPI*d*l),e+(s+10)*H.sin(H.TwoPI*d*l)),n[d].setDatas(r[2*d]),d++;for(d=0;d<i;)a.push(t+s*H.cos(H.TwoPI*d*l)),a.push(e+s*H.sin(H.TwoPI*d*l)),a.push(t+s*H.cos(H.TwoPI*(d+1)*l)),a.push(e+s*H.sin(H.TwoPI*(d+1)*l)),d++;var c=new S(2*s,2*s);return c._vertices=n,c._edges=r,c._faces=o,c._constraintShapes.push(u),c.clipping=!1,c.insertConstraintShape(a),c.clipping=!0,c},t.BitmapObject=z,t.BitmapMesh=K,t.GridMaze=q,t.Dungeon=j,t.SimpleView=k,t.ThreeView=A,Object.defineProperty(t,"__esModule",{value:!0})});
