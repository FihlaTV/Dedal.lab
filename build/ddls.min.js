!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DDLS={})}(this,function(t){"use strict";function e(t){this.type=t||0,0===this.type?(this.k=[],this.v=[]):this.h={}}function s(t,e){this.x=t||0,this.y=e||0}function i(t,e,s,i,n,r){this.n=[t||1,e||0,s||0,i||1,n||0,r||0]}function n(t,e){e=e||1;var i=t.length;if(i<=4)return[].concat(t);for(var r=t[0],o=t[1],h=t[i-2],a=t[i-1],l=-1,u=0,d=1,c=i>>1;d<c;){var p=d++,g=et.distanceSquaredPointToSegment(new s(t[p<<1],t[1+(p<<1)]),new s(r,o),new s(h,a));g>u&&(u=g,l=p)}if(u>e*e){var f=t.slice(0,2+(l<<1)),x=t.slice(l<<1),y=n(f,e),_=n(x,e);return y.slice(0,y.length-2).concat(_)}return[r,o,h,a]}function r(t,e){this.length=t*e,this.bytes=new tt(4*this.length),this.width=t,this.height=e}function o(t,e){if(t){var s=t.width,i=t.height,n=document.createElement("canvas");n.width=s,n.height=i;var o=n.getContext("2d");o.drawImage(t,0,0,s,i),e=o.getImageData(0,0,s,i)}for(var h=new r(e.width,e.height),a=e.data,l=a.byteLength,u=0,d=0;u<l;)d=u++,h.bytes[d]=255&a[d];return t&&(o.clearRect(0,0,s,i),n=null,o=null),h}function h(t,e,s){this.min=e||0,this.max=s||1,this.seed=this.currentSeed=t||1234,this.nid=0}function a(){this._fromFace=null,this._nextEdge=null,Object.defineProperty(this,"fromFace",{set:function(t){this._fromFace=t,this._nextEdge=this._fromFace.edge}})}function l(){this._fromMesh=null,this._currIndex=0,Object.defineProperty(this,"fromMesh",{set:function(t){this._fromMesh=t,this._currIndex=0}})}function u(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){this._fromVertex=t,this._nextEdge=this._fromVertex.edge}})}function d(){this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){for(this._fromVertex=t,this._nextEdge=this._fromVertex.edge;!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function c(){this.realEdgesOnly=!0,this._fromVertex=null,this._nextEdge=null,Object.defineProperty(this,"fromVertex",{set:function(t){if(this._fromVertex=t,this._nextEdge=this._fromVertex.edge,null!=this._nextEdge)for(;this.realEdgesOnly&&!this._nextEdge.isReal;)this._nextEdge=this._nextEdge.rotLeftEdge}})}function p(){this.type=G,this.id=H.get("edge"),this.fromConstraintSegments=[],this.isConstrained=!1,this.isReal=!1,this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,Object.defineProperty(this,"destinationVertex",{get:function(){return this.oppositeEdge.originVertex}}),Object.defineProperty(this,"nextRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"prevLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge}}),Object.defineProperty(this,"rotLeftEdge",{get:function(){return this.nextLeftEdge.nextLeftEdge.oppositeEdge}}),Object.defineProperty(this,"rotRightEdge",{get:function(){return this.oppositeEdge.nextLeftEdge}}),Object.defineProperty(this,"rightFace",{get:function(){return this.oppositeEdge.leftFace}})}function g(){this.type=X,this.id=H.get("face"),this.isReal=!1,this.edge=null}function f(){this.type=W,this.id=H.get("vertex"),this.pos=new s,this.fromConstraintSegments=[],this.edge=null,this.isReal=!1}function x(){this.id=H.get("shape"),this.segments=[]}function y(t,e){this.id=H.get("segment"),this.edges=[],this.fromShape=null}function _(){this.id=H.get("object2D"),this._pivot=new s,this._position=new s,this._scale=new s(1,1),this._matrix=new i,this._rotation=0,this._constraintShape=null,this._coordinates=[],this.hasChanged=!1,Object.defineProperty(this,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation!=t&&(this._rotation=t,this.hasChanged=!0)}}),Object.defineProperty(this,"matrix",{get:function(){return this._matrix},set:function(t){this._matrix=t,this.hasChanged=!0}}),Object.defineProperty(this,"coordinates",{get:function(){return this._coordinates},set:function(t){this._coordinates=t,this.hasChanged=!0}}),Object.defineProperty(this,"constraintShape",{get:function(){return this._constraintShape},set:function(t){this._constraintShape=t,this.hasChanged=!0}}),Object.defineProperty(this,"edges",{get:function(){for(var t,e=[],s=this._constraintShape.segments,i=s.length,n=0,r=0,o=0,h=0;n<i;)for(r=0,t=s[o=n++].edges.length;r<t;)h=r++,e.push(s[o].edges[h]);return e}})}function m(){this.id=H.get("graph"),this.edge=null,this.node=null}function v(){this.id=H.get("graphEdge"),this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}function E(){this.id=H.get("graphNode"),this.successorNodes=new e(1),this.prev=null,this.next=null,this.outgoingEdge=null,this.data=null}function w(){}function C(){}function S(t,e){this.id=H.get("mesh2D"),this.__objectsUpdateInProgress=!1,this.__centerVertex=null,this.width=t,this.height=e,this.clipping=!0,this._edges=[],this._faces=[],this._objects=[],this._vertices=[],this._constraintShapes=[],this.__edgesToCheck=[],this.AR_vertex=null,this.AR_edge=null,this.isRedraw=!0}function F(){this.fromFace=null,this.toFace=null,this.curFace=null,this.iterEdge=new a,this.mesh=null,this._radius=0,this.radiusSquared=0,this.diameter=0,this.diameterSquared=0,Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){this._radius=t,this.radiusSquared=this._radius*this._radius,this.diameter=2*this._radius,this.diameterSquared=this.diameter*this.diameter}})}function P(){this._currPoolPointsIndex=0,this._poolPointsSize=3e3,this._numSamplesCircle=16,this._radiusSquared=0,this._radius=0,this._poolPoints=[];for(var t=this._poolPointsSize,e=0;e<t;){e++;this._poolPoints.push(new s)}Object.defineProperty(this,"radius",{get:function(){return this._radius},set:function(t){if(this._radius=Math.max(0,t),this._radiusSquared=this._radius*this._radius,this._sampleCircle=[],0!=this._radius){for(var e,i=this._numSamplesCircle,n=0;n<i;){var r=n++;e=-B*r/this._numSamplesCircle,this._sampleCircle.push(new s(this._radius*Math.cos(e),this._radius*Math.sin(e)))}this._sampleCircleDistanceSquared=z(this._sampleCircle[0].x-this._sampleCircle[1].x,this._sampleCircle[0].y-this._sampleCircle[1].y)}}})}function V(){this.astar=new F,this.funnel=new P,this.listFaces=[],this.listEdges=[],this._mesh=null,this.entity=null,Object.defineProperty(this,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh=t,this.astar.mesh=t}})}function b(){this.entity=null,this.hasPrev=!1,this.hasNext=!1,this.countMax=0,this.count=0,this._currentX=0,this._currentY=0,this._path=[],Object.defineProperty(this,"x",{get:function(){return this._currentX}}),Object.defineProperty(this,"y",{get:function(){return this._currentY}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this.countMax=.5*this._path.length,this.reset()}})}function D(){this.entity=null,this._path=null,this._samplingDistanceSquared=1,this._samplingDistance=1,this._preCompX=[],this._preCompY=[],this.pos=new s,this.hasPrev=!1,this.hasNext=!1,this._count=0,Object.defineProperty(this,"x",{get:function(){return this.pos.x}}),Object.defineProperty(this,"y",{get:function(){return this.pos.y}}),Object.defineProperty(this,"countMax",{get:function(){return this._preCompX.length-1}}),Object.defineProperty(this,"count",{get:function(){return this._count},set:function(t){this._count=t,this._count<0&&(this._count=0),this._count>this.countMax-1&&(this._count=this.countMax-1),0==this._count?this.hasPrev=!1:this.hasPrev=!0,this._count==this.countMax-1?this.hasNext=!1:this.hasNext=!0,this.applyLast(),this.updateEntity()}}),Object.defineProperty(this,"samplingDistance",{get:function(){return this._samplingDistance},set:function(t){this._samplingDistance=t,this._samplingDistanceSquared=this._samplingDistance*this._samplingDistance}}),Object.defineProperty(this,"path",{get:function(){return this._path},set:function(t){this._path=t,this._preComputed=!1,this.reset()}})}function O(t,e){this.entity=t||null,this.world=e||null}function L(t,e){this.isSee=!1,this.isWalking=!1,this.isSelected=!1,this.isMove=!1,this.world=e,t=t||{},this.position=new s(t.x||0,t.y||0),this.direction=new s(1,0),this.radius=t.r||10,this.angle=0,this.angleFOV=(t.fov||120)*q,this.radiusFOV=t.distance||200,this.testSee=t.see||!1,this.path=[],this.tmppath=[],this.target=new s,this.newPath=!1,this.mesh=null,this.fov=new O(this,this.world),this.pathSampler=new D,this.pathSampler.entity=this,this.pathSampler.path=this.tmppath,this.pathSampler.samplingDistance=t.speed||10}function N(t,e){S.call(this,t,e);for(var s=[],i=[],n=[],r=[],o=4;o--;)n.push(new g),s.push(new f),r.push(new y),i.push(new p,new p,new p);var h=new x;s[0].pos.set(-10,-10),s[1].pos.set(t+10,-10),s[2].pos.set(t+10,e+10),s[3].pos.set(-10,e+10),s[0].setDatas(i[0]),s[1].setDatas(i[2]),s[2].setDatas(i[4]),s[3].setDatas(i[6]),i[0].setDatas(s[0],i[1],i[2],n[3],!0,!0),i[1].setDatas(s[1],i[0],i[7],n[0],!0,!0),i[2].setDatas(s[1],i[3],i[11],n[3],!0,!0),i[3].setDatas(s[2],i[2],i[8],n[1],!0,!0),i[4].setDatas(s[2],i[5],i[6],n[2],!0,!0),i[5].setDatas(s[3],i[4],i[3],n[1],!0,!0),i[6].setDatas(s[3],i[7],i[10],n[2],!0,!0),i[7].setDatas(s[0],i[6],i[9],n[0],!0,!0),i[8].setDatas(s[1],i[9],i[5],n[1],!0,!1),i[9].setDatas(s[3],i[8],i[1],n[0],!0,!1),i[10].setDatas(s[0],i[11],i[4],n[2],!1,!1),i[11].setDatas(s[2],i[10],i[0],n[3],!1,!1),n[0].setDatas(i[9],!0),n[1].setDatas(i[8],!0),n[2].setDatas(i[4],!1),n[3].setDatas(i[2],!1),s[0].fromConstraintSegments.push(r[0],r[3]),s[1].fromConstraintSegments.push(r[0],r[1]),s[2].fromConstraintSegments.push(r[1],r[2]),s[3].fromConstraintSegments.push(r[2],r[3]),i[0].fromConstraintSegments.push(r[0]),i[1].fromConstraintSegments.push(r[0]),i[2].fromConstraintSegments.push(r[1]),i[3].fromConstraintSegments.push(r[1]),i[4].fromConstraintSegments.push(r[2]),i[5].fromConstraintSegments.push(r[2]),i[6].fromConstraintSegments.push(r[3]),i[7].fromConstraintSegments.push(r[3]),r[0].edges.push(i[0]),r[1].edges.push(i[2]),r[2].edges.push(i[4]),r[3].edges.push(i[6]),r[0].fromShape=h,r[1].fromShape=h,r[2].fromShape=h,r[3].fromShape=h,h.segments.push(r[0],r[1],r[2],r[3]),this._vertices=s,this._edges=i,this._faces=n,this._constraintShapes.push(h),this.clipping=!1,this.insertConstraintShape([0,0,t,0,t,0,t,e,t,e,0,e,0,e,0,0]),this.clipping=!0}function T(t,e){H.reset(),this.heroes=[],this.shapes=[],this.segments=[],this.objects=[],this.w=t||512,this.h=e||512,this.mesh=new N(this.w,this.h),this.pathFinder=new V,this.pathFinder.mesh=this.mesh}function M(t,e){this.visited=!1,this.col=t,this.row=e;for(var s=[],i=0;i<4;){i++;s.push([])}this.walls=s}function j(t,e,s,i){this.generate(t,e,s,i)}function R(t,e,s,i){this.generate(t,e,s,i)}function k(t){this.g0=new A(t.w,t.h),this.g=new A(t.w,t.h),this.g.canvas.style.pointerEvents="none",this.g0.canvas.style.pointerEvents="auto",this.entitiesWidth=1,this.entitiesColor={r:0,g:255,b:0,a:.75},this.entitiesColor2={r:255,g:255,b:255,a:.75},this.entitiesField={r:0,g:255,b:0,a:.1},this.entitiesField2={r:255,g:255,b:255,a:.1},this.pathsWidth=2,this.pathsColor={r:255,g:255,b:0,a:.75},this.verticesRadius=1,this.verticesColor={r:255,g:120,b:0,a:.5},this.constraintsWidth=2,this.constraintsColor={r:255,g:0,b:0,a:1},this.edgesWidth=1,this.edgesColor={r:190,g:190,b:190,a:.25},this.edgesColor2={r:0,g:190,b:0,a:.25},this.mesh_data=null,this.domElement=this.g0.canvas,Y.set(this)}function A(t,e){this.w=t||200,this.h=e||200,this.canvas=document.createElement("canvas"),this.canvas.width=this.w,this.canvas.height=this.h,this.ctx=this.canvas.getContext("2d"),this.canvas.style.cssText="position:absolute; left:50%; top:50%; margin-left:"+.5*-this.w+"px; margin-top:"+.5*-this.h+"px;",document.body.appendChild(this.canvas)}function I(t,e,s){var i=s;this.world=e,this.maxVertices=3e4,this.currentVertex=0;var n=new i.BufferGeometry;n.addAttribute("position",new i.BufferAttribute(new Float32Array(3*this.maxVertices),3)),n.addAttribute("color",new i.BufferAttribute(new Float32Array(3*this.maxVertices),3)),this.positions=n.attributes.position.array,this.colors=n.attributes.color.array,n.computeBoundingSphere(),this.buffer=new i.LineSegments(n,new i.LineBasicMaterial({vertexColors:!0})),this.buffer.frustumCulled=!1,t.add(this.buffer),this.maxPathVertices=1e3,this.currentPathVertex=0;var r=new i.BufferGeometry;r.addAttribute("position",new i.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),r.addAttribute("color",new i.BufferAttribute(new Float32Array(3*this.maxPathVertices),3)),this.positionsPath=r.attributes.position.array,this.colorsPath=r.attributes.color.array,n.computeBoundingSphere(),this.bufferPath=new i.LineSegments(r,new i.LineBasicMaterial({vertexColors:!0})),this.bufferPath.frustumCulled=!1,t.add(this.bufferPath),Y.set(this)}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(void 0!==i&&null!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e});var q=.017453292519943295,B=2*Math.PI,W=0,G=1,X=2,Y={view:null,get:function(){return this.view},set:function(t){this.view=t}},H={id:{segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0},get:function(t){return++this.id[t]},reset:function(){this.id={segment:0,shape:0,edge:0,face:0,mesh2D:0,object2D:0,vertex:0,graph:0,graphEdge:0,graphNode:0}}},U=function(t){console.log(t)};e.prototype={set:function(t,e){var s=this.type;0===s&&(this.k.push(t),this.v.push(e)),1===s&&(this.h[t.id]=e),2===s&&(this.h[t]=e)},get:function(t){var e,s=this.type;return 0===s&&-1!=(e=this.k.indexOf(t))?this.v[e]:1===s?this.h[t.id]:2===s?this.h[t]:void 0},dispose:function(){var t=this.type;if(0===t){for(;this.k.length>0;)this.k.pop();for(;this.v.length>0;)this.v.pop();this.k=null,this.v=null}if(1===t){for(var e in this.h)this.h[e.id]=void 0;this.h=null}if(2===t){for(var e in this.h)this.h[e]=void 0;this.h=null}}},s.prototype={constructor:s,set:function(t,e){return this.x=t,this.y=e,this},transform:function(t){return t.tranform(this),this},copy:function(t){return this.x=t.x,this.y=t.y,this},clone:function(){return new s(this.x,this.y)},sub:function(t){return this.x-=t.x,this.y-=t.y,this},mul:function(t){return this.x*=t,this.y*=t,this},add:function(t){return this.x+=t.x,this.y+=t.y,this},div:function(t){var e=1/t;return this.x*=e,this.y*=e,this},negate:function(){return new s(-this.x,-this.y)},transformMat2D:function(t){var e=this.x,s=this.y,i=t.n;return this.x=i[0]*e+i[2]*s+i[4],this.y=i[1]*e+i[3]*s+i[5],this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},angular:function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this},normalize:function(){var t=this.length();return this.x/=t,this.y/=t,t},distanceTo:function(t){var e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)},distanceSquaredTo:function(t){var e=this.x-t.x,s=this.y-t.y;return e*e+s*s},equals:function(t){return this.x===t.x&&this.y===t.y}},i.prototype={constructor:i,identity:function(){return this.n=[1,0,0,1,0,0],this},translate:function(t){var e=this.n;return e[4]+=t.x,e[5]+=t.y,this},scale:function(t){var e=this.n;return e[0]*=t.x,e[1]*=t.y,e[2]*=t.x,e[3]*=t.y,e[4]*=t.x,e[5]*=t.y,this},rotate:function(t){var e=this.n,s=e[0],i=e[1],n=e[2],r=e[3],o=e[4],h=e[5],a=Math.sin(t),l=Math.cos(t);return e[0]=s*l+i*a,e[1]=-s*a+i*l,e[2]=n*l+r*a,e[3]=-n*a+l*r,e[4]=l*o+a*h,e[5]=l*h-a*o,this},tranform:function(t){var e=this.n,s=e[0]*t.x+e[2]*t.y+e[4],i=e[1]*t.x+e[3]*t.y+e[5];t.x=s,t.y=i},transformX:function(t,e){var s=this.n;return s[0]*t+s[2]*e+s[4]},transformY:function(t,e){var s=this.n;return s[1]*t+s[3]*e+s[5]},concat:function(t){var e=this.n,s=t.n,i=e[0]*s[0]+e[1]*s[2],n=e[0]*s[1]+e[1]*s[3],r=e[2]*s[0]+e[3]*s[2],o=e[2]*s[1]+e[3]*s[3],h=e[4]*s[0]+e[5]*s[2]+s[4],a=e[4]*s[1]+e[5]*s[3]+s[5];return e[0]=i,e[1]=n,e[2]=r,e[3]=o,e[4]=h,e[5]=a,this},clone:function(){var t=this.n;return new i(t[0],t[1],t[2],t[3],t[4],t[5])}};var K=function(t,e){return t+Math.floor(Math.random()*(e-t+1))},z=function(t,e){return t*t+e*e},Z=function(t,e){return Math.sqrt(t*t+e*e)},Q=function(t,e,s){return Math.abs(t-e)<s},J=function(t){return Math.floor(t)},$=function(t,e){return 1*t.toFixed(e||3)},tt="undefined"!=typeof Float32Array?Float32Array:Array;h.prototype={constructor:h,getSeed:function(){return this.seed},setSeed:function(t){this.seed=this.currentSeed=t},reset:function(){this.currentSeed=this.seed,this.nid=0},next:function(){for(var t=1*this.currentSeed,e=(t*t).toString();e.length<8;)e="0"+e;this.currentSeed=parseInt(e.substr(1,5));var s=Math.round(this.min+this.currentSeed/99999*(this.max-this.min));return 0===this.currentSeed&&(this.currentSeed=this.seed+this.nid),200===++this.nid&&this.reset(),s},nextInRange:function(t,e){return this.min=t,this.max=e,this.next()},shuffle:function(t){for(var e,s,i=t.length;i--;)e=this.nextInRange(0,i),s=t[i],t[i]=t[e],t[e]=s}},a.prototype={next:function(){return null!=this._nextEdge?(this._resultEdge=this._nextEdge,this._nextEdge=this._nextEdge.nextLeftEdge,this._nextEdge==this._fromFace.edge&&(this._nextEdge=null)):this._resultEdge=null,this._resultEdge}},l.prototype={next:function(){do{if(!(this._currIndex<this._fromMesh._vertices.length)){this._resultVertex=null;break}this._resultVertex=this._fromMesh._vertices[this._currIndex],this._currIndex++}while(!this._resultVertex.isReal);return this._resultVertex}},u.prototype={next:function(){if(null!=this._nextEdge){do{if(this._resultFace=this._nextEdge.leftFace,this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null,this._resultFace.isReal||(this._resultFace=null);break}}while(!this._resultFace.isReal)}else this._resultFace=null;return this._resultFace}},d.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge.oppositeEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}},c.prototype={next:function(){if(null!=this._nextEdge){this._resultEdge=this._nextEdge;do{if(this._nextEdge=this._nextEdge.rotLeftEdge,this._nextEdge==this._fromVertex.edge){this._nextEdge=null;break}}while(this.realEdgesOnly&&!this._nextEdge.isReal)}else this._resultEdge=null;return this._resultEdge}};var et={__samples:[],__circumcenter:new s,_randGen:null,locatePosition:function(t,s){var i,n;for(null===et._randGen&&(et._randGen=new h),et._randGen.setSeed(J(10*t.x+4*t.y)),et.__samples.splice(0,et.__samples.length),n=J(Math.pow(s._vertices.length,.3333333333333333)),et._randGen.min=0,et._randGen.max=s._vertices.length-1,i=0;i<n;)et.__samples.push(s._vertices[et._randGen.next()]),i++;var r,o,l,d=1/0,c=null;for(i=0;i<n;)o=(r=et.__samples[i]).pos,(l=z(o.x-t.x,o.y-t.y))<d&&(d=l,c=r),i++;var p=new u;null===c&&U("no closedVertex find ?"),p.fromVertex=c;for(var g,f=p.next(),x=new e(0),y=new a,_=0,m=0,v=et.isInFace(t,f);x.get(f)||3===v.type;){if(x.set(f,!0),50==++m&&U("WALK TAKE MORE THAN 50 LOOP"),1e3==m){U("WALK TAKE MORE THAN 1000 LOOP -> WE ESCAPE"),v={type:3};break}y.fromFace=f;do{if(null===(g=y.next()))return U("KILL PATH"),null;_=et.getRelativePosition(t,g)}while(1==_||0==_);f=g.rightFace,v=et.isInFace(t,f)}return x.dispose(),v},isCircleIntersectingAnyConstraint:function(t,s,i){if(t.x<=0||t.x>=i.width||t.y<=0||t.y>=i.height)return!0;var n,r=et.locatePosition(t,i);switch(r.type){case 0:n=r.edge.leftFace;break;case 1:n=r.leftFace;break;case 2:n=r;break;case 3:n=null}var o,h=s*s;if(o=n.edge.originVertex.pos,z(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.originVertex.pos,z(o.x-t.x,o.y-t.y)<=h)return!0;if(o=n.edge.nextLeftEdge.nextLeftEdge.originVertex.pos,z(o.x-t.x,o.y-t.y)<=h)return!0;var a=[];a.push(n.edge),a.push(n.edge.nextLeftEdge),a.push(n.edge.nextLeftEdge.nextLeftEdge);for(var l,u,d,c=new e(0);a.length>0;)if(l=a.pop(),c.set(l,!0),u=l.originVertex.pos,d=l.destinationVertex.pos,et.intersectionsSegmentCircle(u,d,t,s)){if(l.isConstrained)return!0;l=l.oppositeEdge.nextLeftEdge,c.get(l)||c.get(l.oppositeEdge)||-1!=a.indexOf(l)||-1!=a.indexOf(l.oppositeEdge)||a.push(l),l=l.nextLeftEdge,c.get(l)||c.get(l.oppositeEdge)||-1!=a.indexOf(l)||-1!=a.indexOf(l.oppositeEdge)||a.push(l)}return!1},getDirection:function(t,e,s){var i=(s.x-t.x)*(e.y-t.y)+(s.y-t.y)*(-e.x+t.x);return 0==i?0:i>0?1:-1},getRelativePosition:function(t,e){return et.getDirection(e.originVertex.pos,e.destinationVertex.pos,t)},getRelativePosition2:function(t,e){return void 0===e?(console.log("error no eUp"),0):et.Orient2d(e.originVertex.pos,e.destinationVertex.pos,t)},Orient2d:function(t,e,s){var i=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x);return i>-1e-4&&i<1e-4?0:i>0?-1:1},isInFace:function(t,e){var s={type:3};if(null===e)return s;var i=e.edge,n=i.nextLeftEdge,r=n.nextLeftEdge;if(et.getRelativePosition(t,i)>=0&&et.getRelativePosition(t,n)>=0&&et.getRelativePosition(t,r)>=0){var o=i.originVertex,h=n.originVertex,a=r.originVertex,l=o.pos.x,u=o.pos.y,d=h.pos.x,c=h.pos.y,p=a.pos.x,g=a.pos.y,f=z(l-t.x,u-t.y),x=z(d-t.x,c-t.y),y=z(p-t.x,g-t.y),_=1/z(d-l,c-u),m=1/z(p-d,g-c),v=1/z(l-p,u-g),E=(t.x-l)*(d-l)+(t.y-u)*(c-u),w=(t.x-d)*(p-d)+(t.y-c)*(g-c),C=(t.x-p)*(l-p)+(t.y-g)*(u-g),S=x-w*w*m<=1e-4,F=y-C*C*v<=1e-4;s=f-E*E*_<=1e-4?F?o:S?h:i:S?F?a:n:F?r:e}return s},clipSegmentByTriangle:function(t,e,s,i,n,r,o){var h=et.getDirection(s,i,t),a=et.getDirection(s,i,e);if(h<=0&&a<=0)return!1;var l=et.getDirection(i,n,t),u=et.getDirection(i,n,e);if(l<=0&&u<=0)return!1;var d=et.getDirection(n,s,t),c=et.getDirection(n,s,e);if(d<=0&&c<=0)return!1;if(h>=0&&l>=0&&d>=0&&a>=0&&u>=0&&c>=0)return r=t.clone(),o=e.clone(),!0;var p=0;return et.intersections2segments(t,e,s,i,r,null)&&p++,0==p?et.intersections2segments(t,e,i,n,r,null)&&p++:et.intersections2segments(t,e,i,n,o,null)&&(-.01>r.x-o.x||r.x-o.x>.01||-.01>r.y-o.y||r.y-o.y>.01)&&p++,0==p?et.intersections2segments(t,e,n,s,r,null)&&p++:1==p&&et.intersections2segments(t,e,n,s,o,null)&&(-.01>r.x-o.x||r.x-o.x>.01||-.01>r.y-o.y||r.y-o.y>.01)&&p++,1==p&&(h>=0&&l>=0&&d>=0?o=t.clone():a>=0&&u>=0&&c>=0?o=e.clone():p=0),p>0},isDelaunay:function(t){var e=t.originVertex,s=t.destinationVertex,i=t.nextLeftEdge.destinationVertex,n=t.nextRightEdge.destinationVertex;et.getCircumcenter(i.pos,e.pos,s.pos,et.__circumcenter);var r=(i.pos.x-et.__circumcenter.x)*(i.pos.x-et.__circumcenter.x)+(i.pos.y-et.__circumcenter.y)*(i.pos.y-et.__circumcenter.y);return(n.pos.x-et.__circumcenter.x)*(n.pos.x-et.__circumcenter.x)+(n.pos.y-et.__circumcenter.y)*(n.pos.y-et.__circumcenter.y)>=r},getCircumcenter:function(t,e,i,n){null==n&&(n=new s);var r=.5*(t.x+e.x),o=.5*(t.y+e.y),h=.5*(t.x+i.x),a=.5*(t.y+i.y),l=(r*(t.x-i.x)+(o-a)*(t.y-i.y)+h*(i.x-t.x))/(t.x*(i.y-e.y)+e.x*(t.y-i.y)+i.x*(e.y-t.y));return n.x=r+l*(e.y-t.y),n.y=o-l*(e.x-t.x),n},intersections2segments:function(t,e,s,i,n,r,o){null==o&&(o=!1);var h,a=0,l=0,u=(t.x-e.x)*(s.y-i.y)+(e.y-t.y)*(s.x-i.x);if(0==u)h=!1;else{h=!0;var d=1/u;o&&null==n&&null==r||(a=(t.x*(s.y-i.y)+t.y*(i.x-s.x)+s.x*i.y-s.y*i.x)*d,l=(t.x*(s.y-e.y)+t.y*(e.x-s.x)-e.x*s.y+e.y*s.x)*d,o||0<=a&&a<=1&&0<=l&&l<=1||(h=!1))}return h&&(null!=n&&(n.x=t.x+a*(e.x-t.x),n.y=t.y+a*(e.y-t.y)),null!=r&&r.push(a,l)),h},intersections2edges:function(t,e,s,i,n){return null==n&&(n=!1),et.intersections2segments(t.originVertex.pos,t.destinationVertex.pos,e.originVertex.pos,e.destinationVertex.pos,s,i,n)},isConvex:function(t){var e,s,i=!0;return e=t.nextLeftEdge.oppositeEdge,s=t.nextRightEdge.destinationVertex,-1!=et.getRelativePosition(s.pos,e)?i=!1:(e=t.prevRightEdge,s=t.prevLeftEdge.originVertex,-1!=et.getRelativePosition(s.pos,e)&&(i=!1)),i},projectOrthogonaly:function(t,e){var s=e.originVertex.pos.x,i=e.originVertex.pos.y,n=e.destinationVertex.pos.x,r=e.destinationVertex.pos.y,o=t.x,h=t.y,a=(s*s-s*n-s*o+i*i-i*r-i*h+n*o+r*h)/(s*s-2*s*n+i*i-2*i*r+n*n+r*r);t.x=s+a*(n-s),t.y=i+a*(r-i)},intersections2Circles:function(t,e,s,i,n){var r,o,h,a,l,u,d;return l=z(s.x-t.x,s.y-t.y),u=1/(2*l),(t.x!=s.x||t.y!=s.y)&&l<=(e+i)*(e+i)&&l>=(e-i)*(e-i)&&(d=Math.sqrt(((e+i)*(e+i)-l)*(l-(i-e)*(i-e))),r=s.clone().sub(t).mul(u),o=t.clone().add(s).mul(.5),h=r.clone().mul(e*e-i*i),a=o.clone().add(h),null!=n&&n.push(a.x+r.y*d,a.y-r.x*d,a.x-r.y*d,a.y+r.x*d),!0)},intersectionsSegmentCircle:function(t,e,s,i,n){var r,o,h,a=t.x*t.x,l=t.y*t.y,u=e.y*e.y-2*e.y*t.y+l+e.x*e.x-2*e.x*t.x+a,d=2*t.y*s.y-2*a+2*e.y*t.y-2*l+2*e.x*t.x-2*e.x*s.x+2*t.x*s.x-2*e.y*s.y,c=d*d-4*u*(l+s.y*s.y+s.x*s.x-2*t.y*s.y-2*t.x*s.x+a-i*i);if(c<0)return!1;if(0==c)return!((o=-d/(2*u))<0||o>1)&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),!0);h=(-d-(r=Math.sqrt(c)))/(2*u);var p=!1;return 0<=(o=(-d+r)/(2*u))&&o<=1&&(null!=n&&n.push(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),o),p=!0),0<=h&&h<=1&&(null!=n&&n.push(t.x+h*(e.x-t.x),t.y+h*(e.y-t.y),h),p=!0),p},tangentsPointToCircle:function(t,e,s,i){var n=t.clone().add(e).mul(.5),r=.5*Z(t.x-e.x,t.y-e.y);return et.intersections2Circles(n,r,e,s,i)},tangentsCrossCircleToCircle:function(t,e,s,i){var n=Z(e.x-s.x,e.y-s.y),r=.25*n,o=s.clone().sub(e).mul(.25).add(e);if(et.intersections2Circles(e,t,o,r,i)){var h=i[0],a=i[1],l=i[2],u=i[3],d=e.clone().add(s).mul(.5),c=((h-d.x)*(s.y-e.y)+(a-d.y)*(-s.x+e.x))/(n*n),p=2*(d.x+c*(s.y-e.y))-h,g=2*(d.y-c*(s.x-e.x))-a,f=p+l-h,x=u+g-a;return i.push(f,x,p,g),!0}return!1},tangentsParalCircleToCircle:function(t,e,s,i){var n=1/Z(e.x-s.x,e.y-s.y),r=e.x+t*(s.y-e.y)*n,o=e.y+t*(-s.x+e.x)*n,h=2*e.x-r,a=2*e.y-o,l=h+s.x-e.x,u=a+s.y-e.y,d=r+s.x-e.x,c=o+s.y-e.y;i.push(r,o,h,a,l,u,d,c)},distanceSquaredPointToSegment:function(t,e,s){var i=z(s.x-e.x,s.y-e.y),n=((t.x-e.x)*(s.x-e.x)+(t.y-e.y)*(s.y-e.y))/i;return n<0?z(t.x-e.x,t.y-e.y):n<=1?z(e.x-t.x,e.y-t.y)-n*n*i:z(t.x-s.x,t.y-s.y)},distanceSquaredVertexToEdge:function(t,e){return et.distanceSquaredPointToSegment(t.pos,e.originVertex.pos,e.destinationVertex.pos)},pathLength:function(t){for(var e,s,i=0,n=t[0],r=t[1],o=2,h=t.length;o<h;)e=t[o],s=t[o+1],i+=Z(e-n,s-r),n=e,r=s,o+=2;return i}};p.prototype={constructor:p,setDatas:function(t,e,s,i,n,r){this.isConstrained=void 0!==n&&r,this.isReal=void 0===n||n,this.originVertex=t,this.oppositeEdge=e,this.nextLeftEdge=s,this.leftFace=i},getDatas:function(){return[this.originVertex.pos.x,this.originVertex.pos.y,this.destinationVertex.pos.x,this.destinationVertex.pos.y,this.isConstrained?1:0]},addFromConstraintSegment:function(t){-1===this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!==e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.originVertex=null,this.oppositeEdge=null,this.nextLeftEdge=null,this.leftFace=null,this.fromConstraintSegments=null},toString:function(){return"edge "+this.originVertex.id+" - "+this.destinationVertex.id}},g.prototype={constructor:g,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},dispose:function(){this.edge=null,this.isReal=!1}},f.prototype={constructor:f,setDatas:function(t,e){this.isReal=void 0===e||e,this.edge=t},addFromConstraintSegment:function(t){-1==this.fromConstraintSegments.indexOf(t)&&this.fromConstraintSegments.push(t)},removeFromConstraintSegment:function(t){var e=this.fromConstraintSegments.indexOf(t);-1!=e&&this.fromConstraintSegments.splice(e,1)},dispose:function(){this.pos=null,this.edge=null,this.fromConstraintSegments=null},toString:function(){return"ver_id "+this.id}},x.prototype={constructor:x,dispose:function(){for(;this.segments.length>0;)this.segments.pop().dispose();this.segments=null}},y.prototype={constructor:y,addEdge:function(t){-1==this.edges.indexOf(t)&&-1==this.edges.indexOf(t.oppositeEdge)&&this.edges.push(t)},removeEdge:function(t){var e=this.edges.indexOf(t);-1==e&&(e=this.edges.indexOf(t.oppositeEdge)),-1!=e&&this.edges.splice(e,1)},dispose:function(){this.edges=null,this.fromShape=null},toString:function(){return"seg_id "+this.id}},_.prototype={constructor:_,position:function(t,e){this._position.set(t,e),this.hasChanged=!0},scale:function(t,e){this._scale.set(t,e),this.hasChanged=!0},pivot:function(t,e){this._pivot.set(t,e),this.hasChanged=!0},dispose:function(){this._matrix=null,this._coordinates=null,this._constraintShape=null},updateValuesFromMatrix:function(){},updateMatrixFromValues:function(){this._matrix.identity().translate(this._pivot.negate()).scale(this._scale).rotate(this._rotation).translate(this._position)}},m.prototype={constructor:m,dispose:function(){for(;null!=this.node;)this.deleteNode(this.node)},insertNode:function(){var t=new E;return null!=this.node&&(t.next=this.node,this.node.prev=t),this.node=t,t},deleteNode:function(t){for(;null!=t.outgoingEdge;)null!=t.outgoingEdge.oppositeEdge&&this.deleteEdge(t.outgoingEdge.oppositeEdge),this.deleteEdge(t.outgoingEdge);for(var e,s=this.node;null!=s;)null!=(e=s.successorNodes.get(t))&&this.deleteEdge(e),s=s.next;this.node==t?null!=t.next?(t.next.prev=null,this.node=t.next):this.node=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.dispose()},insertEdge:function(t,e){if(null!=t.successorNodes.get(e))return null;var s=new v;null!=this.edge&&(this.edge.prev=s,s.next=this.edge),this.edge=s,s.sourceNode=t,s.destinationNode=e,t.successorNodes.set(e,s),null!=t.outgoingEdge?(t.outgoingEdge.rotPrevEdge=s,s.rotNextEdge=t.outgoingEdge,t.outgoingEdge=s):t.outgoingEdge=s;var i=e.successorNodes.get(t);return null!=i&&(s.oppositeEdge=i,i.oppositeEdge=s),s},deleteEdge:function(t){this.edge==t?null!=t.next?(t.next.prev=null,this.edge=t.next):this.edge=null:null!=t.next?(t.prev.next=t.next,t.next.prev=t.prev):t.prev.next=null,t.sourceNode.outgoingEdge==t?null!=t.rotNextEdge?(t.rotNextEdge.rotPrevEdge=null,t.sourceNode.outgoingEdge=t.rotNextEdge):t.sourceNode.outgoingEdge=null:null!=t.rotNextEdge?(t.rotPrevEdge.rotNextEdge=t.rotNextEdge,t.rotNextEdge.rotPrevEdge=t.rotPrevEdge):t.rotPrevEdge.rotNextEdge=null,t.dispose()}},v.prototype={dispose:function(){this.next=null,this.prev=null,this.rotPrevEdge=null,this.rotNextEdge=null,this.oppositeEdge=null,this.sourceNode=null,this.destinationNode=null,this.data=null}},E.prototype={dispose:function(){this.successorNodes.dispose(),this.prev=null,this.next=null,this.outgoingEdge=null,this.successorNodes=null,this.data=null}};var st={color:{r:255,g:255,b:255},nearly:50,maxDistance:1,setColor:function(t){st.color=t},setNearly:function(t){st.nearly=t},buildShapes:function(t){for(var s=[],i=new e(2),n=t.height-1,r=t.width-1,o=1;o<n;o++)for(var h=0;h<r;h++)st.getWhite(t,h,o)&&!st.getWhite(t,h+1,o)&&(i.get(h+1+"_"+o)||s.push(st.buildShape(t,o,h+1,i)));return i.dispose(),s},getWhite:function(t,e,s){var i=!1,n=t.bytes,r=t.width,o=st.color,h=st.nearly,a=e+s*r<<2;return void 0!==o.r&&Q(n[a],o.r,h)&&(i=!0),void 0!==o.g&&Q(n[a+1],o.g,h)&&(i=!0),void 0!==o.b&&Q(n[a+2],o.b,h)&&(i=!0),void 0!==o.a&&Q(n[a+3],o.a,h)&&(i=!0),i},buildShape:function(t,e,i,n){var r=i,o=e,h=[r,o];n.set(r+"_"+o,!0);t.width,t.height;for(var a,l,u=new s(0,1),d=new s,c=-1;;){if(a=e+u.x+u.y,l=i+u.x-u.y,st.getWhite(t,l,a)?(a=e+u.y,l=i+u.x,st.getWhite(t,l,a)?(a=e,l=i,d.x=u.y,d.y=-u.x):(d.x=u.x,d.y=u.y)):(d.x=-u.y,d.y=u.x),r+=u.x,o+=u.y,r===h[0]&&o===h[1])break;if(h.push(r),h.push(o),n.set(r+"_"+o,!0),e=a,i=l,u.x=d.x,u.y=d.y,0===--c)break}return h},buildGraph:function(t){for(var e,i=0,n=new m;i<t.length;)(e=n.insertNode()).data=new C,e.data.index=i,e.data.point=new s(t[i],t[i+1]),i+=2;var r,o,h,a,l,u,d,c,p=!1;for(r=n.node;null!=r;){for(o=null!=r.next?r.next:n.node;o!=r;){for(p=!0,h=null!=r.next?r.next:n.node,u=2,l=0;h!=o;){if((a=et.distanceSquaredPointToSegment(h.data.point,r.data.point,o.data.point))<0&&(a=0),a>=st.maxDistance){p=!1;break}u++,l+=a,h=null!=h.next?h.next:n.node}if(!p)break;d=n.insertEdge(r,o),(c=new w).sumDistancesSquared=l,c.length=r.data.point.distanceTo(o.data.point),c.nodesCount=u,d.data=c,o=null!=o.next?o.next:n.node}r=r.next}return n},buildPolygon:function(t){for(var e,i,n,r,o,h,a=[],l=2147483647,u=null,d=t.node;d.data.index<l;){for(l=d.data.index,a.push(d.data.point.x),a.push(d.data.point.y),h=0,r=d.outgoingEdge;null!=r;)(o=r.data.nodesCount-r.data.length*Math.sqrt(r.data.sumDistancesSquared/r.data.nodesCount))>h&&(h=o,u=r),r=r.rotNextEdge;d=u.destinationNode}return e=new s(a[a.length-2],a[a.length-1]),i=new s(a[0],a[1]),n=new s(a[2],a[3]),0===et.getDirection(e,i,n)&&(a.shift(),a.shift()),a}};S.prototype={constructor:S,clear:function(t){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=[];this._edges.length>0;)this._edges.pop().dispose();for(this._edges=[];this._faces.length>0;)this._faces.pop().dispose();for(this._faces=[];this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();if(this._constraintShapes=[],!t)for(;this._objects.length>0;)this._objects.pop().dispose();this._objects=[],this.__edgesToCheck=[],this.__centerVertex=[],this.AR_vertex=null,this.AR_edge=null},dispose:function(){for(;this._vertices.length>0;)this._vertices.pop().dispose();for(this._vertices=null;this._edges.length>0;)this._edges.pop().dispose();for(this._edges=null;this._faces.length>0;)this._faces.pop().dispose();for(this._faces=null;this._constraintShapes.length>0;)this._constraintShapes.pop().dispose();for(this._constraintShapes=null;this._objects.length>0;)this._objects.pop().dispose();this._objects=null,this.__edgesToCheck=null,this.__centerVertex=null,this.AR_vertex=null,this.AR_edge=null},buildFromRecord:function(t){for(var e=t.split(";"),s=e.length,i=0;i<s;)this.insertConstraintSegment(parseFloat(e[i]),parseFloat(e[i+1]),parseFloat(e[i+2]),parseFloat(e[i+3])),i+=4},insertObject:function(t){null!=t.constraintShape&&this.deleteObject(t);var e,n=new x,r=t.coordinates;t.updateMatrixFromValues();var o=t.matrix||new i,h=new s,a=new s,l=r.length,u=0;for(u=0;u<l;u+=4)h.set(r[u],r[u+1]).transformMat2D(o),a.set(r[u+2],r[u+3]).transformMat2D(o),null!=(e=this.insertConstraintSegment(h.x,h.y,a.x,a.y))&&(e.fromShape=n,n.segments.push(e));this._constraintShapes.push(n),t.constraintShape=n,this.__objectsUpdateInProgress||this._objects.push(t)},deleteObject:function(t){if(null!=t.constraintShape&&(this.deleteConstraintShape(t.constraintShape),t.constraintShape=null,!this.__objectsUpdateInProgress)){var e=this._objects.indexOf(t);this._objects.splice(e,1)}},updateObjects:function(){this.__objectsUpdateInProgress=!0;for(var t,e=this._objects.length,s=0;s<e;)(t=this._objects[s]).hasChanged&&(this.deleteObject(t),this.insertObject(t),t.hasChanged=!1,this.isRedraw=!0),s++;this.__objectsUpdateInProgress=!1},insertConstraintShape:function(t){for(var e=new x,s=null,i=t.length,n=0;n<i;)null!=(s=this.insertConstraintSegment(t[n],t[n+1],t[n+2],t[n+3]))&&(s.fromShape=e,e.segments.push(s)),n+=4;return this._constraintShapes.push(e),e},deleteConstraintShape:function(t){for(var e=0,s=t.segments.length;e<s;)this.deleteConstraintSegment(t.segments[e]),e++;this._constraintShapes.splice(this._constraintShapes.indexOf(t),1),t.dispose()},insertConstraintSegment:function(t,e,i,n){var r=t,o=e,h=i,a=n;if(t>this.width&&i>this.width||t<0&&i<0||e>this.height&&n>this.height||e<0&&n<0)return null;var l=i-t,u=n-e,d=-1/0,g=1/0;if(0!=l){var f=(0-t)/l,x=(this.width-t)/l;d=Math.max(d,Math.min(f,x)),g=Math.min(g,Math.max(f,x))}if(0!=u){var _=(0-e)/u,m=(this.height-e)/u;d=Math.max(d,Math.min(_,m)),g=Math.min(g,Math.max(_,m))}if(!(g>=d))return null;g<1&&(h=l*g+t,a=u*g+e),d>0&&(r=l*d+t,o=u*d+e);var v=this.insertVertex(r,o);if(null==v)return null;var E=this.insertVertex(h,a);if(null==E)return null;if(v.id===E.id)return null;var w,C,S=new c,F=new y,P=new p,V=new p;P.setDatas(v,V,null,null,!0,!0),V.setDatas(E,P,null,null,!0,!0);var b,D,O,L=[],N=[],T=[],M={type:3},j=new s,R=!1;for(M=w=v,M=w;;)if(R=!1,0===M.type){for(w=M,S.fromVertex=w;null!=(C=S.next());){if(C.destinationVertex.id===E.id)return C.isConstrained||(C.isConstrained=!0,C.oppositeEdge.isConstrained=!0),C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,v.addFromConstraintSegment(F),E.addFromConstraintSegment(F),F.addEdge(C),F;if(et.distanceSquaredVertexToEdge(C.destinationVertex,P)<=1e-4){C.isConstrained||(C.isConstrained=!0,C.oppositeEdge.isConstrained=!0),C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,v.addFromConstraintSegment(F),F.addEdge(C),v=C.destinationVertex,P.originVertex=v,M=v,R=!0;break}}if(R)continue;for(S.fromVertex=w;null!=(C=S.next());)if(C=C.nextLeftEdge,et.intersections2edges(C,P,j)){if(C.isConstrained){for(v=this.splitEdge(C,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)if(C.destinationVertex.id===v.id){C.isConstrained=!0,C.oppositeEdge.isConstrained=!0,C.addFromConstraintSegment(F),C.oppositeEdge.fromConstraintSegments=C.fromConstraintSegments,F.addEdge(C);break}w.addFromConstraintSegment(F),P.originVertex=v,M=v}else L.push(C),N.unshift(C.nextLeftEdge),T.push(C.prevLeftEdge),M=C=C.oppositeEdge;break}}else if(1===M.type){if(C=M,(b=C.nextLeftEdge).destinationVertex.id===E.id)return N.unshift(b.nextLeftEdge),T.push(b),D=new p,O=new p,D.setDatas(v,O,null,null,!0,!0),O.setDatas(E,D,null,null,!0,!0),N.push(D),T.push(O),this.insertNewConstrainedEdge(F,D,L,N,T),F;if(et.distanceSquaredVertexToEdge(b.destinationVertex,P)<=1e-4)N.unshift(b.nextLeftEdge),T.push(b),D=new p,O=new p,D.setDatas(v,O,null,null,!0,!0),O.setDatas(b.destinationVertex,D,null,null,!0,!0),N.push(D),T.push(O),this.insertNewConstrainedEdge(F,D,L,N,T),L.splice(0,L.length),N.splice(0,N.length),T.splice(0,T.length),v=b.destinationVertex,P.originVertex=v,M=v;else if(et.intersections2edges(b,P,j))if(b.isConstrained){for(w=this.splitEdge(b,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)C.destinationVertex==N[0].originVertex&&N.unshift(C),C.destinationVertex==T[T.length-1].destinationVertex&&T.push(C.oppositeEdge);D=new p,O=new p,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),N.push(D),T.push(O),this.insertNewConstrainedEdge(F,D,L,N,T),L.splice(0,L.length),N.splice(0,N.length),T.splice(0,T.length),v=w,P.originVertex=v,M=v}else L.push(b),N.unshift(b.nextLeftEdge),M=C=b.oppositeEdge;else if(b=b.nextLeftEdge,et.intersections2edges(b,P,j),b.isConstrained){for(w=this.splitEdge(b,j.x,j.y),S.fromVertex=w;null!=(C=S.next());)C.destinationVertex.id===N[0].originVertex.id&&N.unshift(C),C.destinationVertex.id===T[T.length-1].destinationVertex.id&&T.push(C.oppositeEdge);D=new p,O=new p,D.setDatas(v,O,null,null,!0,!0),O.setDatas(w,D,null,null,!0,!0),N.push(D),T.push(O),this.insertNewConstrainedEdge(F,D,L,N,T),L.splice(0,L.length),N.splice(0,N.length),T.splice(0,T.length),v=w,P.originVertex=v,M=v}else L.push(b),T.push(b.prevLeftEdge),M=C=b.oppositeEdge}},insertNewConstrainedEdge:function(t,e,s,i,n){this._edges.push(e),this._edges.push(e.oppositeEdge),e.addFromConstraintSegment(t),e.oppositeEdge.fromConstraintSegments=e.fromConstraintSegments,t.addEdge(e),e.originVertex.addFromConstraintSegment(t),e.destinationVertex.addFromConstraintSegment(t),this.untriangulate(s),this.triangulate(i,!0),this.triangulate(n,!0)},deleteConstraintSegment:function(t){for(var e,s=[],i=null,n=t.edges.length,r=0;r<n;)(i=t.edges[r]).removeFromConstraintSegment(t),0==i.fromConstraintSegments.length&&(i.isConstrained=!1,i.oppositeEdge.isConstrained=!1),(e=i.originVertex).removeFromConstraintSegment(t),s.push(e),r++;for((e=i.destinationVertex).removeFromConstraintSegment(t),s.push(e),n=s.length,r=0;r<n;)this.deleteVertex(s[r]),r++;t.dispose()},check:function(){for(var t=this._edges.length,e=0;e<t;){if(null==this._edges[e].nextLeftEdge)return void U("!!! missing nextLeftEdge");e++}U("check OK")},insertVertex:function(t,e){if(t<0||e<0||t>this.width||e>this.height)return null;this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=et.locatePosition(new s(t,e),this),n=null;switch(i.type){case 0:n=i;break;case 1:var r=i;n=this.splitEdge(r,t,e);break;case 2:var o=i;n=this.splitFace(o,t,e)}return this.restoreAsDelaunay(),n},flipEdge:function(t){var e=t,s=t.oppositeEdge,i=new p,n=new p,r=e.nextLeftEdge,o=r.nextLeftEdge,h=s.nextLeftEdge,a=h.nextLeftEdge,l=e.originVertex,u=s.originVertex,d=o.originVertex,c=a.originVertex,f=e.leftFace,x=s.leftFace,y=new g,_=new g;return this._edges.push(i),this._edges.push(n),this._faces.push(_),this._faces.push(y),i.setDatas(d,n,a,_,t.isReal,t.isConstrained),n.setDatas(c,i,o,y,t.isReal,t.isConstrained),_.setDatas(i),y.setDatas(n),u.edge.id===s.id&&u.setDatas(r),l.edge.id===e.id&&l.setDatas(h),r.nextLeftEdge=i,r.leftFace=_,o.nextLeftEdge=h,o.leftFace=y,h.nextLeftEdge=n,h.leftFace=y,a.nextLeftEdge=r,a.leftFace=_,this._edges.splice(this._edges.indexOf(e),1),this._edges.splice(this._edges.indexOf(s),1),e.dispose(),s.dispose(),this._faces.splice(this._faces.indexOf(f),1),this._faces.splice(this._faces.indexOf(x),1),f.dispose(),x.dispose(),n},splitEdge:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t,n=i.oppositeEdge,r=i.nextLeftEdge,o=r.nextLeftEdge,h=n.nextLeftEdge,a=h.nextLeftEdge,l=o.originVertex,u=i.originVertex,d=a.originVertex,c=n.originVertex,x=i.leftFace,y=n.leftFace;if((u.pos.x-e)*(u.pos.x-e)+(u.pos.y-s)*(u.pos.y-s)<=1e-4)return u;if((c.pos.x-e)*(c.pos.x-e)+(c.pos.y-s)*(c.pos.y-s)<=1e-4)return c;var _=new f,m=new p,v=new p,E=new p,w=new p,C=new p,S=new p,F=new p,P=new p,V=new g,b=new g,D=new g,O=new g;if(this._vertices.push(_),this._edges.push(v),this._edges.push(m),this._edges.push(S),this._edges.push(C),this._edges.push(w),this._edges.push(E),this._edges.push(P),this._edges.push(F),this._faces.push(O),this._faces.push(D),this._faces.push(b),this._faces.push(V),_.setDatas(x.isReal?v:w),_.pos.x=e,_.pos.y=s,et.projectOrthogonaly(_.pos,i),v.setDatas(_,m,o,V,x.isReal),m.setDatas(l,v,P,O,x.isReal),S.setDatas(_,C,h,b,t.isReal,t.isConstrained),C.setDatas(u,S,v,V,t.isReal,t.isConstrained),w.setDatas(_,E,a,D,y.isReal),E.setDatas(d,w,S,b,y.isReal),P.setDatas(_,F,r,O,t.isReal,t.isConstrained),F.setDatas(c,P,w,D,t.isReal,t.isConstrained),V.setDatas(v,x.isReal),b.setDatas(S,y.isReal),D.setDatas(w,y.isReal),O.setDatas(P,x.isReal),u.edge.id===i.id&&u.setDatas(C),c.edge.id===n.id&&c.setDatas(F),o.nextLeftEdge=C,o.leftFace=V,h.nextLeftEdge=E,h.leftFace=b,a.nextLeftEdge=F,a.leftFace=D,r.nextLeftEdge=m,r.leftFace=O,i.isConstrained){var L=i.fromConstraintSegments;C.fromConstraintSegments=L.slice(0),S.fromConstraintSegments=C.fromConstraintSegments,P.fromConstraintSegments=L.slice(0),F.fromConstraintSegments=P.fromConstraintSegments;for(var N,T,M=i.fromConstraintSegments.length,j=0;j<M;)-1!=(T=(N=i.fromConstraintSegments[j].edges).indexOf(i))?N.splice(T,1,C,P):N.splice(N.indexOf(n),1,F,S),j++;_.fromConstraintSegments=L.slice(0)}return this._edges.splice(this._edges.indexOf(i),1),this._edges.splice(this._edges.indexOf(n),1),i.dispose(),n.dispose(),this._faces.splice(this._faces.indexOf(x),1),this._faces.splice(this._faces.indexOf(y),1),x.dispose(),y.dispose(),this.__centerVertex=_,this.__edgesToCheck.push(o),this.__edgesToCheck.push(h),this.__edgesToCheck.push(a),this.__edgesToCheck.push(r),_},splitFace:function(t,e,s){this.__edgesToCheck.splice(0,this.__edgesToCheck.length);var i=t.edge,n=i.nextLeftEdge,r=n.nextLeftEdge,o=i.originVertex,h=n.originVertex,a=r.originVertex,l=new f,u=new p,d=new p,c=new p,x=new p,y=new p,_=new p,m=new g,v=new g,E=new g;return this._vertices.push(l),this._edges.push(u),this._edges.push(d),this._edges.push(c),this._edges.push(x),this._edges.push(y),this._edges.push(_),this._faces.push(m),this._faces.push(v),this._faces.push(E),l.setDatas(d),l.pos.x=e,l.pos.y=s,u.setDatas(o,d,_,E),d.setDatas(l,u,i,m),c.setDatas(h,x,d,m),x.setDatas(l,c,n,v),y.setDatas(a,_,x,v),_.setDatas(l,y,r,E),m.setDatas(d),v.setDatas(x),E.setDatas(_),i.nextLeftEdge=c,i.leftFace=m,n.nextLeftEdge=y,n.leftFace=v,r.nextLeftEdge=u,r.leftFace=E,this._faces.splice(this._faces.indexOf(t),1),t.dispose(),this.__centerVertex=l,this.__edgesToCheck.push(i),this.__edgesToCheck.push(n),this.__edgesToCheck.push(r),l},restoreAsDelaunay:function(){for(var t;this.__edgesToCheck.length>0;)!(t=this.__edgesToCheck.shift()).isReal||t.isConstrained||et.isDelaunay(t)||(t.nextLeftEdge.destinationVertex.id===this.__centerVertex.id?(this.__edgesToCheck.push(t.nextRightEdge),this.__edgesToCheck.push(t.prevRightEdge)):(this.__edgesToCheck.push(t.nextLeftEdge),this.__edgesToCheck.push(t.prevLeftEdge)),this.flipEdge(t))},deleteVertex:function(t){var e,s=new c;s.fromVertex=t,s.realEdgesOnly=!1;var i,n=[],r=[],o=!1,h=!1,a=[],l=[];if(e=0==t.fromConstraintSegments.length)for(;null!=(i=s.next());)n.push(i),r.push(i.nextLeftEdge);else{for(var u,d=0,g=t.fromConstraintSegments.length;d<g;){var f=d++;if((u=t.fromConstraintSegments[f].edges)[0].originVertex.id===t.id||u[u.length-1].destinationVertex.id===t.id)return!1}for(var x=0;null!=(i=s.next());)if(n.push(i),i.isConstrained&&++x>2)return!1;a=[],l=[];var y=null,_=null,m=new p,v=new p;this._edges.push(m),this._edges.push(v);for(var E=0,w=n.length;E<w;)(i=n[E++]).isConstrained?null==y?(v.setDatas(i.destinationVertex,m,null,null,!0,!0),a.push(m),a.push(i.nextLeftEdge),l.push(v),y=i):null==_&&(m.setDatas(i.destinationVertex,v,null,null,!0,!0),l.push(i.nextLeftEdge),_=i):null==y?l.push(i.nextLeftEdge):null==_?a.push(i.nextLeftEdge):l.push(i.nextLeftEdge);o=y.leftFace.isReal,h=_.leftFace.isReal,m.fromConstraintSegments=y.fromConstraintSegments.slice(0),v.fromConstraintSegments=m.fromConstraintSegments;for(var C,S=0,F=t.fromConstraintSegments.length;S<F;){var P=S++;-1!=(C=(u=t.fromConstraintSegments[P].edges).indexOf(y))?u.splice(C-1,2,m):u.splice(u.indexOf(_)-1,2,v)}}for(var V,b=0,D=n.length;b<D;)V=(i=n[b++]).leftFace,this._faces.splice(this._faces.indexOf(V),1),V.dispose(),i.destinationVertex.edge=i.nextLeftEdge,this._edges.splice(this._edges.indexOf(i.oppositeEdge),1),i.oppositeEdge.dispose(),this._edges.splice(this._edges.indexOf(i),1),i.dispose();return this._vertices.splice(this._vertices.indexOf(t),1),t.dispose(),e?this.triangulate(r,!0):(this.triangulate(a,o),this.triangulate(l,h)),!0},untriangulate:function(t){for(var s,i=new e(1),n=0,r=t.length;n<r;){var o=n++;s=t[o],null==i.get(s.originVertex)&&(s.originVertex.edge=s.prevLeftEdge.oppositeEdge,i.set(s.originVertex,!0)),null==i.get(s.destinationVertex)&&(s.destinationVertex.edge=s.nextLeftEdge,i.set(s.destinationVertex,!0)),this._faces.splice(this._faces.indexOf(s.leftFace),1),s.leftFace.dispose(),o==t.length-1&&(this._faces.splice(this._faces.indexOf(s.rightFace),1),s.rightFace.dispose())}i.dispose();for(var h=0,a=t.length;h<a;)s=t[h++],this._edges.splice(this._edges.indexOf(s.oppositeEdge),1),this._edges.splice(this._edges.indexOf(s),1),s.oppositeEdge.dispose(),s.dispose()},triangulate:function(t,e){if(t.length<2)U("BREAK ! the hole has less than 2 edges");else if(2!==t.length)if(3===t.length){var i=new g;i.setDatas(t[0],e),this._faces.push(i),t[0].leftFace=i,t[1].leftFace=i,t[2].leftFace=i,t[0].nextLeftEdge=t[1],t[1].nextLeftEdge=t[2],t[2].nextLeftEdge=t[0]}else{for(var n,r,o=t[0],h=o.originVertex,a=o.destinationVertex,l=new s,u=0,d=!1,c=0,f=2,x=t.length;f<x;){var y=f++;if(n=t[y].originVertex,1==et.getRelativePosition2(n.pos,o)){c=y,d=!0,et.getCircumcenter(h.pos,a.pos,n.pos,l),u=z(h.pos.x-l.x,h.pos.y-l.y),u-=1e-4;for(var _=2,m=t.length;_<m;){var v=_++;if(v!=y&&(r=t[v].originVertex,z(r.pos.x-l.x,r.pos.y-l.y)<u)){d=!1;break}}if(d)break}}d||(U("NO DELAUNAY FOUND"),c=2);var E,w,C,S,F,P,V=[];c<t.length-1&&(E=new p,w=new p,this._edges.push(E,w),E.setDatas(h,w,null,null,e,!1),w.setDatas(t[c].originVertex,E,null,null,e,!1),(F=t.slice(c)).push(E),this.triangulate(F,e)),c>2&&(C=new p,S=new p,this._edges.push(C,S),C.setDatas(t[1].originVertex,S,null,null,e,!1),S.setDatas(t[c].originVertex,C,null,null,e,!1),(P=t.slice(1,c)).push(S),this.triangulate(P,e)),2===c?V.push(o,t[1],w):c===t.length-1?V.push(o,C,t[c]):V.push(o,C,w),this.triangulate(V,e)}else U("BREAK ! the hole has only 2 edges")},findPositionFromBounds:function(t,e){return t<=0?e<=0?1:e>=this.height?7:8:t>=this.width?e<=0?3:e>=this.height?5:4:e<=0?2:e>=this.height?6:0},compute_Data:function(){var t,s,i,n=[],r=[];(i=new l).fromMesh=this;var o;o=new d;for(var h=new e(1);null!=(t=i.next());)if(h.set(t,!0),this.vertexIsInsideAABB(t,this))for(n.push(t.pos.x,t.pos.y),o.fromVertex=t;null!=(s=o.next());)h.get(s.originVertex)||(r=r.concat(s.getDatas()));h.dispose(),this.AR_vertex=new tt(n),this.AR_edge=new tt(r),this.data_vertex=null,this.data_edges=null},vertexIsInsideAABB:function(t,e){return!(t.pos.x<0||t.pos.x>e.width||t.pos.y<0||t.pos.y>e.height)}},F.prototype={constructor:F,dispose:function(){this.mesh=null,this.closedFaces.dispose(),this.openedFaces.dispose(),this.entryEdges.dispose(),this.predecessor.dispose(),this.entryX.dispose(),this.entryY.dispose(),this.scoreF.dispose(),this.scoreG.dispose(),this.scoreH.dispose(),this.sortedOpenedFaces=null,this.closedFaces=null,this.openedFaces=null,this.entryEdges=null,this.entryX=null,this.entryY=null,this.scoreF=null,this.scoreG=null,this.scoreH=null,this.predecessor=null},findPath:function(t,i,n,r){this.sortedOpenedFaces=[],this.closedFaces=new e(1),this.openedFaces=new e(1),this.entryEdges=new e(1),this.predecessor=new e(1),this.entryX=new e(1),this.entryY=new e(1),this.scoreF=new e(1),this.scoreG=new e(1),this.scoreH=new e(1);var o;if(0!==(o=et.locatePosition(t,this.mesh)).type){if(1===o.type){if(o.isConstrained)return;this.fromFace=o.leftFace}else 2===o.type&&(this.fromFace=o);0===(o=et.locatePosition(i,this.mesh)).type?this.toFace=o.edge.leftFace:1===o.type?this.toFace=o.leftFace:2===o.type&&(this.toFace=o),this.sortedOpenedFaces.push(this.fromFace),this.entryEdges.set(this.fromFace,null),this.entryX.set(this.fromFace,t.x),this.entryY.set(this.fromFace,t.y),this.scoreG.set(this.fromFace,0);var h=Z(i.x-t.x,i.y-t.y);this.scoreH.set(this.fromFace,h),this.scoreF.set(this.fromFace,h);for(var a,l,u,d,c,p=new s,g=new s,f=new s,x=!1;;){if(0==this.sortedOpenedFaces.length){U("AStar no path found"),this.curFace=null;break}if(this.curFace=this.sortedOpenedFaces.pop(),this.curFace==this.toFace)break;for(this.iterEdge.fromFace=this.curFace;null!=(a=this.iterEdge.next());)if(!a.isConstrained&&(l=a.rightFace,!this.closedFaces.get(l))){if(this.curFace!=this.fromFace&&this._radius>0&&!this.isWalkableByRadius(this.entryEdges.get(this.curFace),this.curFace,a))continue;p.x=this.entryX.get(this.curFace),p.y=this.entryY.get(this.curFace),g.x=p.x,g.y=p.y,g.x=.5*(a.originVertex.pos.x+a.destinationVertex.pos.x),g.y=.5*(a.originVertex.pos.y+a.destinationVertex.pos.y),f.x=g.x-i.x,f.y=g.y-i.y,c=f.length(),f.x=p.x-g.x,f.y=p.y-g.y,u=c+(d=this.scoreG.get(this.curFace)+f.length()),x=!1,null!=this.openedFaces.get(l)&&this.openedFaces.get(l)?this.scoreF.get(l)>u&&(x=!0):(this.sortedOpenedFaces.push(l),this.openedFaces.set(l,!0),x=!0),x&&(this.entryEdges.set(l,a),this.entryX.set(l,g.x),this.entryY.set(l,g.y),this.scoreF.set(l,u),this.scoreG.set(l,d),this.scoreH.set(l,c),this.predecessor.set(l,this.curFace))}this.openedFaces.set(this.curFace,!1),this.closedFaces.set(this.curFace,!0),this.sortedOpenedFaces.sort(function(t,e){return this.scoreF.get(t)==this.scoreF.get(e)?0:this.scoreF.get(t)<this.scoreF.get(e)?1:-1}.bind(this))}if(null!=this.curFace)for(n.push(this.curFace);this.curFace!=this.fromFace;)r.unshift(this.entryEdges.get(this.curFace)),this.curFace=this.predecessor.get(this.curFace),n.unshift(this.curFace)}},isWalkableByRadius:function(t,i,n){var r=null,o=null,h=null;t.originVertex==n.originVertex?(r=t.destinationVertex,o=n.destinationVertex,h=t.originVertex):t.destinationVertex==n.destinationVertex?(r=t.originVertex,o=n.originVertex,h=t.destinationVertex):t.originVertex==n.destinationVertex?(r=t.destinationVertex,o=n.originVertex,h=t.originVertex):t.destinationVertex==n.originVertex&&(r=t.originVertex,o=n.destinationVertex,h=t.destinationVertex);var a;if((h.pos.x-r.pos.x)*(o.pos.x-r.pos.x)+(h.pos.y-r.pos.y)*(o.pos.y-r.pos.y)<=0)return z(h.pos.x-r.pos.x,h.pos.y-r.pos.y)>=this.diameterSquared;if((h.pos.x-o.pos.x)*(r.pos.x-o.pos.x)+(h.pos.y-o.pos.y)*(r.pos.y-o.pos.y)<=0)return z(h.pos.x-o.pos.x,h.pos.y-o.pos.y)>=this.diameterSquared;if((a=i.edge!=t&&i.edge.oppositeEdge!=t&&i.edge!=n&&i.edge.oppositeEdge!=n?i.edge:i.edge.nextLeftEdge!=t&&i.edge.nextLeftEdge.oppositeEdge!=t&&i.edge.nextLeftEdge!=n&&i.edge.nextLeftEdge.oppositeEdge!=n?i.edge.nextLeftEdge:i.edge.prevLeftEdge).isConstrained){var l=new s(h.pos.x,h.pos.y);return et.projectOrthogonaly(l,a),z(l.x-h.pos.x,l.y-h.pos.y)>=this.diameterSquared}var u=z(h.pos.x-r.pos.x,h.pos.y-r.pos.y),d=z(h.pos.x-o.pos.x,h.pos.y-o.pos.y);if(u<this.diameterSquared||d<this.diameterSquared)return!1;var c=[],p=[],g=new e(1);if(p.push(a),a.leftFace==i){c.push(a.rightFace);var f=a.rightFace;g.set(f,!0)}else{c.push(a.leftFace);var x=a.leftFace;g.set(x,!0)}for(var y,_,m,v,E,w;c.length>0;){if(y=c.shift(),_=p.shift(),y.edge==_||y.edge==_.oppositeEdge?(m=y.edge.nextLeftEdge,E=y.edge.nextLeftEdge.nextLeftEdge):y.edge.nextLeftEdge==_||y.edge.nextLeftEdge==_.oppositeEdge?(m=y.edge,E=y.edge.nextLeftEdge.nextLeftEdge):(m=y.edge,E=y.edge.nextLeftEdge),v=m.leftFace==y?m.rightFace:m.leftFace,w=E.leftFace==y?E.rightFace:E.leftFace,!g.get(v)&&et.distanceSquaredVertexToEdge(h,m)<this.diameterSquared){if(m.isConstrained)return!1;c.push(v),p.push(m),g.set(v,!0)}if(!g.get(w)&&et.distanceSquaredVertexToEdge(h,E)<this.diameterSquared){if(E.isConstrained)return!1;c.push(w),p.push(E),g.set(w,!0)}}return g.dispose(),!0}},P.prototype={constructor:P,dispose:function(){this._sampleCircle=null},getPoint:function(t,e){return e=e||0,t=t||0,this.__point=this._poolPoints[this._currPoolPointsIndex],this.__point.set(t,e),++this._currPoolPointsIndex==this._poolPointsSize&&(this._poolPoints.push(new s),this._poolPointsSize++),this.__point},getCopyPoint:function(t){return this.getPoint(t.x,t.y)},findPath:function(t,s,i,n,r){var o=t,h=s,a=1.01*this._radius;if(this._currPoolPointsIndex=0,this._radius>0){var l,u,d,c,p,g=i[0];d=g.edge.originVertex.pos,c=g.edge.destinationVertex.pos,p=g.edge.nextLeftEdge.destinationVertex.pos,(l=z(d.x-o.x,d.y-o.y))<=this._radiusSquared?(u=Math.sqrt(l),o.sub(d).div(u).mul(a).add(d)):(l=z(c.x-o.x,c.y-o.y))<=this._radiusSquared?(u=Math.sqrt(l),o.sub(c).div(u).mul(a).add(c)):(l=z(p.x-o.x,p.y-o.y))<=this._radiusSquared&&(u=Math.sqrt(l),o.sub(p).div(u).mul(a).add(p)),d=(g=i[i.length-1]).edge.originVertex.pos,c=g.edge.destinationVertex.pos,p=g.edge.nextLeftEdge.destinationVertex.pos,(l=z(d.x-h.x,d.y-h.y))<=this._radiusSquared?(u=Math.sqrt(l),h.sub(d).div(u).mul(a).add(d)):(l=z(c.x-h.x,c.y-h.y))<=this._radiusSquared?(u=Math.sqrt(l),h.sub(c).div(u).mul(a).add(c)):(l=z(p.x-h.x,p.y-h.y))<=this._radiusSquared&&(u=Math.sqrt(l),h.sub(p).div(u).mul(a).add(p))}var f,x;if(f=o.clone(),x=h.clone(),1==i.length)return r.push($(f.x)),r.push($(f.y)),r.push($(x.x)),void r.push($(x.y));var y,_,m,v,E,w=null,C=null,S=et.isInFace(o,i[0]);S.type===G&&n[0]===S&&(n.length>1&&n.shift(),i.length>1&&i.shift(),U("!! isShift"));var F=[],P=[];F.push(f),P.push(f);var V=new e(1),b=[],D=new e(0),O=new e(0);D.set(f,0),w=n[0];var L,N,T,M=et.getRelativePosition2(o,w);N=this.getCopyPoint(w.destinationVertex.pos),T=this.getCopyPoint(w.originVertex.pos),b.push(N),b.push(T),O.set(f,N),O.set(N,T),L=T,1==M?(D.set(N,1),D.set(T,-1),V.set(w.destinationVertex,1),V.set(w.originVertex,-1)):-1==M&&(D.set(N,-1),D.set(T,1),V.set(w.destinationVertex,-1),V.set(w.originVertex,1));for(var j=n[0].originVertex,R=n[0].destinationVertex,k=1,A=n.length;k<A;)(w=n[k++]).originVertex==j?C=w.destinationVertex:w.destinationVertex==j?C=w.originVertex:w.originVertex==R?(C=w.destinationVertex,j=R):w.destinationVertex==R?(C=w.originVertex,j=R):U("IMPOSSIBLE TO IDENTIFY THE VERTEX !!!"),N=this.getCopyPoint(C.pos),b.push(N),E=-V.get(j),D.set(N,E),O.set(L,N),V.set(C,E),L=N,R=j,j=C;O.set(L,x),D.set(x,0);var I=[],q=new e(1);I.push(f),q.set(f,0);for(var B,W=0,X=b.length;W<X;)if(B=b[W++],-1==D.get(B)){for(_=F.length-2;_>=0;){if(-1!=(E=et.getDirection(F[_],F[_+1],B))){F.shift();for(var Y=0;Y<_;){Y++;I.push(F[0]),q.set(F[0],1),F.shift()}I.push(F[0]),q.set(F[0],1),P.splice(0,P.length),P.push(F[0]),P.push(B);break}_--}for(P.push(B),_=P.length-3;_>=0&&-1!=(E=et.getDirection(P[_],P[_+1],B));)P.splice(_+1,1),_--}else{for(_=P.length-2;_>=0;){if(1!=(E=et.getDirection(P[_],P[_+1],B))){P.shift();for(var H=0;H<_;){H++;I.push(P[0]),q.set(P[0],-1),P.shift()}I.push(P[0]),q.set(P[0],-1),F.splice(0,F.length),F.push(P[0]),F.push(B);break}_--}for(F.push(B),_=F.length-3;_>=0&&1!=(E=et.getDirection(F[_],F[_+1],B));)F.splice(_+1,1),_--}var K=!1;for(_=P.length-2;_>=0;){if(1!=(E=et.getDirection(P[_],P[_+1],h))){P.shift();for(var Z=0,Q=_+1;Z<Q;){Z++;I.push(P[0]),q.set(P[0],-1),P.shift()}I.push(x),q.set(x,0),K=!0;break}_--}if(!K)for(_=F.length-2;_>=0;){if(-1!=(E=et.getDirection(F[_],F[_+1],h))){F.shift();for(var J=0,tt=_+1;J<tt;){J++;I.push(F[0]),q.set(F[0],1),F.shift()}I.push(x),q.set(x,0),K=!0;break}_--}K||(I.push(x),q.set(x,0),K=!0);var st=[];if(this._radius>0){var it=[];if(2==I.length)this.adjustWithTangents(I[0],!1,I[1],!1,D,O,it,st);else if(I.length>2){if(this.adjustWithTangents(I[0],!1,I[1],!0,D,O,it,st),I.length>3)for(var nt=1,rt=I.length-3+1;nt<rt;){var ot=nt++;this.adjustWithTangents(I[ot],!0,I[ot+1],!0,D,O,it,st)}var ht=I.length;this.adjustWithTangents(I[ht-2],!0,I[ht-1],!1,D,O,it,st)}it.push(x),this.checkAdjustedPath(it,st,D);var at=[];for(y=it.length-2;y>=1;){for(this.smoothAngle(st[2*y-1],it[y],st[2*y],D.get(it[y]),at);0!=at.length;)st.splice(2*y,0,at.pop());y--}}else st=I;for(v=0,m=st.length;v<m;)y=v++,r.push($(st[y].x)),r.push($(st[y].y))},adjustWithTangents:function(t,e,s,i,n,r,o,h){var a=[],l=n.get(t),u=n.get(s),d=null,c=null;if(e||i)if(e)if(i)if(1==l&&1==u)et.tangentsParalCircleToCircle(this._radius,t,s,a),d=this.getPoint(a[2],a[3]),c=this.getPoint(a[4],a[5]);else if(-1==l&&-1==u)et.tangentsParalCircleToCircle(this._radius,t,s,a),d=this.getPoint(a[0],a[1]),c=this.getPoint(a[6],a[7]);else if(1==l&&-1==u){if(!et.tangentsCrossCircleToCircle(this._radius,t,s,a))return void U("NO TANGENT, points are too close for radius");d=this.getPoint(a[2],a[3]),c=this.getPoint(a[6],a[7])}else{if(!et.tangentsCrossCircleToCircle(this._radius,t,s,a))return void U("NO TANGENT, points are too close for radius");d=this.getPoint(a[0],a[1]),c=this.getPoint(a[4],a[5])}else{if(!et.tangentsPointToCircle(s,t,this._radius,a))return void U("NO TANGENT");a.length>0&&(1==l?(d=this.getPoint(a[0],a[1]),c=s):(d=this.getPoint(a[2],a[3]),c=s))}else{if(!et.tangentsPointToCircle(t,s,this._radius,a))return void U("NO TANGENT");1==u?(d=t,c=this.getPoint(a[2],a[3])):(d=t,c=this.getPoint(a[0],a[1]))}else d=t,c=s;for(var p=r.get(t);p!=s;){if(et.distanceSquaredPointToSegment(p,d,c)<this._radiusSquared)return this.adjustWithTangents(t,e,p,!0,n,r,o,h),void this.adjustWithTangents(p,!0,s,i,n,r,o,h);p=r.get(p)}h.push(d),h.push(c),o.push(t)},checkAdjustedPath:function(t,e,s){for(var i,n,r,o,h,a,l,u,d,c=!0,p=[],g=null,f=null;c;){c=!1;for(var x=2;x<t.length;)h=t[x],a=s.get(h),r=t[x-1],o=s.get(r),i=t[x-2],n=s.get(i),o==a&&(l=e[2*(x-2)],u=e[2*(x-1)-1],d=e[2*(x-1)],(l.x-u.x)*(d.x-u.x)+(l.y-u.y)*(d.y-u.y)>0&&(2==x?(et.tangentsPointToCircle(i,h,this._radius,p),1==a?(g=i,f=this.getPoint(p[2],p[3])):(g=i,f=this.getPoint(p[0],p[1]))):x==t.length-1?(et.tangentsPointToCircle(h,i,this._radius,p),1==n?(g=this.getPoint(p[0],p[1]),f=h):(g=this.getPoint(p[2],p[3]),f=h)):1==n&&-1==a?(et.tangentsCrossCircleToCircle(this._radius,i,h,p),g=this.getPoint(p[2],p[3]),f=this.getPoint(p[6],p[7])):-1==n&&1==a?(et.tangentsCrossCircleToCircle(this._radius,i,h,p),g=this.getPoint(p[0],p[1]),f=this.getPoint(p[4],p[5])):1==n&&1==a?(et.tangentsParalCircleToCircle(this._radius,i,h,p),g=this.getPoint(p[2],p[3]),f=this.getPoint(p[4],p[5])):-1==n&&-1==a&&(et.tangentsParalCircleToCircle(this._radius,i,h,p),g=this.getPoint(p[0],p[1]),f=this.getPoint(p[6],p[7])),e.splice(2*(x-2),1,g),e.splice(2*x-1,1,f),t.splice(x-1,1),e.splice(2*(x-1)-1,2),p.splice(0,p.length),x--)),x++}},smoothAngle:function(t,e,s,i,n){var r=et.getDirection(t,e,s);if(!(z(t.x-s.x,t.y-s.y)<=this._sampleCircleDistanceSquared)){for(var o,h,a,l,u=0,d=0,c=this._numSamplesCircle;d<c;){var p=d++;a=!1,l=e.clone().add(this._sampleCircle[p]),o=et.getDirection(t,e,l),h=et.getDirection(e,s,l),1==i?-1==r?-1==o&&-1==h&&(a=!0):-1!=o&&-1!=h||(a=!0):1==r?1==o&&1==h&&(a=!0):1!=o&&1!=h||(a=!0),a?(n.splice(u,0,l),u++):u=0}-1==i&&n.reverse()}}},V.prototype={constructor:V,dispose:function(){this._mesh=null,this.astar.dispose(),this.astar=null,this.funnel.dispose(),this.funnel=null,this.listEdges=null,this.listFaces=null},findPath:function(t,e){if(e.splice(0,e.length),!et.isCircleIntersectingAnyConstraint(t,this.entity.radius,this._mesh)){this.astar.radius=this.entity.radius,this.funnel.radius=this.entity.radius,this.listFaces.splice(0,this.listFaces.length),this.listEdges.splice(0,this.listEdges.length);var s=this.entity.position;this.astar.findPath(s,t,this.listFaces,this.listEdges),0!=this.listFaces.length?this.funnel.findPath(s,t,this.listFaces,this.listEdges,e):U("PathFinder listFaces.length == 0")}}},b.prototype={constructor:b,reset:function(){this.count=0,this._currentX=this._path[this.count],this._currentY=this._path[this.count+1],this.updateEntity(),this.hasPrev=!1,this._path.length>2?this.hasNext=!0:this.hasNext=!1},prev:function(){return!!this.hasPrev&&(this.hasNext=!0,this.count--,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),0==this.count&&(this.hasPrev=!1),!0)},next:function(){return!!this.hasNext&&(this.hasPrev=!0,this.count++,this._currentX=this._path[2*this.count],this._currentY=this._path[2*this.count+1],this.updateEntity(),2*(this.count+1)==this._path.length&&(this.hasNext=!1),!0)},updateEntity:function(){this.entity&&(this.entity.x=this._currentX,this.entity.y=this._currentY)}},D.prototype={constructor:D,dispose:function(){this.entity=null,this._path=null,this._preCompX=null,this._preCompY=null},reset:function(){this._path.length>0?(this.pos.x=this._path[0],this.pos.y=this._path[1],this._iPrev=0,this._iNext=2,this.hasPrev=!1,this.hasNext=!0,this._count=0,this.updateEntity()):(this.hasPrev=!1,this.hasNext=!1,this._count=0)},preCompute:function(){for(this._preCompX.splice(0,this._preCompX.length),this._preCompY.splice(0,this._preCompY.length),this._count=0,this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y),this._preComputed=!1;this.next();)this._preCompX.push(this.pos.x),this._preCompY.push(this.pos.y);this.reset(),this._preComputed=!0},prev:function(){if(!this.hasPrev)return!1;if(this.hasNext=!0,this._preComputed)return 0==--this._count&&(this.hasPrev=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iPrev],i=this._path[this._iPrev+1];if(!((e=Z(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this._iPrev-=2,this._iNext-=2,0==this._iNext)break}return 0==this._iNext?(this.pos.x=this._path[0],this.pos.y=this._path[1],this.hasPrev=!1,this._iNext=2,this._iPrev=0,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iPrev]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iPrev+1]-this.pos.y)*t/e,this.updateEntity(),!0)},next:function(){if(!this.hasNext)return!1;if(this.hasPrev=!0,this._preComputed)return++this._count==this._preCompX.length-1&&(this.hasNext=!1),this.applyLast(),this.updateEntity(),!0;var t,e;for(t=this._samplingDistance;;){var s=this._path[this._iNext],i=this._path[this._iNext+1];if(!((e=Z(this.pos.x-s,this.pos.y-i))<t))break;if(t-=e,this.pos.x=this._path[this._iNext],this.pos.y=this._path[this._iNext+1],this._iPrev+=2,this._iNext+=2,this._iNext==this._path.length)break}return this._iNext==this._path.length?(this.pos.x=this._path[this._iPrev],this.pos.y=this._path[this._iPrev+1],this.hasNext=!1,this._iNext=this._path.length-2,this._iPrev=this._iNext-2,this.updateEntity(),!0):(this.pos.x=this.pos.x+(this._path[this._iNext]-this.pos.x)*t/e,this.pos.y=this.pos.y+(this._path[this._iNext+1]-this.pos.y)*t/e,this.updateEntity(),!0)},applyLast:function(){this.pos.set(this._preCompX[this._count],this._preCompY[this._count])},updateEntity:function(){null!=this.entity&&(this.entity.angle=Math.atan2(this.pos.y-this.entity.position.y,this.pos.x-this.entity.position.x),this.entity.direction.angular(this.entity.angle),this.entity.position.copy(this.pos))}},O.prototype={constructor:O,isInField:function(t){if(this.world&&this.entity){this.mesh=this.world.getMesh();var i=this.entity.position,n=this.entity.direction,r=t.position,o=this.entity.radiusFOV,h=this.entity.angleFOV,a=t.radius;if(z(i.x-r.x,i.y-r.y)>=(o+a)*(o+a))return!1;var l,u,d=new s,c=new s,p=[];et.intersections2Circles(i,o,r,a,p)&&(d.set(p[0],p[1]),c.set(p[2],p[3]));var g=i.clone().add(r).mul(.5);(0==p.length||z(g.x-r.x,g.y-r.y)<z(g.x-d.x,g.y-d.y))&&(p.splice(0,p.length),et.tangentsPointToCircle(i,r,a,p),d.set(p[0],p[1]),c.set(p[2],p[3]));var f=Math.cos(.5*this.entity.angleFOV),x=d.clone().sub(i),y=Math.sqrt(x.x*x.x+x.y*x.y);l=x.x/y*n.x+x.y/y*n.y>f;var _=c.clone().sub(i),m=Math.sqrt(_.x*_.x+_.y*_.y);if(u=_.x/m*n.x+_.y/m*n.y>f,!l&&!u){var v=i.clone().add(n);if(1!==et.getDirection(i,v,d)||-1!==et.getDirection(i,v,c))return!1}if(!l||!u){var E,w=new s;if(E=Math.atan2(n.y,n.x),!l){var C=new s(Math.cos(E-.5*h),Math.sin(E-.5*h)).add(i);et.intersections2segments(i,C,d,c,w,null,!0),d=w.clone()}if(!u){var S=new s(Math.cos(E+.5*h),Math.sin(E+.5*h)).add(i);et.intersections2segments(i,S,d,c,w,null,!0),c=w.clone()}}var F,P=new e(0),V=new e(0),b=[],D=et.locatePosition(i,this.mesh);2==D.type?F=D:1==D.type?F=D.leftFace:0==D.type&&(F=D.edge.leftFace);var O=[],L=new e(0);O.push(F),L[F]=!0;for(var N,T,M,j,R,k,A,I,q,B=new s,W=new s,G=[],X=[];O.length>0;)for(N=O.shift(),L.set(N,null),P.set(N,!0),T=N.edge,V.get(T)||V.get(T.oppositeEdge)||(X.push(T),V.set(T,!0)),T=T.nextLeftEdge,V.get(T)||V.get(T.oppositeEdge)||(X.push(T),V.set(T,!0)),T=T.nextLeftEdge,V.get(T)||V.get(T.oppositeEdge)||(X.push(T),V.set(T,!0));X.length>0;)if(T=X.pop(),M=T.originVertex.pos,j=T.destinationVertex.pos,et.clipSegmentByTriangle(M,j,i,c,d,B,W)){if(T.isConstrained){for(G.splice(0,G.length),et.intersections2segments(i,B,d,c,null,G,!0),et.intersections2segments(i,W,d,c,null,G,!0),R=G[1],(k=G[3])<R&&(R=k,k=G[1]),A=b.length-1;A>=0&&!(k>=b[A]);A--);for((q=A+1)%2==0&&b.splice(q,0,k),A=0;A<b.length&&!(R<=b[A]);A++);if((I=A)%2==0?(b.splice(I,0,R),q++):I--,b.splice(I+1,q-I-1),2==b.length&&-.01<b[0]&&b[0]<.01&&.99<b[1]&&b[1]<1.01)return!1}N=T.rightFace,L.get(N)||P.get(N)||(O.push(N),L.set(N,!0))}return!0}}},L.prototype={constructor:L,setTarget:function(t,e){this.path=[],this.target.set(t,e),this.world.pathFinder.entity=this,this.world.pathFinder.findPath(this.target,this.path),this.testPath()},testPath:function(){if(this.path&&this.path.length>0){this.pathSampler.reset(),this.tmppath=[];for(var t=this.path.length;t--;)this.tmppath[t]=this.path[t];this.pathSampler.path=this.tmppath,this.newPath=!0}},getPos:function(){return{x:this.position.x,y:this.position.y,r:-this.angle}},update:function(){var t;this.pathSampler.hasNext?(this.newPath=!1,this.isMove=!0,this.pathSampler.next()):(this.isMove=!1,this.tmppath=[]),this.isMove&&!this.isWalking&&(this.isWalking=!0),!this.isMove&&this.isWalking&&(this.isWalking=!1),null!==this.mesh&&(t=this.getPos(),this.mesh.position.set(t.x,0,t.y),this.mesh.rotation.y=t.r)}},N.prototype=Object.create(S.prototype);var it={};it.buildFromBmpData=function(t,e,s){void 0!==s&&st.setColor(s),e=e||1;var i,r=st.buildShapes(t);if(e>=1)for(var o=0,h=r.length;o<h;){var a=o++;r[a]=n(r[a],e)}for(var l=[],u=0,d=r.length;u<d;){var c=u++;l.push(st.buildGraph(r[c]))}for(var p=[],g=0,f=l.length;g<f;){var x=g++;p.push(st.buildPolygon(l[x]))}for(var y=new _,m=0,v=p.length;m<v;){var E=m++;for(i=0;i<p[E].length-2;)y.coordinates.push(p[E][i]),y.coordinates.push(p[E][i+1]),y.coordinates.push(p[E][i+2]),y.coordinates.push(p[E][i+3]),i+=2;y.coordinates.push(p[E][0]),y.coordinates.push(p[E][1]),y.coordinates.push(p[E][i]),y.coordinates.push(p[E][i+1])}return y};var nt={};nt.buildFromBmpData=function(t,e,s){void 0!==s&&st.setColor(s),e=e||1;var i,r,o,h,a=st.buildShapes(t);if(e>=1)for(i=a.length;i--;)a[i]=n(a[i],e);var l=[];for(o=a.length,i=0;i<o;i++)l.push(st.buildGraph(a[i]));var u=[];for(o=l.length,i=0;i<o;i++)u.push(st.buildPolygon(l[i]));var d=new N(t.width,t.height);for(o=u.length,i=0;i<o;i++){for(h=u[i].length-2,r=0;r<h;r+=2)d.insertConstraintSegment(u[i][r],u[i][r+1],u[i][r+2],u[i][r+3]);d.insertConstraintSegment(u[i][0],u[i][1],u[i][r],u[i][r+1])}return d},T.prototype={constructor:T,getMesh:function(){return this.mesh},update:function(){for(var t,e,s=this.heroes.length,i=s;i--;)if((e=this.heroes[i]).update(),e.testSee)for(t=s;t--;)i!==t&&(this.heroes[i].isSee=this.heroes[i].fov.isInField(this.heroes[t]))},updateMesh:function(){this.mesh.updateObjects()},add:function(t){this.mesh.insertObject(t),this.objects.push(t)},addHeroe:function(t){var e=new L(t,this);return this.heroes.push(e),e},addObject:function(t){t=t||{};var e=new _;return e.coordinates=t.coord||[-1,-1,1,-1,1,-1,1,1,1,1,-1,1,-1,1,-1,-1],e.position(t.x||1,t.y||1),e.scale(t.w||1,t.h||1),e.pivot(t.px||0,t.py||0),e.rotation=t.r||0,this.mesh.insertObject(e),this.objects.push(e),e},reset:function(t,e){this.mesh.dispose(),t&&(this.w=t),e&&(this.h=e),this.mesh=new N(this.w,this.h),this.pathFinder.mesh=this.mesh},rebuild:function(t){this.mesh.clear(!0),this.mesh=void 0!==t?t:new N(this.w,this.h),this.pathFinder.mesh=this.mesh;for(var e=this.objects.length;e--;)this.objects[e]._constraintShape=null,this.mesh.insertObject(this.objects[e])},addBitmapZone:function(t){if((t=t||{}).url){var e=document.createElement("img");e.onload=function(){t.pixel=o(e),t.w=e.width,t.h=e.height,this.updateBitmapZone(t)}.bind(this),e.src=t.url}t.canvas&&(t.w=t.canvas.width,t.h=t.canvas.height,t.pixel=o(null,t.canvas.getContext("2d").getImageData(0,0,t.w,t.h)),this.updateBitmapZone(t)),t.img&&(t.w=t.img.width,t.h=t.img.height,t.pixel=o(t.img),this.updateBitmapZone(t))},updateBitmapZone:function(t){t=t||{},this.mesh.dispose(),this.mesh=nt.buildFromBmpData(t.pixel,t.precision||1.8,t.color),this.pathFinder.mesh=this.mesh;var e=Y.get();e&&e.drawMesh(this.mesh)}},j.prototype={constructor:j,generate:function(t,e,s,i){this.tileWidth=t/s|0,this.tileHeight=e/i|0,this.cols=s,this.rows=i,this.rng=new h(K(1234,7259)),this.makeGrid(),this.traverseGrid(),this.populateObject()},makeGrid:function(){this.grid=[];for(var t=0,e=this.cols;t<e;){var s=t++;this.grid[s]=[];for(var i=0,n=this.rows;i<n;){var r=i++,o=new M(s,r);this.grid[s][r]=o;var h=[s*this.tileWidth,r*this.tileHeight],a=[(s+1)*this.tileWidth,r*this.tileHeight],l=[s*this.tileWidth,(r+1)*this.tileHeight],u=[(s+1)*this.tileWidth,(r+1)*this.tileHeight];o.walls[0]=h.concat(a),o.walls[1]=a.concat(u),o.walls[2]=l.concat(u),0==r&&0==s||(o.walls[3]=h.concat(l))}}},traverseGrid:function(){for(var t=[0,1,0,-1],e=[-1,0,1,0],s=[2,3,0,1],i=this.rng.nextInRange(0,this.cols-1),n=this.rng.nextInRange(0,this.rows-1),r=[this.grid[i][n]];r.length>0;){var o=r.length-1,h=r[o];h.visited=!0;var a=[0,1,2,3];this.rng.shuffle(a);for(var l=0;l<a.length;){var u=a[l];++l;var d=h.col+t[u],c=h.row+e[u];if(d>=0&&d<this.cols&&c>=0&&c<this.rows&&!this.grid[d][c].visited){var p=this.grid[d][c];h.walls[u]=[],p.walls[s[u]]=[],p.visited=!0,r.push(p),o=-1;break}}o>=0&&r.splice(o,1)}},populateObject:function(){this.object=new _;for(var t=[],e=0,s=this.cols;e<s;)for(var i=e++,n=0,r=this.rows;n<r;)for(var o=n++,h=0,a=this.grid[i][o].walls;h<a.length;){var l=a[h];++h;for(var u=0;u<l.length;){var d=l[u];++u,t.push(d)}}this.object.coordinates=t}},R.prototype={constructor:R,generate:function(t,e,s,i){this.w=t/10,this.h=e/10,this.rooms=[],this.map=[];for(p=0;p<this.w;p++){this.map[p]=[];for(g=0;g<this.h;g++)this.map[p][g]=0}for(var n=K(10,20),r=s||5,o=i||15,h=0;h<n;h++)(c={}).x=K(1,this.w-o-1),c.y=K(1,this.h-o-1),c.w=K(r,o),c.h=K(r,o),this.DoesCollide(c)?h--:(c.w--,c.h--,this.rooms.push(c));for(this.SquashRooms(),h=0;h<n;h++)for(var a=this.rooms[h],l=this.FindClosestRoom(a),u={x:K(a.x,a.x+a.w),y:K(a.y,a.y+a.h)},d={x:K(l.x,l.x+l.w),y:K(l.y,l.y+l.h)};d.x!=u.x||d.y!=u.y;)d.x!=u.x?d.x>u.x?d.x--:d.x++:d.y!=u.y&&(d.y>u.y?d.y--:d.y++),this.map[d.x][d.y]=1;for(h=0;h<n;h++)for(var c=this.rooms[h],p=c.x;p<c.x+c.w;p++)for(g=c.y;g<c.y+c.h;g++)this.map[p][g]=1;for(p=0;p<this.w;p++)for(var g=0;g<this.h;g++)if(1==this.map[p][g])for(var f=p-1;f<=p+1;f++)for(var x=g-1;x<=g+1;x++)0==this.map[f][x]&&(this.map[f][x]=2);this.populateObject()},FindClosestRoom:function(t){for(var e={x:t.x+t.w/2,y:t.y+t.h/2},s=null,i=1e3,n=0;n<this.rooms.length;n++){var r=this.rooms[n];if(r!=t){var o={x:r.x+r.w/2,y:r.y+r.h/2},h=Math.min(Math.abs(e.x-o.x)-t.w/2-r.w/2,Math.abs(e.y-o.y)-t.h/2-r.h/2);h<i&&(i=h,s=r)}}return s},SquashRooms:function(){for(var t=0;t<10;t++)for(var e=0;e<this.rooms.length;e++)for(var s=this.rooms[e];;){var i={x:s.x,y:s.y};if(s.x>1&&s.x--,s.y>1&&s.y--,1==s.x&&1==s.y)break;if(this.DoesCollide(s,e)){s.x=i.x,s.y=i.y;break}}},DoesCollide:function(t,e){for(var s=0;s<this.rooms.length;s++)if(s!=e){var i=this.rooms[s];if(!(t.x+t.w<i.x||t.x>i.x+i.w||t.y+t.h<i.y||t.y>i.y+i.h))return!0}return!1},populateObject:function(){var t=document.createElement("canvas");t.width=10*this.w,t.height=10*this.h;var e=t.getContext("2d");e.fillStyle="#FFF",e.fillRect(0,0,t.width,t.height);for(var s=0;s<this.h;s++)for(var i=0;i<this.w;i++){var n=this.map[i][s];e.fillStyle=0===n?"#000000":1===n?"#FFFFFF":"#000000",e.fillRect(10*i,10*s,10,10)}var r=o(null,e.getImageData(0,0,10*this.w,10*this.h));this.object=it.buildFromBmpData(r,1.8)}},k.prototype={drawImage:function(t,e,s){this.g0.drawImage(t,e,s)},drawMesh:function(t,e){var s=this.g0;void 0!==e&&e&&this.g0.clear(),t.compute_Data();for(var i=t.AR_edge,n=t.AR_vertex,r=i.length,o=0;r--;)i[(o=5*r)+4]?s.lineStyle(this.constraintsWidth,this.constraintsColor):s.lineStyle(this.edgesWidth,this.edgesColor),s.moveTo(i[o],i[o+1]),s.lineTo(i[o+2],i[o+3]),s.stroke(),s.closePath();for(s.lineStyle(this.verticesRadius,this.verticesColor),r=n.length;r--;)o=2*r,s.beginFill(this.verticesColor,this.verticesAlpha),s.drawCircle(n[o],n[o+1],this.verticesRadius),s.endFill()},drawEntity:function(t,e){var s=this.g,i=t.isSee;void 0!==e&&e&&s.clear(),i?s.beginFill(this.entitiesField):s.beginFill(this.entitiesField2),s.moveTo(t.position.x,t.position.y),s.drawCircle(t.position.x,t.position.y,t.radiusFOV,t.angle-.5*t.angleFOV,t.angle+.5*t.angleFOV),s.lineTo(t.position.x,t.position.y),s.endFill(),i?s.beginFill(this.entitiesColor):s.beginFill(this.entitiesColor2),s.drawCircle(t.position.x,t.position.y,t.radius),s.endFill()},drawPath:function(t,e){var s=this.g;if(void 0!==e&&e&&this.g.clear(),0!==t.length){s.lineStyle(this.pathsWidth,this.pathsColor),s.moveTo(t[0],t[1]);for(var i=2;i<t.length;)s.lineTo(t[i],t[i+1]),i+=2;s.stroke()}},clear:function(){this.g.clear()}},A.prototype={clear:function(){this.ctx.clearRect(0,0,this.w,this.h)},drawImage:function(t,e,s){this.ctx.drawImage(t,0,0,e||this.w,s||this.h)},drawCircle:function(t,e,s,i,n){i=i||0,n=n||B,this.ctx.beginPath(),this.ctx.arc(t,e,s,i,n,!1)},drawRect:function(t,e,s,i){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+s,e),this.ctx.lineTo(t+s,e+i),this.ctx.lineTo(t,e+i),this.ctx.stroke(),this.ctx.closePath()},lineStyle:function(t,e){this.ctx.lineWidth=t,this.ctx.strokeStyle="rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},moveTo:function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t,e)},lineTo:function(t,e){this.ctx.lineTo(t,e)},stroke:function(){this.ctx.stroke()},closePath:function(){this.ctx.closePath()},beginFill:function(t){this.ctx.fillStyle="rgba("+t.r+","+t.g+","+t.b+","+t.a+")",this.ctx.beginPath()},endFill:function(){this.ctx.closePath(),this.ctx.fill()}},I.prototype={constructor:I,drawMesh:function(t,e){},collapseBuffer:function(){for(var t=this.maxVertices,e=this.currentVertex,s=0;t>=e;)s=3*t,this.positions[s]=0,this.positions[s+1]=0,this.positions[s+2]=0,this.colors[s]=0,this.colors[s+1]=0,this.colors[s+2]=0,t--},collapsePathBuffer:function(){for(var t=this.maxPathVertices,e=this.currentPathVertex,s=0;t>=e;)s=3*t,this.positionsPath[s]=0,this.positionsPath[s+1]=0,this.positionsPath[s+2]=0,this.colorsPath[s]=0,this.colorsPath[s+1]=0,this.colorsPath[s+2]=0,t--},update:function(){this.world.mesh.isRedraw&&(this.currentVertex=0,this.world.mesh.draw(),this.collapseBuffer(),this.buffer.geometry.attributes.position.needsUpdate=!0,this.buffer.geometry.attributes.color.needsUpdate=!0),this.world.update();for(var t,e=this.world.heroes.length;e--;)if((t=this.world.heroes[e]).isSelected&&t.tmppath.length>0){this.currentPathVertex=0;for(var s=this.world.heroes[e].tmppath,i=s[0],n=s[1],r=2;r<s.length;)this.insertPath(i,n,s[r],s[r+1],1,0,0),i=s[r],n=s[r+1],r+=2;this.collapsePathBuffer(),this.bufferPath.geometry.attributes.position.needsUpdate=!0,this.bufferPath.geometry.attributes.color.needsUpdate=!0}},insertLine:function(t,e,s,i,n,r,o){var h=this.currentVertex,a=3*h;this.positions[a]=t,this.positions[a+1]=0,this.positions[a+2]=e,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,a=3*++h,this.positions[a]=s,this.positions[a+1]=0,this.positions[a+2]=i,this.colors[a]=n,this.colors[a+1]=r,this.colors[a+2]=o,this.currentVertex+=2},insertPath:function(t,e,s,i,n,r,o){var h=this.currentPathVertex,a=3*h;this.positionsPath[a]=t,this.positionsPath[a+1]=0,this.positionsPath[a+2]=e,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,a=3*++h,this.positionsPath[a]=s,this.positionsPath[a+1]=0,this.positionsPath[a+2]=i,this.colorsPath[a]=n,this.colorsPath[a+1]=r,this.colorsPath[a+2]=o,this.currentPathVertex+=2}},S.prototype.draw=function(){this.compute_Data();for(var t=Y.get(),e=this.AR_edge,s=e.length,i=0;s--;)e[(i=5*s)+4]?t.insertLine(e[i],e[i+1],e[i+2],e[i+3],0,0,0):t.insertLine(e[i],e[i+1],e[i+2],e[i+3],.4,.4,.4);this.isRedraw=!1},t.Point=s,t.Matrix2D=i,t.Geom2D=et,t.Edge=p,t.Face=g,t.Vertex=f,t.Shape=x,t.Segment=y,t.Object2D=_,t.Graph=m,t.Potrace=st,t.Mesh2D=S,t.AStar=F,t.Funnel=P,t.PathFinder=V,t.PathIterator=b,t.LinearPathSampler=D,t.FieldOfView=O,t.Entity=L,t.World=T,t.RectMesh=N,t.CircleMesh=function(t,e,s,i){s=s||100,t=t||s,e=e||s;for(var n=[],r=[],o=[],h=[],a=[],l=i=i||8;l--;)o.push(new g),n.push(new f),h.push(new y),r.push(new p,new p,new p);var u=new x,d=1/i;for(l=0;l<i;)n[l].pos.set(t+(s+10)*Math.cos(B*l*d),e+(s+10)*Math.sin(B*l*d)),n[l].setDatas(r[2*l]),l++;for(l=0;l<i;)a.push(t+s*Math.cos(B*l*d)),a.push(e+s*Math.sin(B*l*d)),a.push(t+s*Math.cos(B*(l+1)*d)),a.push(e+s*Math.sin(B*(l+1)*d)),l++;var c=new S(2*s,2*s);return c._vertices=n,c._edges=r,c._faces=o,c._constraintShapes.push(u),c.clipping=!1,c.insertConstraintShape(a),c.clipping=!0,c},t.BitmapObject=it,t.BitmapMesh=nt,t.GridMaze=j,t.Dungeon=R,t.SimpleView=k,t.ThreeView=I,t.REVISION="1.0.0",t.TTIER=.3333333333333333,t.torad=q,t.todeg=57.29577951308232,t.EPSILON=.01,t.EPSILON_SQUARED=1e-4,t.INFINITY=1/0,t.TwoPI=B,t.VERTEX=W,t.EDGE=G,t.FACE=X,t.NULL=3,t.Main=Y,t.IDX=H,t.Log=U,t.Dictionary=e,t.rand=function(t,e){return t+Math.random()*(e-t)},t.randInt=K,t.Squared=z,t.SquaredSqrt=Z,t.nearEqual=Q,t.Integral=J,t.fix=$,t.ARRAY=tt,t.ShapeSimplifier=n,t.fromImageData=o,Object.defineProperty(t,"__esModule",{value:!0})});
